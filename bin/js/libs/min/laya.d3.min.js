Laya.interface("laya.d3.core.IClone"),Laya.interface("laya.d3.graphics.IVertex"),Laya.interface("laya.d3.core.render.IUpdate"),Laya.interface("laya.d3.core.scene.ITreeNode"),Laya.interface("laya.d3.core.render.IRenderable");var SplineCurvePositionVelocity=function(){function e(){this._tempVector30=new Vector3,this._tempVector31=new Vector3,this._tempVector32=new Vector3,this._a=new Vector3,this._b=new Vector3,this._c=new Vector3,this._d=new Vector3}__class(e,"laya.d3.core.glitter.SplineCurvePositionVelocity",!0);var t=e.prototype;return t.Init=function(e,t,n,i){e.cloneTo(this._d),t.cloneTo(this._c),Vector3.scale(e,2,this._a),Vector3.scale(n,2,this._tempVector30),Vector3.subtract(this._a,this._tempVector30,this._a),Vector3.add(this._a,t,this._a),Vector3.add(this._a,i,this._a),Vector3.scale(n,3,this._b),Vector3.scale(e,3,this._tempVector30),Vector3.subtract(this._b,this._tempVector30,this._b),Vector3.subtract(this._b,i,this._b),Vector3.scale(t,2,this._tempVector30),Vector3.subtract(this._b,this._tempVector30,this._b)},t.Slerp=function(e,t){Vector3.scale(this._a,e*e*e,this._tempVector30),Vector3.scale(this._b,e*e,this._tempVector31),Vector3.scale(this._c,e,this._tempVector32),Vector3.add(this._tempVector30,this._tempVector31,t),Vector3.add(t,this._tempVector32,t),Vector3.add(t,this._d,t)},e}(),PhasorSpriter3D=function(){function e(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._camera=null,this._sharderNameID=0,this._shader=null,this._shaderCompile=null,this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._spriteShaderValue=new ValusArray,this._vb=VertexBuffer3D.create(e._vertexDeclaration,this._defaultBufferSize/this._floatSizePerVer,35048),this._ib=IndexBuffer3D.create("ushort",this._defaultBufferSize,35048),this._sharderNameID=Shader3D.nameKey.getID("LINE"),this._shaderCompile=ShaderCompile3D._preCompileShader[this._sharderNameID]}__class(e,"laya.d3.core.PhasorSpriter3D",!0);var t=e.prototype;return t.line=function(e,t,n,i){return this._hasBegun&&1==this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e.x,e.y,e.z,t.x,t.y,t.z,t.w),this.addVertex(n.x,n.y,n.z,i.x,i.y,i.z,i.w),this.addIndexes(this._tempUint0,this._tempUint0+1),this},t.circle=function(e,t,n,i,r,a){for(this._hasBegun&&1==this._primitiveType||this.drawLinesException(),this._tempUint0=2*t,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/t,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*e,Math.cos(this._tempNumver0)*e,0,n,i,r,a),0==this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0==this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},t.plane=function(e,t,n,i,r,a,o,s,l){return this._hasBegun&&4==this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n,a,o,s,l),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n,a,o,s,l),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n,a,o,s,l),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n,a,o,s,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},t.box=function(e,t,n,i,r,a,o,s,l,_){return this._hasBegun&&4==this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,o,s,l,_),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n+this._tempNumver2,o,s,l,_),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,o,s,l,_),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n+this._tempNumver2,o,s,l,_),this.addVertex(e+this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,o,s,l,_),this.addVertex(e-this._tempNumver0,t+this._tempNumver1,n-this._tempNumver2,o,s,l,_),this.addVertex(e+this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,o,s,l,_),this.addVertex(e-this._tempNumver0,t-this._tempNumver1,n-this._tempNumver2,o,s,l,_),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},t.cone=function(e,t,n,i,r,a,o){for(this._hasBegun&&4==this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*n+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*n>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/n,this.addVertexIndex(0,t,0,i,r,a,o,this._tempUint0),this.addVertexIndex(0,0,0,i,r,a,o,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<n;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,o,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==n-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(e*this._tempNumver2,0,e*this._tempNumver3,i,r,a,o,this._tempUint0+(this._tempInt0+n)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==n-1?this.addIndexes(this._tempUint1+n+2):this.addIndexes(this._tempUint1+this._tempInt0+n+1),this.addIndexes(this._tempUint1+this._tempInt0+n),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},t.boundingBoxLine=function(e,t,n,i,r,a,o,s,l,_){return this._hasBegun&&1==this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(e,r,a,o,s,l,_),this.addVertex(i,r,a,o,s,l,_),this.addVertex(e,t,a,o,s,l,_),this.addVertex(i,t,a,o,s,l,_),this.addVertex(i,r,n,o,s,l,_),this.addVertex(e,r,n,o,s,l,_),this.addVertex(i,t,n,o,s,l,_),this.addVertex(e,t,n,o,s,l,_),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},t.addVertex=function(e,t,n,i,r,a,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=e,this._vbData[this._posInVBData+1]=t,this._vbData[this._posInVBData+2]=n,this._vbData[this._posInVBData+3]=i,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=o,this._posInVBData+=this._floatSizePerVer,this},t.addVertexIndex=function(e,t,n,i,r,a,o,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[s]=e,this._vbData[s+1]=t,this._vbData[s+2]=n,this._vbData[s+3]=i,this._vbData[s+4]=r,this._vbData[s+5]=a,this._vbData[s+6]=o,(s+=this._floatSizePerVer)>this._posInVBData&&(this._posInVBData=s),this},t.addIndexes=function(e){var t=arguments;this._hasBegun||this.addVertexIndexException();for(var n=0;n<t.length;n++)this._ibData[this._posInIBData]=t[n],this._posInIBData++;return this},t.begin=function(e,t){return this._hasBegun&&this.beginException0(),1!=e&&4!=e&&this.beginException1(),this._primitiveType=e,this._camera=t,this._hasBegun=!0,this},t.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},t.flush=function(){0!=this._posInVBData&&(this._ib.setData(this._ibData),this._vb.setData(this._vbData),this._vb._bind(),this._ib._bind(),this._shader=this._shaderCompile.withCompile(0,0,0),this._shader.bind(),this._shader.uploadAttributes(e._vertexDeclaration.shaderValues.data,null),this._spriteShaderValue.setValue(1,this._camera.projectionViewMatrix.elements),this._shader.uploadSpriteUniforms(this._spriteShaderValue.data),Stat.drawCall++,WebGL.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0)},t.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},t.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},t.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},t.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},t.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},t.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(28,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector4",1)])}]),e}(),Layer=function(){function r(){this._visible=!0,this._nonRigidbodyOffset=0,this._colliders=[]}__class(r,"laya.d3.core.Layer",!0);var e=r.prototype;return e._binarySearchIndex=function(){for(var e=0,t=r._collsionTestList.length-1,n=0;e<=t;){n=Math.floor((e+t)/2);var i=r._collsionTestList[n];if(i==this._number)return n;i>this._number?t=n-1:e=n+1}return e},e._addCollider=function(e){0==this._colliders.length&&r._collsionTestList.splice(this._binarySearchIndex(),0,this._number),e._isRigidbody?(this._colliders.unshift(e),this._nonRigidbodyOffset++):this._colliders.push(e)},e._removeCollider=function(e){var t=this._colliders.indexOf(e);t<this._nonRigidbodyOffset&&this._nonRigidbodyOffset--,this._colliders.splice(t,1),0==this._colliders.length&&r._collsionTestList.splice(r._collsionTestList.indexOf(this._number),1)},__getset(0,e,"visible",function(){return this._visible},function(e){this._visible=e,r._visibleLayers=e?r._visibleLayers|this.mask:r._visibleLayers&~this.mask}),__getset(0,e,"mask",function(){return this._mask}),__getset(0,e,"number",function(){return this._number}),__getset(1,r,"visibleLayers",function(){return r._visibleLayers},function(e){r._visibleLayers=e;for(var t=0,n=r._layerList.length;t<n;t++){var i=r._layerList[t];i._visible=0!=(i._mask&r._visibleLayers)}}),r.__init__=function(){r._layerList.length=31;for(var e=0;e<31;e++){var t=new r;(r._layerList[e]=t).visible=0==e?(t.name="Default Layer",!0):(t.name="Layer-"+e,!1),t._number=e,t._mask=Math.pow(2,e)}r.currentCreationLayer=r._layerList[0]},r.getLayerByNumber=function(e){if(e<0||30<e)throw new Error("无法返回指定Layer，该number超出范围！");return r._layerList[e]},r.getLayerByName=function(e){for(var t=0;t<31;t++)if(r._layerList[t].name==e)return r._layerList[t];throw new Error("无法返回指定Layer,该name不存在")},r.isVisible=function(e){return 0!=(e&r._currentCameraCullingMask&r._visibleLayers)},r._layerList=[],r._visibleLayers=2147483647,r._collsionTestList=[],r._currentCameraCullingMask=2147483647,r.maxCount=31,r.currentCreationLayer=null,r}(),TrailRenderElement=function(){function t(e){this._id=0,this._owner=null,this._camera=null,this._vertexBuffers=null,this._verticesCount=0,this._virtualVerticesCount=0,this._maxVerticesCount=256,this._vertices1=null,this._vertexBuffer1=null,this._floatCountPerVertices1=8,this._verticesIndex1=0,this._everyAddVerticeCount1=0,this._delLength=0,this._vertices2=null,this._vertexBuffer2=null,this._floatCountPerVertices2=1,this._everyGroupVertexBirthTime=null,this._VerticesToTailLength=null,this._everyVertexToPreVertexDistance=null,this._pointe=null,this._pointAtoBVector3e=null,this._isStart=!1,this._isFinish=!1,this._isDead=!1,this._curtime=NaN,this._curDisappearIndex=0,this._lastPosition=new Vector3,this._curPosition=new Vector3,this._delVector3=new Vector3,this._lastFixedVertexPosition=new Vector3,this._pointAtoBVector3=new Vector3,this._pointA=new Vector3,this._pointB=new Vector3,this._owner=e,this._id=t.renderElementCount++,0==this._id?e._owner.transform.position.cloneTo(this._lastPosition):e._curSubTrailFinishPosition.cloneTo(this._lastPosition),this._everyGroupVertexBirthTime=[],this._VerticesToTailLength=new Float32Array(this._maxVerticesCount),this._everyVertexToPreVertexDistance=new Float32Array(this._maxVerticesCount),this._vertices1=new Float32Array(this._maxVerticesCount*this._floatCountPerVertices1),this._vertices2=new Float32Array(this._maxVerticesCount*this._floatCountPerVertices2),this._vertexBuffer1=new VertexBuffer3D(VertexTrail.vertexDeclaration1,this._maxVerticesCount,35044,!0),this._vertexBuffer2=new VertexBuffer3D(VertexTrail.vertexDeclaration2,this._maxVerticesCount,35044,!0),this._vertexBuffers=[],this._vertexBuffers.push(this._vertexBuffer1),this._vertexBuffers.push(this._vertexBuffer2)}__class(t,"laya.d3.core.trail.TrailRenderElement",!0);var e=t.prototype;return Laya.imps(e,{"laya.d3.core.render.IRenderable":!0}),e._updateTrail=function(){this._everyAddVerticeCount1=0,this._isStart||this._addTrailByFirstPosition(this._lastPosition,this._curPosition),this._addTrailByNextPosition(this._curPosition),this._vertexBuffer1.setData(this._vertices1,this._verticesIndex1,this._verticesIndex1,this._everyAddVerticeCount1),this._verticesIndex1+=this._everyAddVerticeCount1,this._curPosition.cloneTo(this._lastPosition),2==this._virtualVerticesCount&&(this._verticesIndex1-=2*this._floatCountPerVertices1)},e._addTrailByFirstPosition=function(e,t){Vector3.subtract(t,e,this._delVector3),Vector3.cross(this._delVector3,this._camera.forward,this._pointAtoBVector3),Vector3.normalize(this._pointAtoBVector3,this._pointAtoBVector3),Vector3.scale(this._pointAtoBVector3,this._owner.widthMultiplier/2,this._pointAtoBVector3),this._updateVerticesByPosition(e),e.cloneTo(this._lastFixedVertexPosition),this._verticesCount+=2,this._curtime=this._owner._hasLifeSubTrail?this._owner._curSubTrailFinishCurTime:this._owner._curtime,this._everyGroupVertexBirthTime.push(this._curtime),this._isStart=!0,this._owner._hasLifeSubTrail=!0},e._addTrailByNextPosition=function(e){Vector3.subtract(e,this._lastFixedVertexPosition,this._delVector3),Vector3.cross(this._delVector3,this._camera.forward,this._pointAtoBVector3),Vector3.normalize(this._pointAtoBVector3,this._pointAtoBVector3),Vector3.scale(this._pointAtoBVector3,this._owner.widthMultiplier/2,this._pointAtoBVector3),this._delLength=Vector3.scalarLength(this._delVector3),this._delLength-this._owner.minVertexDistance>=MathUtils3D.zeroTolerance?(this._owner._trailTotalLength+=this._delLength,this._owner._trailSupplementLength=0,this._updateVerticesByPosition(e),e.cloneTo(this._lastFixedVertexPosition),this._verticesCount+=2,this._virtualVerticesCount=0,this._everyGroupVertexBirthTime.push(this._owner._curtime),this._verticesCount==this._maxVerticesCount&&this._onTrailRenderElementFinish()):(this._owner._trailSupplementLength=this._delLength,this._updateVerticesByPosition(e),this._virtualVerticesCount=2)},e._updateVerticesByPosition=function(e){this._pointe=e.elements,this._pointAtoBVector3e=this._pointAtoBVector3.elements,this._curtime=this._owner._curtime,this._owner._hasLifeSubTrail&&0==this._isStart&&(this._pointe=this._owner._curSubTrailFinishPosition.elements,this._pointAtoBVector3e=this._owner._curSubTrailFinishDirection.elements,this._curtime=this._owner._curSubTrailFinishCurTime),this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._curtime,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=1,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._curtime,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=0,this._VerticesToTailLength[this._verticesCount/2]=this._owner._trailTotalLength+this._owner._trailSupplementLength,0==this._owner._trailSupplementLength?this._everyVertexToPreVertexDistance[this._verticesCount/2]=this._delLength:this._everyVertexToPreVertexDistance[this._verticesCount/2]=this._isStart?this._owner._trailSupplementLength:0},e._updateVertexBuffer2=function(){var e,t=0,n=0,i=0;for(i=0,e=(this._verticesCount+this._virtualVerticesCount)/2;i<e;i++)n=0==this._owner.textureMode?(this._VerticesToTailLength[i]-this._owner._trailDeadLength)/(this._owner._trailTotalLength+this._owner._trailSupplementLength-this._owner._trailDeadLength):this._owner._trailTotalLength+this._owner._trailSupplementLength-this._VerticesToTailLength[i],this._vertices2[t++]=1-n,this._vertices2[t++]=1-n;this._vertexBuffer2.setData(this._vertices2,0,0,this._verticesCount+this._virtualVerticesCount)},e._onTrailRenderElementFinish=function(){this._lastFixedVertexPosition.cloneTo(this._owner._curSubTrailFinishPosition),this._pointAtoBVector3.cloneTo(this._owner._curSubTrailFinishDirection),this._owner._curSubTrailFinishCurTime=this._owner._curtime,this._isFinish=!0},e._updateDisappear=function(){var e,t=0;for(t=this._curDisappearIndex,e=(this._verticesCount+this._virtualVerticesCount)/2;t<e;t++)this._owner._curtime-this._everyGroupVertexBirthTime[t]>=this._owner.time+MathUtils3D.zeroTolerance&&(this._curDisappearIndex++,this._owner._trailDeadLength+=this._everyVertexToPreVertexDistance[this._curDisappearIndex],this._curDisappearIndex>=(this._verticesCount+this._virtualVerticesCount)/2&&(this._isDead=!0))},e._beforeRender=function(e){return this._camera=e.camera,null!=this._camera&&(this._owner._owner.transform.position.cloneTo(this._curPosition),!this._isDead&&(this._verticesCount<this._maxVerticesCount?(this._owner._isStart||(this._owner._owner.transform.position.cloneTo(this._lastPosition),this._owner._isStart=!0),Vector3.equals(this._lastPosition,this._curPosition)||this._updateTrail()):this._isFinish&&(this._isFinish=!1,this._owner._curSubTrailFinished=!0),0<this._verticesCount)&&(this._updateVertexBuffer2(),this._updateDisappear(),!0))},e._render=function(e){this._isDead||(WebGL.mainContext.drawArrays(5,2*this._curDisappearIndex,this._verticesCount+this._virtualVerticesCount-2*this._curDisappearIndex),console.log(2*this._curDisappearIndex,this._verticesCount+this._virtualVerticesCount-2*this._curDisappearIndex),Stat.drawCall++,Stat.trianglesFaces+=this._verticesCount+this._virtualVerticesCount-2*this._curDisappearIndex-2)},e._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer1:1==e?this._vertexBuffer2:null},e._getVertexBuffers=function(){return this._vertexBuffers},e._getIndexBuffer=function(){return null},e.reActivate=function(){this._id=laya.d3.core.trail.TrailRenderElement.renderElementCount++,this._isStart=!1,this._isFinish=!1,this._isDead=!1,this._verticesCount=0,this._virtualVerticesCount=0,this._verticesIndex1=0,this._delLength=0,this._curDisappearIndex=0,this._everyGroupVertexBirthTime=[],this._owner._curSubTrailFinishPosition.cloneTo(this._lastPosition)},e._destroy=function(){this._vertexBuffer1.dispose(),this._vertexBuffer2.dispose(),this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._vertexBuffers=null,this._everyGroupVertexBirthTime=null,this._VerticesToTailLength=null,this._everyVertexToPreVertexDistance=null,this._lastPosition=null,this._curPosition=null,this._delVector3=null,this._lastFixedVertexPosition=null,this._pointAtoBVector3=null,this._pointe=null,this._pointAtoBVector3e=null,this._pointA=null,this._pointB=null},__getset(0,e,"triangleCount",function(){return 0}),__getset(0,e,"_vertexBufferCount",function(){return this._vertexBuffers.length}),t.renderElementCount=0,t}(),GradientMode=function(){function e(){}return __class(e,"laya.d3.core.trail.module.GradientMode",!0),e.Blend=0,e.Fixed=1,e}(),TrailKeyFrame=function(){function e(){this.time=NaN,this.inTangent=NaN,this.outTangent=NaN,this.value=NaN}return __class(e,"laya.d3.core.trail.module.TrailKeyFrame",!0),e.prototype.cloneTo=function(e){e.time=this.time,e.inTangent=this.inTangent,e.outTangent=this.outTangent,e.value=this.value},e}(),Color$1=function(){function e(e,t,n,i){this._r=NaN,this._g=NaN,this._b=NaN,this._a=NaN,void 0===e&&(e=1),void 0===t&&(t=1),void 0===n&&(n=1),void 0===i&&(i=1),this._r=e,this._g=t,this._b=n,this._a=i}return __class(e,"laya.d3.core.trail.module.Color",!0,null,"Color$1"),e.prototype.cloneTo=function(e){e._r=this._r,e._g=this._g,e._b=this._b,e._a=this._a},__static(e,["RED",function(){return this.RED=new e(1,0,0,1)},"GREEN",function(){return this.GREEN=new e(0,1,0,1)},"BLUE",function(){return this.BLUE=new e(0,0,1,1)},"CYAN",function(){return this.CYAN=new e(0,1,1,1)},"YELLOW",function(){return this.YELLOW=new e(1,.92,.016,1)},"MAGENTA",function(){return this.MAGENTA=new e(1,0,1,1)},"GRAY",function(){return this.GRAY=new e(.5,.5,.5,1)},"WHITE",function(){return this.WHITE=new e(1,1,1,1)},"BLACK",function(){return this.BLACK=new e(0,0,0,1)}]),e}(),GradientAlphaKey=function(){function e(e,t){this._alpha=NaN,this._time=NaN,void 0===e&&(e=0),void 0===t&&(t=0),this._alpha=e,this._time=t}__class(e,"laya.d3.core.trail.module.GradientAlphaKey",!0);var t=e.prototype;return t.cloneTo=function(e){e.alpha=this.alpha,e.time=this.time},__getset(0,t,"time",function(){return this._time},function(e){this._time=e}),__getset(0,t,"alpha",function(){return this._alpha},function(e){this._alpha=e}),e}(),TextureMode=function(){function e(){}return __class(e,"laya.d3.core.trail.module.TextureMode",!0),e.Stretch=0,e.Tile=1,e}(),Gradient=function(){function e(){this._mode=0,this._colorKeys=null,this._alphaKeys=null,this.index=0,this._colorKeyData=new Float32Array(40),this._alphaKeyData=new Float32Array(20),this._colorKeys=[],this._alphaKeys=[]}__class(e,"laya.d3.core.trail.module.Gradient",!0);var t=e.prototype;return t.setKeys=function(e,t){var n,i;this._colorKeys=e;for(var r=this.index=0;r<e.length;r++){var a=(n=e[r]).color;this._colorKeyData[this.index++]=a._r,this._colorKeyData[this.index++]=a._g,this._colorKeyData[this.index++]=a._b,this._colorKeyData[this.index++]=n.time}this._alphaKeys=t;for(var o=this.index=0;o<t.length;o++)i=t[o],this._alphaKeyData[this.index++]=i.alpha,this._alphaKeyData[this.index++]=i.time},t.cloneTo=function(e){var t=0,n=0,i=this.colorKeys,r=[];for(t=0,n=i.length;t<n;t++){var a=new GradientColorKey;i[t].cloneTo(a),r.push(a)}var o=this.alphaKeys,s=[];for(t=0,n=o.length;t<n;t++){var l=new GradientAlphaKey;o[t].cloneTo(l),s.push(l)}e.setKeys(r,s)},__getset(0,t,"alphaKeys",function(){return this._alphaKeys},function(e){this._alphaKeys=e;for(var t=this.index=0;t<e.length;t++){var n=e[t];this._alphaKeyData[this.index++]=n.alpha,this._alphaKeyData[this.index++]=n.time}}),__getset(0,t,"colorKeys",function(){return this._colorKeys},function(e){this._colorKeys=e;for(var t=this.index=0;t<e.length;t++){var n=e[t],i=n.color;this._colorKeyData[this.index++]=i._r,this._colorKeyData[this.index++]=i._g,this._colorKeyData[this.index++]=i._b,this._colorKeyData[this.index++]=n.time}}),__getset(0,t,"mode",function(){return this._mode},function(e){this._mode=e}),e}(),GradientColorKey=function(){function e(e,t){this._color=null,this._time=NaN,void 0===t&&(t=0),this._color=e||new Color$1,this._time=t}__class(e,"laya.d3.core.trail.module.GradientColorKey",!0);var t=e.prototype;return t.cloneTo=function(e){this.color.cloneTo(e.color),e.time=this.time},__getset(0,t,"time",function(){return this._time},function(e){this._time=e}),__getset(0,t,"color",function(){return this._color},function(e){this._color=e}),e}(),VertexTrail=function(){function e(){}__class(e,"laya.d3.core.trail.VertexTrail",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration1}),__getset(1,e,"vertexDeclaration2",function(){return e._vertexDeclaration2}),__getset(1,e,"vertexDeclaration1",function(){return e._vertexDeclaration1}),__static(e,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new VertexDeclaration(32,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",41),new VertexElement(24,"single",33),new VertexElement(28,"single",40)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new VertexDeclaration(4,[new VertexElement(0,"single",38)])}]),e}(),RenderElement=function(){function e(){this._id=0,this._type=0,this._mainSortID=0,this._render=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._tempBatchIndexStart=0,this._tempBatchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._onPreRenderFunction=null,this._id=++e._uniqueIDCounter,this._canDynamicBatch=!0,this._shaderValue=new ValusArray}__class(e,"laya.d3.core.render.RenderElement",!0);var t=e.prototype;return t.getDynamicBatchBakedVertexs=function(e){for(var t=this._renderObj._getVertexBuffer(e),n=t.getData().slice(),i=t.vertexDeclaration,r=i.getVertexElementByUsage(0).offset/4,a=i.getVertexElementByUsage(3).offset/4,o=this._sprite3D.transform,s=o.worldMatrix,l=o.rotation,_=i.vertexStride/4,h=0,c=n.length;h<c;h+=_){var u=h+r,d=h+a;Utils3D.transformVector3ArrayToVector3ArrayCoordinate(n,u,s,n,u),Utils3D.transformVector3ArrayByQuat(n,d,l,n,d)}return n},t.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},t._destroy=function(){this._staticBatch&&this._staticBatch._manager._garbageCollection(this)},__getset(0,t,"renderObj",function(){return this._renderObj},function(e){this._renderObj!=e&&(this._renderObj=e)}),__getset(0,t,"id",function(){return this._id}),e._uniqueIDCounter=0,e}(),RenderState=function(){function e(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._viewMatrix=null,this._projectionMatrix=null,this._projectionViewMatrix=null,this._viewport=null,this._shader=null,this.elapsedTime=NaN,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null}return __class(e,"laya.d3.core.render.RenderState",!0),e.clientWidth=0,e.clientHeight=0,e}(),RenderQueue=function(){function t(e){this._id=0,this._needSort=!1,this._renderElements=null,this._renderableRenderObjects=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++t._uniqueIDCounter,this._needSort=!1,this._scene=e,this._renderElements=[],this._renderableRenderObjects=[],this._dynamicBatchCombineRenderElements=[]}__class(t,"laya.d3.core.render.RenderQueue",!0);var e=t.prototype;return e._sortOpaqueFunc=function(e,t){return e._render&&t._render?e._render._distanceForSort-t._render._distanceForSort:0},e._sortAlphaFunc=function(e,t){return e._render&&t._render?t._render._distanceForSort-e._render._distanceForSort:0},e._begainRenderElement=function(e,t,n){return!!t._beforeRender(e)},e._sortAlpha=function(e){t._cameraPosition=e,this._finalElements.sort(__bind(this,this._sortAlphaFunc))},e._sortOpaque=function(e){t._cameraPosition=e,this._finalElements.sort(__bind(this,this._sortOpaqueFunc))},e._preRender=function(e){this._finalElements=this._renderElements.concat(this._dynamicBatchCombineRenderElements)},e._render=function(e,t){for(var n,i,r,a,o,s,l=Stat.loopCount,_=this._scene,h=e.camera,c=(h.id,!1),u=0,d=this._finalElements.length;u<d;u++){var f,m,p,g=this._finalElements[u];if(null!=g._onPreRenderFunction&&g._onPreRenderFunction.call(g._sprite3D,e),0==g._type){if(e.owner=p=g._sprite3D,e.renderElement=g,p._preRenderUpdateComponents(e),f=g.renderObj,m=g._material,this._begainRenderElement(e,f,m)){if(n=f._getVertexBuffers(),r=(i=f._getVertexBuffer(0)).vertexDeclaration,c=(a=e._shader=m._getShader(_._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue)).bind()||l!=a._uploadLoopCount,n){if(a._uploadVertexBuffer!=n||c){for(var E=0;E<n.length;E++){var v=n[E];a.uploadAttributesX(v.vertexDeclaration.shaderValues.data,v)}a._uploadVertexBuffer=n}}else(a._uploadVertexBuffer!=i||c)&&(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=i);(a._uploadScene!=_||c)&&(a.uploadSceneUniforms(_._shaderValues.data),a._uploadScene=_),(h!=a._uploadCamera||a._uploadSprite3D!=p||c)&&(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),(h!=a._uploadCamera||c)&&(a.uploadCameraUniforms(h._shaderValues.data),a._uploadCamera=h),(a._uploadMaterial!=m||c)&&(m._upload(),a._uploadMaterial=m),o!=m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,p.transform),o=m,s=p):s!=p&&(m._setRenderStateFrontFace(t,p.transform),s=p),f._render(e),a._uploadLoopCount=l}p._postRenderUpdateComponents(e)}else if(2==g._type){g.renderObj;e.owner=p=g._sprite3D,e.renderElement=g,e._batchIndexStart=g._tempBatchIndexStart,e._batchIndexEnd=g._tempBatchIndexEnd,f=g.renderObj,m=g._material,this._begainRenderElement(e,f,m)&&(r=(i=f._getVertexBuffer(0)).vertexDeclaration,c=(a=e._shader=m._getShader(_._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue)).bind()||l!=a._uploadLoopCount,(a._uploadVertexBuffer!=i||c)&&(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=i),(a._uploadScene!=_||c)&&(a.uploadSceneUniforms(_._shaderValues.data),a._uploadScene=_),(h!=a._uploadCamera||a._uploadSprite3D!=p||c)&&(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),(h!=a._uploadCamera||c)&&(a.uploadCameraUniforms(h._shaderValues.data),a._uploadCamera=h),(a._uploadMaterial!=m||c)&&(m._upload(),a._uploadMaterial=m),o!=m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,p.transform),o=m,s=p):s!=p&&(m._setRenderStateFrontFace(t,p.transform),s=p),f._render(e),a._uploadLoopCount=l)}}},e._renderShadow=function(e,t){for(var n,i,r,a,o,s=Stat.loopCount,l=this._scene,_=e.camera,h=!1,c=0,u=this._finalElements.length;c<u;c++){var d,f,m,p=this._finalElements[c];0==p._type&&(e.owner=m=p._sprite3D,t||m._projectionViewWorldUpdateCamera==_&&m._projectionViewWorldUpdateLoopCount==Stat.loopCount||(m._render._renderUpdate(e._projectionViewMatrix),m._projectionViewWorldUpdateLoopCount=Stat.loopCount,m._projectionViewWorldUpdateCamera=_),e.renderElement=p,m._preRenderUpdateComponents(e),d=p.renderObj,f=p._material,this._begainRenderElement(e,d,null)&&(i=(n=d._getVertexBuffer(0)).vertexDeclaration,h=(r=e._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue)).bind()||s!=r._uploadLoopCount,(r._uploadVertexBuffer!=n||h)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(_!=r._uploadCamera||r._uploadSprite3D!=m||h)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(_!=r._uploadCamera||h)&&(r.uploadCameraUniforms(_._shaderValues.data),r._uploadCamera=_),(r._uploadMaterial!=f||h)&&(f._upload(),r._uploadMaterial=f),r._uploadRenderElement,a!=f?(f._setRenderStateFrontFace(!1,m.transform),a=f,o=m):o!=m&&(f._setRenderStateFrontFace(!1,m.transform),o=m),d._render(e),r._uploadLoopCount=s),m._postRenderUpdateComponents(e))}},e._clearRenderElements=function(){this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},e._addRenderElement=function(e){this._renderElements.push(e),this._needSort=!0},e._addDynamicBatchElement=function(e){this._dynamicBatchCombineRenderElements.push(e)},__getset(0,e,"id",function(){return this._id}),t._uniqueIDCounter=0,t.OPAQUE=1,t.TRANSPARENT=2,t._cameraPosition=null,t}(),ShurikenParticleData=function(){function U(){}return __class(U,"laya.d3.core.particleShuriKen.ShurikenParticleData",!0),U._getStartLifetimeFromGradient=function(e,t){for(var n=1,i=e.gradientCount;n<i;n++){var r=e.getKeyByIndex(n);if(t<=r){var a=e.getKeyByIndex(n-1),o=(t-a)/(r-a);return MathUtil.lerp(e.getValueByIndex(n-1),e.getValueByIndex(n),o)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},U._randomInvertRoationArray=function(e,t,n,i,r){var a=NaN;i?(i.seed=r[6],a=i.getFloat(),r[6]=i.seed):a=Math.random(),t[2]=a<n?(t[0]=-e[0],t[1]=-e[1],-e[2]):(t[0]=e[0],t[1]=e[1],e[2])},U._randomInvertRoation=function(e,t,n,i){var r=NaN;return n?(n.seed=i[6],r=n.getFloat(),i[6]=n.seed):r=Math.random(),r<t&&(e=-e),e},U.create=function(e,t,n){var i=e.autoRandomSeed,r=e._rand,a=e._randomSeeds;switch(e.startColorType){case 0:var o=e.startColorConstant.elements;U.startColor[0]=o[0],U.startColor[1]=o[1],U.startColor[2]=o[2],U.startColor[3]=o[3];break;case 2:i?MathUtil.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,Math.random(),U.startColor):(r.seed=a[3],MathUtil.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,r.getFloat(),U.startColor),a[3]=r.seed)}var s=e.colorOverLifetime;if(s&&s.enbale){var l=s.color;switch(l.type){case 0:U.startColor[0]=U.startColor[0]*l.constant.x,U.startColor[1]=U.startColor[1]*l.constant.y,U.startColor[2]=U.startColor[2]*l.constant.z,U.startColor[3]=U.startColor[3]*l.constant.w;break;case 2:var _=NaN;i?_=Math.random():(r.seed=a[10],_=r.getFloat(),a[10]=r.seed);var h=l.constantMin,c=l.constantMax;U.startColor[0]=U.startColor[0]*MathUtil.lerp(h.x,c.x,_),U.startColor[1]=U.startColor[1]*MathUtil.lerp(h.y,c.y,_),U.startColor[2]=U.startColor[2]*MathUtil.lerp(h.z,c.z,_),U.startColor[3]=U.startColor[3]*MathUtil.lerp(h.w,c.w,_)}}var u=U.startSize;switch(e.startSizeType){case 0:if(e.threeDStartSize){var d=e.startSizeConstantSeparate;u[0]=d.x,u[1]=d.y,u[2]=d.z}else u[0]=u[1]=u[2]=e.startSizeConstant;break;case 2:if(e.threeDStartSize){var f=e.startSizeConstantMinSeparate,m=e.startSizeConstantMaxSeparate;i?(u[0]=MathUtil.lerp(f.x,m.x,Math.random()),u[1]=MathUtil.lerp(f.y,m.y,Math.random()),u[2]=MathUtil.lerp(f.z,m.z,Math.random())):(r.seed=a[4],u[0]=MathUtil.lerp(f.x,m.x,r.getFloat()),u[1]=MathUtil.lerp(f.y,m.y,r.getFloat()),u[2]=MathUtil.lerp(f.z,m.z,r.getFloat()),a[4]=r.seed)}else i?u[0]=u[1]=u[2]=MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(r.seed=a[4],u[0]=u[1]=u[2]=MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,r.getFloat()),a[4]=r.seed)}var p=e.sizeOverLifetime;if(p&&p.enbale&&1==p.size.type){var g=p.size;if(g.separateAxes)i?(u[0]=u[0]*MathUtil.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,Math.random()),u[1]=u[1]*MathUtil.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,Math.random()),u[2]=u[2]*MathUtil.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,Math.random())):(r.seed=a[11],u[0]=u[0]*MathUtil.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,r.getFloat()),u[1]=u[1]*MathUtil.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,r.getFloat()),u[2]=u[2]*MathUtil.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,r.getFloat()),a[11]=r.seed);else{var E=NaN;i?E=MathUtil.lerp(g.constantMin,g.constantMax,Math.random()):(r.seed=a[11],E=MathUtil.lerp(g.constantMin,g.constantMax,r.getFloat()),a[11]=r.seed),u[0]=u[0]*E,u[1]=u[1]*E,u[2]=u[2]*E}}var v=t.renderMode;if(1!=v)switch(e.startRotationType){case 0:if(e.threeDStartRotation){var x=e.startRotationConstantSeparate,S=U._tempVector30.elements;U._randomInvertRoationArray(x.elements,S,e.randomizeRotationDirection,i?null:r,a),U.startRotation[0]=S[0],U.startRotation[1]=S[1],U.startRotation[2]=4!=v?-S[2]:S[2]}else U.startRotation[0]=U._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,i?null:r,a);break;case 2:if(e.threeDStartRotation){var D=e.startRotationConstantMinSeparate,T=e.startRotationConstantMaxSeparate,M=U._tempVector30.elements;i?(M[0]=MathUtil.lerp(D.x,T.x,Math.random()),M[1]=MathUtil.lerp(D.y,T.y,Math.random()),M[2]=MathUtil.lerp(D.z,T.z,Math.random())):(r.seed=a[5],M[0]=MathUtil.lerp(D.x,T.x,r.getFloat()),M[1]=MathUtil.lerp(D.y,T.y,r.getFloat()),M[2]=MathUtil.lerp(D.z,T.z,r.getFloat()),a[5]=r.seed),U._randomInvertRoationArray(M,M,e.randomizeRotationDirection,i?null:r,a),U.startRotation[0]=M[0],U.startRotation[1]=M[1],U.startRotation[2]=4!=v?-M[2]:M[2]}else i?U.startRotation[0]=U._randomInvertRoation(MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,i?null:r,a):(r.seed=a[5],U.startRotation[0]=U._randomInvertRoation(MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,r.getFloat()),e.randomizeRotationDirection,i?null:r,a),a[5]=r.seed)}switch(e.startLifetimeType){case 0:U.startLifeTime=e.startLifetimeConstant;break;case 1:U.startLifeTime=U._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:i?U.startLifeTime=MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(r.seed=a[7],U.startLifeTime=MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,r.getFloat()),a[7]=r.seed);break;case 3:var V=e.emissionTime;i?U.startLifeTime=MathUtil.lerp(U._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,V),U._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,V),Math.random()):(r.seed=a[7],U.startLifeTime=MathUtil.lerp(U._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,V),U._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,V),r.getFloat()),a[7]=r.seed)}switch(e.startSpeedType){case 0:U.startSpeed=e.startSpeedConstant;break;case 2:i?U.startSpeed=MathUtil.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,Math.random()):(r.seed=a[8],U.startSpeed=MathUtil.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,r.getFloat()),a[8]=r.seed)}var R=e.textureSheetAnimation;if(R&&R.enable){var A=R.tiles,C=A.x,I=A.y,y=1/C,N=1/I,P=0,L=R.startFrame;switch(L.type){case 0:P=L.constant;break;case 1:i?P=MathUtil.lerp(L.constantMin,L.constantMax,Math.random()):(r.seed=a[14],P=MathUtil.lerp(L.constantMin,L.constantMax,r.getFloat()),a[14]=r.seed)}var w=R.frame;switch(w.type){case 0:P+=w.constant;break;case 2:i?P+=MathUtil.lerp(w.constantMin,w.constantMax,Math.random()):(r.seed=a[15],P+=MathUtil.lerp(w.constantMin,w.constantMax,r.getFloat()),a[15]=r.seed)}var O=0;switch(R.type){case 0:O=Math.floor(P/C);break;case 1:R.randomRow?i?O=Math.floor(Math.random()*I):(r.seed=a[13],O=Math.floor(r.getFloat()*I),a[13]=r.seed):O=R.rowIndex}var b=Math.floor(P%C);(U.startUVInfo=U.startUVInfo)[0]=y,U.startUVInfo[1]=N,U.startUVInfo[2]=b*y,U.startUVInfo[3]=O*N}else(U.startUVInfo=U.startUVInfo)[0]=1,U.startUVInfo[1]=1,U.startUVInfo[2]=0,U.startUVInfo[3]=0;switch(e.simulationSpace){case 0:var F=n.position.elements;U.simulationWorldPostion[0]=F[0],U.simulationWorldPostion[1]=F[1],U.simulationWorldPostion[2]=F[2];var B=n.rotation.elements;U.simulationWorldRotation[0]=B[0],U.simulationWorldRotation[1]=B[1],U.simulationWorldRotation[2]=B[2],U.simulationWorldRotation[3]=B[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},U.startLifeTime=NaN,U.startSpeed=NaN,__static(U,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempQuaternion",function(){return this._tempQuaternion=new Quaternion},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]),U}(),FrameOverTime=function(){function i(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}__class(i,"laya.d3.core.particleShuriKen.module.FrameOverTime",!0);var e=i.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax.cloneTo(t._overTimeMax)},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,e,"frameOverTimeDataMax",function(){return this._overTimeMax}),__getset(0,e,"frameOverTimeDataMin",function(){return this._overTimeMin}),__getset(0,e,"type",function(){return this._type}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"frameOverTimeData",function(){return this._overTime}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"constantMax",function(){return this._constantMax}),i.createByConstant=function(e){var t=new i;return t._type=0,t._constant=e,t},i.createByOverTime=function(e){var t=new i;return t._type=1,t._overTime=e,t},i.createByRandomTwoConstant=function(e,t){var n=new i;return n._type=2,n._constantMin=e,n._constantMax=t,n},i.createByRandomTwoOverTime=function(e,t){var n=new i;return n._type=3,n._overTimeMin=e,n._overTimeMax=t,n},i}(),TextureSheetAnimation=function(){function e(e,t){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new Vector2(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}__class(e,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame),t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable},t.clone=function(){var e,t;switch(this._frame.type){case 0:e=FrameOverTime.createByConstant(this._frame.constant);break;case 1:e=FrameOverTime.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=FrameOverTime.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=FrameOverTime.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:t=StartFrame.createByConstant(this._startFrame.constant);break;case 1:t=StartFrame.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new this.constructor(e,t);return this.tiles.cloneTo(n.tiles),n.type=this.type,n.randomRow=this.randomRow,n.cycles=this.cycles,n.enableUVChannels=this.enableUVChannels,n.enable=this.enable,n},__getset(0,t,"startFrame",function(){return this._startFrame}),__getset(0,t,"frame",function(){return this._frame}),e}(),BaseShape=function(){function e(){this.enable=!1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.BaseShape",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t._getShapeBoundBox=function(e){throw new Error("BaseShape: must override it.")},t._getSpeedBoundBox=function(e){throw new Error("BaseShape: must override it.")},t.generatePositionAndDirection=function(e,t,n,i){throw new Error("BaseShape: must override it.")},t._calculateProceduralBounds=function(e,t,n){this._getShapeBoundBox(e);var i=e.min,r=e.max;Vector3.multiply(i,t,i),Vector3.multiply(r,t,r);var a=new BoundBox(new Vector3,new Vector3);this.randomDirection?(a.min=new Vector3(-1,-1,-1),a.max=new Vector3(1,1,1)):this._getSpeedBoundBox(a);var o=new BoundBox(new Vector3,new Vector3),s=o.min,l=o.max;Vector3.scale(a.min,n.y,s),Vector3.scale(a.max,n.y,l),Vector3.add(e.min,s,s),Vector3.add(e.max,l,l),Vector3.min(e.min,s,e.min),Vector3.max(e.max,s,e.max);var _=new BoundBox(new Vector3,new Vector3),h=_.min,c=_.max;Vector3.scale(a.min,n.x,h),Vector3.scale(a.max,n.x,c),Vector3.min(_.min,c,s),Vector3.max(_.min,c,l),Vector3.min(e.min,s,e.min),Vector3.max(e.max,s,e.max)},t.cloneTo=function(e){e.enable=this.enable},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e}(),ShapeUtils=function(){function a(){}return __class(a,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils",!0),a._randomPointUnitArcCircle=function(e,t,n){var i=t.elements,r=NaN;r=n?n.getFloat()*e:Math.random()*e,i[0]=Math.cos(r),i[1]=Math.sin(r)},a._randomPointInsideUnitArcCircle=function(e,t,n){var i=t.elements;a._randomPointUnitArcCircle(e,t,n);var r=NaN;r=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),i[0]=i[0]*r,i[1]=i[1]*r},a._randomPointUnitCircle=function(e,t){var n=e.elements,i=NaN;i=t?t.getFloat()*Math.PI*2:Math.random()*Math.PI*2,n[0]=Math.cos(i),n[1]=Math.sin(i)},a._randomPointInsideUnitCircle=function(e,t){var n=e.elements;a._randomPointUnitCircle(e);var i=NaN;i=t?Math.pow(t.getFloat(),.5):Math.pow(Math.random(),.5),n[0]=n[0]*i,n[1]=n[1]*i},a._randomPointUnitSphere=function(e,t){var n=e.elements,i=NaN,r=NaN;r=t?(i=n[2]=2*t.getFloat()-1,t.getFloat()*Math.PI*2):(i=n[2]=2*Math.random()-1,Math.random()*Math.PI*2);var a=Math.sqrt(1-i*i);n[0]=a*Math.cos(r),n[1]=a*Math.sin(r)},a._randomPointInsideUnitSphere=function(e,t){var n=e.elements;a._randomPointUnitSphere(e);var i=NaN;i=t?Math.pow(t.getFloat(),1/3):Math.pow(Math.random(),1/3),n[0]=n[0]*i,n[1]=n[1]*i,n[2]=n[2]*i},a._randomPointInsideHalfUnitBox=function(e,t){var n=e.elements;n[2]=t?(n[0]=t.getFloat()-.5,n[1]=t.getFloat()-.5,t.getFloat()-.5):(n[0]=Math.random()-.5,n[1]=Math.random()-.5,Math.random()-.5)},a}(),Burst=function(){function e(e,t,n){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=e,this._minCount=t,this._maxCount=n}__class(e,"laya.d3.core.particleShuriKen.module.Burst",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"maxCount",function(){return this._maxCount}),__getset(0,t,"minCount",function(){return this._minCount}),__getset(0,t,"time",function(){return this._time}),e}(),GradientAngularVelocity=function(){function _(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}__class(_,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity",!0);var e=_.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,e,"gradientWMin",function(){return this._gradientWMin}),__getset(0,e,"gradientZMax",function(){return this._gradientZMax}),__getset(0,e,"gradientZMin",function(){return this._gradientZMin}),__getset(0,e,"gradientYMax",function(){return this._gradientYMax}),__getset(0,e,"gradientYMin",function(){return this._gradientYMin}),__getset(0,e,"gradientMax",function(){return this._gradientMax}),__getset(0,e,"gradientMin",function(){return this._gradientMin}),__getset(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"gradientW",function(){return this._gradientW}),__getset(0,e,"gradientXMax",function(){return this._gradientXMax}),__getset(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),__getset(0,e,"gradientY",function(){return this._gradientY}),__getset(0,e,"gradientZ",function(){return this._gradientZ}),__getset(0,e,"gradientX",function(){return this._gradientX}),__getset(0,e,"constantSeparate",function(){return this._constantSeparate}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"gradientWMax",function(){return this._gradientWMax}),__getset(0,e,"gradient",function(){return this._gradient}),__getset(0,e,"separateAxes",function(){return this._separateAxes}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"gradientXMin",function(){return this._gradientXMin}),__getset(0,e,"type",function(){return this._type}),_.createByConstant=function(e){var t=new _;return t._type=0,t._separateAxes=!1,t._constant=e,t},_.createByConstantSeparate=function(e){var t=new _;return t._type=0,t._separateAxes=!0,t._constantSeparate=e,t},_.createByGradient=function(e){var t=new _;return t._type=1,t._separateAxes=!1,t._gradient=e,t},_.createByGradientSeparate=function(e,t,n,i){var r=new _;return r._type=1,r._separateAxes=!0,r._gradientX=e,r._gradientY=t,r._gradientZ=n,r._gradientW=i,r},_.createByRandomTwoConstant=function(e,t){var n=new _;return n._type=2,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n},_.createByRandomTwoConstantSeparate=function(e,t){var n=new _;return n._type=2,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n},_.createByRandomTwoGradient=function(e,t){var n=new _;return n._type=3,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n},_.createByRandomTwoGradientSeparate=function(e,t,n,i,r,a,o,s){var l=new _;return l._type=3,l._separateAxes=!0,l._gradientXMin=e,l._gradientXMax=t,l._gradientYMin=n,l._gradientYMax=i,l._gradientZMin=r,l._gradientZMax=a,l._gradientWMin=o,l._gradientWMax=s,l},_}(),SizeOverLifetime=function(){function e(e){this._size=null,this.enbale=!1,this._size=e}__class(e,"laya.d3.core.particleShuriKen.module.SizeOverLifetime",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._size.cloneTo(t._size),t.enbale=this.enbale},t.clone=function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?GradientSize.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):GradientSize.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?GradientSize.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):GradientSize.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?GradientSize.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):GradientSize.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},__getset(0,t,"size",function(){return this._size}),e}(),Emission=function(){function e(){this._destroyed=!1,this._emissionRate=0,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}__class(e,"laya.d3.core.particleShuriKen.module.Emission",!0);var t=e.prototype;return Laya.imps(t,{"laya.resource.IDestroy":!0,"laya.d3.core.IClone":!0}),t._destroy=function(){this._bursts=null,this._destroyed=!0},t.getBurstsCount=function(){return this._bursts.length},t.getBurstByIndex=function(e){return this._bursts[e]},t.addBurst=function(e){var t=this._bursts.length;if(0<t)for(var n=0;n<t;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);this._bursts.push(e)},t.removeBurst=function(e){var t=this._bursts.indexOf(e);-1!=t&&this._bursts.splice(t,1)},t.removeBurstByIndex=function(e){this._bursts.splice(e,1)},t.clearBurst=function(){this._bursts.length=0},t.cloneTo=function(e){var t=e,n=t._bursts;n.length=this._bursts.length;for(var i=0,r=this._bursts.length;i<r;i++){var a=n[i];a?this._bursts[i].cloneTo(a):n[i]=this._bursts[i].clone()}t._emissionRate=this._emissionRate,t.enbale=this.enbale},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"destroyed",function(){return this._destroyed}),__getset(0,t,"emissionRate",function(){return this._emissionRate},function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e}),e}(),GradientDataColor=function(){function e(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}__class(e,"laya.d3.core.particleShuriKen.module.GradientDataColor",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.addAlpha=function(e,t){this._alphaCurrentLength<8?(6==this._alphaCurrentLength&&1!=e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._alphaElements[this._alphaCurrentLength++]=e,this._alphaElements[this._alphaCurrentLength++]=t):console.log("GradientDataColor warning:data count must lessEqual than 4")},t.addRGB=function(e,t){this._rgbCurrentLength<16?(12==this._rgbCurrentLength&&1!=e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._rgbElements[this._rgbCurrentLength++]=e,this._rgbElements[this._rgbCurrentLength++]=t.x,this._rgbElements[this._rgbCurrentLength++]=t.y,this._rgbElements[this._rgbCurrentLength++]=t.z):console.log("GradientDataColor warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e,n=0,i=0;t._alphaCurrentLength=this._alphaCurrentLength;var r=t._alphaElements;for(r.length=this._alphaElements.length,n=0,i=this._alphaElements.length;n<i;n++)r[n]=this._alphaElements[n];t._rgbCurrentLength=this._rgbCurrentLength;var a=t._rgbElements;for(a.length=this._rgbElements.length,n=0,i=this._rgbElements.length;n<i;n++)a[n]=this._rgbElements[n]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"rgbGradientCount",function(){return this._rgbCurrentLength/4}),__getset(0,t,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),e}(),GradientColor=function(){function i(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}__class(i,"laya.d3.core.particleShuriKen.module.GradientColor",!0);var e=i.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,e,"gradientMax",function(){return this._gradientMax}),__getset(0,e,"gradientMin",function(){return this._gradientMin}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"gradient",function(){return this._gradient}),__getset(0,e,"type",function(){return this._type}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"constantMax",function(){return this._constantMax}),i.createByConstant=function(e){var t=new i;return t._type=0,t._constant=e,t},i.createByGradient=function(e){var t=new i;return t._type=1,t._gradient=e,t},i.createByRandomTwoConstant=function(e,t){var n=new i;return n._type=2,n._constantMin=e,n._constantMax=t,n},i.createByRandomTwoGradient=function(e,t){var n=new i;return n._type=3,n._gradientMin=e,n._gradientMax=t,n},i}(),VelocityOverLifetime=function(){function e(e){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=e}__class(e,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enbale=this.enbale,t.space=this.space},t.clone=function(){var e;switch(this._velocity.type){case 0:e=GradientVelocity.createByConstant(this._velocity.constant.clone());break;case 1:e=GradientVelocity.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=GradientVelocity.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=GradientVelocity.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t.space=this.space,t},__getset(0,t,"velocity",function(){return this._velocity}),e}(),RotationOverLifetime=function(){function e(e){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=e}__class(e,"laya.d3.core.particleShuriKen.module.RotationOverLifetime",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enbale=this.enbale},t.clone=function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?GradientAngularVelocity.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):GradientAngularVelocity.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?GradientAngularVelocity.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone(),this._angularVelocity.gradientW.clone()):GradientAngularVelocity.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?GradientAngularVelocity.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):GradientAngularVelocity.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?GradientAngularVelocity.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):GradientAngularVelocity.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},__getset(0,t,"angularVelocity",function(){return this._angularVelocity}),e}(),ColorOverLifetime=function(){function e(e){this._color=null,this.enbale=!1,this._color=e}__class(e,"laya.d3.core.particleShuriKen.module.ColorOverLifetime",!0);var t=e.prototype;return t.cloneTo=function(e){var t=e;this._color.cloneTo(t._color),t.enbale=this.enbale},t.clone=function(){var e;switch(this._color.type){case 0:e=GradientColor.createByConstant(this._color.constant.clone());break;case 1:e=GradientColor.createByGradient(this._color.gradient.clone());break;case 2:e=GradientColor.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=GradientColor.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},__getset(0,t,"color",function(){return this._color}),e}(),GradientSize=function(){function s(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}__class(s,"laya.d3.core.particleShuriKen.module.GradientSize",!0);var e=s.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.getMaxSizeInGradient=function(){var e=0,t=0,n=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)n=Math.max(n,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)n=Math.max(n,this._gradientY.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)n=Math.max(n,this._gradient.getValueByIndex(e));break;case 1:n=this._separateAxes?(n=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),n=Math.max(n,this._constantMinSeparate.y),Math.max(n,this._constantMaxSeparate.y)):Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientZMax.getValueByIndex(e))}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientMax.getValueByIndex(e))}}return n},e.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,e,"gradientZMax",function(){return this._gradientZMax}),__getset(0,e,"gradientZMin",function(){return this._gradientZMin}),__getset(0,e,"gradientYMax",function(){return this._gradientYMax}),__getset(0,e,"gradientYMin",function(){return this._gradientYMin}),__getset(0,e,"gradientMax",function(){return this._gradientMax}),__getset(0,e,"gradientXMax",function(){return this._gradientXMax}),__getset(0,e,"gradientY",function(){return this._gradientY}),__getset(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),__getset(0,e,"gradientZ",function(){return this._gradientZ}),__getset(0,e,"gradientX",function(){return this._gradientX}),__getset(0,e,"gradientMin",function(){return this._gradientMin}),__getset(0,e,"gradient",function(){return this._gradient}),__getset(0,e,"separateAxes",function(){return this._separateAxes}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"gradientXMin",function(){return this._gradientXMin}),__getset(0,e,"type",function(){return this._type}),s.createByGradient=function(e){var t=new s;return t._type=0,t._separateAxes=!1,t._gradient=e,t},s.createByGradientSeparate=function(e,t,n){var i=new s;return i._type=0,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i},s.createByRandomTwoConstant=function(e,t){var n=new s;return n._type=1,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n},s.createByRandomTwoConstantSeparate=function(e,t){var n=new s;return n._type=1,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n},s.createByRandomTwoGradient=function(e,t){var n=new s;return n._type=2,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n},s.createByRandomTwoGradientSeparate=function(e,t,n,i,r,a){var o=new s;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=r,o._gradientZMax=a,o},s}(),StartFrame=function(){function i(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}__class(i,"laya.d3.core.particleShuriKen.module.StartFrame",!0);var e=i.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"type",function(){return this._type}),i.createByConstant=function(e){var t=new i;return t._type=0,t._constant=e,t},i.createByRandomTwoConstant=function(e,t){var n=new i;return n._type=1,n._constantMin=e,n._constantMax=t,n},i}(),GradientDataVector2=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}__class(e,"laya.d3.core.particleShuriKen.module.GradientDataVector2",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6==this._currentLength&&1!=e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"gradientCount",function(){return this._currentLength/3}),e}(),GradientDataInt=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}__class(e,"laya.d3.core.particleShuriKen.module.GradientDataInt",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6==this._currentLength&&1!=e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),GradientVelocity=function(){function s(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}__class(s,"laya.d3.core.particleShuriKen.module.GradientVelocity",!0);var e=s.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,e,"gradientZMax",function(){return this._gradientZMax}),__getset(0,e,"gradientZMin",function(){return this._gradientZMin}),__getset(0,e,"gradientYMin",function(){return this._gradientYMin}),__getset(0,e,"gradientY",function(){return this._gradientY}),__getset(0,e,"gradientXMax",function(){return this._gradientXMax}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"gradientX",function(){return this._gradientX}),__getset(0,e,"gradientZ",function(){return this._gradientZ}),__getset(0,e,"type",function(){return this._type}),__getset(0,e,"gradientXMin",function(){return this._gradientXMin}),__getset(0,e,"gradientYMax",function(){return this._gradientYMax}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"constantMin",function(){return this._constantMin}),s.createByConstant=function(e){var t=new s;return t._type=0,t._constant=e,t},s.createByGradient=function(e,t,n){var i=new s;return i._type=1,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i},s.createByRandomTwoConstant=function(e,t){var n=new s;return n._type=2,n._constantMin=e,n._constantMax=t,n},s.createByRandomTwoGradient=function(e,t,n,i,r,a){var o=new s;return o._type=3,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=r,o._gradientZMax=a,o},s}(),GradientDataNumber=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}__class(e,"laya.d3.core.particleShuriKen.module.GradientDataNumber",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6==this._currentLength&&1!=e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")},t.getKeyByIndex=function(e){return this._elements[2*e]},t.getValueByIndex=function(e){return this._elements[2*e+1]},t.getAverageValue=function(){for(var e=0,t=this._currentLength-2;e<t;e+=2){this._elements[e+1];this._elements[e+3],this._elements[e+2]-this._elements[e]}return 0},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),HeightMap=function(){function b(e,t,n,i){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=e,this._h=t,this._minHeight=n,this._maxHeight=i}__class(b,"laya.d3.core.HeightMap",!0);var e=b.prototype;return e._inBounds=function(e,t){return 0<=e&&e<this._h&&0<=t&&t<this._w},e.getHeight=function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN},__getset(0,e,"minHeight",function(){return this._minHeight}),__getset(0,e,"maxHeight",function(){return this._maxHeight}),__getset(0,e,"height",function(){return this._h}),__getset(0,e,"width",function(){return this._w}),b.creatFromMesh=function(e,t,n,i){for(var r=[],a=[],o=e.getSubMeshCount(),s=0;s<o;s++){for(var l=e.getSubMesh(s),_=l._getVertexBuffer(),h=_.getData(),c=[],u=0;u<h.length;u+=_.vertexDeclaration.vertexStride/4){var d=new Vector3(h[u+0],h[u+1],h[u+2]);c.push(d)}r.push(c);var f=l._getIndexBuffer();a.push(f.getData())}var m=e.boundingBox,p=m.min.x,g=m.min.z,E=m.max.x,v=m.max.z,x=m.min.y,S=m.max.y,D=E-p,T=v-g,M=i.elements[0]=D/(t-1),V=i.elements[1]=T/(n-1),R=new b(t,n,x,S),A=b._tempRay,C=A.direction.elements;C[0]=0,C[1]=-1,C[2]=0;var I=S+.1;A.origin.elements[1]=I;for(var y=0;y<n;y++){var N=g+y*V;R._datas[y]=[];for(var P=0;P<t;P++){var L=p+P*M,w=A.origin.elements;w[0]=L,w[2]=N;var O=b._getPosition(A,r,a);R._datas[y][P]=O==Number.MAX_VALUE?NaN:I-O}}return R},b.createFromImage=function(e,t,n){for(var i=e.width,r=e.height,a=new b(i,r,t,n),o=(n-t)/254,s=e.getPixels(),l=0,_=0;_<r;_++)for(var h=a._datas[_]=[],c=0;c<i;c++){var u=s[l++],d=s[l++],f=s[l++],m=s[l++];h[c]=255==u&&255==d&&255==f&&255==m?NaN:(u+d+f)/3*o+t}return a},b._getPosition=function(e,t,n){for(var i=Number.MAX_VALUE,r=0;r<t.length;r++)for(var a=t[r],o=n[r],s=0;s<o.length;s+=3){var l=a[o[s+0]],_=a[o[s+1]],h=a[o[s+2]],c=Picker.rayIntersectsTriangle(e,l,_,h);!isNaN(c)&&c<i&&(i=c)}return i},__static(b,["_tempRay",function(){return this._tempRay=new Ray(new Vector3,new Vector3)}]),b}(),OctreeNode=function(){function o(e,t){this._exactBox=null,this._relaxBox=null,this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new BoundSphere(new Vector3,0),this._corners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],this._boundingBoxCenter=new Vector3,this._children=__newvec(8),this._objects=[],this._tempBoundBoxCorners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],this._scene=e,this._currentDepth=t}__class(o,"laya.d3.core.scene.OctreeNode",!0);var e=o.prototype;return Laya.imps(e,{"laya.d3.core.scene.ITreeNode":!0}),e.init=function(e,t){var n=new Vector3,i=new Vector3;Vector3.scale(t,-.5,n),Vector3.scale(t,.5,i),Vector3.add(n,e,n),Vector3.add(i,e,i),this.exactBox=new BoundBox(n,i),this.relaxBox=new BoundBox(n,i)},e.addTreeNode=function(e){1==Collision.boxContainsBox(this._relaxBox,e.boundingBox)?this.addNodeDown(e,0):this.addObject(e)},e.addChild=function(e){var t=this._children[e];if(null==t){t=new o(this._scene,this._currentDepth+1),(this._children[e]=t)._parent=this,Vector3.subtract(this._exactBox.max,this._exactBox.min,o.tempSize),Vector3.multiply(o.tempSize,o._octreeSplit[e],o.tempCenter),Vector3.add(this._exactBox.min,o.tempCenter,o.tempCenter),Vector3.scale(o.tempSize,.25,o.tempSize);var n=new Vector3,i=new Vector3;Vector3.subtract(o.tempCenter,o.tempSize,n),Vector3.add(o.tempCenter,o.tempSize,i),t.exactBox=new BoundBox(n,i),Vector3.scale(o.tempSize,o.relax,o.tempSize);var r=new Vector3,a=new Vector3;Vector3.subtract(o.tempCenter,o.tempSize,r),Vector3.add(o.tempCenter,o.tempSize,a),t.relaxBox=new BoundBox(r,a)}return t},e.addObject=function(e){(e._treeNode=this)._objects.push(e)},e.removeObject=function(e){if(e._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var t=this._objects.indexOf(e);return-1!=t&&(this._objects.splice(t,1),!0)},e.clearObject=function(){this._objects.length=0},e.addNodeUp=function(e,t){this._parent&&1!=Collision.boxContainsBox(this._exactBox,e.boundingBox)?this._parent.addNodeUp(e,t-1):this.addNodeDown(e,t)},e.addNodeDown=function(e,t){if(t<this._scene.treeLevel){var n=this.inChildIndex(e.boundingBoxCenter),i=this.addChild(n);1==Collision.boxContainsBox(i._relaxBox,e.boundingBox)?i.addNodeDown(e,++t):this.addObject(e)}else this.addObject(e)},e.inChildIndex=function(e){return 4*(e.z<this._boundingBoxCenter.z?0:1)+2*(e.y<this._boundingBoxCenter.y?0:1)+(e.x<this._boundingBoxCenter.x?0:1)},e.updateObject=function(e){1==Collision.boxContainsBox(this._relaxBox,e.boundingBox)?(this.removeObject(e),e._treeNode=null,this.addNodeDown(e,this._currentDepth)):this._parent&&(this.removeObject(e),e._treeNode=null,this._parent.addNodeUp(e,this._currentDepth-1))},e.cullingObjects=function(e,t,n,i,r){var a,o=0,s=0,l=0,_=this._scene._dynamicBatchManager;for(o=0,a=this._objects.length;o<a;o++){var h=this._objects[o];if(Layer.isVisible(h._owner.layer.mask)&&h.enable){if(t&&(Stat.treeSpriteCollision+=1,0==e.containsBoundSphere(h.boundingSphere)))continue;h._renderUpdate(r),h._distanceForSort=Vector3.distance(h.boundingSphere.center,i)+h.sortingFudge;var c=h._renderElements;for(s=0,l=c.length;s<l;s++){var u=c[s],d=u._staticBatch;if(d&&d._material==u._material)d._addBatchRenderElement(u);else{var f=u.renderObj;f.triangleCount<10&&1==f._vertexBufferCount&&f._getIndexBuffer()&&u._material.renderQueue<2&&u._canDynamicBatch&&!h._owner.isStatic?_._addPrepareRenderElement(u):this._scene.getRenderQueue(u._material.renderQueue)._addRenderElement(u)}}}}for(o=0;o<8;o++){var m=this._children[o];if(null!=m){var p=t;if(t){var g=e.containsBoundBox(m._relaxBox);if(Stat.treeNodeCollision+=1,0==g)continue;p=2==g}m.cullingObjects(e,p,n,i,r)}}},e.cullingShadowObjects=function(e,t,n,i,r){var a,o=0,s=0,l=0;this._scene._dynamicBatchManager;for(o=0,a=this._objects.length;o<a;o++){var _=this._objects[o];if(_.castShadow&&Layer.isVisible(_._owner.layer.mask)&&_.enable){if(n&&0==e[0].containsBoundSphere(_.boundingSphere))continue;for(var h=1,c=e.length;h<c;h++){var u=t[h-1];if(0!=e[h].containsBoundSphere(_.boundingSphere)){var d=_._renderElements;for(s=0,l=d.length;s<l;s++)u._addRenderElement(d[s])}}}}for(o=0;o<8;o++){var f=this._children[o];if(null!=f){var m=n;if(n){var p=e[0].containsBoundBox(f._relaxBox);if(0==p)continue;m=2==p}f.cullingShadowObjects(e,t,m,i,r)}}},e.cullingShadowObjectsOnePSSM=function(e,t,n,i,r,a){var o,s=t[0],l=0,_=0,h=0;for(l=0,o=this._objects.length;l<o;l++){var c=this._objects[l];if(c.castShadow&&Layer.isVisible(c._owner.layer.mask)&&c.enable){if(i&&0==e.containsBoundSphere(c.boundingSphere))continue;c._renderUpdate(n);var u=c._renderElements;for(_=0,h=u.length;_<h;_++)s._addRenderElement(u[_])}}for(l=0;l<8;l++){var d=this._children[l];if(null!=d){var f=i;if(i){var m=e.containsBoundBox(d._relaxBox);if(0==m)continue;f=2==m}d.cullingShadowObjectsOnePSSM(e,t,n,f,r,a)}}},e.renderBoudingBox=function(e){this._renderBoudingBox(e);for(var t=0;t<8;++t){var n=this._children[t];n&&n.renderBoudingBox(e)}},e.buildAllChild=function(e){if(e<this._scene.treeLevel)for(var t=0;t<8;t++){this.addChild(t).buildAllChild(e+1)}},e._renderBoudingBox=function(e){},__getset(0,e,"relaxBox",function(){return this._relaxBox},function(e){(this._relaxBox=e).getCorners(this._corners),BoundSphere.createfromPoints(this._corners,this._boundingSphere)}),__getset(0,e,"exactBox",function(){return this._exactBox},function(e){this._exactBox=e,Vector3.add(e.min,e.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),o.debugMode=!1,o.relax=1.15,o.CHILDNUM=8,__static(o,["tempVector0",function(){return this.tempVector0=new Vector3},"tempSize",function(){return this.tempSize=new Vector3},"tempCenter",function(){return this.tempCenter=new Vector3},"_octreeSplit",function(){return this._octreeSplit=[new Vector3(.25,.25,.25),new Vector3(.75,.25,.25),new Vector3(.25,.75,.25),new Vector3(.75,.75,.25),new Vector3(.25,.25,.75),new Vector3(.75,.25,.75),new Vector3(.25,.75,.75),new Vector3(.75,.75,.75)]}]),o}(),SceneManager=function(){function e(){}return __class(e,"laya.d3.core.scene.SceneManager",!0),e}(),ParallelSplitShadowMap=function(){function g(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0,this._lightCulling=null,this._renderTarget=null,this._lightVPMatrix=null,this._lightCameras=null,this._shadowQuenes=null,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._shaderValueVPs=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new Vector3(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new Vector3,this._tempLookAt4=new Vector4,this._tempValue=new Vector4,this._tempPos=new Vector3,this._tempLightUp=new Vector3,this._tempMin=new Vector4,this._tempMax=new Vector4,this._tempMatrix44=new Matrix4x4,this._splitFrustumCulling=new BoundFrustum(Matrix4x4.DEFAULT),this._tempScaleMatrix44=new Matrix4x4,this._shadowPCFOffset=new Vector2(1/1024,1/1024),this._shaderValueDistance=new Vector4;var e=0;for(e=0;e<this._spiltDistance.length;e++)this._spiltDistance[e]=0;for(e=0;e<this._dimension.length;e++)this._dimension[e]=new Vector2;for(e=0;e<this._frustumPos.length;e++)this._frustumPos[e]=new Vector3;for(e=0;e<this._boundingBox.length;e++)this._boundingBox[e]=new BoundBox(new Vector3,new Vector3);for(e=0;e<this._boundingSphere.length;e++)this._boundingSphere[e]=new BoundSphere(new Vector3,0);Matrix4x4.createScaling(new Vector3(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}__class(g,"laya.d3.shadowMap.ParallelSplitShadowMap",!0);var e=g.prototype;return e.setInfo=function(e,t,n,i,r,a){3<r&&(this._numberOfPSSM=3),this._scene=e,this._maxDistance=t,this.PSSMNum=r,this._globalParallelLightDir=n,this._ratioOfDistance=1/this._numberOfPSSM;for(var o=0;o<this._spiltDistance.length;o++)this._spiltDistance[o]=0;this._shadowMapTextureSize=i,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(a),this._statesDirty=!0},e.setPCFType=function(e){switch(this._PCFType=e,this._PCFType){case 0:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 1:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 2:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 3:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2)}},e.getPCFType=function(){return this._PCFType},e.setFarDistance=function(e){this._maxDistance!=e&&(this._maxDistance=e,this._statesDirty=!0)},e.getFarDistance=function(){return this._maxDistance},e._setGlobalParallelLightDir=function(e){this._globalParallelLightDir=e},e.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},e.getCurrentPSSM=function(){return this._currentPSSM},e.getLightCamera=function(e){return this._lightCameras[e]},e._beginSampler=function(e,t){if(e<0||e>this._numberOfPSSM)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=e,this._update(t)},e.endSampler=function(e){this._currentPSSM=-1},e._calcAllLightCameraInfo=function(e){if(1==this._numberOfPSSM)this._beginSampler(0,e),this.endSampler(e);else for(var t=0,n=this._numberOfPSSM+1;t<n;t++)this._beginSampler(t,e),this.endSampler(e)},e._recalculate=function(e,t,n){this._calcSplitDistance(e),this._calcBoundingBox(t,n),this._rebuildRenderInfo()},e._update=function(e){var t=e.nearPlane,n=e.fieldOfView,i=e.aspectRatio;(this._statesDirty||this.lastNearPlane!=t||this.lastFieldOfView!=n||this.lastAspectRatio!=i)&&(this._recalculate(t,n,i),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=t,this.lastFieldOfView=n,this.lastAspectRatio=i),this._calcLightViewProject(e)},e._uploadShaderValue=function(){var e=this._scene;switch(this._numberOfPSSM){case 1:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 2:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 3:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2)}var t=e._shaderValues;switch(t.setValue(15,this._shaderValueDistance.elements),t.setValue(16,this._shaderValueLightVP),t.setValue(17,this._shadowPCFOffset.elements),this._numberOfPSSM){case 3:t.setValue(18,this.getRenderTarget(1)),t.setValue(19,this.getRenderTarget(2)),t.setValue(20,this.getRenderTarget(3));break;case 2:t.setValue(18,this.getRenderTarget(1)),t.setValue(19,this.getRenderTarget(2));break;case 1:t.setValue(18,this.getRenderTarget(1))}},e._calcSplitDistance=function(e){var t=this._maxDistance,n=1/this._numberOfPSSM,i=0;for(i=0;i<=this._numberOfPSSM;i++)this._uniformDistance[i]=e+(t-e)*i*n;var r=t/e;for(i=0;i<=this._numberOfPSSM;i++){var a=Math.pow(r,i*n);this._logDistance[i]=e*a}for(i=0;i<=this._numberOfPSSM;i++)this._spiltDistance[i]=this._uniformDistance[i]*this._ratioOfDistance+this._logDistance[i]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3],this._shaderValueDistance.w=this._spiltDistance[4]},e._calcBoundingBox=function(e,t){var n,i,r,a,o=3.1415926*e/180,s=Math.tan(o/2),l=NaN,_=NaN,h=NaN,c=0;for(c=0;c<=this._numberOfPSSM;c++){_=(l=(h=this._spiltDistance[c])*s)*t;var u=this._frustumPos[4*c+0].elements;u[0]=-_,u[1]=-l,u[2]=-h,(u=this._frustumPos[4*c+1].elements)[0]=_,u[1]=-l,u[2]=-h,(u=this._frustumPos[4*c+2].elements)[0]=-_,u[1]=l,u[2]=-h,(u=this._frustumPos[4*c+3].elements)[0]=_,u[1]=l,u[2]=-h,(u=this._dimension[c].elements)[0]=_,u[1]=l}for(c=1;c<=this._numberOfPSSM;c++)n=this._dimension[c].elements,(i=this._boundingBox[c].min.elements)[0]=-n[0],i[1]=-n[1],i[2]=-this._spiltDistance[c],(r=this._boundingBox[c].max.elements)[0]=n[0],r[1]=n[1],r[2]=-this._spiltDistance[c-1],(a=this._boundingSphere[c].center.elements)[0]=.5*(i[0]+r[0]),a[1]=.5*(i[1]+r[1]),a[2]=.5*(i[2]+r[2]),this._boundingSphere[c].radius=.5*Math.sqrt(Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));i=this._boundingBox[0].min.elements,n=this._dimension[this._numberOfPSSM].elements,i[0]=-n[0],i[1]=-n[1],i[2]=-this._spiltDistance[this._numberOfPSSM],(r=this._boundingBox[0].max.elements)[0]=n[0],r[1]=n[1],r[2]=-this._spiltDistance[0],(a=this._boundingSphere[0].center.elements)[0]=.5*(i[0]+r[0]),a[1]=.5*(i[1]+r[1]),a[2]=.5*(i[2]+r[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2))},e.calcSplitFrustum=function(e){0<this._currentPSSM?Matrix4x4.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):Matrix4x4.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),Matrix4x4.multiply(this._tempMatrix44,e.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},e._rebuildRenderInfo=function(){var e=this._numberOfPSSM+1,t=0;if(null==this._renderTarget)for(this._renderTarget=__newvec(e),this._renderTarget[0]=null,t=1;t<e;t++)this._renderTarget[t]=new RenderTexture(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else if(this._renderTarget.length!=e)for(this.disposeAllRenderTarget(),this._renderTarget.length=e,this._renderTarget[0]=null,t=1;t<e;t++)this._renderTarget[t]=new RenderTexture(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else for(t=1;t<e;t++)null!=this._renderTarget[t]&&this._renderTarget[t].width==this._shadowMapTextureSize&&this._renderTarget[t].height==this._shadowMapTextureSize||(null!=this._renderTarget[t]&&this._renderTarget[t].destroy(),this._renderTarget[t]=new RenderTexture(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728));if(null==this._lightCulling||this._lightCulling.length!=e)for(this._lightCulling?this._lightCulling.length=e:this._lightCulling=__newvec(e),t=0;t<this._lightCulling.length;t++)this._lightCulling[t]=new BoundFrustum(Matrix4x4.DEFAULT);if(null==this._lightVPMatrix||this._lightVPMatrix.length!=e)for(this._lightVPMatrix?this._lightVPMatrix.length=e:this._lightVPMatrix=__newvec(e),t=0;t<this._lightVPMatrix.length;t++)this._lightVPMatrix[t]=new Matrix4x4;if(null==this._lightCameras||this._lightCameras.length!=e)for(this._lightCameras?this._lightCameras.length=e:this._lightCameras=__newvec(e),t=0;t<this._lightCameras.length;t++)this._lightCameras[t]=new Camera,this._lightCameras[t].name="lightCamera"+t;if(null==this._shadowQuenes||this._shadowQuenes.length!=this._numberOfPSSM)for(this._shadowQuenes?this._shadowQuenes.length=this._numberOfPSSM:this._shadowQuenes=__newvec(this._numberOfPSSM),t=0;t<this._shadowQuenes.length;t++)this._shadowQuenes[t]=new RenderQueue(this._scene);if(null==this._shaderValueVPs||this._shaderValueVPs.length!=e)for(this._shaderValueVPs?this._shaderValueVPs.length=e:this._shaderValueVPs=__newvec(e),this._shaderValueLightVP=new Float32Array(16*e),t=0;t<e;t++)this._shaderValueVPs[t]=new Float32Array(this._shaderValueLightVP.buffer,64*t)},e._calcLightViewProject=function(e){var t=this._boundingSphere[this._currentPSSM],n=e.transform.worldMatrix;t.radius;t.center.cloneTo(this._tempLookAt3),Vector3.transformV3ToV4(this._tempLookAt3,n,this._tempLookAt4);var i=this._tempLookAt3.elements,r=this._tempLookAt4.elements;i[0]=r[0],i[1]=r[1],i[2]=r[2];var a=this._tempLightUp.elements,o=e.forward.elements;a[0]=o[0],a[1]=1,a[2]=o[2],Vector3.normalize(this._tempLightUp,this._tempLightUp),Vector3.scale(this._globalParallelLightDir,4*t.radius,this._tempPos),Vector3.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var s=this._lightCameras[this._currentPSSM];s.transform.position=this._tempPos,s.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var l=this._tempMax.elements,_=this._tempMin.elements;l[0]=l[1]=l[2]=-1e5,l[3]=1,_[0]=_[1]=_[2]=1e5,_[3]=1,Matrix4x4.multiply(s.viewMatrix,n,this._tempMatrix44);var h=this._tempValue.elements,c=[];c.length=8,this._boundingBox[this._currentPSSM].getCorners(c);for(var u=0;u<8;u++){var d=c[u].elements;h[0]=d[0],h[1]=d[1],h[2]=d[2],h[3]=1,Vector4.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),_[0]=h[0]<_[0]?h[0]:_[0],_[1]=h[1]<_[1]?h[1]:_[1],_[2]=h[2]<_[2]?h[2]:_[2],l[0]=h[0]>l[0]?h[0]:l[0],l[1]=h[1]>l[1]?h[1]:l[1],l[2]=h[2]>l[2]?h[2]:l[2]}Vector4.add(this._tempMax,this._tempMin,this._tempValue),h[0]*=.5,h[1]*=.5,h[2]*=.5,h[3]=1,Vector4.transformByM4x4(this._tempValue,s.transform.worldMatrix,this._tempValue);var f=Math.abs(-this._tempMax.z),m=f>this._maxDistance?f:this._maxDistance;Vector3.scale(this._globalParallelLightDir,m,this._tempPos);var p=this._tempPos.elements;p[0]=h[0]-p[0],p[1]=h[1]-p[1],p[2]=h[2]-p[2],s.transform.position=this._tempPos,s.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),Matrix4x4.createOrthoOffCenterRH(_[0],l[0],_[1],l[1],1,m+.5*(l[2]-_[2]),s.projectionMatrix),s.projectionViewMatrix.cloneTo(this._lightVPMatrix[this._currentPSSM]),this._lightCulling[this._currentPSSM].matrix=this._lightVPMatrix[this._currentPSSM],g.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,this._lightVPMatrix[this._currentPSSM],this._shaderValueVPs[this._currentPSSM])},e.getLightFrustumCulling=function(e){return this._lightCulling[e]},e.getSplitFrustumCulling=function(){return this._splitFrustumCulling},e.getSplitDistance=function(e){return this._spiltDistance[e]},e.setShadowMapTextureSize=function(e){e!=this._shadowMapTextureSize&&(this._shadowMapTextureSize=e,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},e.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},e.beginRenderTarget=function(e){this._renderTarget[e].start()},e.endRenderTarget=function(e){this._renderTarget[e].end()},e.getRenderTarget=function(e){return this._renderTarget[e]},e.disposeAllRenderTarget=function(){for(var e=0,t=this._numberOfPSSM+1;e<t;e++)this._renderTarget[e]&&(this._renderTarget[e].destroy(),this._renderTarget[e]=null)},__getset(0,e,"PSSMNum",function(){return this._numberOfPSSM},function(e){e=(e=0<e?e:1)<=3?e:3,this._numberOfPSSM!=e&&(this._numberOfPSSM=e,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)}),g.multiplyMatrixOutFloat32Array=function(e,t,n){var i,r,a,o,s,l,_;for(r=e.elements,a=t.elements,i=0;i<4;i++)o=r[i],s=r[i+4],l=r[i+8],_=r[i+12],n[i]=o*a[0]+s*a[1]+l*a[2]+_*a[3],n[i+4]=o*a[4]+s*a[5]+l*a[6]+_*a[7],n[i+8]=o*a[8]+s*a[9]+l*a[10]+_*a[11],n[i+12]=o*a[12]+s*a[13]+l*a[14]+_*a[15]},g.SHADERDEFINE_RECEIVE_SHADOW=1,g.SHADERDEFINE_CAST_SHADOW=512,g.SHADERDEFINE_SHADOW_PSSM1=1024,g.SHADERDEFINE_SHADOW_PSSM2=2048,g.SHADERDEFINE_SHADOW_PSSM3=4096,g.SHADERDEFINE_SHADOW_PCF_NO=8192,g.SHADERDEFINE_SHADOW_PCF1=16384,g.SHADERDEFINE_SHADOW_PCF2=32768,g.SHADERDEFINE_SHADOW_PCF3=65536,g.MAX_PSSM_COUNT=3,g}(),AnimationClipParser02=function(){function B(){}return __class(B,"laya.d3.animation.AnimationClipParser02",!0),B.READ_DATA=function(){B._DATA.offset=B._reader.getUint32(),B._DATA.size=B._reader.getUint32()},B.READ_BLOCK=function(){for(var e=B._BLOCK.count=B._reader.getUint16(),t=B._BLOCK.blockStarts=[],n=B._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(B._reader.getUint32()),n.push(B._reader.getUint32())},B.READ_STRINGS=function(){var e=B._reader.getUint32(),t=B._reader.getUint16(),n=B._reader.pos;B._reader.pos=e+B._DATA.offset;for(var i=0;i<t;i++)B._strings[i]=B._reader.readUTFString();B._reader.pos=n},B.parse=function(e,t){B._animationClip=e;(B._reader=t).__getBuffer();B.READ_DATA(),B.READ_BLOCK(),B.READ_STRINGS();for(var n=0,i=B._BLOCK.count;n<i;n++){var r=t.getUint16(),a=B._strings[r],o=B["READ_"+a];if(null==o)throw new Error("model file err,no this function:"+r+" "+a);o.call()}},B.READ_ANIMATIONS=function(){var e,t=0,n=0,i=B._reader,r=i.__getBuffer(),a=[],o=i.getUint8();for(a.length=o,t=0;t<o;t++)a[t]=i.getUint16();var s=[],l=i.getUint16();for(s.length=l,t=0;t<l;t++)s[t]=i.getFloat32();var _=B._animationClip;_.name=B._strings[i.getUint16()];var h=_._duration=i.getFloat32();_.islooping=!!i.getByte(),_._frameRate=i.getInt16();var c=i.getInt16(),u=_._nodes=new Array;u.length=c,(_._publicClipDatas=[]).length=c;var d=_._nodesMap={},f=0,m=0;for(t=0;t<c;t++){e=u[t]=new KeyframeNode;var p=i.getUint16(),g=e.path=[];for(g.length=p,n=0;n<p;n++)g[n]=B._strings[i.getUint16()];var E=g.join("/"),v=d[E];v||(d[E]=v=[]),v.push(e);var x=i.getInt16();-1!=x&&(e.componentType=B._strings[x]);var S=AnimationNode._propertyIndexDic[B._strings[i.getUint16()]];if(null==S)throw new Error("AnimationClipParser02:unknown property name.");var D=S<4,T=!D||D&&""==g[0];(e._cacheProperty=T)?f++:m++,e.propertyNameID=S;var M=a[i.getUint8()];e.keyFrameWidth=M/4;var V=e.keyFrames=[],R=V.length=i.getUint16(),A=null,C=NaN;for(n=0;n<R;n++){var I=V[n]=new Keyframe;C=I.startTime=s[i.getUint16()];var y=i.pos;I.inTangent=new Float32Array(r.slice(y,y+M)),i.pos+=M,y=i.pos,I.outTangent=new Float32Array(r.slice(y,y+M)),i.pos+=M,y=i.pos,I.data=new Float32Array(r.slice(y,y+M)),i.pos+=M,A&&(A.next=I,A.duration=C-A.startTime),A=I}I.next=null,I.duration=h-C}var N=i.getUint16();for(t=0;t<N;t++){var P,L=new AnimationEvent;L.time=i.getFloat32(),L.eventName=B._strings[i.getUint16()];var w=i.getUint16();for(0<w&&(L.params=P=[]),n=0;n<w;n++){switch(i.getByte()){case 0:P.push(!!i.getByte());break;case 1:P.push(i.getInt32());break;case 2:P.push(i.getFloat32());break;case 3:P.push(B._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}_.addEvent(L)}var O=_._nodeToCachePropertyMap=new Int32Array(c),b=_._cachePropertyMap=new Int32Array(f),F=_._unCachePropertyMap=new Int32Array(m);for(f=m=0,t=0;t<c;t++)(e=u[t])._cacheProperty?(O[t]=f,b[f++]=t):F[m++]=t},B._animationClip=null,B._reader=null,B._strings=[],__static(B,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),B}(),KeyframeNode=function(){function e(){this._cacheProperty=!1,this.path=null,this.componentType=null,this.propertyNameID=0,this.keyFrameWidth=0,this.defaultData=null,this.keyFrames=null}return __class(e,"laya.d3.animation.KeyframeNode",!0),e}(),AnimationNode=function(){function i(){this._childs=[],this.transform=new AnimationTransform3D(this)}__class(i,"laya.d3.animation.AnimationNode",!0);var e=i.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.addChild=function(e){e._parent=this,e.transform.setParent(this.transform),this._childs.push(e)},e.removeChild=function(e){var t=this._childs.indexOf(e);-1!=t&&this._childs.splice(t,1)},e.getChildByName=function(e){for(var t=0,n=this._childs.length;t<n;t++){var i=this._childs[t];if(i.name==e)return i}return null},e.getChildByIndex=function(e){return this._childs[e]},e.getChildCount=function(){return this._childs.length},e.cloneTo=function(e){var t=e;t.name=this.name;for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n],a=r.clone();t.addChild(a);var o=r.transform,s=a.transform;s.setLocalPosition(o.getLocalPosition()),s.setLocalRotation(o.getLocalRotation()),s.setLocalScale(o.getLocalScale()),s._localRotationEuler=o._localRotationEuler,s._setWorldMatrixIgnoreUpdate(o.getWorldMatrix())}},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},i.__init__=function(){i.registerAnimationNodeProperty("localPosition",i._getLocalPosition,i._setLocalPosition),i.registerAnimationNodeProperty("localRotation",i._getLocalRotation,i._setLocalRotation),i.registerAnimationNodeProperty("localScale",i._getLocalScale,i._setLocalScale),i.registerAnimationNodeProperty("localRotationEuler",i._getLocalRotationEuler,i._setLocalRotationEuler),i.registerAnimationNodeProperty("particleRender.sharedMaterial.tintColor",i._getParticleRenderSharedMaterialTintColor,i._setParticleRenderSharedMaterialTintColor),i.registerAnimationNodeProperty("meshRender.sharedMaterial.tilingOffset",i._getMeshRenderSharedMaterialTilingOffset,i._setMeshRenderSharedMaterialTilingOffset),i.registerAnimationNodeProperty("meshRender.sharedMaterial.albedoColor",i._getMeshRenderSharedMaterialAlbedo,i._setMeshRenderSharedMaterialAlbedo),i.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.tilingOffset",i._getSkinnedMeshRenderSharedMaterialTilingOffset,i._setSkinnedMeshRenderSharedMaterialTilingOffset),i.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedoColor",i._getSkinnedMeshRenderSharedMaterialAlbedo,i._setSkinnedMeshRenderSharedMaterialAlbedo),i.registerAnimationNodeProperty("meshRender.sharedMaterial.albedo",i._getMeshRenderSharedMaterialAlbedo,i._setMeshRenderSharedMaterialAlbedo),i.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedo",i._getSkinnedMeshRenderSharedMaterialAlbedo,i._setSkinnedMeshRenderSharedMaterialAlbedo)},i.registerAnimationNodeProperty=function(e,t,n){if(i._propertyIndexDic[e])throw new Error("AnimationNode: this propertyName has registered.");i._propertyIndexDic[e]=i._propertyIDCounter,i._propertyGetFuncs[i._propertyIDCounter]=t,i._propertySetFuncs[i._propertyIDCounter]=n,i._propertyIDCounter++},i._getLocalPosition=function(e,t){return e?e.transform.getLocalPosition():t._transform.localPosition.elements},i._setLocalPosition=function(e,t,n){if(e)e.transform.setLocalPosition(n);else{var i=t._transform,r=i.localPosition;r.elements=n,i.localPosition=r}},i._getLocalRotation=function(e,t){return e?e.transform.getLocalRotation():t._transform.localRotation.elements},i._setLocalRotation=function(e,t,n){if(e)e.transform.setLocalRotation(n);else{var i=t._transform,r=i.localRotation;r.elements=n,i.localRotation=r}},i._getLocalScale=function(e,t){return e?e.transform.getLocalScale():t._transform.localScale.elements},i._setLocalScale=function(e,t,n){if(e)e.transform.setLocalScale(n);else{var i=t._transform,r=i.localScale;r.elements=n,i.localScale=r}},i._getLocalRotationEuler=function(e,t){return e?e.transform.getLocalRotationEuler():t._transform.localRotationEuler.elements},i._setLocalRotationEuler=function(e,t,n){if(e)e.transform.setLocalRotationEuler(n);else{var i=t._transform,r=i.localRotationEuler;r.elements=n,i.localRotationEuler=r}},i._getMeshRenderSharedMaterialTilingOffset=function(e,t){if(e){var n=e.transform._entity;return n?n.owner.meshRender.sharedMaterial.tilingOffset.elements:null}return t.meshRender.sharedMaterial.tilingOffset.elements},i._setMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&((r=(i=a.owner.meshRender.material).tilingOffset).elements=n,i.tilingOffset=r)}else(r=(i=t.meshRender.material).tilingOffset).elements=n,i.tilingOffset=r},i._getMeshRenderSharedMaterialAlbedo=function(e,t){if(e){var n=e.transform._entity;return n?n.owner.meshRender.sharedMaterial.albedoColor.elements:null}return t.meshRender.sharedMaterial.albedoColor.elements},i._setMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&((r=(i=a.owner.meshRender.material).albedoColor).elements=n,i.albedoColor=r)}else(r=(i=t.meshRender.material).albedoColor).elements=n,i.albedoColor=r},i._getSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t){if(e){var n=e.transform._entity;return n?n.owner.skinnedMeshRender.sharedMaterial.tilingOffset.elements:null}return t.skinnedMeshRender.sharedMaterial.tilingOffset.elements},i._setSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&((r=(i=a.owner.skinnedMeshRender.material).tilingOffset).elements=n,i.tilingOffset=r)}else(r=(i=t.skinnedMeshRender.material).tilingOffset).elements=n,i.tilingOffset=r},i._getSkinnedMeshRenderSharedMaterialAlbedo=function(e,t){if(e){var n=e.transform._entity;return n?n.owner.skinnedMeshRender.sharedMaterial.albedoColor.elements:null}return t.skinnedMeshRender.sharedMaterial.albedoColor.elements},i._setSkinnedMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&((r=(i=a.owner.skinnedMeshRender.material).albedoColor).elements=n,i.albedoColor=r)}else(r=(i=t.skinnedMeshRender.material).albedoColor).elements=n,i.albedoColor=r},i._getParticleRenderSharedMaterialTintColor=function(e,t){if(e){var n=e.transform._entity;return n?n.owner.particleRender.sharedMaterial.tintColor.elements:null}return t.particleRender.sharedMaterial.tintColor.elements},i._setParticleRenderSharedMaterialTintColor=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&((r=(i=a.owner.particleRender.material).tintColor).elements=n,i.tintColor=r)}else(r=(i=t.particleRender.material).tintColor).elements=n,i.tintColor=r},i._propertyIDCounter=0,i._propertyIndexDic={},i._propertySetFuncs=[],i._propertyGetFuncs=[],i}(),AnimationEvent=function(){function e(){this.time=NaN,this.eventName=null,this.params=null}return __class(e,"laya.d3.animation.AnimationEvent",!0),e}(),Keyframe=function(){function e(){this.startTime=NaN,this.inTangent=null,this.outTangent=null,this.data=null,this.duration=NaN,this.next=null}return __class(e,"laya.d3.animation.Keyframe",!0),e}(),AnimationClipParser01=function(){function w(){}return __class(w,"laya.d3.animation.AnimationClipParser01",!0),w.READ_DATA=function(){w._DATA.offset=w._reader.getUint32(),w._DATA.size=w._reader.getUint32()},w.READ_BLOCK=function(){for(var e=w._BLOCK.count=w._reader.getUint16(),t=w._BLOCK.blockStarts=[],n=w._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(w._reader.getUint32()),n.push(w._reader.getUint32())},w.READ_STRINGS=function(){var e=w._reader.getUint32(),t=w._reader.getUint16(),n=w._reader.pos;w._reader.pos=e+w._DATA.offset;for(var i=0;i<t;i++)w._strings[i]=w._reader.readUTFString();w._reader.pos=n},w.parse=function(e,t){w._animationClip=e;(w._reader=t).__getBuffer();w.READ_DATA(),w.READ_BLOCK(),w.READ_STRINGS();for(var n=0,i=w._BLOCK.count;n<i;n++){var r=t.getUint16(),a=w._strings[r],o=w["READ_"+a];if(null==o)throw new Error("model file err,no this function:"+r+" "+a);o.call()}},w.READ_ANIMATIONS=function(){var e,t=0,n=0,i=w._reader,r=i.__getBuffer(),a=[],o=i.getUint8();for(a.length=o,t=0;t<o;t++)a[t]=i.getUint16();var s=[],l=i.getUint16();for(s.length=l,t=0;t<l;t++)s[t]=i.getFloat32();var _=w._animationClip;_.name=w._strings[i.getUint16()];var h=_._duration=i.getFloat32();_.islooping=!!i.getByte(),_._frameRate=i.getInt16();var c=i.getInt16(),u=_._nodes=new Array;u.length=c,(_._publicClipDatas=[]).length=c;var d=_._nodesMap={},f=0,m=0;for(t=0;t<c;t++){e=u[t]=new KeyframeNode;var p=i.getUint16(),g=e.path=[];for(g.length=p,n=0;n<p;n++)g[n]=w._strings[i.getUint16()];var E=g.join("/"),v=d[E];v||(d[E]=v=[]),v.push(e);var x=i.getInt16();-1!=x&&(e.componentType=w._strings[x]);var S=AnimationNode._propertyIndexDic[w._strings[i.getUint16()]];if(null==S)throw new Error("AnimationClipParser01:unknown property name.");var D=S<4,T=!D||D&&""==g[0];(e._cacheProperty=T)?f++:m++,e.propertyNameID=S;var M=a[i.getUint8()];e.keyFrameWidth=M/4;var V=e.keyFrames=[],R=V.length=i.getUint16(),A=null,C=NaN;for(n=0;n<R;n++){var I=V[n]=new Keyframe;C=I.startTime=s[i.getUint16()];var y=i.pos;I.inTangent=new Float32Array(r.slice(y,y+M)),i.pos+=M,y=i.pos,I.outTangent=new Float32Array(r.slice(y,y+M)),i.pos+=M,y=i.pos,I.data=new Float32Array(r.slice(y,y+M)),i.pos+=M,A&&(A.next=I,A.duration=C-A.startTime),A=I}I.next=null,I.duration=h-C}var N=_._nodeToCachePropertyMap=new Int32Array(c),P=_._cachePropertyMap=new Int32Array(f),L=_._unCachePropertyMap=new Int32Array(m);for(f=m=0,t=0;t<c;t++)(e=u[t])._cacheProperty?(N[t]=f,P[f++]=t):L[m++]=t},w._animationClip=null,w._reader=null,w._strings=[],__static(w,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),w}(),Utils3D=function(){function P(){}return __class(P,"laya.d3.utils.Utils3D",!0),P._rotationTransformScaleSkinAnimation=function(e,t,n,i,r,a,o,s,l,_,h,c){var u,d,f,m,p,g=P._tempArray16_0,E=P._tempArray16_1,v=P._tempArray16_2,x=i+i,S=r+r,D=a+a,T=i*x,M=r*x,V=r*S,R=a*x,A=a*S,C=a*D,I=o*x,y=o*S,N=o*D;for(g[15]=1,g[0]=1-V-C,g[1]=M+N,g[2]=R-y,g[4]=M-N,g[5]=1-T-C,g[6]=A+I,g[8]=R+y,g[9]=A-I,g[10]=1-T-V,E[15]=1,E[0]=s,E[5]=l,E[10]=_,u=0;u<4;u++)d=g[u],f=g[u+4],m=g[u+8],p=g[u+12],v[u]=d,v[u+4]=f,v[u+8]=m,v[u+12]=d*e+f*t+m*n+p;for(u=0;u<4;u++)d=v[u],f=v[u+4],m=v[u+8],p=v[u+12],h[u+c]=d*E[0]+f*E[1]+m*E[2]+p*E[3],h[u+c+4]=d*E[4]+f*E[5]+m*E[6]+p*E[7],h[u+c+8]=d*E[8]+f*E[9]+m*E[10]+p*E[11],h[u+c+12]=d*E[12]+f*E[13]+m*E[14]+p*E[15]},P._createNodeByJson=function(e,t,n,i){if(!n)switch(t.type){case"Sprite3D":n=new Sprite3D;break;case"MeshSprite3D":n=new MeshSprite3D;break;case"SkinnedMeshSprite3D":n=new SkinnedMeshSprite3D;break;case"ShuriKenParticle3D":n=new ShuriKenParticle3D;break;case"TrailSprite3D":n=new TrailSprite3D;break;case"LineSprite3D":break;case"Terrain":n=new Terrain;break;case"Camera":n=new Camera;break;case"DirectionLight":n=new DirectionLight;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var r=t.props;if(r)for(var a in r)n[a]=r[a];var o=t.customProps;o&&(n instanceof laya.d3.core.Sprite3D?(n._parseBaseCustomProps(o),n._parseCustomProps(e,i,o,t),n._parseCustomComponent(e,i,t.components)):n._parseCustomProps(e,i,o,t));var s=t.child;if(s)for(var l=0,_=s.length;l<_;l++){var h=P._createNodeByJson(e,s[l],null,i);n.addChild(h)}return n},P._computeBoneAndAnimationDatasByBindPoseMatrxix=function(e,t,n,i,r,a){var o,s,l=0,_=0,h=e.length;for(o=0;o<h;l+=e[o].keyframeWidth,_+=16,o++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[l+0],t[l+1],t[l+2],t[l+3],t[l+4],t[l+5],t[l+6],t[l+7],t[l+8],t[l+9],i,_),0!=o&&(s=16*e[o].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,_,i,_));var c=n.length;for(o=0;o<c;o++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,16*a[o],n[o],r,16*o)},P._computeAnimationDatasByArrayAndMatrixFast=function(e,t,n,i){for(var r=0,a=e.length;r<a;r++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,16*i[r],e[r],n,16*r)},P._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(e,t,n,i,r){var a,o,s=0,l=0,_=e.length;for(a=0;a<_;s+=e[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[s+7],t[s+8],t[s+9],t[s+3],t[s+4],t[s+5],t[s+6],t[s+0],t[s+1],t[s+2],i,l),0!=a&&(o=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,o,i,l,i,l));var h=n.length;for(a=0;a<h;a++){var c=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,c,n[a],r,c)}},P._computeAnimationDatasByArrayAndMatrixFastOld=function(e,t,n){for(var i=e.length,r=0;r<i;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,a,e[r],n,a)}},P._computeRootAnimationData=function(e,t,n){for(var i=0,r=0,a=0,o=e.length;i<o;r+=e[i].keyframeWidth,a+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],n,a)},P.transformVector3ArrayByQuat=function(e,t,n,i,r){var a=n.elements,o=e[t],s=e[t+1],l=e[t+2],_=a[0],h=a[1],c=a[2],u=a[3],d=u*o+h*l-c*s,f=u*s+c*o-_*l,m=u*l+_*s-h*o,p=-_*o-h*s-c*l;i[r]=d*u+p*-_+f*-c-m*-h,i[r+1]=f*u+p*-h+m*-_-d*-c,i[r+2]=m*u+p*-c+d*-h-f*-_},P.mulMatrixByArray=function(e,t,n,i,r,a){var o,s,l,_,h;if(r==n){for(n=P._tempArray16_3,o=0;o<16;++o)n[o]=r[a+o];i=0}for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],_=e[t+o+8],h=e[t+o+12],r[a+o]=s*n[i+0]+l*n[i+1]+_*n[i+2]+h*n[i+3],r[a+o+4]=s*n[i+4]+l*n[i+5]+_*n[i+6]+h*n[i+7],r[a+o+8]=s*n[i+8]+l*n[i+9]+_*n[i+10]+h*n[i+11],r[a+o+12]=s*n[i+12]+l*n[i+13]+_*n[i+14]+h*n[i+15]},P.mulMatrixByArrayFast=function(e,t,n,i,r,a){var o,s,l,_,h;for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],_=e[t+o+8],h=e[t+o+12],r[a+o]=s*n[i+0]+l*n[i+1]+_*n[i+2]+h*n[i+3],r[a+o+4]=s*n[i+4]+l*n[i+5]+_*n[i+6]+h*n[i+7],r[a+o+8]=s*n[i+8]+l*n[i+9]+_*n[i+10]+h*n[i+11],r[a+o+12]=s*n[i+12]+l*n[i+13]+_*n[i+14]+h*n[i+15]},P.mulMatrixByArrayAndMatrixFast=function(e,t,n,i,r){var a,o,s,l,_,h=n.elements,c=h[0],u=h[1],d=h[2],f=h[3],m=h[4],p=h[5],g=h[6],E=h[7],v=h[8],x=h[9],S=h[10],D=h[11],T=h[12],M=h[13],V=h[14],R=h[15],A=t,C=t+4,I=t+8,y=t+12,N=r,P=r+4,L=r+8,w=r+12;for(a=0;a<4;a++)o=e[A+a],s=e[C+a],l=e[I+a],_=e[y+a],i[N+a]=o*c+s*u+l*d+_*f,i[P+a]=o*m+s*p+l*g+_*E,i[L+a]=o*v+s*x+l*S+_*D,i[w+a]=o*T+s*M+l*V+_*R},P.createAffineTransformationArray=function(e,t,n,i,r,a,o,s,l,_,h,c){var u=i+i,d=r+r,f=a+a,m=i*u,p=i*d,g=i*f,E=r*d,v=r*f,x=a*f,S=o*u,D=o*d,T=o*f;h[c+0]=(1-(E+x))*s,h[c+1]=(p+T)*s,h[c+2]=(g-D)*s,h[c+3]=0,h[c+4]=(p-T)*l,h[c+5]=(1-(m+x))*l,h[c+6]=(v+S)*l,h[c+7]=0,h[c+8]=(g+D)*_,h[c+9]=(v-S)*_,h[c+10]=(1-(m+E))*_,h[c+11]=0,h[c+12]=e,h[c+13]=t,h[c+14]=n,h[c+15]=1},P.transformVector3ArrayToVector3ArrayCoordinate=function(e,t,n,i,r){var a=P._tempArray4_0,o=e[t+0],s=e[t+1],l=e[t+2],_=n.elements;a[0]=o*_[0]+s*_[4]+l*_[8]+_[12],a[1]=o*_[1]+s*_[5]+l*_[9]+_[13],a[2]=o*_[2]+s*_[6]+l*_[10]+_[14],a[3]=1/(o*_[3]+s*_[7]+l*_[11]+_[15]),i[r+0]=a[0]*a[3],i[r+1]=a[1]*a[3],i[r+2]=a[2]*a[3]},P.transformLightingMapTexcoordByUV0Array=function(e,t,n,i,r){var a=n.elements;i[r+0]=e[t+0]*a[0]+a[2],i[r+1]=(e[t+1]-1)*a[1]+a[3]},P.transformLightingMapTexcoordByUV1Array=function(e,t,n,i,r){var a=n.elements;i[r+0]=e[t+0]*a[0]+a[2],i[r+1]=1+e[t+1]*a[1]+a[3]},P.getURLVerion=function(e){var t=e.indexOf("?");return 0<=t?e.substr(t):null},P._quaternionCreateFromYawPitchRollArray=function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),l=Math.cos(r),_=Math.sin(a),h=Math.cos(a),c=Math.sin(o),u=Math.cos(o);i[0]=u*_*l+c*h*s,i[1]=c*h*l-u*_*s,i[2]=u*h*s-c*_*l,i[3]=u*h*l+c*_*s},P._createAffineTransformationArray=function(e,t,n,i){var r=t[0],a=t[1],o=t[2],s=t[3],l=r+r,_=a+a,h=o+o,c=r*l,u=r*_,d=r*h,f=a*_,m=a*h,p=o*h,g=s*l,E=s*_,v=s*h,x=n[0],S=n[1],D=n[2];i[0]=(1-(f+p))*x,i[1]=(u+v)*x,i[2]=(d-E)*x,i[3]=0,i[4]=(u-v)*S,i[5]=(1-(c+p))*S,i[6]=(m+g)*S,i[7]=0,i[8]=(d+E)*D,i[9]=(m-g)*D,i[10]=(1-(c+f))*D,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1},P._mulMatrixArray=function(e,t,n,i){var r,a,o,s,l,_=t.elements,h=_[0],c=_[1],u=_[2],d=_[3],f=_[4],m=_[5],p=_[6],g=_[7],E=_[8],v=_[9],x=_[10],S=_[11],D=_[12],T=_[13],M=_[14],V=_[15],R=i,A=i+4,C=i+8,I=i+12;for(r=0;r<4;r++)a=e[r],o=e[r+4],s=e[r+8],l=e[r+12],n[R+r]=a*h+o*c+s*u+l*d,n[A+r]=a*f+o*m+s*p+l*g,n[C+r]=a*E+o*v+s*x+l*S,n[I+r]=a*D+o*T+s*M+l*V},P.getYawPitchRoll=function(e,t){P.transformQuat(Vector3.ForwardRH,e,Quaternion.TEMPVector31),P.transformQuat(Vector3.Up,e,Quaternion.TEMPVector32);var n=Quaternion.TEMPVector32.elements;P.angleTo(Vector3.ZERO,Quaternion.TEMPVector31,Quaternion.TEMPVector33);var i=Quaternion.TEMPVector33.elements;i[0]==Math.PI/2?(i[1]=P.arcTanAngle(n[2],n[0]),i[2]=0):i[0]==-Math.PI/2?(i[1]=P.arcTanAngle(-n[2],-n[0]),i[2]=0):(Matrix4x4.createRotationY(-i[1],Quaternion.TEMPMatrix0),Matrix4x4.createRotationX(-i[0],Quaternion.TEMPMatrix1),Vector3.transformCoordinate(Quaternion.TEMPVector32,Quaternion.TEMPMatrix0,Quaternion.TEMPVector32),Vector3.transformCoordinate(Quaternion.TEMPVector32,Quaternion.TEMPMatrix1,Quaternion.TEMPVector32),i[2]=P.arcTanAngle(n[1],-n[0])),i[1]<=-Math.PI&&(i[1]=Math.PI),i[2]<=-Math.PI&&(i[2]=Math.PI),i[1]>=Math.PI&&i[2]>=Math.PI&&(i[1]=0,i[2]=0,i[0]=Math.PI-i[0]),t[0]=i[1],t[1]=i[0],t[2]=i[2]},P.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:0<e?Math.atan(t/e):e<0?0<t?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},P.angleTo=function(e,t,n){Vector3.subtract(t,e,Quaternion.TEMPVector30),Vector3.normalize(Quaternion.TEMPVector30,Quaternion.TEMPVector30),n.elements[0]=Math.asin(Quaternion.TEMPVector30.y),n.elements[1]=P.arcTanAngle(-Quaternion.TEMPVector30.z,-Quaternion.TEMPVector30.x)},P.transformQuat=function(e,t,n){var i=n.elements,r=e.elements,a=t,o=r[0],s=r[1],l=r[2],_=a[0],h=a[1],c=a[2],u=a[3],d=u*o+h*l-c*s,f=u*s+c*o-_*l,m=u*l+_*s-h*o,p=-_*o-h*s-c*l;i[0]=d*u+p*-_+f*-c-m*-h,i[1]=f*u+p*-h+m*-_-d*-c,i[2]=m*u+p*-c+d*-h-f*-_},P.quaterionNormalize=function(e,t){var n=e[0],i=e[1],r=e[2],a=e[3],o=n*n+i*i+r*r+a*a;0<o&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=i*o,t[2]=r*o,t[3]=a*o)},P.matrix4x4MultiplyFFF=function(e,t,n){var i,r,a,o,s;if(n==t)for(t=new Float32Array(16),i=0;i<16;++i)t[i]=n[i];for(i=0;i<4;i++)r=e[i],a=e[i+4],o=e[i+8],s=e[i+12],n[i]=r*t[0]+a*t[1]+o*t[2]+s*t[3],n[i+4]=r*t[4]+a*t[5]+o*t[6]+s*t[7],n[i+8]=r*t[8]+a*t[9]+o*t[10]+s*t[11],n[i+12]=r*t[12]+a*t[13]+o*t[14]+s*t[15]},P.matrix4x4MultiplyMFM=function(e,t,n){P.matrix4x4MultiplyFFF(e.elements,t,n.elements)},P._tempVector3_0=new Vector3,P._tempVector3_1=new Vector3,P._tempVector3_2=new Vector3,P._tempVector3_3=new Vector3,P._tempVector3_4=new Vector3,P._tempVector3_5=new Vector3,P._tempVector3_6=new Vector3,P._tempArray4_0=new Float32Array(4),P._tempArray16_0=new Float32Array(16),P._tempArray16_1=new Float32Array(16),P._tempArray16_2=new Float32Array(16),P._tempArray16_3=new Float32Array(16),__static(P,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),P}(),Physics=function(){function u(){}return __class(u,"laya.d3.utils.Physics",!0),u.__init__=function(){u._layerCollsionMatrix.length=31;for(var e=0;e<31;e++){var t=[],n=31-e;t.length=n;for(var i=0;i<n;i++)t[i]=i==n-1;u._layerCollsionMatrix[e]=t}},u.setLayerCollision=function(e,t,n){u._layerCollsionMatrix[e.number][30-t.number]=n},u.getLayerCollision=function(e,t){return u._layerCollsionMatrix[e.number][30-t.number]},u.setColliderCollision=function(e,t,n){n?(delete e._ignoreCollisonMap[t.id],delete t._ignoreCollisonMap[e.id]):(e._ignoreCollisonMap[t.id]=t)._ignoreCollisonMap[e.id]=e},u.getIColliderCollision=function(e,t){return!!e._ignoreCollisonMap[t.id]},u.rayCast=function(e,t,n,i){void 0===n&&(n=179e306),void 0===i&&(i=0),u._outHitAllInfo.length=0;for(var r=Layer.getLayerByNumber(i)._colliders,a=0,o=r.length;a<o;a++){var s=r[a];if(s.enable&&(s.raycast(e,u._outHitInfo,n),-1!=u._outHitInfo.distance&&u._outHitInfo.distance<=n)){var l=new RaycastHit;u._outHitInfo.cloneTo(l),u._outHitAllInfo.push(l)}}if(0==u._outHitAllInfo.length)return t.sprite3D=null,void(t.distance=-1);for(var _=Number.MAX_VALUE,h=0,c=0;c<u._outHitAllInfo.length;c++)u._outHitAllInfo[c].distance<_&&(_=u._outHitAllInfo[c].distance,h=c);u._outHitAllInfo[h].cloneTo(t)},u.rayCastAll=function(e,t,n,i){void 0===n&&(n=179e306),void 0===i&&(i=0),t.length=0;for(var r=Layer.getLayerByNumber(i)._colliders,a=0,o=r.length;a<o;a++){var s=r[a];if(s.enable&&(u._outHitInfo.distance=-1,u._outHitInfo.sprite3D=null,s.raycast(e,u._outHitInfo,n),-1!=u._outHitInfo.distance&&u._outHitInfo.distance<=n)){var l=new RaycastHit;u._outHitInfo.cloneTo(l),t.push(l)}}},u._outHitAllInfo=[],u._layerCollsionMatrix=[],__static(u,["_outHitInfo",function(){return this._outHitInfo=new RaycastHit},"collisionManager",function(){return this.collisionManager=new CollisionManager},"gravity",function(){return this.gravity=new Vector3(0,-9.81,0)}]),u}(),RaycastHit=function(){function e(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new Vector3,new Vector3,new Vector3],this.trianglePositions.length=3,this.triangleNormals=[new Vector3,new Vector3,new Vector3],this.triangleNormals.length=3,this.position=new Vector3}return __class(e,"laya.d3.utils.RaycastHit",!0),e.prototype.cloneTo=function(e){e.distance=this.distance,this.trianglePositions[0].cloneTo(e.trianglePositions[0]),this.trianglePositions[1].cloneTo(e.trianglePositions[1]),this.trianglePositions[2].cloneTo(e.trianglePositions[2]),this.triangleNormals[0].cloneTo(e.triangleNormals[0]),this.triangleNormals[1].cloneTo(e.triangleNormals[1]),this.triangleNormals[2].cloneTo(e.triangleNormals[2]),this.position.cloneTo(e.position),e.sprite3D=this.sprite3D},e}(),Picker=function(){function K(){}return __class(K,"laya.d3.utils.Picker",!0),K.calculateCursorRay=function(e,t,n,i,r,a){var o=e.elements[0],s=e.elements[1],l=K._tempVector30,_=l.elements;_[0]=o,_[1]=s,_[2]=t.minDepth;var h=K._tempVector31,c=h.elements;c[0]=o,c[1]=s,c[2]=t.maxDepth;var u=a.origin,d=K._tempVector32;t.unprojectFromWVP(l,n,i,r,u),t.unprojectFromWVP(h,n,i,r,d);var f=a.direction.elements;f[0]=d.x-u.x,f[1]=d.y-u.y,f[2]=d.z-u.z,Vector3.normalize(a.direction,a.direction)},K.rayIntersectsPositionsAndIndices=function(e,t,n,i,r){for(var a=n.vertexStride/4,o=n.getVertexElementByUsage(0).offset/4,s=Number.MAX_VALUE,l=-1,_=-1,h=-1,c=0;c<i.length;c+=3){var u=K._tempVector35,d=u.elements,f=i[c]*a,m=f+o;d[0]=t[m],d[1]=t[m+1],d[2]=t[m+2];var p=K._tempVector36,g=p.elements,E=i[c+1]*a,v=E+o;g[0]=t[v],g[1]=t[v+1],g[2]=t[v+2];var x=K._tempVector37,S=x.elements,D=i[c+2]*a,T=D+o;S[0]=t[T],S[1]=t[T+1],S[2]=t[T+2];var M=laya.d3.utils.Picker.rayIntersectsTriangle(e,u,p,x);!isNaN(M)&&M<s&&(s=M,l=f,_=E,h=D)}if(s==Number.MAX_VALUE)return r.position.toDefault(),r.distance=Number.MAX_VALUE,r.trianglePositions[0].toDefault(),r.trianglePositions[1].toDefault(),r.trianglePositions[2].toDefault(),r.triangleNormals[0].toDefault(),r.triangleNormals[1].toDefault(),r.triangleNormals[2].toDefault(),!1;r.distance=s,Vector3.scale(e.direction,s,r.position),Vector3.add(e.origin,r.position,r.position);var V=r.trianglePositions,R=V[0],A=V[1],C=V[2],I=R.elements,y=A.elements,N=C.elements,P=l+o;I[0]=t[P],I[1]=t[P+1],I[2]=t[P+2];var L=_+o;y[0]=t[L],y[1]=t[L+1],y[2]=t[L+2];var w=h+o;N[0]=t[w],N[1]=t[w+1],N[2]=t[w+2];var O=n.getVertexElementByUsage(3);if(O){var b=O.offset/4,F=r.triangleNormals,B=F[0],U=F[1],H=F[2],G=B.elements,z=U.elements,W=H.elements,k=l+b;G[0]=t[k],G[1]=t[k+1],G[2]=t[k+2];var X=_+b;z[0]=t[X],z[1]=t[X+1],z[2]=t[X+2];var Z=h+b;W[0]=t[Z],W[1]=t[Z+1],W[2]=t[Z+2]}return!0},K.rayIntersectsTriangle=function(e,t,n,i){var r=K._tempVector30,a=K._tempVector31;Vector3.subtract(n,t,r),Vector3.subtract(i,t,a);var o,s=K._tempVector32;if(Vector3.cross(e.direction,a,s),(o=Vector3.dot(r,s))>-Number.MIN_VALUE&&o<Number.MIN_VALUE)return Number.NaN;var l,_=1/o,h=K._tempVector33;if(Vector3.subtract(e.origin,t,h),l=Vector3.dot(h,s),(l*=_)<0||1<l)return Number.NaN;var c,u,d=K._tempVector34;return Vector3.cross(h,r,d),c=Vector3.dot(e.direction,d),(c*=_)<0||1<l+c?Number.NaN:(u=Vector3.dot(a,d),(u*=_)<0?Number.NaN:u)},__static(K,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempVector34",function(){return this._tempVector34=new Vector3},"_tempVector35",function(){return this._tempVector35=new Vector3},"_tempVector36",function(){return this._tempVector36=new Vector3},"_tempVector37",function(){return this._tempVector37=new Vector3}]),K}(),Size=function(){function e(e,t){this._width=0,this._height=0,this._width=e,this._height=t}__class(e,"laya.d3.utils.Size",!0);var t=e.prototype;return __getset(0,t,"height",function(){return-1==this._height?RenderState.clientHeight:this._height}),__getset(0,t,"width",function(){return-1==this._width?RenderState.clientWidth:this._width}),__getset(1,e,"fullScreen",function(){return new e(-1,-1)}),e}(),MathUtils3D=function(){function n(){}return __class(n,"laya.d3.math.MathUtils3D",!0),n.isZero=function(e){return Math.abs(e)<n.zeroTolerance},n.nearEqual=function(e,t){return!!n.isZero(e-t)},n.fastInvSqrt=function(e){return n.isZero(e)?e:1/Math.sqrt(e)},__static(n,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=340282347e30},"MinValue",function(){return this.MinValue=-340282347e30}]),n}(),Rand=function(){function e(e){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}__class(e,"laya.d3.math.Rand",!0);var t=e.prototype;return t.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]},t.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},t.getSignedFloat=function(){return 2*this.getFloat()-1},__getset(0,t,"seed",function(){return this.seeds[0]},function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),e.getFloatFromInt=function(e){return 1/8388607*(8388607&e)},e.getByteFromInt=function(e){return(8388607&e)>>>15},e}(),Matrix3x3=function(){function l(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}__class(l,"laya.d3.math.Matrix3x3",!0);var e=l.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],_=e[8];return t*(_*a-o*l)+n*(-_*r+o*s)+i*(l*r-a*s)},e.translate=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],_=i[4],h=i[5],c=i[6],u=i[7],d=i[8],f=r[0],m=r[1];n[0]=a,n[1]=o,n[2]=s,n[3]=l,n[4]=_,n[5]=h,n[6]=f*a+m*l+c,n[7]=f*o+m*_+u,n[8]=f*s+m*h+d},e.rotate=function(e,t){var n=t.elements,i=this.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=i[4],_=i[5],h=i[6],c=i[7],u=i[8],d=Math.sin(e),f=Math.cos(e);n[0]=f*r+d*s,n[1]=f*a+d*l,n[2]=f*o+d*_,n[3]=f*s-d*r,n[4]=f*l-d*a,n[5]=f*_-d*o,n[6]=h,n[7]=c,n[8]=u},e.scale=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=r[0],o=r[1];n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=o*i[3],n[4]=o*i[4],n[5]=o*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]},e.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],_=n[6],h=n[7],c=n[8],u=c*s-l*h,d=-c*o+l*_,f=h*o-s*_,m=i*u+r*d+a*f;m||(e=null),m=1/m,t[0]=u*m,t[1]=(-c*r+a*h)*m,t[2]=(l*r-a*s)*m,t[3]=d*m,t[4]=(c*i-a*_)*m,t[5]=(-l*i+a*o)*m,t[6]=f*m,t[7]=(-h*i+r*_)*m,t[8]=(s*i-r*o)*m},e.transpose=function(e){var t=e.elements,n=this.elements;if(e==this){var i=n[1],r=n[2],a=n[5];t[1]=n[3],t[2]=n[6],t[3]=i,t[5]=n[7],t[6]=r,t[7]=a}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]},e.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},e.cloneTo=function(e){var t,n,i;if((n=this.elements)!=(i=e.elements))for(t=0;t<9;++t)i[t]=n[t]},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},l.createFromTranslation=function(e,t){t.elements;var n=e.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=n[0],t[7]=n[1],t[8]=1},l.createFromRotation=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[0]=r,n[1]=i,n[2]=0,n[3]=-i,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1},l.createFromScaling=function(e,t){var n=t.elements,i=e.elements;n[0]=i[0],n[1]=0,n[2]=0,n[3]=0,n[4]=i[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1},l.createFromMatrix4x4=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]},l.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,o=r[0],s=r[1],l=r[2],_=r[3],h=r[4],c=r[5],u=r[6],d=r[7],f=r[8],m=a[0],p=a[1],g=a[2],E=a[3],v=a[4],x=a[5],S=a[6],D=a[7],T=a[8];i[0]=m*o+p*_+g*u,i[1]=m*s+p*h+g*d,i[2]=m*l+p*c+g*f,i[3]=E*o+v*_+x*u,i[4]=E*s+v*h+x*d,i[5]=E*l+v*c+x*f,i[6]=S*o+D*_+T*u,i[7]=S*s+D*h+T*d,i[8]=S*l+D*c+T*f},l.lookAt=function(e,t,n,i){Vector3.subtract(e,t,l._tempV30),Vector3.normalize(l._tempV30,l._tempV30),Vector3.cross(n,l._tempV30,l._tempV31),Vector3.normalize(l._tempV31,l._tempV31),Vector3.cross(l._tempV30,l._tempV31,l._tempV32);var r=l._tempV30.elements,a=l._tempV31.elements,o=l._tempV32.elements,s=i.elements;s[0]=a[0],s[3]=a[1],s[6]=a[2],s[1]=o[0],s[4]=o[1],s[7]=o[2],s[2]=r[0],s[5]=r[1],s[8]=r[2]},l.DEFAULT=new l,__static(l,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3}]),l}(),Viewport=function(){function a(e,t,n,i){this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}__class(a,"laya.d3.math.Viewport",!0);var e=a.prototype;return e.project=function(e,t,n){Vector3.transformV3ToV3(e,t,n);var i=e.elements,r=t.elements,a=n.elements,o=i[0]*r[3]+i[1]*r[7]+i[2]*r[11]+r[15];1!=o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(1-a[1])*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},e.unprojectFromMat=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=(i[0]-this.x)/this.width*2-1,a[1]=-((i[1]-this.y)/this.height*2-1);var o=(this.maxDepth-this.minDepth)/2;a[2]=(i[2]-this.minDepth-o)/o;var s=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];Vector3.transformV3ToV3(n,t,n),1!=s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s)},e.unprojectFromWVP=function(e,t,n,i,r){Matrix4x4.multiply(t,n,a._tempMatrix4x4),i&&Matrix4x4.multiply(a._tempMatrix4x4,i,a._tempMatrix4x4),a._tempMatrix4x4.invert(a._tempMatrix4x4),this.unprojectFromMat(e,a._tempMatrix4x4,r)},__static(a,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Matrix4x4}]),a}(),Vector4=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0);var r=this.elements;r[0]=e,r[1]=t,r[2]=n,r[3]=i}__class(e,"laya.d3.math.Vector4",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]},t.cloneTo=function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},__getset(0,t,"w",function(){return this.elements[3]},function(e){this.elements[3]=e}),__getset(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),__getset(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),__getset(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],_=a[2],h=a[3];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=_+n*(o[2]-_),r[3]=h+n*(o[3]-h)},e.transformByM4x4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=t.elements,_=n.elements;_[0]=r*l[0]+a*l[4]+o*l[8]+s*l[12],_[1]=r*l[1]+a*l[5]+o*l[9]+s*l[13],_[2]=r*l[2]+a*l[6]+o*l[10]+s*l[14],_[3]=r*l[3]+a*l[7]+o*l[11]+s*l[15]},e.equals=function(e,t){var n=e.elements,i=t.elements;return MathUtils3D.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&MathUtils3D.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&MathUtils3D.nearEqual(Math.abs(n[2]),Math.abs(i[2]))&&MathUtils3D.nearEqual(Math.abs(n[3]),Math.abs(i[3]))},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=e.length();0<r&&(i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[3]=n[3]*r)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2],i[3]=r[3]-a[3]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2],i[3]=r[3]*a[3]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t,i[3]=r[3]*t},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],o=r[1],s=r[2],l=r[3],_=t.elements,h=_[0],c=_[1],u=_[2],d=_[3],f=n.elements,m=f[0],p=f[1],g=f[2],E=f[3],v=i.elements;a=(a=m<a?m:a)<h?h:a,o=(o=p<o?p:o)<c?c:o,s=(s=g<s?g:s)<u?u:s,l=(l=E<l?E:l)<d?d:l,v[0]=a,v[1]=o,v[2]=s,v[3]=l},e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return r*r+a*a+o*o+s*s},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return Math.sqrt(r*r+a*a+o*o+s*s)},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2]),i[3]=Math.min(r[3],a[3])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2]),i[3]=Math.max(r[3],a[3])},__static(e,["ZERO",function(){return this.ZERO=new e},"ONE",function(){return this.ONE=new e(1,1,1,1)},"UnitX",function(){return this.UnitX=new e(1,0,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1,0)},"UnitW",function(){return this.UnitW=new e(0,0,0,1)}]),e}(),ContainmentType=function(){function e(){}return __class(e,"laya.d3.math.ContainmentType",!0),e.Disjoint=0,e.Contains=1,e.Intersects=2,e}(),OrientedBoundBox=function(){function v(e,t){this.extents=null,this.transformation=null,this.extents=e,this.transformation=t}__class(v,"laya.d3.math.OrientedBoundBox",!0);var e=v.prototype;return e.getCorners=function(e){var t=v._tempV30.elements,n=v._tempV31.elements,i=v._tempV32.elements,r=this.extents.elements;t[0]=r[0],t[1]=t[2]=0,n[1]=r[1],n[0]=n[2]=0,i[2]=r[2],i[0]=i[1]=0,Vector3.TransformNormal(v._tempV30,this.transformation,v._tempV30),Vector3.TransformNormal(v._tempV31,this.transformation,v._tempV31),Vector3.TransformNormal(v._tempV32,this.transformation,v._tempV32);var a=v._tempV33;this.transformation.getTranslationVector(a),e.length=8,Vector3.add(a,v._tempV30,v._tempV34),Vector3.add(v._tempV34,v._tempV31,v._tempV34),Vector3.add(v._tempV34,v._tempV32,e[0]),Vector3.add(a,v._tempV30,v._tempV34),Vector3.add(v._tempV34,v._tempV31,v._tempV34),Vector3.subtract(v._tempV34,v._tempV32,e[1]),Vector3.subtract(a,v._tempV30,v._tempV34),Vector3.add(v._tempV34,v._tempV31,v._tempV34),Vector3.subtract(v._tempV34,v._tempV32,e[2]),Vector3.subtract(a,v._tempV30,v._tempV34),Vector3.add(v._tempV34,v._tempV31,v._tempV34),Vector3.add(v._tempV34,v._tempV32,e[3]),Vector3.add(a,v._tempV30,v._tempV34),Vector3.subtract(v._tempV34,v._tempV31,v._tempV34),Vector3.add(v._tempV34,v._tempV32,e[4]),Vector3.add(a,v._tempV30,v._tempV34),Vector3.subtract(v._tempV34,v._tempV31,v._tempV34),Vector3.subtract(v._tempV34,v._tempV32,e[5]),Vector3.subtract(a,v._tempV30,v._tempV34),Vector3.subtract(v._tempV34,v._tempV31,v._tempV34),Vector3.subtract(v._tempV34,v._tempV32,e[6]),Vector3.subtract(a,v._tempV30,v._tempV34),Vector3.subtract(v._tempV34,v._tempV31,v._tempV34),Vector3.add(v._tempV34,v._tempV32,e[7])},e.transform=function(e){Matrix4x4.multiply(this.transformation,e,this.transformation)},e.scale=function(e){Vector3.multiply(this.extents,e,this.extents)},e.translate=function(e){this.transformation.getTranslationVector(v._tempV30),Vector3.add(v._tempV30,e,v._tempV31),this.transformation.setTranslationVector(v._tempV31)},e.Size=function(e){Vector3.scale(this.extents,2,e)},e.getSize=function(e){var t=this.extents.elements;v._tempV30.x=t[0],v._tempV31.y=t[1],v._tempV32.z=t[2],Vector3.TransformNormal(v._tempV30,this.transformation,v._tempV30),Vector3.TransformNormal(v._tempV31,this.transformation,v._tempV31),Vector3.TransformNormal(v._tempV31,this.transformation,v._tempV32);var n=e.elements;n[0]=Vector3.scalarLength(v._tempV30),n[1]=Vector3.scalarLength(v._tempV31),n[2]=Vector3.scalarLength(v._tempV32)},e.getSizeSquared=function(e){var t=this.extents.elements;v._tempV30.x=t[0],v._tempV31.y=t[1],v._tempV32.z=t[2],Vector3.TransformNormal(v._tempV30,this.transformation,v._tempV30),Vector3.TransformNormal(v._tempV31,this.transformation,v._tempV31),Vector3.TransformNormal(v._tempV31,this.transformation,v._tempV32);var n=e.elements;n[0]=Vector3.scalarLengthSquared(v._tempV30),n[1]=Vector3.scalarLengthSquared(v._tempV31),n[2]=Vector3.scalarLengthSquared(v._tempV32)},e.getCenter=function(e){this.transformation.getTranslationVector(e)},e.containsPoint=function(e){var t=this.extents.elements,n=t[0],i=t[1],r=t[2];this.transformation.invert(v._tempM0),Vector3.transformCoordinate(e,v._tempM0,v._tempV30);var a=v._tempV30.elements,o=Math.abs(a[0]),s=Math.abs(a[1]),l=Math.abs(a[2]);return MathUtils3D.nearEqual(o,n)&&MathUtils3D.nearEqual(s,i)&&MathUtils3D.nearEqual(l,r)?2:o<n&&s<i&&l<r?1:0},e.containsPoints=function(e){var t=this.extents.elements,n=t[0],i=t[1],r=t[2];this.transformation.invert(v._tempM0);for(var a=!0,o=!1,s=0;s<e.length;s++){Vector3.transformCoordinate(e[s],v._tempM0,v._tempV30);var l=v._tempV30.elements,_=Math.abs(l[0]),h=Math.abs(l[1]),c=Math.abs(l[2]);MathUtils3D.nearEqual(_,n)&&MathUtils3D.nearEqual(h,i)&&MathUtils3D.nearEqual(c,r)&&(o=!0),_<n&&h<i&&c<r?o=!0:a=!1}return a?1:o?2:0},e.containsSphere=function(e,t){void 0===t&&(t=!1);var n=this.extents.elements,i=n[0],r=n[1],a=n[2],o=e.radius;this.transformation.invert(v._tempM0),Vector3.transformCoordinate(e.center,v._tempM0,v._tempV30);var s=NaN;if(s=t?o:(Vector3.scale(Vector3.UnitX,o,v._tempV31),Vector3.TransformNormal(v._tempV31,v._tempM0,v._tempV31),Vector3.scalarLength(v._tempV31)),Vector3.scale(this.extents,-1,v._tempV32),Vector3.Clamp(v._tempV30,v._tempV32,this.extents,v._tempV33),s*s<Vector3.distanceSquared(v._tempV30,v._tempV33))return 0;var l=v._tempV30.elements,_=l[0],h=l[1],c=l[2],u=v._tempV32.elements,d=u[0],f=u[1],m=u[2];return d+s<=_&&_<=i-s&&s<i-d&&f+s<=h&&h<=r-s&&s<r-f&&m+s<=c&&c<=a-s&&s<a-m?1:2},e.containsOrientedBoundBox=function(e){var t=0,n=0;e.getCorners(v._corners);var i=this.containsPoints(v._corners);if(0!=i)return i;var r=this.extents.elements;e.extents.cloneTo(v._tempV35);var a=v._tempV35.elements;v._getRows(this.transformation,v._rows1),v._getRows(e.transformation,v._rows2);var o=NaN;for(t=0;t<4;t++)for(n=0;n<4;n++)3==t||3==n?(v._tempM0.setElementByRowColumn(t,n,0),v._tempM1.setElementByRowColumn(t,n,0)):(o=Vector3.dot(v._rows1[t],v._rows2[n]),v._tempM0.setElementByRowColumn(t,n,o),v._tempM1.setElementByRowColumn(t,n,Math.abs(o)));e.getCenter(v._tempV34),this.getCenter(v._tempV36),Vector3.subtract(v._tempV34,v._tempV36,v._tempV30);var s=v._tempV31.elements;s[0]=Vector3.dot(v._tempV30,v._rows1[0]),s[1]=Vector3.dot(v._tempV30,v._rows1[1]),s[2]=Vector3.dot(v._tempV30,v._rows1[2]);var l=v._tempV32.elements,_=v._tempV33.elements;for(t=0;t<3;t++)if(l[0]=v._tempM1.getElementByRowColumn(t,0),l[1]=v._tempM1.getElementByRowColumn(t,1),l[2]=v._tempM1.getElementByRowColumn(t,2),r[t]+Vector3.dot(v._tempV35,v._tempV32)<Math.abs(s[t]))return 0;for(n=0;n<3;n++)if(l[0]=v._tempM1.getElementByRowColumn(0,n),l[1]=v._tempM1.getElementByRowColumn(1,n),l[2]=v._tempM1.getElementByRowColumn(2,n),_[0]=v._tempM0.getElementByRowColumn(0,n),_[1]=v._tempM0.getElementByRowColumn(1,n),_[2]=v._tempM0.getElementByRowColumn(2,n),Vector3.dot(this.extents,v._tempV32)+a[n]<Math.abs(Vector3.dot(v._tempV31,v._tempV33)))return 0;for(t=0;t<3;t++)for(n=0;n<3;n++){var h=(t+1)%3,c=(t+2)%3,u=(n+1)%3,d=(n+2)%3;if(r[h]*v._tempM1.getElementByRowColumn(c,n)+r[c]*v._tempM1.getElementByRowColumn(h,n)+(a[u]*v._tempM1.getElementByRowColumn(t,d)+a[d]*v._tempM1.getElementByRowColumn(t,u))<Math.abs(s[c]*v._tempM0.getElementByRowColumn(h,n)-s[h]*v._tempM0.getElementByRowColumn(c,n)))return 0}return 2},e.containsLine=function(e,t){v._corners[0]=e,v._corners[1]=t;var n=this.containsPoints(v._corners);if(0!=n)return n;var i=this.extents.elements,r=i[0],a=i[1],o=i[2];this.transformation.invert(v._tempM0),Vector3.transformCoordinate(e,v._tempM0,v._tempV30),Vector3.transformCoordinate(t,v._tempM0,v._tempV31),Vector3.add(v._tempV30,v._tempV31,v._tempV32),Vector3.scale(v._tempV32,.5,v._tempV32),Vector3.subtract(v._tempV30,v._tempV32,v._tempV33);var s=v._tempV33.elements,l=s[0],_=s[1],h=s[2],c=v._tempV34.elements,u=c[0]=Math.abs(s[0]),d=c[1]=Math.abs(s[1]),f=c[2]=Math.abs(s[2]),m=v._tempV32.elements,p=m[0],g=m[1],E=m[2];return Math.abs(p)>r+u?0:Math.abs(g)>a+d?0:Math.abs(E)>o+f?0:Math.abs(g*h-E*_)>a*f+o*d?0:Math.abs(p*h-E*l)>r*f+o*u?0:Math.abs(p*_-g*l)>r*d+a*u?0:2},e.containsBoundBox=function(e){var t=0,n=0,i=e.min,r=e.max;e.getCorners(v._corners);var a=this.containsPoints(v._corners);if(0!=a)return a;Vector3.subtract(r,i,v._tempV30),Vector3.scale(v._tempV30,.5,v._tempV30),Vector3.add(i,v._tempV30,v._tempV30),Vector3.subtract(r,v._tempV30,v._tempV31);var o=this.extents.elements,s=v._tempV31.elements;v._getRows(this.transformation,v._rows1),this.transformation.invert(v._tempM0);for(t=0;t<3;t++)for(n=0;n<3;n++)v._tempM1.setElementByRowColumn(t,n,Math.abs(v._tempM0.getElementByRowColumn(t,n)));this.getCenter(v._tempV35),Vector3.subtract(v._tempV30,v._tempV35,v._tempV32);var l=v._tempV31.elements;l[0]=Vector3.dot(v._tempV32,v._rows1[0]),l[1]=Vector3.dot(v._tempV32,v._rows1[1]),l[2]=Vector3.dot(v._tempV32,v._rows1[2]);var _=v._tempV33.elements,h=v._tempV34.elements;for(t=0;t<3;t++)if(_[0]=v._tempM1.getElementByRowColumn(t,0),_[1]=v._tempM1.getElementByRowColumn(t,1),_[2]=v._tempM1.getElementByRowColumn(t,2),o[t]+Vector3.dot(v._tempV31,v._tempV33)<Math.abs(l[t]))return 0;for(n=0;n<3;n++)if(_[0]=v._tempM1.getElementByRowColumn(0,n),_[1]=v._tempM1.getElementByRowColumn(1,n),_[2]=v._tempM1.getElementByRowColumn(2,n),h[0]=v._tempM0.getElementByRowColumn(0,n),h[1]=v._tempM0.getElementByRowColumn(1,n),h[2]=v._tempM0.getElementByRowColumn(2,n),Vector3.dot(this.extents,v._tempV33)+s[n]<Math.abs(Vector3.dot(v._tempV31,v._tempV34)))return 0;for(t=0;t<3;t++)for(n=0;n<3;n++){var c=(t+1)%3,u=(t+2)%3,d=(n+1)%3,f=(n+2)%3;if(o[c]*v._tempM1.getElementByRowColumn(u,n)+o[u]*v._tempM1.getElementByRowColumn(c,n)+(s[d]*v._tempM1.getElementByRowColumn(t,f)+s[f]*v._tempM1.getElementByRowColumn(t,d))<Math.abs(l[u]*v._tempM0.getElementByRowColumn(c,n)-l[c]*v._tempM0.getElementByRowColumn(u,n)))return 0}return 2},e.intersectsRay=function(e,t){Vector3.scale(this.extents,-1,v._tempV30),this.transformation.invert(v._tempM0),Vector3.TransformNormal(e.direction,v._tempM0,v._ray.direction),Vector3.transformCoordinate(e.origin,v._tempM0,v._ray.origin),v._boxBound1.min=v._tempV30,v._boxBound1.max=this.extents;var n=Collision.intersectsRayAndBoxRP(v._ray,v._boxBound1,t);return-1!=n&&Vector3.transformCoordinate(t,this.transformation,t),n},e._getLocalCorners=function(e){e.length=8;var t=this.extents.elements;v._tempV30.x=t[0],v._tempV31.y=t[1],v._tempV32.z=t[2],Vector3.add(v._tempV30,v._tempV31,v._tempV33),Vector3.add(v._tempV33,v._tempV32,e[0]),Vector3.add(v._tempV30,v._tempV31,v._tempV33),Vector3.subtract(v._tempV33,v._tempV32,e[1]),Vector3.subtract(v._tempV31,v._tempV30,v._tempV33),Vector3.subtract(v._tempV33,v._tempV30,e[2]),Vector3.subtract(v._tempV31,v._tempV30,v._tempV33),Vector3.add(v._tempV33,v._tempV32,e[3]),Vector3.subtract(v._tempV30,v._tempV31,v._tempV33),Vector3.add(v._tempV33,v._tempV32,e[4]),Vector3.subtract(v._tempV30,v._tempV31,v._tempV33),Vector3.subtract(v._tempV33,v._tempV32,e[5]),Vector3.scale(e[0],-1,e[6]),Vector3.subtract(v._tempV32,v._tempV30,v._tempV33),Vector3.subtract(v._tempV33,v._tempV31,e[7])},e.equals=function(e){return this.extents==e.extents&&this.transformation==e.transformation},e.cloneTo=function(e){var t=e;this.extents.cloneTo(t.extents),this.transformation.cloneTo(t.transformation)},v.createByBoundBox=function(e,t){var n=e.min,i=e.max;Vector3.subtract(i,n,v._tempV30),Vector3.scale(v._tempV30,.5,v._tempV30),Vector3.add(n,v._tempV30,v._tempV31),Vector3.subtract(i,v._tempV31,v._tempV32),Matrix4x4.translation(v._tempV31,v._tempM0);var r=v._tempV32.clone(),a=v._tempM0.clone();t.extents=r,t.transformation=a},v.createByMinAndMaxVertex=function(e,t){return Vector3.subtract(t,e,v._tempV30),Vector3.scale(v._tempV30,.5,v._tempV30),Vector3.add(e,v._tempV30,v._tempV31),Vector3.subtract(t,v._tempV31,v._tempV32),Matrix4x4.translation(v._tempV31,v._tempM0),new v(v._tempV32,v._tempM0)},v._getRows=function(e,t){t.length=3;var n=e.elements,i=t[0].elements;i[0]=n[0],i[1]=n[1],i[2]=n[2];var r=t[1].elements;r[0]=n[4],r[1]=n[5],r[2]=n[6];var a=t[2].elements;a[0]=n[8],a[1]=n[9],a[2]=n[10]},v.getObbtoObbMatrix4x4=function(e,t,n,i){var r=e.transformation,a=t.transformation;if(n){v._getRows(r,v._rows1),v._getRows(a,v._rows2);for(var o=0;o<3;o++)for(var s=0;s<3;s++)i.setElementByRowColumn(o,s,Vector3.dot(v._rows2[o],v._rows1[s]));t.getCenter(v._tempV30),e.getCenter(v._tempV31),Vector3.subtract(v._tempV30,v._tempV31,v._tempV32);var l=i.elements;l[12]=Vector3.dot(v._tempV32,v._rows1[0]),l[13]=Vector3.dot(v._tempV32,v._rows1[1]),l[14]=Vector3.dot(v._tempV32,v._rows1[2]),l[15]=1}else r.invert(v._tempM0),Matrix4x4.multiply(a,v._tempM0,i)},v.merge=function(e,t,n){var i=e.extents,r=e.transformation;v.getObbtoObbMatrix4x4(e,t,n,v._tempM0),t._getLocalCorners(v._corners),Vector3.transformCoordinate(v._corners[0],v._tempM0,v._corners[0]),Vector3.transformCoordinate(v._corners[1],v._tempM0,v._corners[1]),Vector3.transformCoordinate(v._corners[2],v._tempM0,v._corners[2]),Vector3.transformCoordinate(v._corners[3],v._tempM0,v._corners[3]),Vector3.transformCoordinate(v._corners[4],v._tempM0,v._corners[4]),Vector3.transformCoordinate(v._corners[5],v._tempM0,v._corners[5]),Vector3.transformCoordinate(v._corners[6],v._tempM0,v._corners[6]),Vector3.transformCoordinate(v._corners[7],v._tempM0,v._corners[7]),Vector3.scale(i,-1,v._boxBound1.min),i.cloneTo(v._boxBound1.max),BoundBox.createfromPoints(v._corners,v._boxBound2),BoundBox.merge(v._boxBound2,v._boxBound1,v._boxBound3);var a=v._boxBound3.min,o=v._boxBound3.max;Vector3.subtract(o,a,v._tempV30),Vector3.scale(v._tempV30,.5,v._tempV30),Vector3.add(a,v._tempV30,v._tempV32),Vector3.subtract(o,v._tempV32,i),Vector3.transformCoordinate(v._tempV32,r,v._tempV33)},__static(v,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3},"_tempM0",function(){return this._tempM0=new Matrix4x4},"_tempM1",function(){return this._tempM1=new Matrix4x4},"_corners",function(){return this._corners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]},"_rows1",function(){return this._rows1=[new Vector3,new Vector3,new Vector3]},"_rows2",function(){return this._rows2=[new Vector3,new Vector3,new Vector3]},"_ray",function(){return this._ray=new Ray(new Vector3,new Vector3)},"_boxBound1",function(){return this._boxBound1=new BoundBox(new Vector3,new Vector3)},"_boxBound2",function(){return this._boxBound2=new BoundBox(new Vector3,new Vector3)},"_boxBound3",function(){return this._boxBound3=new BoundBox(new Vector3,new Vector3)}]),v}(),Plane=function(){function S(e,t){this.normal=null,this.distance=NaN,void 0===t&&(t=0),this.normal=e,this.distance=t}return __class(S,"laya.d3.math.Plane",!0),S.prototype.normalize=function(){var e=this.normal.elements,t=e[0],n=e[1],i=e[2],r=1/Math.sqrt(t*t+n*n+i*i);e[0]=t*r,e[1]=n*r,e[2]=i*r,this.distance*=r},S.createPlaneBy3P=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=r[0]-i[0],s=r[1]-i[1],l=r[2]-i[2],_=a[0]-i[0],h=a[1]-i[1],c=a[2]-i[2],u=s*c-l*h,d=l*_-o*c,f=o*h-s*_,m=1/Math.sqrt(u*u+d*d+f*f),p=u*m,g=d*m,E=f*m,v=S._TEMPVec3.elements;v[0]=p,v[1]=g,v[2]=E;var x=-(p*i[0]+g*i[1]+E*i[2]);return new S(S._TEMPVec3,x)},S.PlaneIntersectionType_Back=0,S.PlaneIntersectionType_Front=1,S.PlaneIntersectionType_Intersecting=2,__static(S,["_TEMPVec3",function(){return this._TEMPVec3=new Vector3}]),S}(),BoundBox=function(){function e(e,t){this.min=null,this.max=null,this.min=e,this.max=t}__class(e,"laya.d3.math.BoundBox",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.getCorners=function(e){e.length=8;var t=this.min.elements,n=this.max.elements,i=t[0],r=t[1],a=t[2],o=n[0],s=n[1],l=n[2];e[0]=new Vector3(i,s,l),e[1]=new Vector3(o,s,l),e[2]=new Vector3(o,r,l),e[3]=new Vector3(i,r,l),e[4]=new Vector3(i,s,a),e[5]=new Vector3(o,s,a),e[6]=new Vector3(o,r,a),e[7]=new Vector3(i,r,a)},t.toDefault=function(){this.min.toDefault(),this.max.toDefault()},t.cloneTo=function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)},t.clone=function(){var e=new this.constructor(new Vector3,new Vector3);return this.cloneTo(e),e},e.createfromPoints=function(e,t){if(null==e)throw new Error("points");var n=t.min,i=t.max,r=n.elements;r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE;var a=i.elements;a[0]=-Number.MAX_VALUE,a[1]=-Number.MAX_VALUE,a[2]=-Number.MAX_VALUE;for(var o=0,s=e.length;o<s;++o)Vector3.min(n,e[o],n),Vector3.max(i,e[o],i)},e.merge=function(e,t,n){Vector3.min(e.min,t.min,n.min),Vector3.max(e.max,t.max,n.max)},e}(),Matrix4x4=function(){function V(e,t,n,i,r,a,o,s,l,_,h,c,u,d,f,m){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===l&&(l=0),void 0===_&&(_=0),void 0===h&&(h=1),void 0===c&&(c=0),void 0===u&&(u=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=e,p[1]=t,p[2]=n,p[3]=i,p[4]=r,p[5]=a,p[6]=o,p[7]=s,p[8]=l,p[9]=_,p[10]=h,p[11]=c,p[12]=u,p[13]=d,p[14]=f,p[15]=m}__class(V,"laya.d3.math.Matrix4x4",!0);var e=V.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.getElementByRowColumn=function(e,t){if(e<0||3<e)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||3<t)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]},e.setElementByRowColumn=function(e,t,n){if(e<0||3<e)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||3<t)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n},e.equalsOtherMatrix=function(e){var t=this.elements,n=e.elements;return MathUtils3D.nearEqual(t[0],n[0])&&MathUtils3D.nearEqual(t[1],n[1])&&MathUtils3D.nearEqual(t[2],n[2])&&MathUtils3D.nearEqual(t[3],n[3])&&MathUtils3D.nearEqual(t[4],n[4])&&MathUtils3D.nearEqual(t[5],n[5])&&MathUtils3D.nearEqual(t[6],n[6])&&MathUtils3D.nearEqual(t[7],n[7])&&MathUtils3D.nearEqual(t[8],n[8])&&MathUtils3D.nearEqual(t[9],n[9])&&MathUtils3D.nearEqual(t[10],n[10])&&MathUtils3D.nearEqual(t[11],n[11])&&MathUtils3D.nearEqual(t[12],n[12])&&MathUtils3D.nearEqual(t[13],n[13])&&MathUtils3D.nearEqual(t[14],n[14])&&MathUtils3D.nearEqual(t[15],n[15])},e.decomposeTransRotScale=function(e,t,n){var i=V._tempMatrix4x4;return this.decomposeTransRotMatScale(e,i,n)?(Quaternion.createFromMatrix4x4(i,t),!0):(t.identity(),!1)},e.decomposeTransRotMatScale=function(e,t,n){var i=this.elements,r=e.elements,a=t.elements,o=n.elements;r[0]=i[12],r[1]=i[13],r[2]=i[14];var s=i[0],l=i[1],_=i[2],h=i[4],c=i[5],u=i[6],d=i[8],f=i[9],m=i[10],p=o[0]=Math.sqrt(s*s+l*l+_*_),g=o[1]=Math.sqrt(h*h+c*c+u*u),E=o[2]=Math.sqrt(d*d+f*f+m*m);if(MathUtils3D.isZero(p)||MathUtils3D.isZero(g)||MathUtils3D.isZero(E))return a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[12]=a[13]=a[14]=0,a[0]=a[5]=a[10]=a[15]=1,!1;var v=V._tempVector0,x=v.elements;x[0]=d/E,x[1]=f/E,x[2]=m/E;var S=V._tempVector1,D=S.elements;D[0]=s/p,D[1]=l/p,D[2]=_/p;var T=V._tempVector2;Vector3.cross(v,S,T);var M=V._tempVector1;return Vector3.cross(T,v,M),a[3]=a[7]=a[11]=a[12]=a[13]=a[14]=0,a[15]=1,a[0]=M.x,a[1]=M.y,a[2]=M.z,a[4]=T.x,a[5]=T.y,a[6]=T.z,a[8]=v.x,a[9]=v.y,a[10]=v.z,a[0]*s+a[1]*l+a[2]*_<0&&(o[0]=-p),a[4]*h+a[5]*c+a[6]*u<0&&(o[1]=-g),a[8]*d+a[9]*f+a[10]*m<0&&(o[2]=-E),!0},e.decomposeYawPitchRoll=function(e){var t=e.elements,n=Math.asin(-this.elements[9]);t[1]=n,Math.cos(n)>MathUtils3D.zeroTolerance?(t[2]=Math.atan2(this.elements[1],this.elements[5]),t[0]=Math.atan2(this.elements[8],this.elements[10])):(t[2]=Math.atan2(-this.elements[4],this.elements[0]),t[0]=0)},e.normalize=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=Math.sqrt(t*t+n*n+i*i);if(!r)return e[0]=0,e[1]=0,void(e[2]=0);1!=r&&(r=1/r,e[0]=t*r,e[1]=n*r,e[2]=i*r)},e.transpose=function(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},e.invert=function(e){var t=this.elements,n=e.elements,i=t[0],r=t[1],a=t[2],o=t[3],s=t[4],l=t[5],_=t[6],h=t[7],c=t[8],u=t[9],d=t[10],f=t[11],m=t[12],p=t[13],g=t[14],E=t[15],v=i*l-r*s,x=i*_-a*s,S=i*h-o*s,D=r*_-a*l,T=r*h-o*l,M=a*h-o*_,V=c*p-u*m,R=c*g-d*m,A=c*E-f*m,C=u*g-d*p,I=u*E-f*p,y=d*E-f*g,N=v*y-x*I+S*C+D*A-T*R+M*V;0!=Math.abs(N)&&(N=1/N,n[0]=(l*y-_*I+h*C)*N,n[1]=(a*I-r*y-o*C)*N,n[2]=(p*M-g*T+E*D)*N,n[3]=(d*T-u*M-f*D)*N,n[4]=(_*A-s*y-h*R)*N,n[5]=(i*y-a*A+o*R)*N,n[6]=(g*S-m*M-E*x)*N,n[7]=(c*M-d*S+f*x)*N,n[8]=(s*I-l*A+h*V)*N,n[9]=(r*A-i*I-o*V)*N,n[10]=(m*T-p*S+E*v)*N,n[11]=(u*S-c*T-f*v)*N,n[12]=(l*R-s*C-_*V)*N,n[13]=(i*C-r*R+a*V)*N,n[14]=(p*x-m*D-g*v)*N,n[15]=(c*D-u*x+d*v)*N)},e.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},e.cloneTo=function(e){var t,n,i;if((n=this.elements)!=(i=e.elements))for(t=0;t<16;++t)i[t]=n[t]},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.getTranslationVector=function(e){var t=this.elements,n=e.elements;n[0]=t[12],n[1]=t[13],n[2]=t[14]},e.setTranslationVector=function(e){var t=this.elements,n=e.elements;t[12]=n[0],t[13]=n[1],t[14]=n[2]},e.getForward=function(e){var t=this.elements,n=e.elements;n[0]=-t[8],n[1]=-t[9],n[2]=-t[10]},e.setForward=function(e){var t=this.elements,n=e.elements;t[8]=-n[0],t[9]=-n[1],t[10]=-n[2]},V.createRotationX=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=r,n[6]=i,n[9]=-i},V.createRotationY=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=r,n[2]=-i,n[8]=i},V.createRotationZ=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=r,n[1]=i,n[4]=-i},V.createRotationYawPitchRoll=function(e,t,n,i){Quaternion.createFromYawPitchRoll(e,t,n,V._tempQuaternion),V.createRotationQuaternion(V._tempQuaternion,i)},V.createRotationAxis=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=Math.cos(t),l=Math.sin(t),_=r*r,h=a*a,c=o*o,u=r*a,d=r*o,f=a*o,m=n.elements;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=_+s*(1-_),m[1]=u-s*u+l*o,m[2]=d-s*d-l*a,m[4]=u-s*u-l*o,m[5]=h+s*(1-h),m[6]=f-s*f+l*r,m[8]=d-s*d+l*a,m[9]=f-s*f-l*r,m[10]=c+s*(1-c)},V.createRotationQuaternion=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],l=r*r,_=a*a,h=o*o,c=r*a,u=o*s,d=o*r,f=a*s,m=a*o,p=r*s;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(_+h),i[1]=2*(c+u),i[2]=2*(d-f),i[4]=2*(c-u),i[5]=1-2*(h+l),i[6]=2*(m+p),i[8]=2*(d+f),i[9]=2*(m-p),i[10]=1-2*(_+l)},V.createTranslate=function(e,t){var n=e.elements,i=t.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},V.createScaling=function(e,t){var n=e.elements,i=t.elements;i[0]=n[0],i[5]=n[1],i[10]=n[2],i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1},V.multiply=function(e,t,n){var i,r,a,o,s,l,_,h;if(r=n.elements,a=e.elements,r==(o=t.elements))for(o=new Float32Array(16),i=0;i<16;++i)o[i]=r[i];for(i=0;i<4;i++)s=a[i],l=a[i+4],_=a[i+8],h=a[i+12],r[i]=s*o[0]+l*o[1]+_*o[2]+h*o[3],r[i+4]=s*o[4]+l*o[5]+_*o[6]+h*o[7],r[i+8]=s*o[8]+l*o[9]+_*o[10]+h*o[11],r[i+12]=s*o[12]+l*o[13]+_*o[14]+h*o[15]},V.createFromQuaternion=function(e,t){var n=t.elements,i=e.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=r+r,_=a+a,h=o+o,c=r*l,u=a*l,d=a*_,f=o*l,m=o*_,p=o*h,g=s*l,E=s*_,v=s*h;n[0]=1-d-p,n[1]=u+v,n[2]=f-E,n[3]=0,n[4]=u-v,n[5]=1-c-p,n[6]=m+g,n[7]=0,n[8]=f+E,n[9]=m-g,n[10]=1-c-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},V.createAffineTransformation=function(e,t,n,i){var r=e.elements,a=t.elements,o=n.elements,s=i.elements,l=a[0],_=a[1],h=a[2],c=a[3],u=l+l,d=_+_,f=h+h,m=l*u,p=l*d,g=l*f,E=_*d,v=_*f,x=h*f,S=c*u,D=c*d,T=c*f,M=o[0],V=o[1],R=o[2];s[0]=(1-(E+x))*M,s[1]=(p+T)*M,s[2]=(g-D)*M,s[3]=0,s[4]=(p-T)*V,s[5]=(1-(m+x))*V,s[6]=(v+S)*V,s[7]=0,s[8]=(g+D)*R,s[9]=(v-S)*R,s[10]=(1-(m+E))*R,s[11]=0,s[12]=r[0],s[13]=r[1],s[14]=r[2],s[15]=1},V.createLookAt=function(e,t,n,i){var r=i.elements,a=V._tempVector0,o=V._tempVector1,s=V._tempVector2;Vector3.subtract(e,t,s),Vector3.normalize(s,s),Vector3.cross(n,s,a),Vector3.normalize(a,a),Vector3.cross(s,a,o),i.identity(),r[0]=a.x,r[4]=a.y,r[8]=a.z,r[1]=o.x,r[5]=o.y,r[9]=o.z,r[2]=s.x,r[6]=s.y,r[10]=s.z,r[12]=-Vector3.dot(a,e),r[13]=-Vector3.dot(o,e),r[14]=-Vector3.dot(s,e)},V.createPerspective=function(e,t,n,i,r){var a=r.elements,o=1/Math.tan(e/2),s=1/(n-i);a[0]=o/t,a[5]=o,a[10]=(i+n)*s,a[11]=-1,a[14]=2*i*n*s,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},V.createOrthoOffCenterRH=function(e,t,n,i,r,a,o){var s=o.elements,l=1/(e-t),_=1/(n-i),h=1/(r-a);s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=0,s[15]=1,s[0]=-2*l,s[5]=-2*_,s[10]=2*h,s[12]=(e+t)*l,s[13]=(i+n)*_,s[14]=(a+r)*h},V.translation=function(e,t){var n=e.elements,i=t.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},__static(V,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new V},"_tempVector0",function(){return this._tempVector0=new Vector3},"_tempVector1",function(){return this._tempVector1=new Vector3},"_tempVector2",function(){return this._tempVector2=new Vector3},"_tempQuaternion",function(){return this._tempQuaternion=new Quaternion},"DEFAULT",function(){return this.DEFAULT=new V},"ZERO",function(){return this.ZERO=new V(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}]),V}(),Ray=function(){function e(e,t){this.origin=null,this.direction=null,this.origin=e,this.direction=t}return __class(e,"laya.d3.math.Ray",!0),e}(),Vector3=function(){function h(e,t,n){this.elements=new Float32Array(3),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0);var i=this.elements;i[0]=e,i[1]=t,i[2]=n}__class(h,"laya.d3.math.Vector3",!0);var e=h.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]},e.cloneTo=function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2]},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},__getset(0,e,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),__getset(0,e,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),__getset(0,e,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),h.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2];return r*r+a*a+o*o},h.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2];return Math.sqrt(r*r+a*a+o*o)},h.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2])},h.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2])},h.transformQuat=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,o=r[0],s=r[1],l=r[2],_=a[0],h=a[1],c=a[2],u=a[3],d=u*o+h*l-c*s,f=u*s+c*o-_*l,m=u*l+_*s-h*o,p=-_*o-h*s-c*l;i[0]=d*u+p*-_+f*-c-m*-h,i[1]=f*u+p*-h+m*-_-d*-c,i[2]=m*u+p*-c+d*-h-f*-_},h.scalarLength=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)},h.scalarLengthSquared=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return n*n+i*i+r*r},h.normalize=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=r*r+a*a+o*o;0<s&&(s=1/Math.sqrt(s),i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s)},h.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2]},h.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t},h.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],_=a[2];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=_+n*(o[2]-_)},h.transformV3ToV3=function(e,t,n){var i=h._tempVector4;h.transformV3ToV4(e,t,i);var r=i.elements,a=n.elements;a[0]=r[0],a[1]=r[1],a[2]=r[2]},h.transformV3ToV4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=r*s[0]+a*s[4]+o*s[8]+s[12],l[1]=r*s[1]+a*s[5]+o*s[9]+s[13],l[2]=r*s[2]+a*s[6]+o*s[10]+s[14],l[3]=r*s[3]+a*s[7]+o*s[11]+s[15]},h.TransformNormal=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=r*s[0]+a*s[4]+o*s[8],l[1]=r*s[1]+a*s[5]+o*s[9],l[2]=r*s[2]+a*s[6]+o*s[10]},h.transformCoordinate=function(e,t,n){var i=h._tempVector4.elements,r=e.elements,a=r[0],o=r[1],s=r[2],l=t.elements;i[0]=a*l[0]+o*l[4]+s*l[8]+l[12],i[1]=a*l[1]+o*l[5]+s*l[9]+l[13],i[2]=a*l[2]+o*l[6]+s*l[10]+l[14],i[3]=1/(a*l[3]+o*l[7]+s*l[11]+l[15]);var _=n.elements;_[0]=i[0]*i[3],_[1]=i[1]*i[3],_[2]=i[2]*i[3]},h.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],o=r[1],s=r[2],l=t.elements,_=l[0],h=l[1],c=l[2],u=n.elements,d=u[0],f=u[1],m=u[2],p=i.elements;a=(a=d<a?d:a)<_?_:a,o=(o=f<o?f:o)<h?h:o,s=(s=m<s?m:s)<c?c:s,p[0]=a,p[1]=o,p[2]=s},h.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2]},h.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2]},h.cross=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],_=r[0],h=r[1],c=r[2];a[0]=s*c-l*h,a[1]=l*_-o*c,a[2]=o*h-s*_},h.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]},h.equals=function(e,t){var n=e.elements,i=t.elements;return MathUtils3D.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&MathUtils3D.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&MathUtils3D.nearEqual(Math.abs(n[2]),Math.abs(i[2]))},h.ZERO=new h(0,0,0),h.ONE=new h(1,1,1),h.NegativeUnitX=new h(-1,0,0),h.UnitX=new h(1,0,0),h.UnitY=new h(0,1,0),h.UnitZ=new h(0,0,1),h.ForwardRH=new h(0,0,-1),h.ForwardLH=new h(0,0,1),h.Up=new h(0,1,0),h.NAN=new h(NaN,NaN,NaN),__static(h,["_tempVector4",function(){return this._tempVector4=new Vector4}]),h}(),RandX=function(){function r(e){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(e instanceof Array)||4!=e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}__class(r,"laya.d3.math.RandX",!0);var e=r.prototype;return e.randomint=function(){var e=this._state0U,t=this._state0L,n=this._state1U,i=this._state1L,r=(i>>>0)+(t>>>0),a=n+e+(r/2>>>31)>>>0,o=r>>>0,s=0,l=0;s=(e^=s=e<<23|(-512&t)>>>9)^(this._state0U=n),l=(t^=l=t<<23)^(this._state0L=i);s^=e>>>18,l^=t>>>18|(262143&e)<<14;return s^=n>>>5,l^=i>>>5|(31&n)<<27,this._state1U=s,this._state1L=l,[a,o]},e.random=function(){var e=this.randomint(),t=e[0],n=1023<<20|t>>>12,i=0|(e[1]>>>12|(4095&t)<<20);return r._CONVERTION_BUFFER.setUint32(0,n,!1),r._CONVERTION_BUFFER.setUint32(4,i,!1),Rand._CONVERTION_BUFFER.getFloat64(0,!1)-1},__static(r,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new Rand([0,Date.now()/65536,0,Date.now()%65536])}]),r}(),Collision=function(){function Q(){}return __class(Q,"laya.d3.math.Collision",!0),Q.distancePlaneToPoint=function(e,t){return Vector3.dot(e.normal,t)-e.distance},Q.distanceBoxToPoint=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],o=e.max.elements,s=o[0],l=o[1],_=o[2],h=t.elements,c=h[0],u=h[1],d=h[2],f=0;return c<i&&(f+=(i-c)*(i-c)),s<c&&(f+=(s-c)*(s-c)),u<r&&(f+=(r-u)*(r-u)),l<u&&(f+=(l-u)*(l-u)),d<a&&(f+=(a-d)*(a-d)),_<d&&(f+=(_-d)*(_-d)),Math.sqrt(f)},Q.distanceBoxToBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],o=e.max.elements,s=o[0],l=o[1],_=o[2],h=t.min.elements,c=h[0],u=h[1],d=h[2],f=t.max.elements,m=f[0],p=f[1],g=f[2],E=0,v=NaN;return m<i?E+=(v=i-m)*v:s<c&&(E+=(v=c-s)*v),p<r?E+=(v=r-p)*v:l<u&&(E+=(v=u-l)*v),g<a?E+=(v=a-g)*v:_<d&&(E+=(v=d-_)*v),Math.sqrt(E)},Q.distanceSphereToPoint=function(e,t){var n=Math.sqrt(Vector3.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)},Q.distanceSphereToSphere=function(e,t){var n=Math.sqrt(Vector3.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)},Q.intersectsRayAndTriangleRD=function(e,t,n,i,r){var a=e.origin.elements,o=a[0],s=a[1],l=a[2],_=e.direction.elements,h=_[0],c=_[1],u=_[2],d=t.elements,f=d[0],m=d[1],p=d[2],g=n.elements,E=g[0],v=g[1],x=g[2],S=i.elements,D=S[0],T=S[1],M=S[2],V=Q._tempV30.elements,R=V[0],A=V[1],C=V[2];R=E-f,A=v-m,C=x-p;var I=Q._tempV31.elements,y=I[0],N=I[1],P=I[2];y=D-f,N=T-m,P=M-p;var L=Q._tempV32.elements,w=L[0],O=L[1],b=L[2],F=R*(w=c*P-u*N)+A*(O=u*y-h*P)+C*(b=h*N-c*y);if(MathUtils3D.isZero(F))return 0,!1;var B=1/F,U=Q._tempV33.elements,H=U[0],G=U[1],z=U[2],W=(H=o-f)*w+(G=s-m)*O+(z=l-p)*b;if((W*=B)<0||1<W)return 0,!1;var k=Q._tempV34.elements,X=k[0],Z=k[1],K=k[2],Y=h*(X=G*C-z*A)+c*(Z=z*R-H*C)+u*(K=H*A-G*R);if((Y*=B)<0||1<W+Y)return 0,!1;var j=y*X+N*Z+P*K;return(j*=B)<0?(0,!1):(j,!0)},Q.intersectsRayAndTriangleRP=function(e,t,n,i,r){return Q.intersectsRayAndTriangleRD(e,t,n,i,NaN)?(Vector3.scale(e.direction,NaN,Q._tempV30),Vector3.add(e.origin,Q._tempV30,r),!0):(r=Vector3.ZERO,!1)},Q.intersectsRayAndPoint=function(e,t){Vector3.subtract(e.origin,t,Q._tempV30);var n=Vector3.dot(Q._tempV30,e.direction),i=Vector3.dot(Q._tempV30,Q._tempV30)-MathUtils3D.zeroTolerance;return!(0<i&&0<n)&&!(n*n-i<0)},Q.intersectsRayAndRay=function(e,t,n){var i=e.origin,r=i.elements,a=r[0],o=r[1],s=r[2],l=e.direction,_=l.elements,h=_[0],c=_[1],u=_[2],d=t.origin,f=d.elements,m=f[0],p=f[1],g=f[2],E=t.direction,v=E.elements,x=v[0],S=v[1],D=v[2];Vector3.cross(l,E,Q._tempV30);var T=Q._tempV30.elements,M=Vector3.scalarLengthSquared(Q._tempV30);if(MathUtils3D.isZero(M)&&MathUtils3D.nearEqual(m,a)&&MathUtils3D.nearEqual(p,o)&&MathUtils3D.nearEqual(g,s))return Vector3.ZERO.cloneTo(n),!0;var V=m-a,R=p-o,A=g-s,C=x,I=S,y=D,N=T[0],P=T[1],L=T[2],w=(V*I*L+R*y*N+A*C*P-V*y*P-R*C*L-A*I*N)/M,O=(V*(I=c)*L+R*(y=u)*N+A*(C=h)*P-V*y*P-R*C*L-A*I*N)/M;Vector3.scale(l,w,Q._tempV30),Vector3.scale(E,O,Q._tempV31),Vector3.add(i,Q._tempV30,Q._tempV32),Vector3.add(d,Q._tempV31,Q._tempV33);var b=Q._tempV32.elements,F=Q._tempV33.elements;return MathUtils3D.nearEqual(F[0],b[0])&&MathUtils3D.nearEqual(F[1],b[1])&&MathUtils3D.nearEqual(F[2],b[2])?(Q._tempV32.cloneTo(n),!0):(Vector3.ZERO.cloneTo(n),!1)},Q.intersectsPlaneAndTriangle=function(e,t,n,i){var r=Q.intersectsPlaneAndPoint(e,t),a=Q.intersectsPlaneAndPoint(e,n),o=Q.intersectsPlaneAndPoint(e,i);return r==Plane.PlaneIntersectionType_Front&&a==Plane.PlaneIntersectionType_Front&&o==Plane.PlaneIntersectionType_Front?Plane.PlaneIntersectionType_Front:r==Plane.PlaneIntersectionType_Back&&a==Plane.PlaneIntersectionType_Back&&o==Plane.PlaneIntersectionType_Back?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},Q.intersectsRayAndPlaneRD=function(e,t,n){var i=t.normal,r=Vector3.dot(i,e.direction);if(MathUtils3D.isZero(r))return 0,!1;var a=Vector3.dot(i,e.origin);return!((-t.distance-a)/r<0)||(0,!1)},Q.intersectsRayAndPlaneRP=function(e,t,n){return Q.intersectsRayAndPlaneRD(e,t,NaN)?(Vector3.scale(e.direction,NaN,Q._tempV30),Vector3.add(e.origin,Q._tempV30,Q._tempV31),Q._tempV31,!0):(Vector3.ZERO,!1)},Q.intersectsRayAndBoxRD=function(e,t){var n=e.origin.elements,i=n[0],r=n[1],a=n[2],o=e.direction.elements,s=o[0],l=o[1],_=o[2],h=t.min.elements,c=h[0],u=h[1],d=h[2],f=t.max.elements,m=f[0],p=f[1],g=f[2],E=0,v=MathUtils3D.MaxValue;if(MathUtils3D.isZero(s)){if(i<c||m<i)return-1}else{var x=1/s,S=(c-i)*x,D=(m-i)*x;if(D<S){var T=S;S=D,D=T}if(E=Math.max(S,E),(v=Math.min(D,v))<E)return-1}if(MathUtils3D.isZero(l)){if(r<u||p<r)return-1}else{var M=1/l,V=(u-r)*M,R=(p-r)*M;if(R<V){var A=V;V=R,R=A}if(E=Math.max(V,E),(v=Math.min(R,v))<E)return-1}if(MathUtils3D.isZero(_)){if(a<d||g<a)return-1}else{var C=1/_,I=(d-a)*C,y=(g-a)*C;if(y<I){var N=I;I=y,y=N}if(E=Math.max(I,E),(v=Math.min(y,v))<E)return-1}return E},Q.intersectsRayAndBoxRP=function(e,t,n){var i=Q.intersectsRayAndBoxRD(e,t);return-1==i?Vector3.ZERO.cloneTo(n):(Vector3.scale(e.direction,i,Q._tempV30),Vector3.add(e.origin,Q._tempV30,Q._tempV31),Q._tempV31.cloneTo(n)),i},Q.intersectsRayAndSphereRD=function(e,t){var n=t.radius;Vector3.subtract(e.origin,t.center,Q._tempV30);var i=Vector3.dot(Q._tempV30,e.direction),r=Vector3.dot(Q._tempV30,Q._tempV30)-n*n;if(0<r&&0<i)return-1;var a=i*i-r;if(a<0)return-1;var o=-i-Math.sqrt(a);return o<0&&(o=0),o},Q.intersectsRayAndSphereRP=function(e,t,n){var i=Q.intersectsRayAndSphereRD(e,t);return-1===i?Vector3.ZERO.cloneTo(n):(Vector3.scale(e.direction,i,Q._tempV30),Vector3.add(e.origin,Q._tempV30,Q._tempV31),Q._tempV31.cloneTo(n)),i},Q.intersectsSphereAndTriangle=function(e,t,n,i){var r=e.center,a=e.radius;return Q.closestPointPointTriangle(r,t,n,i,Q._tempV30),Vector3.subtract(Q._tempV30,r,Q._tempV31),Vector3.dot(Q._tempV31,Q._tempV31)<=a*a},Q.intersectsPlaneAndPoint=function(e,t){var n=Vector3.dot(e.normal,t)+e.distance;return 0<n?Plane.PlaneIntersectionType_Front:n<0?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},Q.intersectsPlaneAndPlane=function(e,t){Vector3.cross(e.normal,t.normal,Q._tempV30);var n=Vector3.dot(Q._tempV30,Q._tempV30);return!MathUtils3D.isZero(n)},Q.intersectsPlaneAndPlaneRL=function(e,t,n){var i=e.normal,r=t.normal;Vector3.cross(i,r,Q._tempV34);var a=Vector3.dot(Q._tempV34,Q._tempV34);return!MathUtils3D.isZero(a)&&(Vector3.scale(r,e.distance,Q._tempV30),Vector3.scale(i,t.distance,Q._tempV31),Vector3.subtract(Q._tempV30,Q._tempV31,Q._tempV32),Vector3.cross(Q._tempV32,Q._tempV34,Q._tempV33),Vector3.normalize(Q._tempV34,Q._tempV34),new Ray(Q._tempV33,Q._tempV34),!0)},Q.intersectsPlaneAndBox=function(e,t){var n=e.distance,i=e.normal,r=i.elements,a=r[0],o=r[1],s=r[2],l=t.min.elements,_=l[0],h=l[1],c=l[2],u=t.max.elements,d=u[0],f=u[1],m=u[2];Q._tempV30.elements[0]=0<a?_:d,Q._tempV30.elements[1]=0<o?h:f,Q._tempV30.elements[2]=0<s?c:m,Q._tempV31.elements[0]=0<a?d:_,Q._tempV31.elements[1]=0<o?f:h,Q._tempV31.elements[2]=0<s?m:c;var p=Vector3.dot(i,Q._tempV30);return 0<p+n?Plane.PlaneIntersectionType_Front:(p=Vector3.dot(i,Q._tempV31))+n<0?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},Q.intersectsPlaneAndSphere=function(e,t){var n=t.radius,i=Vector3.dot(e.normal,t.center)+e.distance;return n<i?Plane.PlaneIntersectionType_Front:i<-n?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},Q.intersectsBoxAndBox=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.min.elements,a=t.max.elements;return!(n[0]>a[0]||r[0]>i[0])&&(!(n[1]>a[1]||r[1]>i[1])&&!(n[2]>a[2]||r[2]>i[2]))},Q.intersectsBoxAndSphere=function(e,t){var n=t.center,i=t.radius;return Vector3.Clamp(n,e.min,e.max,Q._tempV30),Vector3.distanceSquared(n,Q._tempV30)<=i*i},Q.intersectsSphereAndSphere=function(e,t){var n=e.radius+t.radius;return Vector3.distanceSquared(e.center,t.center)<=n*n},Q.boxContainsPoint=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.elements;return n[0]<=r[0]&&i[0]>=r[0]&&n[1]<=r[1]&&i[1]>=r[1]&&n[2]<=r[2]&&i[2]>=r[2]?1:0},Q.boxContainsBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],o=e.max.elements,s=o[0],l=o[1],_=o[2],h=t.min.elements,c=h[0],u=h[1],d=h[2],f=t.max.elements,m=f[0],p=f[1],g=f[2];return s<c||m<i?0:l<u||p<r?0:_<d||g<a?0:i<=c&&m<=m&&r<=u&&p<=l&&a<=d&&g<=_?1:2},Q.boxContainsSphere=function(e,t){var n=e.min,i=n.elements,r=i[0],a=i[1],o=i[2],s=e.max,l=s.elements,_=l[0],h=l[1],c=l[2],u=t.center,d=u.elements,f=d[0],m=d[1],p=d[2],g=t.radius;return Vector3.Clamp(u,n,s,Q._tempV30),g*g<Vector3.distanceSquared(u,Q._tempV30)?0:r+g<=f&&f<=_-g&&g<_-r&&a+g<=m&&m<=h-g&&g<h-a&&o+g<=p&&p<=c-g&&g<c-o?1:2},Q.sphereContainsPoint=function(e,t){return Vector3.distanceSquared(t,e.center)<=e.radius*e.radius?1:0},Q.sphereContainsTriangle=function(e,t,n,i){var r=Q.sphereContainsPoint(e,t),a=Q.sphereContainsPoint(e,n),o=Q.sphereContainsPoint(e,i);return 1==r&&1==a&&1==o?1:Q.intersectsSphereAndTriangle(e,t,n,i)?2:0},Q.sphereContainsBox=function(e,t){var n=e.center.elements,i=n[0],r=n[1],a=n[2],o=e.radius,s=t.min.elements,l=s[0],_=s[1],h=s[2],c=t.max.elements,u=c[0],d=c[1],f=c[2],m=Q._tempV30.elements;m[0],m[1],m[2];if(!Q.intersectsBoxAndSphere(t,e))return 0;var p=o*o;return i-l,r-d,a-f,Vector3.scalarLengthSquared(Q._tempV30)>p?2:(i-u,r-d,a-f,Vector3.scalarLengthSquared(Q._tempV30)>p?2:(i-u,r-_,a-f,Vector3.scalarLengthSquared(Q._tempV30)>p?2:(i-l,r-_,a-f,Vector3.scalarLengthSquared(Q._tempV30)>p?2:(i-l,r-d,a-h,Vector3.scalarLengthSquared(Q._tempV30)>p?2:(i-u,r-d,a-h,Vector3.scalarLengthSquared(Q._tempV30)>p?2:(i-u,r-_,a-h,Vector3.scalarLengthSquared(Q._tempV30)>p?2:(i-l,r-_,a-h,Vector3.scalarLengthSquared(Q._tempV30)>p?2:1)))))))},Q.sphereContainsSphere=function(e,t){var n=e.radius,i=t.radius,r=Vector3.distance(e.center,t.center);return n+i<r?0:n-i<r?2:1},Q.closestPointPointTriangle=function(e,t,n,i,r){Vector3.subtract(n,t,Q._tempV30),Vector3.subtract(i,t,Q._tempV31),Vector3.subtract(e,t,Q._tempV32),Vector3.subtract(e,n,Q._tempV33),Vector3.subtract(e,i,Q._tempV34);var a=Vector3.dot(Q._tempV30,Q._tempV32),o=Vector3.dot(Q._tempV31,Q._tempV32),s=Vector3.dot(Q._tempV30,Q._tempV33),l=Vector3.dot(Q._tempV31,Q._tempV33),_=Vector3.dot(Q._tempV30,Q._tempV34),h=Vector3.dot(Q._tempV31,Q._tempV34);if(a<=0&&o<=0)t.cloneTo(r);else if(0<=s&&l<=s)n.cloneTo(r);else{var c=a*l-s*o;if(c<=0&&0<=a&&s<=0){var u=a/(a-s);return Vector3.scale(Q._tempV30,u,r),void Vector3.add(t,r,r)}if(0<=h&&_<=h)i.cloneTo(r);else{var d=_*o-a*h;if(d<=0&&0<=o&&h<=0){var f=o/(o-h);return Vector3.scale(Q._tempV31,f,r),void Vector3.add(t,r,r)}var m=s*h-_*l;if(m<=0&&0<=l-s&&0<=_-h){var p=(l-s)/(l-s+(_-h));return Vector3.subtract(i,n,r),Vector3.scale(r,p,r),void Vector3.add(n,r,r)}var g=1/(m+d+c),E=d*g,v=c*g;Vector3.scale(Q._tempV30,E,Q._tempV35),Vector3.scale(Q._tempV31,v,Q._tempV36),Vector3.add(Q._tempV35,Q._tempV36,r),Vector3.add(t,r,r)}}},Q.closestPointPlanePoint=function(e,t,n){var i=e.normal,r=Vector3.dot(i,t)-e.distance;Vector3.scale(i,r,Q._tempV30),Vector3.subtract(t,Q._tempV30,n)},Q.closestPointBoxPoint=function(e,t,n){Vector3.max(t,e.min,Q._tempV30),Vector3.min(Q._tempV30,e.max,n)},Q.closestPointSpherePoint=function(e,t,n){var i=e.center;Vector3.subtract(t,i,n),Vector3.normalize(n,n),Vector3.scale(n,e.radius,n),Vector3.add(n,i,n)},Q.closestPointSphereSphere=function(e,t,n){var i=e.center;Vector3.subtract(t.center,i,n),Vector3.normalize(n,n),Vector3.scale(n,e.radius,n),Vector3.add(n,i,n)},__static(Q,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3}]),Q}(),BoundFrustum=function(){function _(e){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=e,this._near=new Plane(new Vector3),this._far=new Plane(new Vector3),this._left=new Plane(new Vector3),this._right=new Plane(new Vector3),this._top=new Plane(new Vector3),this._bottom=new Plane(new Vector3),_._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}__class(_,"laya.d3.math.BoundFrustum",!0);var e=_.prototype;return e.equalsBoundFrustum=function(e){return this._matrix.equalsOtherMatrix(e.matrix)},e.equalsObj=function(e){if(e instanceof laya.d3.math.BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1},e.getPlane=function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},e.getCorners=function(e){_._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(e[0]),_._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(e[1]),_._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(e[2]),_._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(e[3]),_._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(e[4]),_._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(e[5]),_._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(e[6]),_._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(e[7])},e.containsPoint=function(e){for(var t=Plane.PlaneIntersectionType_Front,n=Plane.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Collision.intersectsPlaneAndPoint(this._near,e);break;case 1:n=Collision.intersectsPlaneAndPoint(this._far,e);break;case 2:n=Collision.intersectsPlaneAndPoint(this._left,e);break;case 3:n=Collision.intersectsPlaneAndPoint(this._right,e);break;case 4:n=Collision.intersectsPlaneAndPoint(this._top,e);break;case 5:n=Collision.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case Plane.PlaneIntersectionType_Back:return 0;case Plane.PlaneIntersectionType_Intersecting:t=Plane.PlaneIntersectionType_Intersecting}}switch(t){case Plane.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e.containsBoundBox=function(e){for(var t,n=_._tempV30,i=_._tempV31,r=1,a=0;a<6;a++){if(t=this.getPlane(a),this._getBoxToPlanePVertexNVertex(e,t.normal,n,i),Collision.intersectsPlaneAndPoint(t,n)==Plane.PlaneIntersectionType_Back)return 0;Collision.intersectsPlaneAndPoint(t,i)==Plane.PlaneIntersectionType_Back&&(r=2)}return r},e.containsBoundSphere=function(e){for(var t=Plane.PlaneIntersectionType_Front,n=Plane.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Collision.intersectsPlaneAndSphere(this._near,e);break;case 1:n=Collision.intersectsPlaneAndSphere(this._far,e);break;case 2:n=Collision.intersectsPlaneAndSphere(this._left,e);break;case 3:n=Collision.intersectsPlaneAndSphere(this._right,e);break;case 4:n=Collision.intersectsPlaneAndSphere(this._top,e);break;case 5:n=Collision.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case Plane.PlaneIntersectionType_Back:return 0;case Plane.PlaneIntersectionType_Intersecting:t=Plane.PlaneIntersectionType_Intersecting}}switch(t){case Plane.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e._getBoxToPlanePVertexNVertex=function(e,t,n,i){var r=e.min,a=r.elements,o=e.max,s=o.elements,l=t.elements,_=l[0],h=l[1],c=l[2];r.cloneTo(n);var u=n.elements;0<=_&&(u[0]=s[0]),0<=h&&(u[1]=s[1]),0<=c&&(u[2]=s[2]),o.cloneTo(i);var d=i.elements;0<=_&&(d[0]=a[0]),0<=h&&(d[1]=a[1]),0<=c&&(d[2]=a[2])},__getset(0,e,"bottom",function(){return this._bottom}),__getset(0,e,"top",function(){return this._top}),__getset(0,e,"left",function(){return this._left}),__getset(0,e,"far",function(){return this._far}),__getset(0,e,"near",function(){return this._near}),__getset(0,e,"right",function(){return this._right}),__getset(0,e,"matrix",function(){return this._matrix},function(e){this._matrix=e,_._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),_._getPlanesFromMatrix=function(e,t,n,i,r,a,o){var s=e.elements,l=s[0],_=s[1],h=s[2],c=s[3],u=s[4],d=s[5],f=s[6],m=s[7],p=s[8],g=s[9],E=s[10],v=s[11],x=s[12],S=s[13],D=s[14],T=s[15],M=t.normal.elements;M[0]=c+h,M[1]=m+f,M[2]=v+E,t.distance=T+D,t.normalize();var V=n.normal.elements;V[0]=c-h,V[1]=m-f,V[2]=v-E,n.distance=T-D,n.normalize();var R=i.normal.elements;R[0]=c+l,R[1]=m+u,R[2]=v+p,i.distance=T+x,i.normalize();var A=r.normal.elements;A[0]=c-l,A[1]=m-u,A[2]=v-p,r.distance=T-x,r.normalize();var C=a.normal.elements;C[0]=c-_,C[1]=m-d,C[2]=v-g,a.distance=T-S,a.normalize();var I=o.normal.elements;I[0]=c+_,I[1]=m+d,I[2]=v+g,o.distance=T+S,o.normalize()},_._get3PlaneInterPoint=function(e,t,n){var i=e.normal,r=t.normal,a=n.normal;Vector3.cross(r,a,_._tempV30),Vector3.cross(a,i,_._tempV31),Vector3.cross(i,r,_._tempV32);var o=Vector3.dot(i,_._tempV30),s=Vector3.dot(r,_._tempV31),l=Vector3.dot(a,_._tempV32);return Vector3.scale(_._tempV30,-e.distance/o,_._tempV33),Vector3.scale(_._tempV31,-t.distance/s,_._tempV34),Vector3.scale(_._tempV32,-n.distance/l,_._tempV35),Vector3.add(_._tempV33,_._tempV34,_._tempV36),Vector3.add(_._tempV35,_._tempV36,_._tempV37),_._tempV37},__static(_,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3},"_tempV37",function(){return this._tempV37=new Vector3}]),_}(),BoundSphere=function(){function h(e,t){this.center=null,this.radius=NaN,this.center=e,this.radius=t}__class(h,"laya.d3.math.BoundSphere",!0);var e=h.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.toDefault=function(){this.center.toDefault(),this.radius=0},e.intersectsRayDistance=function(e){return Collision.intersectsRayAndSphereRD(e,this)},e.intersectsRayPoint=function(e,t){return Collision.intersectsRayAndSphereRP(e,this,t)},e.cloneTo=function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius},e.clone=function(){var e=new this.constructor(new Vector3,new Vector3);return this.cloneTo(e),e},h.createFromSubPoints=function(e,t,n,i){if(null==e)throw new Error("points");if(t<0||t>=e.length)throw new Error("start"+t+"Must be in the range [0, "+(e.length-1)+"]");if(n<0||t+n>e.length)throw new Error("count"+n+"Must be in the range <= "+e.length+"}");var r=t+n,a=h._tempVector3;a.elements[0]=0,a.elements[1]=0,a.elements[2]=0;for(var o=t;o<r;++o)Vector3.add(e[o],a,a);var s=i.center;Vector3.scale(a,1/n,s);var l=0;for(o=t;o<r;++o){var _=Vector3.distanceSquared(s,e[o]);l<_&&(l=_)}i.radius=Math.sqrt(l)},h.createfromPoints=function(e,t){if(null==e)throw new Error("points");h.createFromSubPoints(e,0,e.length,t)},__static(h,["_tempVector3",function(){return this._tempVector3=new Vector3}]),h}(),Quaternion=function(){function r(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.elements[0]=e,this.elements[1]=t,this.elements[2]=n,this.elements[3]=i}__class(r,"laya.d3.math.Quaternion",!0);var e=r.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.scaling=function(e,t){var n=t.elements,i=this.elements;n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e},e.normalize=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=i*i+r*r+a*a+o*o;0<s&&(s=1/Math.sqrt(s),t[0]=i*s,t[1]=r*s,t[2]=a*s,t[3]=o*s)},e.length=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3];return Math.sqrt(t*t+n*n+i*i+r*r)},e.rotateX=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),_=Math.cos(e);n[0]=r*_+s*l,n[1]=a*_+o*l,n[2]=o*_-a*l,n[3]=s*_-r*l},e.rotateY=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),_=Math.cos(e);n[0]=r*_-o*l,n[1]=a*_+s*l,n[2]=o*_+r*l,n[3]=s*_-a*l},e.rotateZ=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),_=Math.cos(e);n[0]=r*_+a*l,n[1]=a*_-r*l,n[2]=o*_+s*l,n[3]=s*_-o*l},e.getYawPitchRoll=function(e){Vector3.transformQuat(Vector3.ForwardRH,this,r.TEMPVector31),Vector3.transformQuat(Vector3.Up,this,r.TEMPVector32);var t=r.TEMPVector32.elements;r.angleTo(Vector3.ZERO,r.TEMPVector31,r.TEMPVector33);var n=r.TEMPVector33.elements;n[0]==Math.PI/2?(n[1]=r.arcTanAngle(t[2],t[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=r.arcTanAngle(-t[2],-t[0]),n[2]=0):(Matrix4x4.createRotationY(-n[1],r.TEMPMatrix0),Matrix4x4.createRotationX(-n[0],r.TEMPMatrix1),Vector3.transformCoordinate(r.TEMPVector32,r.TEMPMatrix0,r.TEMPVector32),Vector3.transformCoordinate(r.TEMPVector32,r.TEMPMatrix1,r.TEMPVector32),n[2]=r.arcTanAngle(t[1],-t[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]);var i=e.elements;i[0]=n[1],i[1]=n[0],i[2]=n[2]},e.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=i*i+r*r+a*a+o*o,l=s?1/s:0;t[0]=-i*l,t[1]=-r*l,t[2]=-a*l,t[3]=o*l},e.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},e.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]},e.cloneTo=function(e){var t,n,i;if((n=this.elements)!=(i=e.elements))for(t=0;t<4;++t)i[t]=n[t]},e.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.equals=function(e){var t=this.elements,n=e.elements;return MathUtils3D.nearEqual(t[0],n[0])&&MathUtils3D.nearEqual(t[1],n[1])&&MathUtils3D.nearEqual(t[2],n[2])&&MathUtils3D.nearEqual(t[3],n[3])},e.lengthSquared=function(){var e=this.elements[0],t=this.elements[1],n=this.elements[2],i=this.elements[3];return e*e+t*t+n*n+i*i},__getset(0,e,"w",function(){return this.elements[3]}),__getset(0,e,"z",function(){return this.elements[2]}),__getset(0,e,"y",function(){return this.elements[1]}),__getset(0,e,"x",function(){return this.elements[0]}),r.createFromYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),l=Math.cos(r),_=Math.sin(a),h=Math.cos(a),c=Math.sin(o),u=Math.cos(o),d=i.elements;d[0]=u*_*l+c*h*s,d[1]=c*h*l-u*_*s,d[2]=u*h*s-c*_*l,d[3]=u*h*l+c*_*s},r.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],_=i[3],h=r[0],c=r[1],u=r[2],d=r[3],f=s*u-l*c,m=l*h-o*u,p=o*c-s*h,g=o*h+s*c+l*u;a[0]=o*d+h*_+f,a[1]=s*d+c*_+m,a[2]=l*d+u*_+p,a[3]=_*d-g},r.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:0<e?Math.atan(t/e):e<0?0<t?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},r.angleTo=function(e,t,n){Vector3.subtract(t,e,r.TEMPVector30),Vector3.normalize(r.TEMPVector30,r.TEMPVector30),n.elements[0]=Math.asin(r.TEMPVector30.y),n.elements[1]=r.arcTanAngle(-r.TEMPVector30.z,-r.TEMPVector30.x)},r.createFromAxisAngle=function(e,t,n){var i=n.elements,r=e.elements;t*=.5;var a=Math.sin(t);i[0]=a*r[0],i[1]=a*r[1],i[2]=a*r[2],i[3]=Math.cos(t)},r.createFromMatrix3x3=function(e,t){var n,i=t.elements,r=e.elements,a=r[0]+r[4]+r[8];if(0<a)n=Math.sqrt(a+1),i[3]=.5*n,n=.5/n,i[0]=(r[5]-r[7])*n,i[1]=(r[6]-r[2])*n,i[2]=(r[1]-r[3])*n;else{var o=0;r[4]>r[0]&&(o=1),r[8]>r[3*o+o]&&(o=2);var s=(o+1)%3,l=(o+2)%3;n=Math.sqrt(r[3*o+o]-r[3*s+s]-r[3*l+l]+1),i[o]=.5*n,n=.5/n,i[3]=(r[3*s+l]-r[3*l+s])*n,i[s]=(r[3*s+o]+r[3*o+s])*n,i[l]=(r[3*l+o]+r[3*o+l])*n}},r.createFromMatrix4x4=function(e,t){var n,i,r=e.elements,a=t.elements,o=r[0]+r[5]+r[10];0<o?(n=Math.sqrt(o+1),a[3]=.5*n,n=.5/n,a[0]=(r[6]-r[9])*n,a[1]=(r[8]-r[2])*n,a[2]=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(i=.5/(n=Math.sqrt(1+r[0]-r[5]-r[10])),a[0]=.5*n,a[1]=(r[1]+r[4])*i,a[2]=(r[2]+r[8])*i,a[3]=(r[6]-r[9])*i):r[5]>r[10]?(i=.5/(n=Math.sqrt(1+r[5]-r[0]-r[10])),a[0]=(r[4]+r[1])*i,a[1]=.5*n,a[2]=(r[9]+r[6])*i,a[3]=(r[8]-r[2])*i):(i=.5/(n=Math.sqrt(1+r[10]-r[0]-r[5])),a[0]=(r[8]+r[2])*i,a[1]=(r[9]+r[6])*i,a[2]=.5*n,a[3]=(r[1]-r[4])*i)},r.slerp=function(e,t,n,i){var r,a,o,s,l,_=e.elements,h=t.elements,c=i.elements,u=_[0],d=_[1],f=_[2],m=_[3],p=h[0],g=h[1],E=h[2],v=h[3];return(a=u*p+d*g+f*E+m*v)<0&&(a=-a,p=-p,g=-g,E=-E,v=-v),l=1e-6<1-a?(r=Math.acos(a),o=Math.sin(r),s=Math.sin((1-n)*r)/o,Math.sin(n*r)/o):(s=1-n,n),c[0]=s*u+l*p,c[1]=s*d+l*g,c[2]=s*f+l*E,c[3]=s*m+l*v,c},r.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],_=a[2],h=a[3];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=_+n*(o[2]-_),r[3]=h+n*(o[3]-h)},r.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},r.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},r.rotationLookAt=function(e,t,n){r.lookAt(Vector3.ZERO,e,t,n)},r.lookAt=function(e,t,n,i){Matrix3x3.lookAt(e,t,n,r._tempMatrix3x3),r.rotationMatrix(r._tempMatrix3x3,i)},r.invert=function(e,t){var n=e.elements,i=t.elements,r=e.lengthSquared();MathUtils3D.isZero(r)||(r=1/r,i[0]=-n[0]*r,i[1]=-n[1]*r,i[2]=-n[2]*r,i[3]=n[3]*r)},r.rotationMatrix=function(e,t){var n=e.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],_=n[6],h=n[7],c=n[8],u=t.elements,d=NaN,f=NaN,m=i+s+c;0<m?(d=Math.sqrt(m+1),u[3]=.5*d,d=.5/d,u[0]=(l-h)*d,u[1]=(_-a)*d,u[2]=(r-o)*d):u[3]=s<=i&&c<=i?(f=.5/(d=Math.sqrt(1+i-s-c)),u[0]=.5*d,u[1]=(r+o)*f,u[2]=(a+_)*f,(l-h)*f):c<s?(f=.5/(d=Math.sqrt(1+s-i-c)),u[0]=(o+r)*f,u[1]=.5*d,u[2]=(h+l)*f,(_-a)*f):(f=.5/(d=Math.sqrt(1+c-i-s)),u[0]=(_+a)*f,u[1]=(h+l)*f,u[2]=.5*d,(r-o)*f)},r.DEFAULT=new r,__static(r,["TEMPVector30",function(){return this.TEMPVector30=new Vector3},"TEMPVector31",function(){return this.TEMPVector31=new Vector3},"TEMPVector32",function(){return this.TEMPVector32=new Vector3},"TEMPVector33",function(){return this.TEMPVector33=new Vector3},"TEMPMatrix0",function(){return this.TEMPMatrix0=new Matrix4x4},"TEMPMatrix1",function(){return this.TEMPMatrix1=new Matrix4x4},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new Matrix3x3},"NAN",function(){return this.NAN=new r(NaN,NaN,NaN,NaN)}]),r}(),Vector2=function(){function e(e,t){this.elements=new Float32Array(2),void 0===e&&(e=0),void 0===t&&(t=0);var n=this.elements;n[0]=e,n[1]=t}__class(e,"laya.d3.math.Vector2",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1]},t.cloneTo=function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),__getset(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t},__static(e,["ZERO",function(){return this.ZERO=new e(0,0)},"ONE",function(){return this.ONE=new e(1,1)}]),e}(),ChunkInfo=function(){function e(){this.alphaMap=null,this.detailID=null,this.normalMap=null}return __class(e,"laya.d3.terrain.unit.ChunkInfo",!0),e}(),MaterialInfo=function(){function e(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}return __class(e,"laya.d3.terrain.unit.MaterialInfo",!0),e}(),DetailTextureInfo=function(){function e(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}return __class(e,"laya.d3.terrain.unit.DetailTextureInfo",!0),e}(),TerrainLeaf=function(){function D(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,D.__init__(),this._currentLODLevel=0}__class(D,"laya.d3.terrain.TerrainLeaf",!0);var e=D.prototype;return e.calcVertextNorml=function(e,t,n,i,r,a){var o=0,s=0;s=-1*D.getHeightFromTerrainHeightData(e-1,t-1,n,i,r),s+=-1*D.getHeightFromTerrainHeightData(e-1,t,n,i,r),s+=-1*D.getHeightFromTerrainHeightData(e-1,t+1,n,i,r),s+=1*D.getHeightFromTerrainHeightData(e+1,t-1,n,i,r),s+=1*D.getHeightFromTerrainHeightData(e+1,t,n,i,r),s+=1*D.getHeightFromTerrainHeightData(e+1,t+1,n,i,r),o=-1*D.getHeightFromTerrainHeightData(e-1,t-1,n,i,r),o+=-1*D.getHeightFromTerrainHeightData(e,t-1,n,i,r),o+=-1*D.getHeightFromTerrainHeightData(e+1,t-1,n,i,r),o+=1*D.getHeightFromTerrainHeightData(e-1,t+1,n,i,r),o+=1*D.getHeightFromTerrainHeightData(e,t+1,n,i,r),o+=1*D.getHeightFromTerrainHeightData(e+1,t+1,n,i,r),a.x=-s,a.y=6,a.z=-o,Vector3.normalize(a,a)},e.calcVertextNormlUV=function(e,t,n,i,r){r.x=e/n,r.y=t/i,r.z=t/i},e.calcVertextBuffer=function(e,t,n,i,r,a,o,s,l,_,h,c){if(1==c&&!D.__ADAPT_MATRIX__){D.__ADAPT_MATRIX__=new Matrix4x4;var u=new Matrix4x4;Matrix4x4.createRotationY(Math.PI,D.__ADAPT_MATRIX__),Matrix4x4.createTranslate(new Vector3(0,0,(h-1)*r),u),Matrix4x4.multiply(u,D.__ADAPT_MATRIX__,D.__ADAPT_MATRIX__),D.__ADAPT_MATRIX_INV__=new Matrix4x4,D.__ADAPT_MATRIX__.invert(D.__ADAPT_MATRIX_INV__)}this._gridSize=r,this._beginGridX=e*D.CHUNK_GRID_NUM+n,this._beginGridZ=t*D.CHUNK_GRID_NUM+i;for(var d=o*s,f=2147483647,m=-2147483648,p=new Vector3,g=0,E=D.LEAF_GRID_NUM+1;g<E;g++)for(var v=0,x=D.LEAF_GRID_NUM+1;v<x;v++)D.__VECTOR3__.x=(this._beginGridX+v)*this._gridSize,D.__VECTOR3__.z=(this._beginGridZ+g)*this._gridSize,D.__VECTOR3__.y=l[(this._beginGridZ+g)*_+(this._beginGridX+v)],f=D.__VECTOR3__.y<f?D.__VECTOR3__.y:f,m=D.__VECTOR3__.y>m?D.__VECTOR3__.y:m,D.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(D.__VECTOR3__,D.__ADAPT_MATRIX__,D.__VECTOR3__),a[d]=D.__VECTOR3__.x,a[++d]=D.__VECTOR3__.y,a[++d]=D.__VECTOR3__.z,d++,this.calcVertextNormlUV(this._beginGridX+v,this._beginGridZ+g,_,h,p),a[d]=p.x,a[++d]=p.y,a[++d]=p.z,a[++d]=(n+v)/D.CHUNK_GRID_NUM,a[++d]=(i+g)/D.CHUNK_GRID_NUM,a[++d]=this._beginGridX+v,a[++d]=this._beginGridZ+g,d++;this._sizeOfY=new Vector2(f-1,m+1),this.calcLODErrors(l,_,h),this.calcOriginalBoudingBoxAndSphere()},e.calcSkirtVertextBuffer=function(e,t,n,i,r,a,o,s,l,_,h){this._gridSize=r,this._beginGridX=e*D.CHUNK_GRID_NUM+n,this._beginGridZ=t*D.CHUNK_GRID_NUM+i;var c=o*s,u=0,d=0,f=D.LEAF_GRID_NUM+1,m=new Vector3,p=0,g=0;for(u=0;u<2;u++)for(d=0;d<f;d++)D.__VECTOR3__.x=(this._beginGridX+d)*this._gridSize,D.__VECTOR3__.y=1==u?l[this._beginGridZ*_+(this._beginGridX+d)]:-this._gridSize,D.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,D.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(D.__VECTOR3__,D.__ADAPT_MATRIX__,D.__VECTOR3__),a[c]=D.__VECTOR3__.x,a[++c]=D.__VECTOR3__.y,a[++c]=D.__VECTOR3__.z,c++,p=0==u?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+d,p,_,h,m),a[c]=m.x,a[++c]=m.y,a[++c]=m.z,a[++c]=(n+d)/D.CHUNK_GRID_NUM,a[++c]=(i+0)/D.CHUNK_GRID_NUM,a[++c]=this._beginGridX+d,a[++c]=p,c++;for(u=0;u<2;u++)for(d=0;d<f;d++)D.__VECTOR3__.x=(this._beginGridX+d)*this._gridSize,D.__VECTOR3__.y=0==u?l[(this._beginGridZ+D.LEAF_GRID_NUM)*_+(this._beginGridX+d)]:-this._gridSize,D.__VECTOR3__.z=(this._beginGridZ+D.LEAF_GRID_NUM)*this._gridSize,D.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(D.__VECTOR3__,D.__ADAPT_MATRIX__,D.__VECTOR3__),a[c]=D.__VECTOR3__.x,a[++c]=D.__VECTOR3__.y,a[++c]=D.__VECTOR3__.z,c++,p=0==u?this._beginGridZ+D.LEAF_GRID_NUM:this._beginGridZ+D.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+d,p,_,h,m),a[c]=m.x,a[++c]=m.y,a[++c]=m.z,a[++c]=(n+d)/D.CHUNK_GRID_NUM,a[++c]=(i+D.LEAF_GRID_NUM)/D.CHUNK_GRID_NUM,a[++c]=this._beginGridX+d,a[++c]=p,c++;for(u=0;u<2;u++)for(d=0;d<f;d++)D.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,D.__VECTOR3__.y=0==u?l[(this._beginGridZ+d)*_+(this._beginGridX+0)]:-this._gridSize,D.__VECTOR3__.z=(this._beginGridZ+d)*this._gridSize,D.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(D.__VECTOR3__,D.__ADAPT_MATRIX__,D.__VECTOR3__),a[c]=D.__VECTOR3__.x,a[++c]=D.__VECTOR3__.y,a[++c]=D.__VECTOR3__.z,c++,g=0==u?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(g,this._beginGridZ+d,_,h,m),a[c]=m.x,a[++c]=m.y,a[++c]=m.z,a[++c]=(n+0)/D.CHUNK_GRID_NUM,a[++c]=(i+d)/D.CHUNK_GRID_NUM,a[++c]=g,a[++c]=this._beginGridZ+d,c++;for(u=0;u<2;u++)for(d=0;d<f;d++)D.__VECTOR3__.x=(this._beginGridX+D.LEAF_GRID_NUM)*this._gridSize,D.__VECTOR3__.y=1==u?l[(this._beginGridZ+d)*_+(this._beginGridX+D.LEAF_GRID_NUM)]:-this._gridSize,D.__VECTOR3__.z=(this._beginGridZ+d)*this._gridSize,D.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(D.__VECTOR3__,D.__ADAPT_MATRIX__,D.__VECTOR3__),a[c]=D.__VECTOR3__.x,a[++c]=D.__VECTOR3__.y,a[++c]=D.__VECTOR3__.z,c++,g=0==u?this._beginGridX+D.LEAF_GRID_NUM+1:this._beginGridX+D.LEAF_GRID_NUM,this.calcVertextNormlUV(g,this._beginGridZ+d,_,h,m),a[c]=m.x,a[++c]=m.y,a[++c]=m.z,a[++c]=(n+D.LEAF_GRID_NUM)/D.CHUNK_GRID_NUM,a[++c]=(i+d)/D.CHUNK_GRID_NUM,a[++c]=g,a[++c]=this._beginGridZ+d,c++},e.calcOriginalBoudingBoxAndSphere=function(){var e=new Vector3(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),t=new Vector3((this._beginGridX+D.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+D.LEAF_GRID_NUM)*this._gridSize);D.__ADAPT_MATRIX__&&(Vector3.transformV3ToV3(e,D.__ADAPT_MATRIX__,e),Vector3.transformV3ToV3(t,D.__ADAPT_MATRIX__,t)),this._originalBoundingBox=new BoundBox(e,t);var n=new Vector3;Vector3.subtract(t,e,n),Vector3.scale(n,.5,n);var i=new Vector3;Vector3.add(e,n,i),this._originalBoundingSphere=new BoundSphere(i,Vector3.scalarLength(n)),this._originalBoundingBoxCorners=__newvec(8,null),this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new BoundBox(new Vector3(-.5,-.5,-.5),new Vector3(.5,.5,.5)),this._boundingSphere=new BoundSphere(new Vector3(0,0,0),1)},e.calcLeafBoudingBox=function(e){for(var t=0;t<8;t++)Vector3.transformCoordinate(this._originalBoundingBoxCorners[t],e,BaseRender._tempBoundBoxCorners[t]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox)},e.calcLeafBoudingSphere=function(e,t){Vector3.transformCoordinate(this._originalBoundingSphere.center,e,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*t},e.calcLODErrors=function(e,t,n){this._LODError=new Float32Array(D._maxLODLevel+1);for(var i=1,r=0,a=D._maxLODLevel+1;r<a;r++){for(var o=0,s=0,l=D.LEAF_GRID_NUM;s<l;s+=i)for(var _=0,h=D.LEAF_GRID_NUM;_<h;_+=i)for(var c=e[(this._beginGridZ+s)*t+(this._beginGridX+_)],u=e[(this._beginGridZ+s)*t+(this._beginGridX+_)+i],d=e[(this._beginGridZ+s+i)*t+(this._beginGridX+_)],f=e[(this._beginGridZ+s+i)*t+(this._beginGridX+_)+i],m=0;m<i;m++)for(var p=m/i,g=0;g<i;g++){var E=g/i,v=e[(this._beginGridZ+s+m)*t+(this._beginGridX+_)+g],x=E+p<=1?c+(u-c)*E+(d-c)*p:f+(d-f)*(1-E)+(u-f)*(1-p),S=Math.abs(x-v);o=Math.max(o,S)}i*=2,this._LODError[r]=o}},e.determineLod=function(e,t,n,i){var r=Vector3.distance(e,this._boundingSphere.center),a=D._maxLODLevel;if(!i){if(this._lastDistanceToEye==r)return this._currentLODLevel;this._lastDistanceToEye>r&&(a=this._currentLODLevel)}for(var o=a;1<=o;o--)if(Terrain.LOD_DISTANCE_FACTOR*this._LODError[o]/r*t<n){this._currentLODLevel=o;break}return this._lastDistanceToEye=r,this._currentLODLevel},D.__init__=function(){if(!D._bInit){var e=D.CHUNK_GRID_NUM/D.LEAF_GRID_NUM*(D.CHUNK_GRID_NUM/D.LEAF_GRID_NUM);D._planeLODIndex=__newvec(e);var t=0,n=0,i=0,r=0,a=0,o=0,s=null,l=null;for(t=0;t<e;t++)D._planeLODIndex[t]=new Array(D._maxLODLevel+1);for(t=0,r=D._maxLODLevel+1;t<r;t++)D._planeLODIndex[0][t]=D.calcPlaneLODIndex(t);for(t=1;t<e;t++)for(o=t*D.LEAF_PLANE_VERTEXT_COUNT,n=0,a=D._maxLODLevel+1;n<a;n++){for(s=D._planeLODIndex[0][n],l=new Uint16Array(s.length),i=0;i<s.length;i++)l[i]=s[i]+o;D._planeLODIndex[t][n]=l}for(D._skirtLODIndex=__newvec(e),t=0;t<e;t++)D._skirtLODIndex[t]=new Array(D._maxLODLevel+1);for(t=0,r=D._maxLODLevel+1;t<r;t++)D._skirtLODIndex[0][t]=D.calcSkirtLODIndex(t);for(t=1;t<e;t++)for(o=t*D.LEAF_SKIRT_VERTEXT_COUNT,n=0,a=D._maxLODLevel+1;n<a;n++){for(s=D._skirtLODIndex[0][n],l=new Uint16Array(s.length),i=0;i<s.length;i++)l[i]=s[i]+o;D._skirtLODIndex[t][n]=l}D._bInit=!0}},D.getPlaneLODIndex=function(e,t){return D._planeLODIndex[e][t]},D.getSkirtLODIndex=function(e,t){return D._skirtLODIndex[e][t]},D.calcPlaneLODIndex=function(e){D._maxLODLevel<e&&(e=D._maxLODLevel);var t=D.LEAF_GRID_NUM+1,n=0,i=null,r=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);i=new Uint16Array(r*r*6);for(var a=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/r,o=0;o<D.LEAF_GRID_NUM;o+=a)for(var s=0;s<D.LEAF_GRID_NUM;s+=a)i[n]=(o+a)*t+s,i[++n]=o*t+s,i[++n]=o*t+s+a,i[++n]=o*t+s+a,i[++n]=(o+a)*t+s+a,i[++n]=(o+a)*t+s,n++;return i},D.calcSkirtLODIndex=function(e){D._maxLODLevel<e&&(e=D._maxLODLevel);var t=D.CHUNK_GRID_NUM/D.LEAF_GRID_NUM*(D.CHUNK_GRID_NUM/D.LEAF_GRID_NUM)*D.LEAF_PLANE_VERTEXT_COUNT,n=D.LEAF_GRID_NUM+1,i=0,r=null,a=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);r=new Uint16Array(4*a*6);for(var o=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/a,s=0;s<4;s++){for(var l=0;l<D.LEAF_GRID_NUM;l+=o)r[i]=t+n+l,r[++i]=t+l,r[++i]=t+l+o,r[++i]=t+l+o,r[++i]=t+n+l+o,r[++i]=t+n+l,i++;t+=2*n}return r},D.getHeightFromTerrainHeightData=function(e,t,n,i,r){return n[(t=r<=(t=t<0?0:t)?r-1:t)*i+(e=i<=(e=e<0?0:e)?i-1:e)]},D.CHUNK_GRID_NUM=64,D.LEAF_GRID_NUM=32,D.__ADAPT_MATRIX__=null,D.__ADAPT_MATRIX_INV__=null,D._planeLODIndex=null,D._skirtLODIndex=null,D._bInit=!1,__static(D,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(D.LEAF_GRID_NUM+1)*(D.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(D.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=D.LEAF_PLANE_VERTEXT_COUNT+D.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=D.LEAF_GRID_NUM*D.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*D.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=D.LEAF_PLANE_MAX_INDEX_COUNT+D.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new Vector3},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(D.LEAF_GRID_NUM)}]),D}(),ShaderDefines$1=function(){function e(e){this.defineCounter=0,this.defines=null,this.defines=e?(this.defineCounter=e.defineCounter,e.defines.slice()):(this.defineCounter=0,[])}return __class(e,"laya.d3.shader.ShaderDefines",!0,null,"ShaderDefines$1"),e.prototype.registerDefine=function(e){var t=Math.pow(2,this.defineCounter++);return this.defines[t]=e,t},e}(),ValusArray=function(){function e(){this._data=null,this._data=[]}__class(e,"laya.d3.shader.ValusArray",!0);var t=e.prototype;return t.setValue=function(e,t){this._data[e]=t},__getset(0,t,"data",function(){return this._data}),e}(),ShaderInit3D=function(){function e(){}return __class(e,"laya.d3.shader.ShaderInit3D",!0),e.__init__=function(){var e,t;ShaderCompile3D._globalRegDefine("HIGHPRECISION",ShaderCompile3D.SHADERDEFINE_HIGHPRECISION),ShaderCompile3D._globalRegDefine("FOG",ShaderCompile3D.SHADERDEFINE_FOG),ShaderCompile3D._globalRegDefine("DIRECTIONLIGHT",ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT),ShaderCompile3D._globalRegDefine("POINTLIGHT",ShaderCompile3D.SHADERDEFINE_POINTLIGHT),ShaderCompile3D._globalRegDefine("SPOTLIGHT",ShaderCompile3D.SHADERDEFINE_SPOTLIGHT),ShaderCompile3D._globalRegDefine("UV",ShaderCompile3D.SHADERDEFINE_UV0),ShaderCompile3D._globalRegDefine("COLOR",ShaderCompile3D.SHADERDEFINE_COLOR),ShaderCompile3D._globalRegDefine("UV1",ShaderCompile3D.SHADERDEFINE_UV1),ShaderCompile3D._globalRegDefine("CASTSHADOW",ParallelSplitShadowMap.SHADERDEFINE_CAST_SHADOW),ShaderCompile3D._globalRegDefine("SHADOWMAP_PSSM1",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),ShaderCompile3D._globalRegDefine("SHADOWMAP_PSSM2",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),ShaderCompile3D._globalRegDefine("SHADOWMAP_PSSM3",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF_NO",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF1",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF2",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF3",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),ShaderCompile3D._globalRegDefine("DEPTHFOG",ShaderCompile3D.SAHDERDEFINE_DEPTHFOG),Shader3D.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n\tvec3 normalT = 2.0*normalMapSample - 1.0;\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent- dot(tangent, N)*N);\n\tvec3 B = cross(T, N);\n\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 ambinentColor,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec=-normalize(dirLight.Direction);\n\t\n\tamb=matAmb*ambinentColor;\n\t\n\tfloat  diffuseFactor=dot(lightVec, normal);\n\t\n\tif(diffuseFactor>0.0)\n\t{\n\t   vec3 v = reflect(-lightVec, normal);\n\t   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t   \n\t   dif = diffuseFactor * matDif * dirLight.Diffuse;\n\t   spec = specFactor * matSpe.rgb;\n\t}\n\t\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight,in vec3 ambinentColor, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec = poiLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > poiLight.Range )\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif( diffuseFactor > 0.0 )\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * poiLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\n\tfloat attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 ambinentColor,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tamb = vec3(0.0);\n\tdif =vec3(0.0);\n\tspec= vec3(0.0);\n\tvec3 lightVec = spoLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > spoLight.Range)\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif(diffuseFactor > 0.0)\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * spoLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\t\n\tfloat spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n\tfloat attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n\tamb *= spot;\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\n"),Shader3D.addInclude("Lighting.glsl","\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat Spot;\n\tfloat Range;\n};\n\n// U3D中使用衰减纹理,此函数模拟并非正确\n//float U3DAttenuation(in vec3 L,in float invLightRadius)\n//{\n//\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n//\tfRatio *= fRatio;\n//\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n//} \n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius)\n{\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius)); \t\n\treturn attenuation * attenuation;\n} \n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\t\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius)\n{\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n} \n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor)\n{\n    mediump vec3 h = normalize(viewDir-lightVec);\n    lowp float ln = max (0.0, dot (-lightVec,normal));\n    float nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec=normalize(light.Direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec,diffuseColor,specularColor);\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,normalLightVec,diffuseColor,specularColor);\n\tfloat spot = pow(max(dot(normalLightVec, normalize(light.Direction)), 0.0), light.Spot);\n\tfloat attenuate = spot*BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal)\n{\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\t\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tmat3 TBN = mat3(T, B, N);\n\t\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\n"),Shader3D.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2\t  u_shadowPCFoffset;\nuniform vec4     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n\tres -= res.xxyz * bitMask;\n\treturn res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n\tvec2 texelpos =texcoord / invsize;\n\tvec2 lerps = fract( texelpos );\n\tfloat sourcevals[4];\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\tnPSNum += int(posViewZ>pssmDistance.z);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\telse if( nPSNum == 2 )\n\t{\n\t\tlightVP = lightShadowVP[3];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t} \n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tif( posViewZ < pssmDistance.x )\n\t{\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n\t\tfloat fMyZ = vText.z - zBias;\n\t\t/*\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\t\tbool bInFrustum = all( bInFrustumVec );\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\t\tbool bFrustumTest = all( bFrustumTestVec );\n\t\t*/\n\t\tif ( fMyZ <= 1.0 ) \n\t\t{\n\t\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n\t\t\tvalue = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2\t\t\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO\t\t\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t\t}\n\t}\n\treturn value;\n}"),Shader3D.addInclude("WaveFunction.glsl","\nuniform vec2 u_WaveInfoD[20];\nuniform vec4 u_WaveInfo[20];\n\nuniform float TEXWAVE_UV_SCALE ;//= 20.0; //每texwidth像素代表的实际距离\n/**\n\t这里的计算都是\n*/\n\n/**\n* 计算一个波形\n*  开始计算的时候都按照z向上，最后输出的时候，颠倒一下。\n* @param tm {float} 毫秒\n*/\nvoid calcGerstnerWave(float curtm, vec3 pos, float deep, vec2 uvpos, out vec3 opos, out vec3 B, out vec3 T, out vec3 N, out float foamS){\n\tfloat tm = curtm/1000.;\n\topos = pos;\n\tvec3 wpos=vec3(0.);\t\t//累加的位置\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tT=vec3(0.,0.,0.);\n\tB=vec3(0.,0.,0.);\n\tvec2 cD ;//= D;\n\t//float deepAtt = max(0.,min(deep,1.0));\n\t//A*=deepAtt; //TODO\n\t\n\tfor( int i=0; i<4; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat Q = u_WaveInfo[i].x;//wi.QorK;\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\twpos += vec3(Q*A*cD.x*c,\n\t\t\t\t\tQ*A*cD.y*c,\n\t\t\t\t\tA*s);\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\tT += vec3(_QxyAWs,\n\t\t\t\tQ*cD.y*cD.y*AWs,//记得1-\n\t\t\t\tcD.y*AWc\n\t\t\t);\n\t\tB += vec3(Q*cD.x*cD.x*AWs,//记得1-\n\t\t\t\t_QxyAWs,\n\t\t\t\tcD.x*AWc\n\t\t\t);\n\t\t//float v1 = exp(-tan((dop*W - tm*P)/2.+1.07));//除2，+pi/2 这样正好能对齐\n#ifdef USE_FOAM\t\t\n\t\tfloat v1 = 0.5-sin((dop*W - tm*P)/1.+2.0)/2.;\n\t\tfoamS += pow(v1,9.)/4.;\n#endif\n\t}\n\tT.y=1.-T.y; B.x=1.-B.x;N.z=1.-N.z;\n\topos += vec3(wpos.x,wpos.z*min(deep/10.,1.),wpos.y);\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tT.xyz=T.xzy;\n\tB.xyz=B.xzy;\n\tN.xyz=N.xzy;\n}\n\n\nvoid calcWave(float curtm, vec2 uv, out vec3 B, out vec3 T, out vec3 N){\n\tfloat tm = curtm/1000.;\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tvec2 uvpos = uv*TEXWAVE_UV_SCALE; //TODO 这个范围是什么 就是1？\n\tuvpos.y*=-1.;\n\tvec2 cD;// = D;\n\tconst int NumWaves = 4;\n\tfloat scale = 1./float(NumWaves);\n\tfor( int i=0; i<NumWaves; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat k = 1.5;//u_WaveInfo[i].x;//wi.QorK; TODO  不知道为什么，这个取u_WaveInfo[i].x，在mi3w上就会闪。测试发现实际值也传过来了，就是1.5\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\t\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\t/*\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\t*/\n\t\tfloat kWAc = scale*c;//k*W*A*c;  为了提高精度，这里只保留sin，cos部分，实际使用的时候再乘回来。\n\t\t//float kWAc = k*W*A*c;  \n\t\tN += vec3(\n\t\t\t-kWAc*cD.x*pow((s+1.)/2.,k-1.),\n\t\t\t-kWAc*cD.y*pow((s+1.)/2.,k-1.),\n\t\t\t1.\n\t\t);\n\t}\n\t//N.z=1.-N.z;\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tN.xyz=N.xzy;\n}\n"),Shader3D.addInclude("BRDF.glsl","vec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\n\tvec3 halfDir = SafeNormalize(viewDir - lightDir);\n\t\n\tfloat nv = abs(dot(normal, viewDir));\n\t\n\tfloat nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\n\tfloat nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\n\tfloat lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\n\tfloat lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\n\t\n\tfloat diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\t\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\n\t\n\t//#if UNITY_BRDF_GGX\n\tfloat V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = GGXTerm(nh, roughness);\n\t\n\tfloat specularTerm = V * D * PI;\n\t\n\tspecularTerm = sqrt(max(0.0001, specularTerm));\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\n\tvec4 color;\n\tcolor.rgb = diffuseColor * (gi + lightColor * diffuseTerm) + specularTerm * lightColor * FresnelTerm (specularColor, lh);\n\t\n\tcolor.a = 1.0;\n\treturn color;\n}"),Shader3D.addInclude("PBRUtils.glsl","struct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvec3 UnpackScaleNormal(in vec2 uv0)\n{\n\t#ifdef NORMALTEXTURE\n\t\tvec3 normalT;\n\t\tvec4 normalMapSample = texture2D(u_NormalTexture, uv0);\n\t\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\t\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\t\tnormalT.xy *= u_normalScale;\n\t\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\t\t\n\t\tvec3 T = normalize(v_Tangent);\n\t\tvec3 B = normalize(v_Binormal);\n\t\tvec3 N = normalize(v_Normal);\n\t\tmat3 TBN = mat3(T, B, N);\n\t\t\n\t\tvec3 bumpedNormal = TBN * normalize(normalT);\n\t\treturn bumpedNormal;\n\t#else\n\t\treturn normalize(v_Normal);\n\t#endif\n}\n\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nfloat PI = 3.14159265359;\n\nvec3 FresnelTerm (in vec3 F0, in float cosA)\n{\n\treturn F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\n}\n\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\n{\n\treturn perceptualRoughness * perceptualRoughness;\n}\n\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\n{\n\tfloat m = PerceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat sq = max(0.0001, m * m);\n\tfloat n = (2.0 / sq) - 2.0;\n\tn = max(n, 0.0001);\n\treturn n;\n}\n\nfloat RoughnessToPerceptualRoughness(in float roughness)\n{\n\treturn sqrt(roughness);\n}\n\nfloat SmoothnessToRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness) * (1.0 - smoothness);\n}\n\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness);\n}\n\nvec3 SafeNormalize(in vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * (1.0 / sqrt(dp3));\n}\n\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\n{\n\tfloat fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\tfloat lightScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\n\tfloat viewScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\n\n\treturn lightScatter * viewScatter;\n}\n\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\n{\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\n\treturn 0.5 / (lambdaV + lambdaL + 0.00001);\n}\n\nfloat GGXTerm (float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0;\n\treturn 0.31830988618 * a2 / (d * d + 0.0000001);\n}\n\nfloat OneMinusReflectivityFromMetallic(in float metallic)\n{\n\tfloat oneMinusDielectricSpec = DielectricSpecularColor.a;\n\treturn oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\n}\n\nfloat SpecularStrength(vec3 specular)\n{\n    //(SHADER_TARGET < 30)return specular.r; \n    return max (max (specular.r, specular.g), specular.b);\n}\n\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\n{\n\tspecularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\n\toneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec3 EnergyConservationBetweenDiffuseAndSpecular(in vec3 diffuseColor, in vec3 specularColor, out float oneMinusReflectivity)\n{\n\toneMinusReflectivity = 1.0 - SpecularStrength(specularColor);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec4 Occlusion(in vec2 uv0){\n\t#ifdef OCCLUSIONTEXTURE\n\t\tvec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\n\t\tfloat occ = occlusionTextureColor.g;\n\t\tfloat oneMinusT = 1.0 - u_occlusionStrength;\n\t\tfloat lerpOneTo = oneMinusT + occ * u_occlusionStrength;\n\t\treturn occlusionTextureColor * lerpOneTo;\n\t#else\n\t\treturn vec4(1.0);\n\t#endif\n}\n\nvec2 ParallaxOffset(in vec3 viewDir){\n\t#ifdef PARALLAXTEXTURE\n\t\tfloat h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\n\t\th = h * u_parallaxScale - u_parallaxScale / 2.0;\n\t\tvec3 v = viewDir;\n\t\tv.z += 0.42;\n\t\tvec2 offset = h * (v.xy / v.z);\n\t\treturn v_Texcoord0 + offset;\n\t#else\n\t\treturn v_Texcoord0;\n\t#endif\n}\n\n"),Shader3D.addInclude("PBRStandardLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRStandardLight(in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 specularColor;\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (diffuseColor, metallic, specularColor, oneMinusReflectivity);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\treturn color;\n}\n\nvec4 PBRStandardDiectionLight (in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRStandardLight(diffuseColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec2 MetallicGloss(in float diffuseTextureAlpha, in vec2 uv0)\n{\n\tvec2 mg;\n\t\n\t#ifdef METALLICGLOSSTEXTURE\n\t\tvec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.r = metallicGlossTextureColor.r;\n\t\t\tmg.g = diffuseTextureAlpha;\n\t\t#else\n\t\t    mg = metallicGlossTextureColor.ra;\n\t\t#endif\n\t\tmg.g *= u_smoothnessScale;\n\t#else\n\t\tmg.r = u_metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.g = diffuseTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tmg.g = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n\treturn mg;\n}\n\n'),Shader3D.addInclude("PBRSpecularLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRSpecularLight(in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat oneMinusReflectivity;\n\tdiffuseColor = EnergyConservationBetweenDiffuseAndSpecular (diffuseColor, specularColor, oneMinusReflectivity);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\treturn color;\n}\n\nvec4 PBRSpecularDiectionLight (in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRSpecularLight(diffuseColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 SpecularGloss(float diffuseTextureAlpha, in vec2 uv0)\n{\n    vec4 sg;\n\t\n\t#ifdef SPECULARTEXTURE\n\t\tvec4 specularTextureColor = texture2D(u_SpecularTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tsg.rgb = specularTextureColor.rgb;\n\t\t\tsg.a = diffuseTextureAlpha;\n\t\t#else\n\t\t\tsg = specularTextureColor;\n\t\t#endif\n\t\tsg.a *= u_smoothnessScale;\n\t#else\n\t\tsg.rgb = u_SpecularColor.rgb;\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tsg.a = diffuseTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tsg.a = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n    return sg;\n}\n\n');var n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_ReflectTexture:[5,1],u_AlphaTestValue:[0,1],u_DiffuseColor:[6,1],u_GlowingEdgeColor:[12,1],u_MaterialSpecular:[8,1],u_Shininess:[9,1],u_MaterialReflect:[10,1],u_TilingOffset:[11,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Color":[4,4],"u_DirectionLight.Direction":[3,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Color":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Color":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},r=Shader3D.nameKey.add("BLINNPHONG");e='attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal; \n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tmat3 worldMat;\n\t\t#ifdef BONE\n\t\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\t#else\n\t\t\tworldMat=mat3(u_WorldMat);\n\t\t#endif  \n\t\tv_Normal=worldMat*a_Normal;//TODO:法线可以用"魔法"矩阵\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tv_Tangent=worldMat*a_Tangent0.xyz;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t\t#ifdef BONE\n\t\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t\t#else\n\t\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\tv_Texcoord0=a_Texcoord0;\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0+v_Texcoord0.y);\n\t\t#endif\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t\t#else\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t\t#endif \n\t\t#else\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t\t#else\n\t\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t\t#endif \n\t\t#endif \n\t#endif\n\n\t#ifdef COLOR\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',t='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nuniform vec4 u_DiffuseColor;\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(GLOWINGEDGE)\n\tvarying vec3 v_ViewDir; \n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform vec3 u_MaterialReflect;\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(GLOWINGEDGE)\n\tvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(GLOWINGEDGE)\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\n#ifdef GLOWINGEDGE\n\tuniform vec4 u_GlowingEdgeColor;\n#endif\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#ifdef COLOR\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(GLOWINGEDGE)\n\t\tvec3 normal;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t\t#else\n\t\t\tnormal = normalize(v_Normal);\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(GLOWINGEDGE)\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t\tvec3 diffuse = vec3(0.0);\n\t\tvec3 specular= vec3(0.0);\n\t\tvec3 dif,spe;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef SPOTLIGHT\n\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t\n\tvec3 finalDiffuse;\n\t#ifdef LIGHTMAP\n\t\tfinalDiffuse=texture2D(u_LightMap, v_LightMapUV).rgb*2.0;\n\t\t//float exponent = texture2D(u_LightMap, v_LightMapUV).a;\n\t\t//finalDiffuse = texture2D(u_LightMap, v_LightMapUV).rgb;\n\t\t//float ratio = pow(2.0, exponent * 255.0 - (128.0 + 8.0));\n\t\t//finalDiffuse = finalDiffuse * 255.0 * ratio;\t\n\t\t//finalDiffuse = sqrt(finalDiffuse);\n\t#else\n\t\tfinalDiffuse=vec3(0.0);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tfinalDiffuse+=diffuse;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse)*shadowValue,mainColor.a);\n\t#else\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse),mainColor.a);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t#ifdef RECEIVESHADOW\n\t\t\tgl_FragColor.rgb+=specular*shadowValue;\n\t\t#else\n\t\t\tgl_FragColor.rgb+=specular;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef GLOWINGEDGE\n\t\tfloat Rim = 1.0 - max(0.0,dot(viewDir, normal));\n\t\tvec3 Emissive = 2.0 * u_DirectionLight.Color * u_GlowingEdgeColor.rgb * pow(Rim,5.0);\n\t\tgl_FragColor.rgb += Emissive;\n\t#endif\n\n\t#ifdef REFLECTMAP\n\t\tvec3 incident = -viewDir;\n\t\tvec3 reflectionVector = reflect(incident,normal);\n\t\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\t\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n\t#endif\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t  main_normal();\n\t#endif  \n}\n\n';var a=ShaderCompile3D.add(r,e,t,n,i);BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),BlinnPhongMaterial.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),BlinnPhongMaterial.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),BlinnPhongMaterial.SHADERDEFINE_GLOWINGEDGE=a.registerMaterialDefine("GLOWINGEDGE"),n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_AmbientTexture:[5,1],u_ReflectTexture:[6,1],u_AlphaTestValue:[0,1],u_Albedo:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_TilingOffset:[15,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var o=Shader3D.nameKey.add("SIMPLE");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#if defined(AMBIENTMAP)||(defined(LIGHTMAP)&&defined(UV1))\nattribute vec2 a_Texcoord1;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_LightMapUV;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n \n//TODO没考虑UV动画呢\n#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\tv_Texcoord0=a_Texcoord0;\n#endif\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t#else\n\t\tworldMat=mat3(u_WorldMat);\n\t#endif  \n\tv_Normal=worldMat*a_Normal;\n\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tv_Tangent0=worldMat*a_Tangent0;\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t#ifdef BONE\n\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t#else\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n\tv_Texcoord0=a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,v_Texcoord0.y+1.0);\n\t#endif\n\t#ifdef UVTRANSFORM\n\t\tv_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n\t#endif\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\n\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t#else\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t#else\n\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t#endif \n\t#endif \n#endif\n\n#ifdef COLOR\n\tv_Color=a_Color;\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\n\tmain_castShadow();\n#else\n\tmain_normal();\n#endif\n}",t='#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nvarying vec2 v_LightMapUV;\n#endif\n#ifdef AMBIENTMAP\nuniform sampler2D u_AmbientTexture;\n#endif\n#ifdef LIGHTMAP\nuniform sampler2D u_LightMap;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#if defined(FOG)||defined(DEPTHFOG)\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||(defined(RECEIVESHADOW)&&(defined(SHADOWMAP_PSM2)||defined(SHADOWMAP_PSM3)))\nuniform vec3 u_CameraPos;\n#endif\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)\nvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n#if defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n#endif \n  \n#if defined(COLOR)&&!defined(DIFFUSEMAP)\n\tgl_FragColor=v_Color;\n#endif \n  \n#if defined(DIFFUSEMAP)&&defined(COLOR)\n\tvec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\tgl_FragColor=texColor*v_Color;\n#endif\n  \n#if !defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=vec4(1.0,1.0,1.0,1.0);\n#endif \n    \n#ifdef ALPHATEST\n\tif(gl_FragColor.a-u_AlphaTestValue<0.0)\n\t\tdiscard;\n#endif\n  \n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n\t#else\n\t\tnormal = normalize(v_Normal);\n    #endif\n#endif\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\t\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef AMBIENTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_Albedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n\t\tspecular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular*shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n\t#endif\n#endif\n  \n#ifdef REFLECTMAP\n\tvec3 incident = -toEye;\n\tvec3 reflectionVector = reflect(incident,normal);\n\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n#endif\n  \n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t#ifdef ADDTIVEFOG\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t#else\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n#endif\n#ifdef DEPTHFOG\n\tfloat lerpFact = (-v_PositionWorld.y-u_FogStart)/u_FogRange;\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\t\t\n\tmain_castShadow();\n#else\n  main_normal();\n#endif  \n}\n\n',a=ShaderCompile3D.add(o,e,t,n,i),StandardMaterial.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),StandardMaterial.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),StandardMaterial.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),StandardMaterial.SHADERDEFINE_EMISSIVEMAP=a.registerMaterialDefine("EMISSIVEMAP"),StandardMaterial.SHADERDEFINE_AMBIENTMAP=a.registerMaterialDefine("AMBIENTMAP"),StandardMaterial.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),StandardMaterial.SHADERDEFINE_UVTRANSFORM=a.registerMaterialDefine("UVTRANSFORM"),StandardMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),StandardMaterial.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),n={a_Position:0,a_Color:1},i={u_MvpMatrix:[1,2]};var s=Shader3D.nameKey.add("LINE");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",ShaderCompile3D.add(s,e,t,n,i),n={a_position:0,a_normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_lodRect:[9,3],irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],u_aoObjPos:[14,1],texBaseColor:[1,1],texNormal:[2,1],texPbrInfo:[3,1],texPrefilterdEnv:[8,3],texHSNoise:[15,1],texPrefilterDiff:[7,3],u_AlphaTestValue:[0,1],texBRDFLUT:[4,1],u_UVAniAge:[5,1],u_roughness:[6,1],u_metaless:[7,1],u_UVMatrix:[8,1],u_UVAge:[9,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var l=Shader3D.nameKey.add("PBR");e="\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n#ifdef HAS_TANGENT\nattribute vec3 tangent;\nattribute vec3 binormal;\n#endif\nattribute vec2 uv;\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\n\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\nvoid main() {\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tgl_Position = mvp*skinTransform*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix*skinTransform;\n#else\n\tgl_Position = mvp*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix;\n#endif\t\n\tvWorldPos = modelMat*vec4(a_position,1.);\n\n#ifdef CASTSHADOW \n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tvUv = uv;\n\t#endif\t\n#else\n    vUv = uv;\n\tvWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t#ifdef HAS_TANGENT\n\tvWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\tvWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n\t#endif\n    \n    vViewDir = (vWorldPos.xyz-cameraPosition);//这个不能normalize。否则无法线性差值了\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.z;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vWorldPos;\n\t#endif\n#endif\t\n#endif\n}\n",t='//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n#ifdef HAS_PBRINFO\nuniform sampler2D texPbrInfo;   //Ao, Roughness, Metallic\n#endif\nuniform float u_hdrexposure;\nuniform float u_AlphaTestValue;\n\nuniform float u_roughness;\nuniform float u_metaless;\nconst float maxlv = 7.;\t//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n\t\t\t\t\t\t\t\nuniform mat4 irrad_mat_red;\nuniform mat4 irrad_mat_green;\nuniform mat4 irrad_mat_blue;\t\t\t\t\t\t\t\n\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n\tvec2 uv = vec2(u,v);\n\tuv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n\treturn texture2D(tex,uv,lod-16.);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn tex2dLod(tex,envu,envv,lod);\n}\n\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nfloat environment_exposure = 1.0;\nvec3 diff_sh9(vec3 dir){\n\tvec4 shDir = vec4(dir.x,-dir.z,dir.y,1.0);\n  return max(vec3(0.0), vec3(\n\tdot(shDir, irrad_mat_red * shDir),\n\tdot(shDir, irrad_mat_green * shDir),\n\tdot(shDir, irrad_mat_blue * shDir)\n\t)) * environment_exposure;\t\n}\n\n#ifdef HAS_TANGENT\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );\n    return normalize( tsn * mapN );\n}\n#endif\n\nvec4 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tbasecolor.rgb = pow(basecolor.rgb,vec3(2.2));\n\tfloat metaless = 1.0; \t\n\tconst float ismetalinfov = (128./255.);\n\tif(basecolor.a>=ismetalinfov){//这时候表示金属度\n\t\tmetaless = (basecolor.a-ismetalinfov)*2.;\n\t\tbasecolor.a = 1.0;\n\t}else{\n\t\tmetaless = 0.;\n\t\tbasecolor.a = basecolor.a*2.0;\n\t}\n\t#ifdef FIX_METALESS\n\tmetaless = u_metaless;\n\t#endif\n\t#ifdef HAS_PBRINFO\t\n\tvec4 pbrinfo = texture2D(texPbrInfo, vUv);\n\tmetaless = pbrinfo.b;\n\trough = pbrinfo.g;\n\t#endif\n    const vec3 nonmetalF0 =vec3(0.02);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n\t\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, rough*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(rough , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    speccontrib = (F0* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n\tvec3 color_spec = PrefilteredColor.rgb*speccontrib;\n\t\n\tvec3 color_diff=diff_sh9(normal);\n\tvec3 outc =  color_diff*mix(basecolor.rgb,vec3(0.),metaless)*(vec3(1.0)-speccontrib)+color_spec;\n\t#ifdef HAS_PBRINFO\n\toutc*=pbrinfo.r;\n\t#endif\n\treturn vec4(outc, basecolor.a);\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tconst vec3 lightdir=normalize(vec3(1.,1.,0.));\n\tconst vec3 spcecol = vec3(1.,0.8,0.8);\n\tconst vec3 amb = vec3(0.5);\n\tvec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n\t//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n\treturn diffv*basecolor.rgb;//+spec;\n}\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main() {\n#ifdef CASTSHADOW\n\tgl_FragColor=packDepth(gl_FragCoord.w);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(texBaseColor,vUv).w;\n\t\tif( alpha < u_AlphaTestValue ){\n\t\t\tdiscard;\n\t\t}\n\t#endif\n#else\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.0001);\n\t\t#endif\n\t#endif\t\n\t\n    vec3 normal =  normalize(vWorldNorm);\n\tvec4 normtex = texture2D( texNormal, vUv );\n\t#ifdef HAS_TANGENT\t\n\tnormal = applyNormalTex(normtex.xyz, normal);\n\t#endif\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n\tfloat roughness = normtex.a;\n\t#ifdef FIX_ROUGHNESS\n\troughness = u_roughness;\n\t#endif\n\t\n\tvec4 pbrl = pbrlight(normal,roughness,NoV,R)*u_hdrexposure;\n    gl_FragColor.rgb =  pow(pbrl.rgb,vec3(0.45455));\n\t//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n\t#ifdef RECEIVESHADOW\n\tgl_FragColor.rgb *= max(shadowValue,0.7);\n\t#endif\n\t\n    gl_FragColor.a = pbrl.a;\n\n#endif\n}\n',a=ShaderCompile3D.add(l,e,t,n,i),PBRMaterial.SHADERDEFINE_FIX_METALESS=a.registerMaterialDefine("FIX_METALESS"),PBRMaterial.SHADERDEFINE_FIX_ROUGHNESS=a.registerMaterialDefine("FIX_ROUGHNESS"),PBRMaterial.SHADERDEFINE_HAS_TANGENT=a.registerMaterialDefine("HAS_TANGENT"),PBRMaterial.SHADERDEFINE_HAS_PBRINFO=a.registerMaterialDefine("HAS_PBRINFO"),PBRMaterial.SHADERDEFINE_USE_GROUNDTRUTH=a.registerMaterialDefine("USE_GROUNDTRUTH"),PBRMaterial.SHADERDEFINE_TEST_CLIPZ=a.registerMaterialDefine("CLIPZ"),n={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},i={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_EmissionColor:[8,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_MetallicGlossTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_metallic:[9,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var _=Shader3D.nameKey.add("PBRStandard");e="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}",t='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec4 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\n\n#ifdef DIFFUSETEXTURE\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRStandardLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec2 mg;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n\t\tvec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n\t\tmg = MetallicGloss(diffuseTextureColor.a, uv0);\n\t#else\n\t\tvec4 diffuseColor = u_DiffuseColor;\n\t\tmg = MetallicGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(diffuseColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tgl_FragColor = diffuseColor;\n\t\n\tvec3 normal = UnpackScaleNormal(uv0);\n  \n\tvec3 gi = (u_AmbientColor * Occlusion(uv0)).rgb;\n  \n\tvec4 color = PBRStandardDiectionLight(diffuseColor.rgb, mg.r, mg.g, normal, viewDir, u_DirectionLight, gi);\n\t\n\tcolor.a = diffuseColor.a;\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',a=ShaderCompile3D.add(_,e,t,n,i),PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE=a.registerMaterialDefine("METALLICGLOSSTEXTURE"),PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=a.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE=a.registerMaterialDefine("NORMALTEXTURE"),PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE=a.registerMaterialDefine("PARALLAXTEXTURE"),PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=a.registerMaterialDefine("OCCLUSIONTEXTURE"),PBRStandardMaterial.SHADERDEFINE_EMISSION=a.registerMaterialDefine("EMISSION"),PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE=a.registerMaterialDefine("EMISSIONTEXTURE"),PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),n={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},i={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_SpecularColor:[8,1],u_EmissionColor:[9,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_SpecularTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var h=Shader3D.nameKey.add("PBRSpecular");e="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}",t='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec4 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\nuniform vec4 u_SpecularColor;\n\n#ifdef DIFFUSETEXTURE\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRSpecularLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec4 sg;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n\t\tvec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n\t\tsg = SpecularGloss(diffuseTextureColor.a, uv0);\n\t#else\n\t\tvec4 diffuseColor = u_DiffuseColor;\n\t\tsg = SpecularGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(diffuseColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\tvec3 normal = UnpackScaleNormal(uv0);\n\t\n\tvec3 gi = (u_AmbientColor * Occlusion(uv0)).rgb;\n\t\n\t//float a = (sg.r+sg.g+sg.b) / 3.0;\n  \n\tvec4 color = PBRSpecularDiectionLight(diffuseColor.rgb, sg.rgb, sg.a, normal,viewDir, u_DirectionLight, gi);\n\t\n\tcolor.a = diffuseColor.a;\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',a=ShaderCompile3D.add(h,e,t,n,i),PBRSpecularMaterial.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE=a.registerMaterialDefine("SPECULARTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=a.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE=a.registerMaterialDefine("NORMALTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE=a.registerMaterialDefine("PARALLAXTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=a.registerMaterialDefine("OCCLUSIONTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_EMISSION=a.registerMaterialDefine("EMISSION"),PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE=a.registerMaterialDefine("EMISSIONTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),n={a_position:0,a_normal:3,uv:2},i={irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],texBaseColor:[1,1],texNormal:[2,1],texSky:[11,1],texUnderWater:[3,1],texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texWaterDisp:[4,1],texWaveDetail:[9,1],texDeepColor:[10,1],texWaterInfo:[16,1],texFoam:[17,1],GEOWAVE_UV_SCALE:[18,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_curTm:[8,1],u_scrsize:[15,1],u_WaveInfoD:[13,1],u_WaveInfo:[12,1],u_WaveMainDir:[14,1],u_DeepScale:[20,1],u_SeaColor:[19,1],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4]};var c=Shader3D.nameKey.add("Water");e='\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\nuniform float u_curTm;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n//uniform sampler2D texWaterDisp;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nuniform sampler2D texWaterInfo;\nvarying vec4 vWaterInfo;\nuniform float u_DeepScale;//texWaterInfo.r*vDeepScale\n#endif\nuniform float u_WaveMainDir;\t//主波方向\nuniform float GEOWAVE_UV_SCALE ;//= 100.0;\n\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vDisp;\nvarying float fDeep;\nvarying mat2 matUVTrans;\nvarying float fFoam;\n\nconst float PI = 3.14159265358979323846264;\n\n#include "WaveFunction.glsl"\n\nvec2 getPosFromUV(vec2 uv){\n\treturn uv*50.;\n}\n\nvoid main() {\n\tvec3 pos = a_position;\n    vUv = uv;\n\t\n\t//vDisp = texture2D(texWaterDisp,uv).rgb;\n\t//vec3 disp = vDisp;\n\t\n\t//TODO 这里有个潜规则。\n\tfloat tt = pos.y; pos.y=pos.z; pos.z=-tt;\n\t\n\t#ifdef USE_VERTEX_DEEPINFO\n\tfDeep = -pos.y;\n\tpos.y=0.0;\n\t#else\n\tvWaterInfo = texture2D(texWaterInfo,uv);\n\tfDeep = vWaterInfo.r*u_DeepScale;\n\t#endif\n\t\n\t\n\t//计算波形\n\tmat4 modelMat = modelMatrix;\n\tvec3 opos, T,B,N;\n\tfloat foams=0.;\n\tvec2 uvpos = uv*GEOWAVE_UV_SCALE+vec2(modelMat[3][0],0.);//TODO 如果有旋转缩放怎么办\n\tcalcGerstnerWave(u_curTm, pos,fDeep, uvpos,opos,B,T,N,foams);\n\tfFoam = foams;\n\tgl_Position = mvp*vec4(opos,1.);\n\tvWorldPos = modelMat*vec4(opos,1.);\n\n\tvWorldNorm = normalize((modelMatrix*vec4(N,0.0)).xyz);\n\tvWorldTan = normalize((modelMatrix*vec4(T,0.0)).xyz);\n\tvWorldBin = normalize((modelMatrix*vec4(B,0.0)).xyz);\n    vViewDir = vWorldPos.xyz-cameraPosition; //这个不能取normalize，否则会引入非线性\n\t\n\tfloat s = sin(u_WaveMainDir);\n\tfloat c = cos(u_WaveMainDir);\n\tmatUVTrans = mat2(c,-s,s,c);\n}\n',t="//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec3 vViewDir;//入射。pos-cam\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying float fDeep;\nvarying mat2 matUVTrans;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nvarying vec4 vWaterInfo;\n#endif\nmat3 matTBNOff;//\n\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n#ifdef CUBE_ENV\nuniform samplerCube texSky;\n#else\nuniform sampler2D texSky;\n#endif\nuniform sampler2D texUnderWater;\nuniform sampler2D texWaveDetail;\n//uniform sampler2D texDeepColor;\nuniform sampler2D texFoam;\nvarying float fFoam;\nuniform float u_curTm;\nuniform vec2 u_scrsize;\nuniform vec3 u_SeaColor;//\n\nconst int NumTexWaves=4;\nconst float Amp_over_L = 0.01;\n//const vec3 SEA_COLOR1 = vec3(0.0292,0.672,0.7467);//大洋\n//const vec3 SEA_COLOR2 = vec3(0,0.927,0.43);//近海\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/*\n\t各种 ToneMap\n*/\n//Reinhard\nvec3 ReinhardToneMapping(vec3 color, float adapted_lum) {\n    const float MIDDLE_GREY = 1.;\n    color *= MIDDLE_GREY / adapted_lum;\n    return color / (1.0 + color);\n}\n\n//CE2\nvec3 CEToneMapping(vec3 color, float adapted_lum){\n    return 1. - exp(-adapted_lum * color);\n}\n\n//UC2\nvec3 F1(vec3 x){\n\tconst float A = 0.22;\n\tconst float B = 0.30;\n\tconst float C = 0.10;\n\tconst float D = 0.20;\n\tconst float E = 0.01;\n\tconst float F = 0.30;\n \n\treturn ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;\n}\n\nvec3 Uncharted2ToneMapping(vec3 color, float adapted_lum){\n\tconst vec3 WHITE = vec3(11.2);\n\treturn F1(1.6 * adapted_lum * color) / F1(WHITE);\n}\n\n//ACES\nvec3 ACESToneMapping(vec3 color, float adapted_lum){\n\tconst float A = 2.51;\n\tconst float B = 0.03;\n\tconst float C = 2.43;\n\tconst float D = 0.59;\n\tconst float E = 0.14;\n\n\tcolor *= adapted_lum;\n\treturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\n/*\n\t与位于0点的测试棒的相交测试交点\n\t这个是瞎写的，只是为了测试\n*/\nbool hitClydiner(vec3 pos, vec3 dir, out vec3 hitpos, out vec3 hitnormal){\n\tconst float r = 0.5;\n\tfloat a = dir.x*dir.x+dir.z*dir.z;\n\tfloat b = 2.*dir.x*pos.x+2.*dir.z*pos.z;\n\tfloat c = pos.x*pos.x+pos.z*pos.z-r*r;\n\tfloat d = b*b-4.*a*c;\n\tif(d>=0.0){\n\t\tfloat t = (-b+sqrt(d))/2./a;\n\t\tt =min(t, (-b-sqrt(d))/2./a);\n\t\thitpos = pos+dir*t;\n\t\treturn true;\n\t}\n\t/*\n\tvec3 v1 = normalize(cross(dir,vec3(0.,1.,0.)));//公垂线\n\tfloat dist = dot(pos,v1);//最短距离\n\tif(abs(dist)<r){\n\t\treturn true;\n\t}\n\t*/\n\treturn false;\n}\n\n///* 根据散射公式来计算某个方向的颜色 *///\n//\nfloat phase_function(float costheta, float g, float g2){\n\treturn 1.5*( (1.0-g2) / (2.0+g2) ) * (1.0+costheta*costheta) / pow(1.0+g2-2.0*g*costheta, 1.5);\t\n}\n\nconst float _density = .2;\nconst vec3 _vLightDir=vec3(0.,-1.,0.);//必须是规格化的\nconst int _SAMPLENUM = 20;\nconst float _K1 = 1.0;\nconst float _g = -0.93;\n//\nvec3 calcScatter(vec3 start, vec3 dir, vec3 end){\n\tfloat len = length(end-start);\n\tfloat costheta = dot(dir,_vLightDir);\n\tfloat g2 = _g*_g;\n\tfloat K = _K1*len*_density*phase_function(costheta,_g,g2);\n\t//用分段的方式来积分\n\tfloat dlen = len/float(_SAMPLENUM);//距离平分\n\tfloat ddeep = (start.y-end.y)/float(_SAMPLENUM);//深度平分\n\tfloat sum=0.;\n\tfor( int i=0; i<_SAMPLENUM; i++){\n\t\tfloat fi = float(i);\n\t\tfloat v1 = exp(-_density*(dlen+ddeep)*fi);//TODO 应该可以用分析法计算出来\n\t\tsum += v1;\n\t}\n\treturn vec3(K*sum);\n}\n///* 根据散射公式来计算某个方向的亮度  END *///\n\nconst float cDeep = -2.;\t//假设水的深度\nvec3 getShuiDiColor(vec3 pos, vec3 dir, vec3 normal){\n\t//一个无限大的水底，黑白格纹理。纹理长度为1米\n\tfloat t = ( cDeep-pos.y )/dir.y;\n\tif(t<0.) return vec3(1.,0.,0.);//TEST\n\tbool bhit = false;\n\tvec3 hitpos;\n\tvec3 hitcolor;\n\tvec3 hn;\n\tif(hitClydiner(pos,dir,hitpos,hn) && hitpos.y>cDeep && hitpos.y<pos.y){\n\t\tbhit=true;\n\t\thitcolor = vec3(.8,.8,.8);\n\n\t}else\n\t{\n\t\thitpos = pos+dir*t;\n\t\tvec3 hp = floor(hitpos);\n\t\tfloat a = mod((hp.x+hp.z),2.);\n\t\thitcolor = (a<.9)?vec3(0.,0.,0.):vec3(1.,1.,1.);\n\t\t//hitcolor = texture2D(texUnderWater,hitpos.xz/10.).rgb;\n\t}\n\t\n\tfloat l = length(hitpos-pos);\n\t//return texture2D(texDeepColor,vec2(min(max(l/400.,0.),1.),0.5)).rgb;\n\t//return SEA_COLOR1*calcScatter(pos,dir,hitpos);\n\tfloat left = pow(0.8,l);//假设透过率为80%，则到达水底的时候的光强。\n\treturn mix(hitcolor,u_SeaColor,1.-left);\n}\n\n/*\n\tview已经normalize了\n*/\nvec3 getRefractColor(vec3 view,vec3 normal){\n\tvec3 T = refract(-view, normal, 0.7);\n\treturn getShuiDiColor(vWorldPos.xyz,T,normal); \n}\n\nvec4 calcWaterC(vec3 view, vec3 normal, float von, vec3 R, float rough){\n\t/*\n\t只有浪顶的法线向下，也就是波形形成了交叠的时候，才会这样，所以要通过参数控制避免出现这种情况，而不是在这里保护。\n\tif(dot(R,vec3(0.,1.,0.))<0.){\n\t\tR = -R;\n\t}\n\t*/\n\t//vec3 refr = getRefractColor(-view,normal);\n#ifdef USE_REFR_TEX\t\n\tvec3 refr = texture2D(texUnderWater, gl_FragCoord.xy/u_scrsize+normal.xz/8.).rgb;\n#else\n\tvec3 refr = u_SeaColor;\n#endif\n\tfloat F0=0.02;\n\t//菲涅尔，越大反射越强\n\tfloat f =  F0+(1.0-F0)*exp2((-5.55473*von-6.98316)*von);\n\t//float f = F0+(1.0-F0)*pow(1.-von,5.);\n\t//能看到水底的程度。反射剩余的*水中的衰减\n\t//float a = (1.-f)*(1.-deepk);\n#ifdef CUBE_ENV\n\tvec4 reflc = textureCube(texSky,R);\n#else\n\tvec4 reflc = texPanorama(texSky, R);\n#endif\n#ifdef HDR_ENV\n\tvec3 refl = _RGBEToRGB(reflc)*f;\n#else\n\tvec3 refl = reflc.rgb*f;\n#endif\n\t//return vec4(refl*(1.-rough),1.);\n\t\n\t//vec3 refl = reflc.rgb*f;\n\tvec3 final = mix(refr, u_SeaColor, min(fDeep/10.,1.))+refl*(max(0.,1.-rough));\n#ifdef HDR_ENV\n\tfinal = ACESToneMapping(final,1.);//TODO 这个要uniform传入\n#endif\n\treturn vec4(final,f);\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n\t//如果uv=1为100米，希望每个细节纹理表示20米的小波形，则uv缩放是 100/20。细节纹理内部也要用这个值，即pos=uv*20\n\tvec2 ruv = matUVTrans*vUv;\n\tvec3 detailNorm = texture2D(texWaveDetail,fract(ruv*5.)).rgb*2.-vec3(1.);//TODO uv怎么算\n\tfloat texNormScale = 2.*PI*float(NumTexWaves)*Amp_over_L*2.5;\n\tdetailNorm *= vec3(texNormScale,1.,texNormScale);\n\t//旋转\n\t//细节纹理来自rendertarget，因此需要颠倒z\n\t\n\tmatTBNOff = mat3(matUVTrans[0][0],0.,matUVTrans[1][0],\n\t0.,1.,0.,\n\tmatUVTrans[0][1],0.,matUVTrans[1][1]\n\t);\n\t\n\t/*\n\tmatTBNOff = mat3(0.,0.,1.,\n\t0.,1.,0.,\n\t-1.,0.,0.\n\t);\n\t*/\n\n    mat3 tsn = mat3( vWorldBin, normal, vWorldTan);\t\n    //normal = normalize(tsn * matTBNOff * detailNorm);\n\tnormal = normalize(tsn * detailNorm); //这个应该更正确。因为本身方向就是根据uv算的，如果是静态图片才需要转换。\n\t//vec4 normtex = texture2D( texNormal, vUv );\n    vec3 view   = -normalize(vViewDir);//view 是指向camera的\n    float NoV = saturate(dot( view, normal ));\n    //vec3 R = 2. * NoV * normal - view;\n\t\n#ifdef USE_FOAM\t\n\tvec4 foamc = (texture2D(texFoam,vUv*50.)+texture2D(texFoam,vUv*20.))/2.;\n\tfloat nearcoast = 1.-min(fDeep/10.,1.);// 1.-vWaterInfo.r;\n\tfloat foams = (nearcoast/4.+fFoam)*2.*nearcoast;\n#else\n\tfloat foams =0.;\n#endif\n\t\n\tvec3 R = reflect(-view,normal);\n\tvec4 wc = calcWaterC(view, normal,NoV,R, foams);\n\n\tgl_FragColor.rgb = wc.rgb;//normalize(detailNorm).rrr;//((normal)+vec3(0.0))/1.;//normalize(normal).rgb;//texture2D(texWaveDetail,vUv).rgb;// fracColor * texture2D(texUnderWater, vUv*20.0).rgb;// vec3(1.0);//pbrl.rgb;\n    gl_FragColor.a = 1.0;//wc.a;\n#ifdef USE_FOAM\n\tgl_FragColor.rgb = mix(gl_FragColor.rgb,vec3(1.),foamc.a*foams);\n\tgl_FragColor.a = foamc.r;\n#endif\n\t//if(mod(vUv.x*100.,1.0)<0.02 || mod(vUv.y*100.,1.0)<0.02) gl_FragColor.rgb=vec3(0.5,.5,.5);\n\t//gl_FragColor.rgb = detailNorm;\n}\n",a=ShaderCompile3D.add(c,e,t,n,i),WaterMaterial.SHADERDEFINE_CUBE_ENV=a.registerMaterialDefine("CUBE_ENV"),WaterMaterial.SHADERDEFINE_HDR_ENV=a.registerMaterialDefine("HDR_ENV"),WaterMaterial.SHADERDEFINE_SHOW_NORMAL=a.registerMaterialDefine("SHOW_NORMAL"),WaterMaterial.SHADERDEFINE_USEVERTEXHEIGHT=a.registerMaterialDefine("USE_VERTEX_DEEPINFO"),WaterMaterial.SHADERDEFINE_USE_FOAM=a.registerMaterialDefine("USE_FOAM"),WaterMaterial.SHADERDEFINE_USE_REFRACT_TEX=a.registerMaterialDefine("USE_REFR_TEX"),n={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshColor:1,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},i={u_Tintcolor:[2,1],u_TilingOffset:[3,1],u_texture:[1,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]};var u=Shader3D.nameKey.add("PARTICLESHURIKEN");e="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0){ \n\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t#endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,a_StartRotation0.z), age,normalizedAge);\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n\t\t\t\t#endif\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t\tv_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef DIFFUSEMAP\n\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t\t\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset.xy+vec2(u_TilingOffset.z,-u_TilingOffset.w);//需要特殊处理\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t#endif\n    v_Discard=0.0;\n\t  \n\t#ifdef FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n}\n\n",t="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\tif(v_Discard!=0.0)\n\t\t\tdiscard;\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",a=ShaderCompile3D.add(u,e,t,n,i),ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR=a.registerMaterialDefine("TINTCOLOR"),ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD=a.registerSpriteDefine("SPHERHBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=a.registerSpriteDefine("STRETCHEDBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=a.registerSpriteDefine("HORIZONTALBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=a.registerSpriteDefine("VERTICALBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME=a.registerSpriteDefine("COLOROVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerSpriteDefine("ROTATIONOVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH=a.registerSpriteDefine("RENDERMODE_MESH"),ShuriKenParticle3D.SHADERDEFINE_SHAPE=a.registerSpriteDefine("SHAPE"),n={a_Position:0,a_Texcoord0:2,a_Time:33},i={u_Texture:[1,1],u_Albedo:[2,1],u_Color:[3,1],u_CurrentTime:[2,2],u_Duration:[3,2],u_MvpMatrix:[1,2]};var d=Shader3D.nameKey.add("GLITTER");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",t="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\t\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",a=ShaderCompile3D.add(d,e,t,n,i),n={a_Position:0},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]};var f=Shader3D.nameKey.add("SkyBox");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ShaderCompile3D.add(f,e,t,n,i),n={a_Position:0,a_Texcoord0:2},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]};var m=Shader3D.nameKey.add("SkyDome");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ShaderCompile3D.add(m,e,t,n,i),n={a_Position:0,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_NormalTexture:[1,1],u_DiffuseTexture1:[2,1],u_DiffuseTexture2:[3,1],u_DiffuseTexture3:[4,1],u_DiffuseTexture4:[5,1],u_DiffuseScale1:[6,1],u_DiffuseScale2:[7,1],u_DiffuseScale3:[8,1],u_DiffuseScale4:[9,1],u_MaterialDiffuse:[11,1],u_MaterialAmbient:[10,1],u_MaterialSpecular:[12,1],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var p=Shader3D.nameKey.add("Terrain");e="attribute vec4 a_Position;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nuniform mat4 u_MvpMatrix;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Texcoord0=a_Texcoord0;\n\tv_Texcoord1=a_Texcoord1;\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tv_Normal=a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n#endif\n\n#ifdef LIGHTMAP\n\t//这个地方使用a_Normal 并不是真的代表normal，其实凑巧法线图的uv正好是符合 light_Map的UV\n\tv_LightMapUV=vec2(a_Normal.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Normal.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1\n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n\n}",t='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\nuniform sampler2D u_NormalTexture;\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform vec2 u_DiffuseScale1;\nuniform vec2 u_DiffuseScale2;\nuniform vec2 u_DiffuseScale3;\nuniform vec2 u_DiffuseScale4;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n#ifdef DETAIL_NUM1\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz;\n#endif\n#ifdef DETAIL_NUM2\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-splatAlpha.r) + color2.xyz * splatAlpha.r;\n#endif\n#ifdef DETAIL_NUM3\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g)) + color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g;\n#endif\n#ifdef DETAIL_NUM4\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord1/u_DiffuseScale4);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g+splatAlpha.b))+ color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g + color4.xyz * splatAlpha.b;\n#endif\n\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = texture2D(u_NormalTexture,v_Normal.xy).xyz;\n\tnormal = normal*2.0 - vec3(1.0);\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n';var g=ShaderCompile3D.add(p,e,t,n,i);TerrainMaterial.SHADERDEFINE_DETAIL_NUM1=g.registerMaterialDefine("DETAIL_NUM1"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM2=g.registerMaterialDefine("DETAIL_NUM2"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM4=g.registerMaterialDefine("DETAIL_NUM4"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM3=g.registerMaterialDefine("DETAIL_NUM3"),n={a_Position:0,a_Normal:3,a_Texcoord0:2},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_DiffuseTexture1:[1,1],u_DiffuseTexture2:[2,1],u_DiffuseTexture3:[3,1],u_DiffuseTexture4:[4,1],u_DiffuseTexture5:[5,1],u_DiffuseScaleOffset1:[6,1],u_DiffuseScaleOffset2:[7,1],u_DiffuseScaleOffset3:[8,1],u_DiffuseScaleOffset4:[9,1],u_DiffuseScaleOffset5:[10,1],u_MaterialAlbedo:[14,1],u_MaterialDiffuse:[12,1],u_MaterialAmbient:[11,1],u_MaterialSpecular:[13,1],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var E=Shader3D.nameKey.add("ExtendTerrain");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n\tvarying float v_posViewZ;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}",t='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\nuniform vec3 u_MaterialAmbient;\nuniform vec4 u_MaterialAlbedo;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\t\t\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t\t//vec3 tColor= u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue + mix(vec3(0.15,0.15,0.15),vec3(0.0),shadowValue);\n\t\t\t//gl_FragColor.rgb*=tColor;\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_MaterialAlbedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor = vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n';var v=ShaderCompile3D.add(E,e,t,n,i);v.addSpriteDefines(RenderableSprite3D.shaderDefines),v.addSpriteDefines(ExtendTerrainMaterial.shaderDefines),n={a_Position:0,a_OffsetVector:41,a_Texcoord0X:38,a_Texcoord0Y:40,a_BirthTime:33},i={u_MvpMatrix:[1,2],u_VMatrix:[1,3],u_PMatrix:[2,3],u_TilingOffset:[3,1],u_MainTexture:[1,1],u_MainColor:[2,1],u_CurTime:[3,2],u_LifeTime:[4,2],u_WidthCurve:[5,2],u_WidthCurveKeyLength:[6,2],u_GradientColorkey:[7,2],u_GradientAlphakey:[8,2]};var x=Shader3D.nameKey.add("Trail");e="attribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_VMatrix;\nuniform mat4 u_PMatrix;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tif(normalizeTime == 0.0){\n\t\treturn u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\treturn u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x)\n\t\t\t{\n\t\t\t\treturn u_WidthCurve[i].w;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\treturn hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t}\n\t\t}\t\n\t}\n}\t\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tfloat colorKey = gradientColor.w;\n\t\tif(colorKey >= normalizeTime)\n\t\t{\n\t\t\tvec4 lastGradientColor = gradientColors[i-1];\n\t\t\tfloat lastColorKey = lastGradientColor.w;\n\t\t\tfloat age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n\t\t\tcolor.rgb = mix(gradientColors[i-1].xyz, gradientColor.xyz, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tfloat alphaKey = gradientAlpha.y;\n\t\tif(alphaKey >= normalizeTime)\n\t\t{\n\t\t\tvec2 lastGradientAlpha = gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey = lastGradientAlpha.y;\n\t\t\tfloat age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n\t\t\tcolor.a = mix(lastGradientAlpha.x, gradientAlpha.x, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tif(gradientColor.w >= normalizeTime)\n\t\t{\n\t\t\tcolor.rgb = gradientColor.xyz;\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tif(gradientAlpha.y >= normalizeTime)\n\t\t{\n\t\t\tcolor.a = gradientAlpha.x;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvoid main()\n{\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n\t\n\tgl_Position = u_PMatrix * u_VMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\n\t\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0 = (vec2(a_Texcoord0X, a_Texcoord0Y) * u_TilingOffset.xy) + u_TilingOffset.zw;\n\t#else\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n\t#endif\n\t\n\t#ifdef GRADIENTMODE_BLEND\n\t\tv_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#else\n\t\tv_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#endif\n}\n\n\n\n",t="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\t\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n";var S=ShaderCompile3D.add(x,e,t,n,i);TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE=S.registerMaterialDefine("DIFFUSETEXTURE"),TrailMaterial.SHADERDEFINE_TILINGOFFSET=S.registerSpriteDefine("TILINGOFFSET"),TrailSprite3D.SHADERDEFINE_GRADIENTMODE_BLEND=S.registerSpriteDefine("GRADIENTMODE_BLEND")},e}(),Sky=function(){function e(){this._alphaBlending=1,this._colorIntensity=1,this._shaderValue=new ValusArray}__class(e,"laya.d3.resource.models.Sky",!0);var t=e.prototype;return t._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse):this._environmentDiffuse.on("loaded",this,__bind(this,this._environmentDiffuseLoaded))},t._setEnvironmentSpecular=function(){if(this._environmentSpecular.loaded){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)}else this._environmentSpecular.on("loaded",this,__bind(this,this._environmentSpecularLoaded))},t._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse)},t._environmentSpecularLoaded=function(){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)},t._render=function(e){},t.destroy=function(){this.__ownerCamera=null},__getset(0,t,"envDiffuseSHRed",null,function(e){this.__ownerCamera._shaderValues.setValue(10,e)}),__getset(0,t,"envDiffuseSHBlue",null,function(e){this.__ownerCamera._shaderValues.setValue(12,e)}),__getset(0,t,"environmentDiffuse",function(){return this._environmentDiffuse},function(e){e.minFifter=9728,this._environmentDiffuse=e,this.__ownerCamera&&this._setEnvironmentDiffuse()}),__getset(0,t,"environmentSpecular",function(){return this._environmentSpecular},function(e){this._environmentSpecular=e,this.__ownerCamera&&this._setEnvironmentSpecular()}),__getset(0,t,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0)}),__getset(0,t,"envDiffuseSHGreen",null,function(e){this.__ownerCamera._shaderValues.setValue(11,e)}),__getset(0,t,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),1<this._alphaBlending&&(this._alphaBlending=1)}),__getset(0,t,"_ownerCamera",null,function(e){this.__ownerCamera=e,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),e.MVPMATRIX=0,e.INTENSITY=1,e.ALPHABLENDING=2,e.DIFFUSETEXTURE=3,e}(),SubMesh=function(){function C(e){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._indexInMesh=0,this._vertexBuffer=null,this._vertexStart=0,this._vertexCount=0,this._indexBuffer=null,this._indexStart=0,this._indexCount=0,this._indices=null,this._bufferUsage={},this._mesh=e,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}__class(C,"laya.d3.resource.models.SubMesh",!0);var e=C.prototype;return Laya.imps(e,{"laya.resource.IDispose":!0,"laya.d3.core.render.IRenderable":!0}),e._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getStaticBatchBakedVertexs=function(e,t){var n,i,r=this._vertexBuffer,a=r.vertexDeclaration,o=a.getVertexElementByUsage(0).offset/4,s=a.getVertexElementByUsage(3).offset/4,l=t.meshRender.lightmapScaleOffset,_=0,h=0,c=0,u=0,d=0,f=0;if(l)if(i=a.getVertexElementByUsage(15))c=a.vertexStride/4,n=0<this._vertexCount?r.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):r.getData().slice(),u=i.offset/4;else{c=(f=a.vertexStride/4)+2,n=this._vertexCount?new Float32Array(this._vertexCount*(r.vertexDeclaration.vertexStride/4+2)):new Float32Array(r.vertexCount*(r.vertexDeclaration.vertexStride/4+2)),u=(d=a.getVertexElementByUsage(2).offset/4)+2;var m=r.getData();for(_=0,h=m.length/f;_<h;_++){var p=0;p=0<this._vertexCount?(this._vertexStart+_)*f:_*f;var g=_*c,E=0;for(E=0;E<u;E++)n[g+E]=m[p+E];for(E=u;E<f;E++)n[g+E+2]=m[p+E]}}else c=a.vertexStride/4,n=this._vertexCount?r.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):r.getData().slice();if(e){var v=e.worldMatrix,x=C._tempMatrix4x40;v.invert(x);var S=C._tempMatrix4x41,D=t.transform.worldMatrix;Matrix4x4.multiply(x,D,S)}else S=t.transform.worldMatrix;var T=C._tempQuaternion0;for(S.decomposeTransRotScale(C._tempVector30,T,C._tempVector31),_=0,h=n.length/c;_<h;_++){var M=_*c+o,V=_*c+s;if(Utils3D.transformVector3ArrayToVector3ArrayCoordinate(n,M,S,n,M),Utils3D.transformVector3ArrayByQuat(n,V,T,n,V),l){var R=_*c+u;if(i)Utils3D.transformLightingMapTexcoordByUV1Array(n,R,l,n,R);else{var A=_*f+d;Utils3D.transformLightingMapTexcoordByUV0Array(m,A,l,n,R)}}}return n},e._getVertexBuffers=function(){return null},e._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(e){var t,n=0,i=e.renderElement;if(1<this._indexCount){var r=this._boneIndicesList.length;if(1<r){for(var a=0;a<r;a++)(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[a]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),WebGL.mainContext.drawElements(4,this._subIndexBufferCount[a],5123,2*this._subIndexBufferStart[a]);Stat.drawCall+=r}else(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),WebGL.mainContext.drawElements(4,this._indexCount,5123,2*this._indexStart),Stat.drawCall++;n=this._indexCount}else n=this._indexBuffer.indexCount,(t=i._skinAnimationDatas||this._skinAnimationDatas)&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),WebGL.mainContext.drawElements(4,n,5123,0),Stat.drawCall++;Stat.trianglesFaces+=n/3},e.getIndices=function(){return 0<this._indexCount?this._indices:this._indexBuffer.getData()},e.dispose=function(){this._indexBuffer.destroy(),this._vertexBuffer.destroy(),this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._vertexBuffer=null,this._indexBuffer=null},__getset(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),__getset(0,e,"_vertexBufferCount",function(){return 1}),__static(C,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempQuaternion0",function(){return this._tempQuaternion0=new Quaternion},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Matrix4x4}]),C}(),VertexPositionNormalColorTexture0Texture1=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r}__class(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15)])}]),e}(),DynamicBatchManager=function(){function x(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}__class(x,"laya.d3.graphics.DynamicBatchManager",!0);var e=x.prototype;return e.getDynamicBatch=function(e,t){var n,i=e.id.toString()+t;return this._dynamicBatches[i]?n=this._dynamicBatches[i]:this._dynamicBatches[i]=n=new DynamicBatch(e),n},e._garbageCollection=function(){for(var e in this._dynamicBatches)0==this._dynamicBatches[e].combineRenderElementsCount&&delete this._dynamicBatches[e]},e._addPrepareRenderElement=function(e){this._prepareDynamicBatchCombineElements.push(e)},e._finishCombineDynamicBatch=function(e){var t,n,i;this._prepareDynamicBatchCombineElements.sort(x._sortPrepareDynamicBatch);for(var r,a,o,s,l,_=-1,h=!0,c=0,u=-1,d=0,f=this._prepareDynamicBatchCombineElements.length;d<f;d++){var m=(a=this._prepareDynamicBatchCombineElements[d]).renderObj._getVertexBuffer(0).vertexDeclaration,p=n!=m;p&&(c=0,n=m);var g=c!=_;if(g&&(_=c),(p||g)&&(o=this.getDynamicBatch(m,c),t=null),h)if(o._addCombineRenderObjTest(a)){if(t!=(r=a._material))s&&(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),l=s=null,u=-1),s=r,u=o.combineRenderElementsCount,l=a,t=r;else if(s){var E=l.renderObj,v=a.renderObj;E._getVertexBuffer().vertexCount+v._getVertexBuffer().vertexCount>DynamicBatch.maxVertexCount||E._getIndexBuffer().indexCount+v._getIndexBuffer().indexCount>DynamicBatch.maxIndexCount?(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),s=r,u=o.combineRenderElementsCount,l=a):(o._addCombineMaterial(s),o._addMaterialToRenderElementOffset(u),o._addCombineRenderObj(l),l=s=null,u=-1,o._addCombineRenderObj(a))}else o._addCombineRenderObj(a);h=!0}else s&&(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),l=s=null,u=-1),c++,h=!1;else i=this._prepareDynamicBatchCombineElements[d-1],o._addMaterialToRenderElementOffset(o.combineRenderElementsCount),t=i._material,o._addCombineMaterial(t),o._addCombineRenderObj(i),h=!0,t!=(r=a._material)?(s=r,u=o.combineRenderElementsCount,l=a):o._addCombineRenderObj(a),t=r}s&&(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),l=s=null,u=-1),this._prepareDynamicBatchCombineElements.length=0},e._clearRenderElements=function(){for(var e in this._dynamicBatches)this._dynamicBatches[e]._clearRenderElements()},e._addToRenderQueue=function(e,t,n,i){for(var r in this._dynamicBatches){var a=this._dynamicBatches[r];0<a.combineRenderElementsCount&&a._addToRenderQueue(e,t,n,i)}},e.dispose=function(){this._dynamicBatches=null},x._sortPrepareDynamicBatch=function(e,t){return e._mainSortID-t._mainSortID},x}(),VertexPositionNormalColorTexture0Texture1SkinSTangent=function(){function e(e,t,n,i,r,a,o,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=o,this._blendWeight=s}__class(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(104,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6),new VertexElement(88,"vector4",5)])}]),e}(),VertexPositionNormalTexture=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}__class(e,"laya.d3.graphics.VertexPositionNormalTexture",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(32,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2)])}]),e}(),VertexPositionNormalColorSkinSTangent=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(e,"laya.d3.graphics.VertexPositionNormalColorSkinSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector4",5)])}]),e}(),VertexPositionNormalTextureSkin=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._blendIndex=i,this._blendWeight=r}__class(e,"laya.d3.graphics.VertexPositionNormalTextureSkin",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(64,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",7),new VertexElement(48,"vector4",6)])}]),e}(),VertexPositionNormalColorSkin=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._blendIndex=i,this._blendWeight=r}__class(e,"laya.d3.graphics.VertexPositionNormalColorSkin",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(72,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6)])}]),e}(),StaticBatch=function(){function e(e,t,n){this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=null,this._initBatchRenderElements=null,this._batchRenderElements=null,this._material=null,this._rootOwner=null,this._key=null,this._manager=null,this._key=e,this._manager=t,this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=[],this._initBatchRenderElements=[],this._batchRenderElements=[],this._rootOwner=n}__class(e,"laya.d3.graphics.StaticBatch",!0);var t=e.prototype;return Laya.imps(t,{"laya.resource.IDispose":!0,"laya.d3.core.render.IRenderable":!0}),t._binarySearch=function(e){for(var t=0,n=this._batchRenderElements.length-1,i=0;t<=n;)i=Math.floor((t+n)/2),this._compareBatchRenderElement(this._batchRenderElements[i],e)?n=i-1:t=i+1;return t},t._compareBatchRenderElement=function(e,t){throw new Error("StaticBatch:must override this function.")},t._getVertexDecLightMap=function(e){return e==VertexPositionNormalTextureSkinSTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1SkinSTangent.vertexDeclaration:e==VertexPositionNormalTextureSkin.vertexDeclaration?VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:e==VertexPositionNormalColorTextureSTangent.vertexDeclaration?VertexPositionNormalColorTexture0Texture1STangent.vertexDeclaration:e==VertexPositionNTBTexture.vertexDeclaration?null:e==VertexPositionNormalColorTexture.vertexDeclaration?VertexPositionNormalColorTexture0Texture1.vertexDeclaration:e==VertexPositionNormalTextureSTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1STangent.vertexDeclaration:e==VertexPositionNormalTexture.vertexDeclaration?VertexPositionNormalTexture0Texture1.vertexDeclaration:e==VertexPositionNormalTextureSkinTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration:e==VertexPositionNormalTextureSkin.vertexDeclaration?VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:e==VertexPositionNormalColorTextureTangent.vertexDeclaration?VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration:e==VertexPositionNTBTexture.vertexDeclaration?null:e==VertexPositionNormalColorTexture.vertexDeclaration?VertexPositionNormalColorTexture0Texture1.vertexDeclaration:e==VertexPositionNormalTextureTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration:e==VertexPositionNormalTexture.vertexDeclaration?VertexPositionNormalTexture0Texture1.vertexDeclaration:e},t._getCombineRenderElementFromPool=function(){throw new Error("StaticBatch:must override this function.")},t._addBatchRenderElement=function(e){this._batchRenderElements.splice(this._binarySearch(e),0,e)},t._updateToRenderQueue=function(e,t){this._combineRenderElementPoolIndex=0,this._getRenderElement(e.getRenderQueue(this._material.renderQueue)._renderElements,e,t)},t._getRenderElement=function(e,t,n){throw new Error("StaticBatch:must override this function.")},t._finishInit=function(){throw new Error("StaticBatch:must override this function.")},t._clearRenderElements=function(){this._batchRenderElements.length=0},t.dispose=function(){},t._getVertexBuffer=function(e){return void 0===e&&(e=0),null},t._getIndexBuffer=function(){return null},t._beforeRender=function(e){return!0},t._render=function(e){},t._getVertexBuffers=function(){return null},__getset(0,t,"triangleCount",function(){return 0}),__getset(0,t,"_vertexBufferCount",function(){return 1}),e.combine=function(e){console.log("StaticBatch: discard property,please use StaticBatchManager.combine() function instead."),StaticBatchManager.combine(e)},e.maxBatchVertexCount=65535,e}(),VertexPosition=function(){function e(e){this._position=null,this._position=e}__class(e,"laya.d3.graphics.VertexPosition",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(12,[new VertexElement(0,"vector3",0)])}]),e}(),VertexParticle=function(){function e(e,t,n,i,r,a,o,s,l,_){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=e,this._position=t,this._velocity=n,this._startColor=i,this._endColor=r,this._sizeRotation=a,this._radius=o,this._radian=s,this._ageAddScale=l,this._time=_}__class(e,"laya.d3.graphics.VertexParticle",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"time",function(){return this._time}),__getset(0,t,"ageAddScale",function(){return this._ageAddScale}),__getset(0,t,"radius",function(){return this._radius}),__getset(0,t,"sizeRotation",function(){return this._sizeRotation}),__getset(0,t,"radian",function(){return this._radian}),__getset(0,t,"endColor",function(){return this._endColor}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(0,t,"startColor",function(){return this._startColor}),__getset(0,t,"velocity",function(){return this._velocity}),__getset(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(116,[new VertexElement(0,"vector4",17),new VertexElement(16,"vector3",0),new VertexElement(28,"vector3",18),new VertexElement(40,"vector4",19),new VertexElement(56,"vector4",23),new VertexElement(72,"vector3",27),new VertexElement(84,"vector2",28),new VertexElement(92,"vector4",29),new VertexElement(108,"single",24),new VertexElement(112,"single",33)])}]),e}(),VertexPositionNormalTextureSTangent=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}__class(e,"laya.d3.graphics.VertexPositionNormalTextureSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(48,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",5)])}]),e}(),VertexPositionNormalColorTexture0Texture1STangent=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a}__class(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1STangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(72,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",5)])}]),e}(),VertexPositionNormalColorTexture0Texture1Skin=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=o}__class(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6)])}]),e}(),VertexPositionNormalTexture0Texture1STangent=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r}__class(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1STangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",5)])}]),e}(),VertexPositionNormalColorSTangent=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}__class(e,"laya.d3.graphics.VertexPositionNormalColorSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",5)])}]),e}(),VertexPositionNormalColorTexture0Texture1SkinTangent=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}__class(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0SkinTangent=function(e,t,n,i,r,a,o,s){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=o,this._blendWeight=s},__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(100,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6),new VertexElement(88,"vector3",5)])}]),e}(),VertexPositionNormalTextureSkinTangent=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(e,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(76,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",7),new VertexElement(48,"vector4",6),new VertexElement(64,"vector3",5)])}]),e}(),VertexElementFormat=function(){function e(){}return __class(e,"laya.d3.graphics.VertexElementFormat",!0),e.Single="single",e.Vector2="vector2",e.Vector3="vector3",e.Vector4="vector4",e.Color="color",e.Byte4="byte4",e.Short2="short2",e.Short4="short4",e.NormalizedShort2="normalizedshort2",e.NormalizedShort4="normalizedshort4",e.HalfVector2="halfvector2",e.HalfVector4="halfvector4",e}(),VertexPositionNormalColorTexture0Texture1Tangent=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}__class(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0Tangent=function(e,t,n,i,r,a){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a},__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(68,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector3",5)])}]),e}(),VertexPositionNormalTexture0Texture1SkinSTangent=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}__class(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector4",5)])}]),e}(),VertexShurikenParticleBillboard=function(){function e(e,t,n,i,r,a,o,s,l,_,h,c,u,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=o,this._startRotation2=s,this._startLifeTime=l,this._time=_,this._startSpeed=h,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}__class(e,"laya.d3.graphics.VertexShurikenParticleBillboard",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"simulationWorldPostion",function(){return this._simulationWorldPostion}),__getset(0,t,"time",function(){return this._time}),__getset(0,t,"startLifeTime",function(){return this._startLifeTime}),__getset(0,t,"startRotation2",function(){return this._startRotation2}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"startRotation1",function(){return this._startRotation1}),__getset(0,t,"random0",function(){return this._randoms0}),__getset(0,t,"startRotation0",function(){return this._startRotation0}),__getset(0,t,"startSize",function(){return this._startSize}),__getset(0,t,"random1",function(){return this._randoms1}),__getset(0,t,"startColor",function(){return this._startColor}),__getset(0,t,"startSpeed",function(){return this._startSpeed}),__getset(0,t,"velocity",function(){return this._velocity}),__getset(0,t,"positionStartLifeTime",function(){return this._positionStartLifeTime}),__getset(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(152,[new VertexElement(0,"vector4",17),new VertexElement(16,"vector4",30),new VertexElement(32,"vector4",32),new VertexElement(48,"vector4",19),new VertexElement(64,"vector3",20),new VertexElement(76,"vector3",22),new VertexElement(88,"single",31),new VertexElement(92,"vector4",34),new VertexElement(108,"vector4",35),new VertexElement(124,"vector3",36),new VertexElement(136,"vector4",37)])}]),e}(),VertexPositionNormalTextureTangent=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}__class(e,"laya.d3.graphics.VertexPositionNormalTextureTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(44,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector3",5)])}]),e}(),VertexPositionNormal=function(){function e(e,t){this._position=null,this._normal=null,this._position=e,this._normal=t}__class(e,"laya.d3.graphics.VertexPositionNormal",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(24,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3)])}]),e}(),VertexPositionNormalColorTextureSkinSTangent=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}__class(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(96,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",7),new VertexElement(64,"vector4",6),new VertexElement(80,"vector4",5)])}]),e}(),VertexPositionNormalColorTangent=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}__class(e,"laya.d3.graphics.VertexPositionNormalColorTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(52,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector3",5)])}]),e}(),VertexPositionNormalColorSkinTangent=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(e,"laya.d3.graphics.VertexPositionNormalColorSkinTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(84,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector3",5)])}]),e}(),VertexPositionTerrain=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=e,this._normal=t,this._textureCoord0=n,this._textureCoord1=i}__class(e,"laya.d3.graphics.VertexPositionTerrain",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoord1",function(){return this._textureCoord1}),__getset(0,t,"textureCoord0",function(){return this._textureCoord0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15)])}]),e}(),StaticBatchManager=function(){function a(){this._initBatchRenderElements=null,this._staticBatches=null,this._initBatchRenderElements=[],this._staticBatches={}}__class(a,"laya.d3.graphics.StaticBatchManager",!0);var e=a.prototype;return e._finishInit=function(){for(var e in this._staticBatches)this._staticBatches[e]._finishInit();this._initBatchRenderElements.length=0},e._initStaticBatchs=function(e){throw new Error("StaticBatchManager:must override this function.")},e._addInitBatchSprite=function(e){for(var t=e._render._renderElements,n=0,i=t.length;n<i;n++)this._initBatchRenderElements.push(t[n])},e._clearRenderElements=function(){for(var e in this._staticBatches)this._staticBatches[e]._clearRenderElements()},e._garbageCollection=function(e){var t=e._staticBatch,n=t._initBatchRenderElements,i=n.indexOf(e);n.splice(i,1),0==n.length&&(t.dispose(),delete this._staticBatches[t._key])},e._addToRenderQueue=function(e,t,n,i){for(var r in this._staticBatches){var a=this._staticBatches[r];0<a._batchRenderElements.length&&a._updateToRenderQueue(e,i)}},e.dispose=function(){this._staticBatches=null},a._addToStaticBatchQueue=function(e){e instanceof laya.d3.core.RenderableSprite3D&&e._addToInitStaticBatchManager();for(var t=0,n=e.numChildren;t<n;t++)a._addToStaticBatchQueue(e._childs[t])},a.combine=function(e,t){var n,i=0,r=0;if(t)for(i=0,r=t.length;i<r;i++){t[i]._addToInitStaticBatchManager()}else e&&a._addToStaticBatchQueue(e);for(i=0,r=a._staticBatchManagers.length;i<r;i++)(n=a._staticBatchManagers[i])._initStaticBatchs(e),n._finishInit()},a._staticBatchManagers=[],a}(),VertexPositionNormalColorTexture=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i}__class(e,"laya.d3.graphics.VertexPositionNormalColorTexture",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(48,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2)])}]),e}(),VertexGlitter=function(){function e(e,t,n){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=e,this._textureCoordinate0=t,this._time=n}__class(e,"laya.d3.graphics.VertexGlitter",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"time",function(){return this._time}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate0}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(24,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector2",2),new VertexElement(20,"single",33)])}]),e}(),VertexPositionNormalSTangent=function(){function e(e,t,n){this._position=null,this._normal=null,this._tangent=null,this._position=e,this._normal=t,this._tangent=n}__class(e,"laya.d3.graphics.VertexPositionNormalSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",5)])}]),e}(),FrustumCulling=function(){function e(){}return __class(e,"laya.d3.graphics.FrustumCulling",!0),e.renderShadowObjectCulling=function(e,t,n,i,r){var a=0,o=0,s=0,l=0;for(a=0,s=n.length;a<s;a++){var _=n[a];_&&_._clearRenderElements()}var h,c,u,d=e._cullingRenders;if(1<r){for(a=0,s=e._cullingRendersLength;a<s;a++)if((h=d[a]).castShadow&&Layer.isVisible(h._owner.layer.mask)&&h.enable)for(var f=1,m=t.length;f<m;f++)if(c=n[f-1],0!=t[f].containsBoundSphere(h.boundingSphere))for(o=0,l=(u=h._renderElements).length;o<l;o++)c._addRenderElement(u[o])}else for(a=0,s=e._cullingRendersLength;a<s;a++)if((h=d[a]).castShadow&&Layer.isVisible(h._owner.layer.mask)&&h.enable&&0!=t[0].containsBoundSphere(h.boundingSphere))for(h._renderUpdate(i),c=n[0],o=0,l=(u=h._renderElements).length;o<l;o++)c._addRenderElement(u[o])},e.renderShadowObjectCullingOctree=function(e,t,n,i,r){for(var a=0,o=n.length;a<o;a++){var s=n[a];s&&s._clearRenderElements()}1<r?e.treeRoot.cullingShadowObjects(t,n,!0,0,e):e.treeRoot.cullingShadowObjectsOnePSSM(t[0],n,i,!0,0,e)},e.renderObjectCulling=function(e,t,n,i,r,a){var o=0,s=0,l=0,_=0,h=t._quenes,c=t._dynamicBatchManager,u=t._cullingRenders;for(o=0,s=h.length;o<s;o++){var d=h[o];d&&d._clearRenderElements()}var f=StaticBatchManager._staticBatchManagers;for(o=0,s=f.length;o<s;o++)f[o]._clearRenderElements();c._clearRenderElements();var m=n.transform.position;for(o=0,s=t._cullingRendersLength;o<s;o++){var p=u[o];if(Layer.isVisible(p._owner.layer.mask)&&p.enable&&0!=e.containsBoundSphere(p.boundingSphere)&&p._renderUpdate(a)){p._distanceForSort=Vector3.distance(p.boundingSphere.center,m)+p.sortingFudge;var g=p._renderElements;for(l=0,_=g.length;l<_;l++){var E=g[l],v=E._staticBatch;if(v&&v._material==E._material)v._addBatchRenderElement(E);else{var x=E.renderObj;x.triangleCount<10&&1==x._vertexBufferCount&&x._getIndexBuffer()&&E._material.renderQueue<2&&E._canDynamicBatch&&!p._owner.isStatic?c._addPrepareRenderElement(E):t.getRenderQueue(E._material.renderQueue)._addRenderElement(E)}}}}for(o=0,s=f.length;o<s;o++)f[o]._addToRenderQueue(t,i,r,a);c._finishCombineDynamicBatch(t),c._addToRenderQueue(t,i,r,a)},e.renderObjectCullingOctree=function(e,t,n,i,r,a){var o=0,s=0,l=t._quenes,_=t._dynamicBatchManager;for(o=0,s=l.length;o<s;o++){var h=l[o];h&&h._clearRenderElements()}var c=StaticBatchManager._staticBatchManagers;for(o=0,s=c.length;o<s;o++)c[o]._clearRenderElements();for(_._clearRenderElements(),t._cullingRenders.length=0,t.treeRoot.cullingObjects(e,!0,0,n.transform.position,a),o=0,s=c.length;o<s;o++)c[o]._addToRenderQueue(t,i,r,a);_._finishCombineDynamicBatch(t),_._addToRenderQueue(t,i,r,a)},e.renderObjectCullingNoBoundFrustum=function(e,t,n,i,r){var a=0,o=0,s=0,l=0,_=e._quenes,h=e._dynamicBatchManager,c=e._cullingRenders;for(a=0,o=_.length;a<o;a++){var u=_[a];u&&u._clearRenderElements()}var d=StaticBatchManager._staticBatchManagers;for(a=0,o=d.length;a<o;a++)d[a]._clearRenderElements();h._clearRenderElements();var f=t.transform.position;for(a=0,o=e._cullingRendersLength;a<o;a++){var m=c[a];if(Layer.isVisible(m._owner.layer.mask)&&m.enable){m._renderUpdate(r),m._distanceForSort=Vector3.distance(m.boundingSphere.center,f)+m.sortingFudge;var p=m._renderElements;for(s=0,l=p.length;s<l;s++){var g=p[s],E=g._staticBatch;if(E&&E._material==g._material)E._addBatchRenderElement(g);else{var v=g.renderObj;v.triangleCount<10&&1==v._vertexBufferCount&&v._getIndexBuffer()&&g._material.renderQueue<2&&g._canDynamicBatch&&!m._owner.isStatic?h._addPrepareRenderElement(g):e.getRenderQueue(g._material.renderQueue)._addRenderElement(g)}}}}for(a=0,o=d.length;a<o;a++)d[a]._addToRenderQueue(e,n,i,r);h._finishCombineDynamicBatch(e),h._addToRenderQueue(e,n,i,r)},e}(),VertexPositionNormalTexture0Texture1=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i}__class(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15)])}]),e}(),VertexElement=function(){function e(e,t,n){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=e,this.elementFormat=t,this.elementUsage=n}return __class(e,"laya.d3.graphics.VertexElement",!0),e}(),VertexPositionNormalColorTextureSkin=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._blendIndex=r,this._blendWeight=a}__class(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkin",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(80,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",7),new VertexElement(64,"vector4",6)])}]),e}(),VertexPositionNormalColorTextureSTangent=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}__class(e,"laya.d3.graphics.VertexPositionNormalColorTextureSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(64,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",5)])}]),e}(),VertexPositionNormalColorTextureTangent=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}__class(e,"laya.d3.graphics.VertexPositionNormalColorTextureTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(60,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector3",5)])}]),e}(),VertexPositionNormalColor=function(){function e(e,t,n){this._position=null,this._normal=null,this._color=null,this._position=e,this._normal=t,this._color=n}__class(e,"laya.d3.graphics.VertexPositionNormalColor",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1)])}]),e}(),VertexShurikenParticleMesh=function(){function e(e,t,n,i,r,a,o,s,l,_,h,c,u,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=o,this._startRotation2=s,this._startLifeTime=l,this._time=_,this._startSpeed=h,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}__class(e,"laya.d3.graphics.VertexShurikenParticleMesh",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"simulationWorldPostion",function(){return this._simulationWorldPostion}),__getset(0,t,"time",function(){return this._time}),__getset(0,t,"startLifeTime",function(){return this._startLifeTime}),__getset(0,t,"startRotation2",function(){return this._startRotation2}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"startRotation1",function(){return this._startRotation1}),__getset(0,t,"random0",function(){return this._randoms0}),__getset(0,t,"startRotation0",function(){return this._startRotation0}),__getset(0,t,"startSize",function(){return this._startSize}),__getset(0,t,"velocity",function(){return this._velocity}),__getset(0,t,"startSpeed",function(){return this._startSpeed}),__getset(0,t,"position",function(){return this._positionStartLifeTime}),__getset(0,t,"random1",function(){return this._randoms1}),__getset(0,t,"startColor",function(){return this._startColor}),__getset(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(172,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector4",1),new VertexElement(28,"vector2",2),new VertexElement(36,"vector4",30),new VertexElement(52,"vector4",32),new VertexElement(68,"vector4",19),new VertexElement(84,"vector3",20),new VertexElement(96,"vector3",22),new VertexElement(108,"single",31),new VertexElement(112,"vector4",34),new VertexElement(128,"vector4",35),new VertexElement(144,"vector3",36),new VertexElement(156,"vector4",37)])}]),e}(),VertexPositionTexture0=function(){function e(e,t){this._position=null,this._textureCoordinate0=null,this._position=e,this._textureCoordinate0=t}__class(e,"laya.d3.graphics.VertexPositionTexture0",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(20,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector2",2)])}]),e}(),VertexPositionNTBTexture=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}__class(e,"laya.d3.graphics.VertexPositionNTBTexture",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5),new VertexElement(36,"vector3",4),new VertexElement(48,"vector2",2)])}]),e}(),VertexDeclaration=function(){function o(e,t){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._id=++o._uniqueIDCounter,this._id>o.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",o.maxVertexDeclaration);this._shaderValues=new ValusArray,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t;for(var n=0;n<t.length;n++){var i=t[n],r=i.elementUsage;this._vertexElementsDic[r]=i;var a=[o._getTypeSize(i.elementFormat)/4,5126,!1,this._vertexStride,i.offset];switch(this._shaderValues.setValue(r,a),r){case 1:this._addShaderDefine(ShaderCompile3D.SHADERDEFINE_COLOR);break;case 2:this._addShaderDefine(ShaderCompile3D.SHADERDEFINE_UV0);break;case 15:this._addShaderDefine(ShaderCompile3D.SHADERDEFINE_UV1)}}}__class(o,"laya.d3.graphics.VertexDeclaration",!0);var e=o.prototype;return e._addShaderDefine=function(e){this._shaderDefineValue|=e},e._removeShaderDefine=function(e){this._shaderDefineValue&=~e},e.getVertexElements=function(){return this._vertexElements.slice()},e.getVertexElementByUsage=function(e){return this._vertexElementsDic[e]},e.unBinding=function(){},__getset(0,e,"shaderValues",function(){return this._shaderValues}),__getset(0,e,"shaderDefineValue",function(){return this._shaderDefineValue}),__getset(0,e,"vertexStride",function(){return this._vertexStride}),__getset(0,e,"id",function(){return this._id}),o._getTypeSize=function(e){switch(e){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":case"byte4":case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},o.getVertexStride=function(e){for(var t=0,n=0;n<e.Length;n++){var i=e[n],r=i.offset+o._getTypeSize(i.elementFormat);t<r&&(t=r)}return t},o._maxVertexDeclarationBit=1e3,o._uniqueIDCounter=1,__static(o,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),o}(),VertexPositionNTBTextureSkin=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}__class(e,"laya.d3.graphics.VertexPositionNTBTextureSkin",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5),new VertexElement(36,"vector3",4),new VertexElement(48,"vector2",2),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6)])}]),e}(),VertexPositionNormalTexture0Texture1Skin=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._blendIndex=r,this._blendWeight=a}__class(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(72,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6)])}]),e}(),VertexPositionNormalTextureSkinSTangent=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(e,"laya.d3.graphics.VertexPositionNormalTextureSkinSTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(80,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",7),new VertexElement(48,"vector4",6),new VertexElement(64,"vector4",5)])}]),e}(),VertexPositionNormalColorTextureSkinTangent=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}__class(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,t,"color",function(){return this._color}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(92,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",7),new VertexElement(64,"vector4",6),new VertexElement(80,"vector3",5)])}]),e}(),VertexPositionNTBTexture0Texture1Skin=function(){function e(e,t,n,i,r,a,o,s){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this.binormal=null,this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,n=n,this._blendIndex=o,this._blendWeight=s}__class(e,"laya.d3.graphics.VertexPositionNTBTexture0Texture1Skin",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(96,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5),new VertexElement(36,"vector3",4),new VertexElement(48,"vector2",2),new VertexElement(56,"vector2",15),new VertexElement(64,"vector4",7),new VertexElement(80,"vector4",6)])}]),e}(),VertexElementUsage=function(){function e(){}return __class(e,"laya.d3.graphics.VertexElementUsage",!0),e.POSITION0=0,e.COLOR0=1,e.TEXTURECOORDINATE0=2,e.NORMAL0=3,e.BINORMAL0=4,e.TANGENT0=5,e.BLENDINDICES0=6,e.BLENDWEIGHT0=7,e.DEPTH0=8,e.FOG0=9,e.POINTSIZE0=10,e.SAMPLE0=11,e.TESSELLATEFACTOR0=12,e.COLOR1=13,e.NEXTTEXTURECOORDINATE0=14,e.TEXTURECOORDINATE1=15,e.NEXTTEXTURECOORDINATE1=16,e.CORNERTEXTURECOORDINATE0=17,e.VELOCITY0=18,e.STARTCOLOR0=19,e.STARTSIZE=20,e.AGEADDSCALE0=21,e.STARTROTATION=22,e.ENDCOLOR0=23,e.STARTLIFETIME=24,e.TIME0=33,e.SHAPEPOSITIONSTARTLIFETIME=30,e.DIRECTIONTIME=32,e.SIZEROTATION0=27,e.RADIUS0=28,e.RADIAN0=29,e.STARTSPEED=31,e.RANDOM0=34,e.RANDOM1=35,e.SIMULATIONWORLDPOSTION=36,e.SIMULATIONWORLDROTATION=37,e.TEXTURECOORDINATE0X=38,e.TEXTURECOORDINATE0X1=39,e.TEXTURECOORDINATE0Y=40,e.OFFSETVECTOR=41,e}(),VertexPositionNormalTexture0Texture1Tangent=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}__class(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0Tangent=function(e,t,n,i,r){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r},__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(52,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector3",5)])}]),e}(),DynamicBatch=function(){function x(e){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=e}__class(x,"laya.d3.graphics.DynamicBatch",!0);var e=x.prototype;return Laya.imps(e,{"laya.d3.core.render.IRenderable":!0}),e._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getCombineRenderElementFromPool=function(e,t,n){var i=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return i||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=i=new RenderElement,i._sprite3D=new MeshSprite3D),i._sprite3D._render._renderUpdate(n),i},e._getRenderElement=function(e,t,n){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*x.maxVertexCount),this._indexDatas=new Uint16Array(x.maxIndexCount),this._vertexBuffer=VertexBuffer3D.create(this._vertexDeclaration,x.maxVertexCount,35048),this._indexBuffer=IndexBuffer3D.create("ushort",x.maxIndexCount,35048));for(var i=this._merageElements.length=0,r=0,a=0,o=this._combineRenderElements.length;a<o;a++){var s=this._combineRenderElements[a],l=s.getDynamicBatchBakedVertexs(0),_=s.getBakedIndices(),h=s._sprite3D.transform._isFrontFaceInvert,c=i/(this._vertexDeclaration.vertexStride/4),u=r,d=u+_.length;s._tempBatchIndexStart=u,s._tempBatchIndexEnd=d,this._indexDatas.set(_,r);var f=0;if(h)for(f=u;f<d;f+=3){this._indexDatas[f]=c+this._indexDatas[f];var m=this._indexDatas[f+1],p=this._indexDatas[f+2];this._indexDatas[f+1]=c+p,this._indexDatas[f+2]=c+m}else for(f=u;f<d;f+=3)this._indexDatas[f]=c+this._indexDatas[f],this._indexDatas[f+1]=c+this._indexDatas[f+1],this._indexDatas[f+2]=c+this._indexDatas[f+2];r+=_.length,this._vertexDatas.set(l,i),i+=l.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),a=this._combineRenderElementPoolIndex=0,o=this._materials.length;a<o;a++){var g=this._getCombineRenderElementFromPool(e,t,n);g._type=2,g._staticBatch=null;var E=(g.renderObj=this)._combineRenderElements[this._materialToRenderElementsOffsets[a]]._tempBatchIndexStart,v=a+1==this._materialToRenderElementsOffsets.length?r:this._combineRenderElements[this._materialToRenderElementsOffsets[a+1]]._tempBatchIndexStart;g._tempBatchIndexStart=E,g._tempBatchIndexEnd=v,g._material=this._materials[a],this._merageElements.push(g)}},e._addCombineRenderObjTest=function(e){var t=e.renderObj,n=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,i=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount;return!(x.maxVertexCount<i||x.maxIndexCount<n)},e._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount},e._addCombineMaterial=function(e){this._materials.push(e)},e._addMaterialToRenderElementOffset=function(e){this._materialToRenderElementsOffsets.push(e)},e._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},e._addToRenderQueue=function(e,t,n,i){this._getRenderElement(t,n,i);for(var r=0,a=this._materials.length;r<a;r++)e.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},e._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;WebGL.mainContext.drawElements(4,t,5123,2*e._batchIndexStart),Stat.drawCall++,Stat.trianglesFaces+=t/3},e._getVertexBuffers=function(){return null},__getset(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),__getset(0,e,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),__getset(0,e,"_vertexBufferCount",function(){return 1}),x.maxVertexCount=2e4,x.maxIndexCount=4e4,x.maxCombineTriangleCount=10,x}(),VertexPositionNormalTangent=function(){function e(e,t,n){this._position=null,this._normal=null,this._tangent=null,this._position=e,this._normal=t,this._tangent=n}__class(e,"laya.d3.graphics.VertexPositionNormalTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(36,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5)])}]),e}(),VertexPositionNormalTexture0Texture1SkinTangent=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}__class(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent",!0);var t=e.prototype;return Laya.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0SkinTangent=function(e,t,n,i,r,a,o){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o},__getset(0,t,"tangent",function(){return this._tangent}),__getset(0,t,"blendIndex",function(){return this._blendIndex}),__getset(0,t,"blendWeight",function(){return this._blendWeight}),__getset(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,t,"normal",function(){return this._normal}),__getset(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),__getset(0,t,"position",function(){return this._position}),__getset(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),__static(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(84,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector3",5)])}]),e}(),MeshReader=function(){function s(){}return __class(s,"laya.d3.loaders.MeshReader",!0),s.read=function(e,t,n,i,r){var a=new Byte(e);a.pos=0;var o=a.readUTFString();switch(o){case"LAYAMODEL:01":case"LAYASKINANI:01":s._readVersion01(a,o,t,n,i,r);break;case"LAYAMODEL:02":LoadModelV02.parse(a,o,t,n,i,r);break;case"LAYAMODEL:03":case"LAYAMODEL:0301":LoadModelV03.parse(a,o,t,i,r);break;default:throw new Error("MeshReader: unknown mesh version.")}t._setSubMeshes(i)},s._readVersion01=function(e,t,n,i,r,a){new LoadModelV01(e,t,n,i,r,a)},s}(),LoadModelV02=function(){function T(){}return __class(T,"laya.d3.loaders.LoadModelV02",!0),T.parse=function(e,t,n,i,r,a){T._mesh=n,T._materials=i,T._subMeshes=r,T._materialMap=a,T._version=t,T._readData=e,T.READ_DATA(),T.READ_BLOCK(),T.READ_STRINGS();for(var o=0,s=T._BLOCK.count;o<s;o++){T._readData.pos=T._BLOCK.blockStarts[o];var l=T._readData.getUint16(),_=T._strings[l],h=T["READ_"+_];if(null==h)throw new Error("model file err,no this function:"+l+" "+_);h.call()}T._strings.length=0,T._readData=null,T._version=null,T._mesh=null,T._materials=null,T._subMeshes=null,T._materialMap=null},T._readString=function(){return T._strings[T._readData.getUint16()]},T.READ_DATA=function(){T._DATA.offset=T._readData.getUint32(),T._DATA.size=T._readData.getUint32()},T.READ_BLOCK=function(){for(var e=T._BLOCK.count=T._readData.getUint16(),t=T._BLOCK.blockStarts=[],n=T._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(T._readData.getUint32()),n.push(T._readData.getUint32())},T.READ_STRINGS=function(){var e=T._readData.getUint32(),t=T._readData.getUint16(),n=T._readData.pos;T._readData.pos=e+T._DATA.offset;for(var i=0;i<t;i++)T._strings[i]=T._readData.readUTFString();T._readData.pos=n},T.READ_MATERIAL=function(){T._readString(),T._readString();var e=T._readString();return""!=e&&T._materials.push(Loader.getRes(T._materialMap[e])),!0},T.READ_MESH=function(){T._readString();var e,t=T._readData.__getBuffer(),n=0,i=T._readData.getInt16(),r=T._DATA.offset;for(n=0;n<i;n++){var a=r+T._readData.getUint32(),o=T._readData.getUint32(),s=new Float32Array(t.slice(a,a+o)),l=T._readString().match(T._attrReg),_=T._getVertexDeclaration(l),h=VertexBuffer3D.create(_,4*s.length/_.vertexStride,35044,!0);h.setData(s),T._mesh._vertexBuffers.push(h)}var c=r+T._readData.getUint32(),u=T._readData.getUint32(),d=new Uint16Array(t.slice(c,c+u)),f=IndexBuffer3D.create("ushort",u/2,35044,!0);f.setData(d),T._mesh._indexBuffer=f;var m=T._mesh._boneNames=[],p=T._readData.getUint16();for(m.length=p,n=0;n<p;n++)m[n]=T._strings[T._readData.getUint16()];var g=T._readData.getUint32(),E=T._readData.getUint32(),v=(new Float32Array(t.slice(r+g,r+g+E)),T._readData.getUint32()),x=T._readData.getUint32(),S=new Float32Array(t.slice(r+v,r+v+x));for(T._mesh._inverseBindPoses=[],n=0,e=S.length;n<e;n+=16){var D=new Matrix4x4(S[n+0],S[n+1],S[n+2],S[n+3],S[n+4],S[n+5],S[n+6],S[n+7],S[n+8],S[n+9],S[n+10],S[n+11],S[n+12],S[n+13],S[n+14],S[n+15]);T._mesh._inverseBindPoses.push(D)}return T._mesh._skinnedDatas=new Float32Array(16*S.length),!0},T.READ_SUBMESH=function(){var e=T._readData.__getBuffer(),t=new SubMesh(T._mesh),n=T._readData.getInt16(),i=T._readData.getUint32(),r=T._readData.getUint32();t._vertexBuffer=T._mesh._vertexBuffers[n],t._vertexStart=i,t._vertexCount=r;var a=T._readData.getUint32(),o=T._readData.getUint32(),s=T._mesh._indexBuffer;t._indexBuffer=s,t._indexStart=a,t._indexCount=o,t._indices=new Uint16Array(s.getData().buffer,2*a,o);var l=T._DATA.offset,_=t._subIndexBufferStart,h=t._subIndexBufferCount,c=t._boneIndicesList,u=T._readData.getUint16();_.length=u,h.length=u,c.length=u;for(var d=0;d<u;d++){_[d]=T._readData.getUint32(),h[d]=T._readData.getUint32();var f=T._readData.getUint32(),m=T._readData.getUint32();t._boneIndicesList[d]=new Uint8Array(e.slice(l+f,l+f+m))}return T._subMeshes.push(t),!0},T._getVertexDeclaration=function(e){for(var t,n=!1,i=!1,r=!1,a=!1,o=!1,s=!1,l=!1,_=!1,h=!1,c=0;c<e.length;c++)switch(e[c]){case"POSITION":n=!0;break;case"NORMAL":i=!0;break;case"COLOR":r=!0;break;case"UV":a=!0;break;case"UV1":o=!0;break;case"BLENDWEIGHT":l=!0;break;case"BLENDINDICES":_=!0;break;case"TANGENT":s=!0;break;case"BINORMAL":h=!0}return n&&i&&r&&a&&o&&l&&_&&s?t=VertexPositionNormalColorTexture0Texture1SkinTangent.vertexDeclaration:n&&i&&r&&a&&o&&l&&_?t=VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration:n&&i&&a&&o&&l&&_&&s?t=VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration:n&&i&&a&&o&&l&&_?t=VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:n&&i&&r&&a&&l&&_&&s?t=VertexPositionNormalColorTextureSkinTangent.vertexDeclaration:n&&i&&r&&a&&l&&_?t=VertexPositionNormalColorTextureSkin.vertexDeclaration:n&&i&&a&&l&&_&&s?t=VertexPositionNormalTextureSkinTangent.vertexDeclaration:n&&i&&a&&l&&_?t=VertexPositionNormalTextureSkin.vertexDeclaration:n&&i&&r&&l&&_&&s?t=VertexPositionNormalColorSkinTangent.vertexDeclaration:n&&i&&r&&l&&_?t=VertexPositionNormalColorSkin.vertexDeclaration:n&&i&&r&&a&&o&&s?t=VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration:n&&i&&r&&a&&o?t=VertexPositionNormalColorTexture0Texture1.vertexDeclaration:n&&i&&a&&o&&s?t=VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration:n&&i&&a&&o?t=VertexPositionNormalTexture0Texture1.vertexDeclaration:n&&i&&r&&a&&s?t=VertexPositionNormalColorTextureTangent.vertexDeclaration:n&&i&&a&&s&&h?t=VertexPositionNTBTexture.vertexDeclaration:n&&i&&r&&a?t=VertexPositionNormalColorTexture.vertexDeclaration:n&&i&&a&&s?t=VertexPositionNormalTextureTangent.vertexDeclaration:n&&i&&a?t=VertexPositionNormalTexture.vertexDeclaration:n&&i&&r&&s?t=VertexPositionNormalColorTangent.vertexDeclaration:n&&i&&r&&(t=VertexPositionNormalColor.vertexDeclaration),t},T._attrReg=new RegExp("(\\w+)|([:,;])","g"),T._strings=[],T._readData=null,T._version=null,T._mesh=null,T._materials=null,T._subMeshes=null,T._materialMap=null,__static(T,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),T}(),LoadModelV03=function(){function S(){}return __class(S,"laya.d3.loaders.LoadModelV03",!0),S.parse=function(e,t,n,i,r){S._mesh=n,S._subMeshes=i,S._materialMap=r,S._version=t,S._readData=e,S.READ_DATA(),S.READ_BLOCK(),S.READ_STRINGS();for(var a=0,o=S._BLOCK.count;a<o;a++){S._readData.pos=S._BLOCK.blockStarts[a];var s=S._readData.getUint16(),l=S._strings[s],_=S["READ_"+l];if(null==_)throw new Error("model file err,no this function:"+s+" "+l);_.call()}S._strings.length=0,S._readData=null,S._version=null,S._mesh=null,S._subMeshes=null,S._materialMap=null},S._readString=function(){return S._strings[S._readData.getUint16()]},S.READ_DATA=function(){S._DATA.offset=S._readData.getUint32(),S._DATA.size=S._readData.getUint32()},S.READ_BLOCK=function(){for(var e=S._BLOCK.count=S._readData.getUint16(),t=S._BLOCK.blockStarts=[],n=S._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(S._readData.getUint32()),n.push(S._readData.getUint32())},S.READ_STRINGS=function(){var e=S._readData.getUint32(),t=S._readData.getUint16(),n=S._readData.pos;S._readData.pos=e+S._DATA.offset;for(var i=0;i<t;i++)S._strings[i]=S._readData.readUTFString();S._readData.pos=n},S.READ_MESH=function(){S._readString();var e,t=S._readData.__getBuffer(),n=0,i=S._readData.getInt16(),r=S._DATA.offset;for(n=0;n<i;n++){var a,o=r+S._readData.getUint32(),s=S._readData.getUint32(),l=new Float32Array(t.slice(o,o+s)),_=S._readString();switch(S._version){case"LAYAMODEL:03":a=S._vertexDeclarationMap_Discard[_];break;case"LAYAMODEL:0301":a=S._vertexDeclarationMap[_];break;default:throw new Error("LoadModelV03: unknown version.")}if(!a)throw new Error("LoadModelV03: unknown vertexDeclaration.");var h=VertexBuffer3D.create(a,4*l.length/a.vertexStride,35044,!0);h.setData(l),S._mesh._vertexBuffers.push(h)}var c=r+S._readData.getUint32(),u=S._readData.getUint32(),d=new Uint16Array(t.slice(c,c+u)),f=IndexBuffer3D.create("ushort",u/2,35044,!0);f.setData(d),S._mesh._indexBuffer=f;var m=S._mesh._boneNames=[],p=S._readData.getUint16();for(m.length=p,n=0;n<p;n++)m[n]=S._strings[S._readData.getUint16()];S._readData.pos+=8;var g=S._readData.getUint32(),E=S._readData.getUint32(),v=new Float32Array(t.slice(r+g,r+g+E));for(S._mesh._inverseBindPoses=[],n=0,e=v.length;n<e;n+=16){var x=new Matrix4x4(v[n+0],v[n+1],v[n+2],v[n+3],v[n+4],v[n+5],v[n+6],v[n+7],v[n+8],v[n+9],v[n+10],v[n+11],v[n+12],v[n+13],v[n+14],v[n+15]);S._mesh._inverseBindPoses.push(x)}return S._mesh._skinnedDatas=new Float32Array(16*v.length),!0},S.READ_SUBMESH=function(){var e=S._readData.__getBuffer(),t=new SubMesh(S._mesh),n=S._readData.getInt16(),i=S._readData.getUint32(),r=S._readData.getUint32();t._vertexBuffer=S._mesh._vertexBuffers[n],t._vertexStart=i,t._vertexCount=r;var a=S._readData.getUint32(),o=S._readData.getUint32(),s=S._mesh._indexBuffer;t._indexBuffer=s,t._indexStart=a,t._indexCount=o,t._indices=new Uint16Array(s.getData().buffer,2*a,o);var l=S._DATA.offset,_=t._subIndexBufferStart,h=t._subIndexBufferCount,c=t._boneIndicesList,u=S._readData.getUint16();_.length=u,h.length=u,c.length=u;for(var d=0;d<u;d++){_[d]=S._readData.getUint32(),h[d]=S._readData.getUint32();var f=S._readData.getUint32(),m=S._readData.getUint32();c[d]=new Uint8Array(e.slice(l+f,l+f+m))}return S._subMeshes.push(t),!0},S._strings=[],S._readData=null,S._version=null,S._mesh=null,S._subMeshes=null,S._materialMap=null,__static(S,["_vertexDeclarationMap_Discard",function(){return this._vertexDeclarationMap_Discard={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTexture0Texture1SkinTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":VertexPositionNTBTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTextureSkinTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTextureSkin.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTextureSkinTangent.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTextureSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorSkinTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":VertexPositionNormalColorTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1":VertexPositionNormalTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":VertexPositionNormalColorTextureTangent.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":VertexPositionNTBTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":VertexPositionNormalColorTexture.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":VertexPositionNormalTextureTangent.vertexDeclaration,"POSITION,NORMAL,UV":VertexPositionNormalTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":VertexPositionNormalColorTangent.vertexDeclaration,"POSITION,NORMAL,COLOR":VertexPositionNormalColor.vertexDeclaration,"POSITION,NORMAL,TANGENT":VertexPositionNormalTangent.vertexDeclaration,"POSITION,NORMAL":VertexPositionNormal.vertexDeclaration,"POSITION,UV":VertexPositionTexture0.vertexDeclaration,POSITION:VertexPosition.vertexDeclaration}},"_vertexDeclarationMap",function(){return this._vertexDeclarationMap={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTexture0Texture1SkinSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":VertexPositionNTBTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTexture0Texture1SkinSTangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTextureSkinSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTextureSkin.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTextureSkinSTangent.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTextureSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorSkinSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":VertexPositionNormalColorTexture0Texture1STangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":VertexPositionNormalColorTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":VertexPositionNormalTexture0Texture1STangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1":VertexPositionNormalTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":VertexPositionNormalColorTextureSTangent.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":VertexPositionNTBTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":VertexPositionNormalColorTexture.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":VertexPositionNormalTextureSTangent.vertexDeclaration,"POSITION,NORMAL,UV":VertexPositionNormalTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":VertexPositionNormalColorSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR":VertexPositionNormalColor.vertexDeclaration,"POSITION,NORMAL,TANGENT":VertexPositionNormalSTangent.vertexDeclaration,"POSITION,NORMAL":VertexPositionNormal.vertexDeclaration,"POSITION,UV":VertexPositionTexture0.vertexDeclaration,POSITION:VertexPosition.vertexDeclaration}},"_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),S}(),LoadModelV01=function(){function v(e,t,n,i,r,a){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._subMeshes=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=n,this._materials=i,this._subMeshes=r,this._materialMap=a,this._version=t,this._onLoaded(e)}__class(v,"laya.d3.loaders.LoadModelV01",!0);var e=v.prototype;return e._onLoaded=function(e){this._readData=e,this.READ_BLOCK();for(var t=0;t<this._BLOCK.count;t++){var n=this._readData.getUint16(),i=this._strings[n],r=this["READ_"+i];if(null==r)throw new Error("model file err,no this function:"+n+" "+i);if(!r.call(this))break}return this._mesh},e.onError=function(){},e._readString=function(){return this._strings[this._readData.getUint16()]},e.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},e.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},e.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},e.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=(this._readString(),this._readString());return this._materials[e]="null"!=t?Loader.getRes(this._materialMap[t]):new BaseMaterial,!0},e.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var e,t=this._readData.__getBuffer(),n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),a=(new Float32Array(t.slice(i+this._DATA.offset,i+this._DATA.offset+r)),this._readData.getUint32()),o=this._readData.getUint32(),s=new Float32Array(t.slice(a+this._DATA.offset,a+this._DATA.offset+o));for(this.mesh._inverseBindPoses=[],n=0,e=s.length;n<e;n+=16){var l=new Matrix4x4(s[n+0],s[n+1],s[n+2],s[n+3],s[n+4],s[n+5],s[n+6],s[n+7],s[n+8],s[n+9],s[n+10],s[n+11],s[n+12],s[n+13],s[n+14],s[n+15]);this.mesh._inverseBindPoses.push(l)}break;default:throw new Error("LoadModel:unknown version.")}return!0},e.READ_SUBMESH=function(){this._readString(),this._readData.getUint8();var e=this._readString();this._shaderAttributes=e.match(v._attrReg);var t=this._readData.getUint32(),n=this._readData.getUint32(),i=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),r=this._readData.getUint32(),a=this._readData.getUint32(),o=this._readData.getUint32(),s=this._readData.__getBuffer(),l=new SubMesh(this._mesh),_=this._getVertexDeclaration(),h=VertexBuffer3D.create(_,r/_.vertexStride,35044,!0),c=i+this._DATA.offset,u=s.slice(c,c+r);h.setData(new Float32Array(u));for(var d=(l._vertexBuffer=h).vertexDeclaration.getVertexElements(),f=0;f<d.length;f++)l._bufferUsage[d[f].elementUsage]=h;var m=IndexBuffer3D.create("ushort",n/2,35044,!0),p=t+this._DATA.offset,g=s.slice(p,p+n);m.setData(new Uint16Array(g)),l._indexBuffer=m;var E=s.slice(a+this._DATA.offset,a+this._DATA.offset+o);return l._boneIndicesList[0]=new Uint8Array(E),this._subMeshes.push(l),!0},e.READ_DATAAREA=function(){return!1},e._getVertexDeclaration=function(){for(var e,t=!1,n=!1,i=!1,r=!1,a=!1,o=!1,s=!1,l=!1,_=!1,h=0;h<this._shaderAttributes.length;h+=8)switch(this._shaderAttributes[h]){case"POSITION":t=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":l=!0;break;case"TANGENT":o=!0;break;case"BINORMAL":_=!0}return t&&n&&i&&r&&a&&s&&l&&o?e=VertexPositionNormalColorTexture0Texture1SkinTangent.vertexDeclaration:t&&n&&i&&r&&a&&s&&l?e=VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration:t&&n&&r&&a&&s&&l&&o?e=VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration:t&&n&&r&&a&&s&&l?e=VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:t&&n&&i&&r&&s&&l&&o?e=VertexPositionNormalColorTextureSkinTangent.vertexDeclaration:t&&n&&i&&r&&s&&l?e=VertexPositionNormalColorTextureSkin.vertexDeclaration:t&&n&&o&&_&&r&&s&&l?e=VertexPositionNTBTextureSkin.vertexDeclaration:t&&n&&r&&s&&l&&o?e=VertexPositionNormalTextureSkinTangent.vertexDeclaration:t&&n&&r&&s&&l?e=VertexPositionNormalTextureSkin.vertexDeclaration:t&&n&&i&&s&&l&&o?e=VertexPositionNormalColorSkinTangent.vertexDeclaration:t&&n&&i&&s&&l?e=VertexPositionNormalColorSkin.vertexDeclaration:t&&n&&i&&r&&a&&o?e=VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration:t&&n&&i&&r&&a?e=VertexPositionNormalColorTexture0Texture1.vertexDeclaration:t&&n&&r&&a&&o?e=VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration:t&&n&&r&&a?e=VertexPositionNormalTexture0Texture1.vertexDeclaration:t&&n&&i&&r&&o?e=VertexPositionNormalColorTextureTangent.vertexDeclaration:t&&n&&r&&o&&_?e=VertexPositionNTBTexture.vertexDeclaration:t&&n&&i&&r?e=VertexPositionNormalColorTexture.vertexDeclaration:t&&n&&r&&o?e=VertexPositionNormalTextureTangent.vertexDeclaration:t&&n&&r?e=VertexPositionNormalTexture.vertexDeclaration:t&&n&&i&&o?e=VertexPositionNormalColorTangent.vertexDeclaration:t&&n&&i&&(e=VertexPositionNormalColor.vertexDeclaration),e},__getset(0,e,"mesh",function(){return this._mesh}),v._attrReg=new RegExp("(\\w+)|([:,;])","g"),v}(),Laya3D=function(){function C(){}return __class(C,"Laya3D",!0),C._cancelLoadByUrl=function(e){Laya.loader.cancelLoadByUrl(e),C._innerFirstLevelLoaderManager.cancelLoadByUrl(e),C._innerSecondLevelLoaderManager.cancelLoadByUrl(e),C._innerThirdLevelLoaderManager.cancelLoadByUrl(e),C._innerFourthLevelLoaderManager.cancelLoadByUrl(e)},C._changeWebGLSize=function(e,t){WebGL.onStageResize(e,t),RenderState.clientWidth=e,RenderState.clientHeight=t},C.__init__=function(){var e=LoaderManager.createMap;e.lh=[Sprite3D,"SPRITE3DHIERARCHY"],e.ls=[Scene,"SPRITE3DHIERARCHY"],e.lm=[Mesh,"MESH"],e.lmat=[StandardMaterial,"MATERIAL"],e.lpbr=[PBRMaterial,"MATERIAL"],e.ltc=[TextureCube,"TEXTURECUBE"],e.jpg=[Texture2D,"nativeimage"],e.jpeg=[Texture2D,"nativeimage"],e.png=[Texture2D,"nativeimage"],e.pkm=[Texture2D,"arraybuffer"],e.lsani=[AnimationTemplet,"arraybuffer"],e.lrani=[AnimationTemplet,"arraybuffer"],e.raw=[DataTexture2D,"arraybuffer"],e.mipmaps=[DataTexture2D,"arraybuffer"],e.thdata=[TerrainHeightData,"arraybuffer"],e.lt=[TerrainRes,"TERRAIN"],e.lani=[AnimationClip,"arraybuffer"],e.lav=[Avatar,"json"],e.ani=[AnimationTemplet,"arraybuffer"],Loader.parserMap.SPRITE3DHIERARCHY=C._loadHierarchy,Loader.parserMap.MESH=C._loadMesh,Loader.parserMap.MATERIAL=C._loadMaterial,Loader.parserMap.TEXTURECUBE=C._loadTextureCube,Loader.parserMap.TERRAIN=C._loadTerrain,C._innerFirstLevelLoaderManager.on("error",null,C._eventLoadManagerError),C._innerSecondLevelLoaderManager.on("error",null,C._eventLoadManagerError),C._innerThirdLevelLoaderManager.on("error",null,C._eventLoadManagerError),C._innerFourthLevelLoaderManager.on("error",null,C._eventLoadManagerError)},C.READ_BLOCK=function(){return C._readData.pos+=4,!0},C.READ_DATA=function(){return C._DATA.offset=C._readData.getUint32(),C._DATA.size=C._readData.getUint32(),!0},C.READ_STRINGS=function(){var e=[],t={offset:0,size:0};t.offset=C._readData.getUint16(),t.size=C._readData.getUint16();C._readData.pos;C._readData.pos=t.offset+C._DATA.offset;for(var n=0;n<t.size;n++){var i=C._readData.readUTFString();-1==i.lastIndexOf(".lmat")&&-1==i.lastIndexOf(".lpbr")||e.push(i)}return e},C.formatRelativePath=function(e,t){var n;if("."==t.charAt(0)){for(var i=(e+t).split("/"),r=0,a=i.length;r<a;r++)if(".."==i[r]){var o=r-1;0<o&&".."!=i[o]&&(i.splice(o,2),r-=2)}n=i.join("/")}else n=e+t;return null!=URL.customFormat&&(n=URL.customFormat(n,null)),n},C._eventLoadManagerError=function(e){Laya.loader.event("error",e)},C._addHierarchyInnerUrls=function(e,t,n,i,r,a){var o=C.formatRelativePath(i,r);n&&(o+=n),e.push({url:o,clas:a}),t[r]=o},C._getSprite3DHierarchyInnerUrls=function(e,t,n,i,r,a,o){var s,l=0,_=0;switch(e.type){case"Scene":var h=e.customProps.lightmaps;for(l=0,_=h.length;l<_;l++){var c=h[l].replace(".exr",".png");C._addHierarchyInnerUrls(i,r,a,o,c,Texture2D)}break;case"MeshSprite3D":case"TrailSprite3D":case"LineSprite3D":case"SkinnedMeshSprite3D":var u;if(e.instanceParams)(u=e.instanceParams.loadPath)&&C._addHierarchyInnerUrls(t,r,a,o,u,Mesh);else{(u=(s=e.customProps).meshPath)&&C._addHierarchyInnerUrls(t,r,a,o,u,Mesh);var d=s.materials;if(d)for(l=0,_=d.length;l<_;l++){var f=d[l],m=f.type.split("."),p=Browser.window;if(m.forEach(function(e){p=p[e]}),"function"!=typeof p)throw"_getSprite3DHierarchyInnerUrls 错误: "+f.type+" 不是类";C._addHierarchyInnerUrls(n,r,a,o,f.path,p)}}break;case"ShuriKenParticle3D":var g=(s=e.customProps).meshPath;g&&C._addHierarchyInnerUrls(t,r,a,o,g,Mesh);var E=s.material;if(E)m=E.type.split("."),p=Browser.window,m.forEach(function(e){p=p[e]}),C._addHierarchyInnerUrls(n,r,a,o,E.path,p);else{var v=s.materialPath;if(v)C._addHierarchyInnerUrls(n,r,a,o,v,ShurikenParticleMaterial);else{var x=s.texturePath;x&&C._addHierarchyInnerUrls(i,r,a,o,x,Texture2D)}}break;case"Terrain":C._addHierarchyInnerUrls(i,r,a,o,e.customProps.dataPath,TerrainRes)}var S=e.components;for(var D in S){var T=S[D];switch(D){case"Animator":var M=T.avatarPath;if(M)C._addHierarchyInnerUrls(i,r,a,o,M,Avatar);else{var V=T.avatar;V&&C._addHierarchyInnerUrls(i,r,a,o,V.path,Avatar)}var R=T.clipPaths;for(l=0,_=R.length;l<_;l++)C._addHierarchyInnerUrls(i,r,a,o,R[l],AnimationClip)}}var A=e.child;for(l=0,_=A.length;l<_;l++)C._getSprite3DHierarchyInnerUrls(A[l],t,n,i,r,a,o)},C._loadHierarchy=function(e){e.on("loaded",null,C._onHierarchylhLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},C._onHierarchylhLoaded=function(e,t,n){if(e._class.destroyed)e.endLoad();else{var i=e.url,r=Utils3D.getURLVerion(i),a=URL.getPath(i),o=[],s=[],l=[],_={};C._getSprite3DHierarchyInnerUrls(n,o,s,l,_,r,a);var h=o.length+s.length+l.length,c=h+1,u=1/c;if(C._onProcessChange(e,0,u,1),0<l.length){var d=h/c,f=Handler.create(null,C._onProcessChange,[e,u,d],!1);C._innerFourthLevelLoaderManager.create(l,Handler.create(null,C._onHierarchyInnerForthLevResouLoaded,[e,t,f,n,_,o,s,u+d*l.length,d]),f,null,null,1,!0,t)}else C._onHierarchyInnerForthLevResouLoaded(e,t,null,n,_,o,s,u,d)}},C._onHierarchyInnerForthLevResouLoaded=function(e,t,n,i,r,a,o,s,l){if(e._class.destroyed)e.endLoad();else if(n&&n.recover(),0<o.length){var _=Handler.create(null,C._onProcessChange,[e,s,l],!1);C._innerSecondLevelLoaderManager.create(o,Handler.create(null,C._onHierarchyInnerSecondLevResouLoaded,[e,t,_,i,r,a,s+l*o.length,l]),n,null,null,1,!0,t)}else C._onHierarchyInnerSecondLevResouLoaded(e,t,null,i,r,a,s,l)},C._onHierarchyInnerSecondLevResouLoaded=function(e,t,n,i,r,a,o,s){if(e._class.destroyed)e.endLoad();else if(n&&n.recover(),0<a.length){var l=Handler.create(null,C._onProcessChange,[e,o,s],!1);C._innerFirstLevelLoaderManager.create(a,Handler.create(null,C._onHierarchyInnerFirstLevResouLoaded,[e,l,i,r]),n,null,null,1,!0,t)}else C._onHierarchyInnerFirstLevResouLoaded(e,null,i,r)},C._onHierarchyInnerFirstLevResouLoaded=function(e,t,n,i){t&&t.recover(),e.endLoad([n,i])},C._loadTerrain=function(e){e.on("loaded",null,C._onTerrainLtLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},C._onTerrainLtLoaded=function(e,t,n){if(e._class.destroyed)e.endLoad();else{var i,r,a=e.url,o=Utils3D.getURLVerion(a),s=URL.getPath(a),l=[],_={},h=0,c=0,u=n.heightData;i=u.url,r=C.formatRelativePath(s,i),o&&(r+=o),i=_[i]=r;var d=n.detailTexture;for(h=0,c=d.length;h<c;h++)l.push({url:d[h].diffuse});var f=n.normalMap;for(h=0,c=f.length;h<c;h++)l.push({url:f[h]});var m=n.alphaMap;for(h=0,c=m.length;h<c;h++)l.push({url:m[h],params:[!1,!1,6408,!0]});for(h=0,c=l.length;h<c;h++){var p=l[h].url;r=C.formatRelativePath(s,p),o&&(r+=o),l[h].url=r,_[p]=r}var g=l.length,E=g+2,v=1/E;C._onProcessChange(e,0,v,1);var x={heightMapLoaded:!1,texturesLoaded:!1},S=Handler.create(null,C._onProcessChange,[e,v,v],!1);C._innerFourthLevelLoaderManager.create(i,Handler.create(null,C._onTerrainHeightMapLoaded,[e,S,n,_,x]),S,null,[u.numX,u.numZ,u.bitType,u.value],1,!0,t);var D=Handler.create(null,C._onProcessChange,[e,2*v,g/E],!1);C._innerFourthLevelLoaderManager.create(l,Handler.create(null,C._onTerrainTexturesLoaded,[e,D,n,_,x]),D,null,null,1,!0,t)}},C._onTerrainHeightMapLoaded=function(e,t,n,i,r){r.heightMapLoaded=!0,r.texturesLoaded&&(e.endLoad([n,i]),t.recover())},C._onTerrainTexturesLoaded=function(e,t,n,i,r){r.texturesLoaded=!0,r.heightMapLoaded&&(e.endLoad([n,i]),t.recover())},C._loadMesh=function(e){e.on("loaded",null,C._onMeshLmLoaded,[e,e._class._getGroup()]),e.load(e.url,"arraybuffer",!1,null,!0)},C._onMeshLmLoaded=function(e,t,n){if(e._class.destroyed)e.endLoad();else{var i,r,a,o=e.url,s=Utils3D.getURLVerion(o),l=URL.getPath(o),_={},h=0,c=0;switch((C._readData=new Byte(n)).pos=0,C._readData.readUTFString()){case"LAYAMODEL:02":case"LAYAMODEL:03":case"LAYAMODEL:0301":var u=C._readData.getUint32();C._readData.pos=C._readData.pos+4,c=C._readData.getUint16(),C._readData.pos=C._readData.pos+8*c;var d=C._readData.getUint32();for(c=C._readData.getUint16(),C._readData.pos=u+d,i=[],h=0;h<c;h++){var f=C._readData.readUTFString();-1!=f.lastIndexOf(".lmat")&&i.push(f)}break;default:for(C.READ_BLOCK(),h=0;h<2;h++){var m=C._readData.getUint16(),p=C._strings[m],g=C["READ_"+p];if(null==g)throw new Error("model file err,no this function:"+m+" "+p);1==h?i=g.call():g.call()}}for(h=0,a=i.length;h<a;h++){var E=i[h];r=C.formatRelativePath(l,E),s&&(r+=s),i[h]=r,_[E]=r}if(0<i.length){C._onProcessChange(e,0,.5,1);var v=Handler.create(null,C._onProcessChange,[e,.5,.5],!1);C._innerSecondLevelLoaderManager.create(i,Handler.create(null,C._onMeshMateialLoaded,[e,v,n,_]),v,null,null,1,!0,t)}else e.endLoad([n,_])}},C._onMeshMateialLoaded=function(e,t,n,i){e.endLoad([n,i]),t.recover()},C._getMaterialTexturePath=function(e,t,n){var i=e.length-4;return e.indexOf(".dds")!=i&&e.indexOf(".tga")!=i&&e.indexOf(".exr")!=i&&e.indexOf(".DDS")!=i&&e.indexOf(".TGA")!=i&&e.indexOf(".EXR")!=i||(e=e.substr(0,i)+".png"),e=C.formatRelativePath(n,e),t&&(e+=t),e},C._loadMaterial=function(e){e.on("loaded",null,C._onMaterilLmatLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},C._onMaterilLmatLoaded=function(e,t,n){if(e._class.destroyed)e.endLoad();else{var i,r=e.url,a=Utils3D.getURLVerion(r),o=URL.getPath(r),s=[],l={},_=n.customProps,h=n.version;if(h)switch(h){case"LAYAMATERIAL:01":for(var c=n.props.textures,u=0,d=c.length;u<d;u++){var f=c[u],m=f.path;if(m){var p=m.length-4;m.indexOf(".exr")!=p&&m.indexOf(".EXR")!=p||(m=m.substr(0,p)+".png"),i=C.formatRelativePath(o,m),a&&(i+=a),s.push({url:i,params:f.params}),l[m]=i}}break;default:throw new Error("Laya3D:unkonwn version.")}else{var g=_.diffuseTexture.texture2D;if(g&&(i=C._getMaterialTexturePath(g,a,o),s.push(i),l[g]=i),_.normalTexture){var E=_.normalTexture.texture2D;E&&(i=C._getMaterialTexturePath(E,a,o),s.push(i),l[E]=i)}if(_.specularTexture){var v=_.specularTexture.texture2D;v&&(i=C._getMaterialTexturePath(v,a,o),s.push(i),l[v]=i)}if(_.emissiveTexture){var x=_.emissiveTexture.texture2D;x&&(i=C._getMaterialTexturePath(x,a,o),s.push(i),l[x]=i)}if(_.ambientTexture){var S=_.ambientTexture.texture2D;S&&(i=C._getMaterialTexturePath(S,a,o),s.push(i),l[S]=i)}if(_.reflectTexture){var D=_.reflectTexture.texture2D;D&&(i=C._getMaterialTexturePath(D,a,o),s.push(i),l[D]=i)}}var T=s.length,M=T+1,V=1/M;if(C._onProcessChange(e,0,V,1),0<T){var R=Handler.create(null,C._onProcessChange,[e,V,T/M],!1);C._innerFourthLevelLoaderManager.create(s,Handler.create(null,C._onMateialTexturesLoaded,[e,R,n,l]),R,Texture2D,null,1,!0,t)}else C._onMateialTexturesLoaded(e,null,n,null)}},C._onMateialTexturesLoaded=function(e,t,n,i){e.endLoad([n,i]),t&&t.recover()},C._loadTextureCube=function(e){e.on("loaded",null,C._onTextureCubeLtcLoaded,[e]),e.load(e.url,"json",!1,null,!0)},C._onTextureCubeLtcLoaded=function(e,t){if(e._class.destroyed)e.endLoad();else{var n=URL.getPath(e.url),i=[C.formatRelativePath(n,t.px),C.formatRelativePath(n,t.nx),C.formatRelativePath(n,t.py),C.formatRelativePath(n,t.ny),C.formatRelativePath(n,t.pz),C.formatRelativePath(n,t.nz)];C._onProcessChange(e,0,1/7,1);var r=Handler.create(null,C._onProcessChange,[e,1/7,6/7],!1);C._innerFourthLevelLoaderManager.load(i,Handler.create(null,C._onTextureCubeImagesLoaded,[e,i,r]),r,"nativeimage")}},C._onTextureCubeImagesLoaded=function(e,t,n){var i=[];i.length=6;for(var r=0;r<6;r++){var a=t[r];i[r]=Loader.getRes(a),Loader.clearRes(a)}e.endLoad(i),n.recover()},C._onProcessChange=function(e,t,n,i){(i=t+i*n)<1&&e.event("progress",i)},C.init=function(e,t,n,i,r,a){void 0===n&&(n=!1),void 0===i&&(i=!1),void 0===r&&(r=!0),void 0===a&&(a=!0),RunDriver.update3DLoop=function(){CollisionManager._triggerCollision()},RunDriver.cancelLoadByUrl=function(e){C._cancelLoadByUrl(e)},Config.isAntialias=n,Config.isAlpha=i,Config.premultipliedAlpha=r,Config.isStencil=a,WebGL.enable()?(RunDriver.changeWebGLSize=C._changeWebGLSize,Render.is3DMode=!0,Laya.init(e,t),Layer.__init__(),Physics.__init__(),ShaderInit3D.__init__(),MeshSprite3D.__init__(),AnimationNode.__init__(),C.__init__(),AtlasResourceManager.maxTextureCount=2,(C.debugMode||OctreeNode.debugMode)&&(C._debugPhasorSprite=new PhasorSpriter3D)):alert("Laya3D init error,must support webGL!")},C.HIERARCHY="SPRITE3DHIERARCHY",C.MESH="MESH",C.MATERIAL="MATERIAL",C.PBRMATERIAL="PBRMTL",C.TEXTURECUBE="TEXTURECUBE",C.TERRAIN="TERRAIN",C._readData=null,C._debugPhasorSprite=null,C.debugMode=!1,__static(C,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new LoaderManager},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new LoaderManager},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new LoaderManager},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new LoaderManager}]),C}(),GeometryFilter=function(e){function t(){this._destroyed=!1,t.__super.call(this),this._destroyed=!1}__class(t,"laya.d3.core.GeometryFilter",!1,e);var n=t.prototype;return Laya.imps(n,{"laya.resource.IDestroy":!0}),n._destroy=function(){this.offAll(),this._destroyed=!0},__getset(0,n,"_originalBoundingBoxCorners",function(){throw new Error("BaseRender: must override it.")}),__getset(0,n,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),__getset(0,n,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),__getset(0,n,"destroyed",function(){return this._destroyed}),__getset(0,n,"_isAsyncLoaded",function(){return!0}),t}(EventDispatcher),BaseRender=function(e){function i(e){i.__super.call(this),this._id=++i._uniqueIDCounter,this._indexInSceneFrustumCullingObjects=-1,this._boundingBox=new BoundBox(new Vector3,new Vector3),this._boundingBoxCenter=new Vector3,this._boundingSphere=new BoundSphere(new Vector3,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._isPartOfStaticBatch=!1,this._destroyed=!1,this._owner=e,this._enable=!0,this._materialsInstance=[],this.lightmapIndex=-1,this.castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatNeedChange))}__class(i,"laya.d3.core.render.BaseRender",!1,e);var t=i.prototype;return Laya.imps(t,{"laya.resource.IDestroy":!0}),t._changeMaterialReference=function(e,t){e&&e._removeReference(),t._addReference()},t._getInstanceMaterial=function(e,t){var n=new e.constructor;return e.cloneTo(n),n.name=n.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._materials[t],n),this._materials[t]=n},t._setShaderValuelightMap=function(e){this._setShaderValueTexture(3,e)},t._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},t._renderRenderableBoundBox=function(){var e=Laya3D._debugPhasorSprite,t=this.boundingBox,n=i._tempBoundBoxCorners;t.getCorners(n),e.line(n[0],i._greenColor,n[1],i._greenColor),e.line(n[2],i._greenColor,n[3],i._greenColor),e.line(n[4],i._greenColor,n[5],i._greenColor),e.line(n[6],i._greenColor,n[7],i._greenColor),e.line(n[0],i._greenColor,n[3],i._greenColor),e.line(n[1],i._greenColor,n[2],i._greenColor),e.line(n[2],i._greenColor,n[6],i._greenColor),e.line(n[3],i._greenColor,n[7],i._greenColor),e.line(n[0],i._greenColor,n[4],i._greenColor),e.line(n[1],i._greenColor,n[5],i._greenColor),e.line(n[4],i._greenColor,n[7],i._greenColor),e.line(n[5],i._greenColor,n[6],i._greenColor)},t._calculateBoundingSphere=function(){throw"BaseRender: must override it."},t._calculateBoundingBox=function(){throw"BaseRender: must override it."},t._setShaderValueTexture=function(e,t){this._owner._shaderValues.setValue(e,t)},t._setShaderValueMatrix4x4=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},t._setShaderValueColor=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},t._setShaderValueBuffer=function(e,t){this._owner._shaderValues.setValue(e,t)},t._setShaderValueInt=function(e,t){this._owner._shaderValues.setValue(e,t)},t._setShaderValueBool=function(e,t){this._owner._shaderValues.setValue(e,t)},t._setShaderValueNumber=function(e,t){this._owner._shaderValues.setValue(e,t)},t._setShaderValueVector2=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},t._addShaderDefine=function(e){this._owner._shaderDefineValue|=e},t._removeShaderDefine=function(e){this._owner._shaderDefineValue&=~e},t._renderUpdate=function(e){return!0},t._applyLightMapParams=function(){if(0<=this._lightmapIndex){var e=this._owner.scene;if(e){var t=e.getlightmaps()[this._lightmapIndex];t?(this._addShaderDefine(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),t.loaded?this._setShaderValuelightMap(t):t.once("loaded",this,__bind(this,this._setShaderValuelightMap))):this._removeShaderDefine(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP)}else this._removeShaderDefine(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP)}else this._removeShaderDefine(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP)},t._updateOctreeNode=function(){var e=this._treeNode;e&&this._octreeNodeNeedChange&&(e.updateObject(this),this._octreeNodeNeedChange=!1)},t._destroy=function(){this.offAll();var e=0,t=0;for(e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e]._destroy();for(e=0,t=this._materials.length;e<t;e++)this._materials[e]._removeReference();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null,this._destroyed=!0},__getset(0,t,"receiveShadow",function(){return this._receiveShadow},function(e){this._receiveShadow!=e&&((this._receiveShadow=e)?this._addShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_RECEIVE_SHADOW):this._removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_RECEIVE_SHADOW))}),__getset(0,t,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),__getset(0,t,"sharedMaterials",function(){return this._materials.slice()},function(e){if(!e)throw new Error("MeshRender: shadredMaterials value can't be null.");var t=e.length;this._materialsInstance.length=t;for(var n=0;n<t;n++){var i=this._materials[n];i!=e[n]&&(this._materialsInstance[n]=!1,this._changeMaterialReference(i,e[n]),this.event("materialchanged",[this,n,e[n]]))}this._materials=e}),__getset(0,t,"id",function(){return this._id}),__getset(0,t,"lightmapIndex",function(){return this._lightmapIndex},function(e){this._lightmapIndex=e,this._applyLightMapParams()}),__getset(0,t,"enable",function(){return this._enable},function(e){this._enable=e,this.event("enablechanged",[this,e])}),__getset(0,t,"destroyed",function(){return this._destroyed}),__getset(0,t,"sharedMaterial",function(){return this._materials[0]},function(e){var t=this._materials[0];t!=e&&(this._materials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e),this.event("materialchanged",[this,0,e]))}),__getset(0,t,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var e=this.boundingBox;Vector3.add(e.min,e.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),__getset(0,t,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),__getset(0,t,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(e){this._lightmapScaleOffset=e,this._setShaderValueColor(2,e),this._addShaderDefine(RenderableSprite3D.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)}),__getset(0,t,"material",function(){var e=this._materials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0);this.event("materialchanged",[this,0,t])}return this._materials[0]},function(e){this.sharedMaterial=e}),__getset(0,t,"materials",function(){for(var e=0,t=this._materials.length;e<t;e++)if(!this._materialsInstance[e]){var n=this._getInstanceMaterial(this._materials[e],e);this.event("materialchanged",[this,e,n])}return this._materials.slice()},function(e){this.sharedMaterials=e}),i._uniqueIDCounter=0,__static(i,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]},"_greenColor",function(){return this._greenColor=new Vector4(0,1,0,1)}]),i}(EventDispatcher),TransformUV=function(e){function t(){this._rotation=0,this._matNeedUpdte=!1,t.__super.call(this),this._matrix=new Matrix4x4,this._offset=new Vector2,this._tiling=new Vector2(1,1)}__class(t,"laya.d3.core.TransformUV",!1,e);var n=t.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0}),n._updateMatrix=function(){t._tempOffsetV3.elements[0]=this._offset.x,t._tempOffsetV3.elements[1]=this._offset.y,Quaternion.createFromYawPitchRoll(0,0,this._rotation,t._tempRotationQua),t._tempTitlingV3.elements[0]=this._tiling.x,t._tempTitlingV3.elements[1]=this._tiling.y,Matrix4x4.createAffineTransformation(t._tempOffsetV3,t._tempRotationQua,t._tempTitlingV3,this._matrix)},n.cloneTo=function(e){e._matrix=this._matrix.clone(),e._offset=this._offset.clone(),e._rotation=this._rotation,e._tiling=this._tiling.clone()},n.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,n,"tiling",function(){return this._tiling},function(e){this._tiling=e,this._matNeedUpdte=!0}),__getset(0,n,"rotation",function(){return this._rotation},function(e){this._rotation=e,this._matNeedUpdte=!0}),__getset(0,n,"offset",function(){return this._offset},function(e){this._offset=e,this._matNeedUpdte=!0}),__getset(0,n,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),__static(t,["_tempOffsetV3",function(){return this._tempOffsetV3=new Vector3(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new Quaternion},"_tempTitlingV3",function(){return this._tempTitlingV3=new Vector3(1,1,1)}]),t}(EventDispatcher),Transform3D=function(e){function s(e){this._owner=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._dummy=null,this.pivot=null,s.__super.call(this),this._localPosition=new Vector3,this._localRotation=new Quaternion(0,0,0,1),this._localScale=new Vector3(1,1,1),this._localRotationEuler=new Vector3,this._localMatrix=new Matrix4x4,this._position=new Vector3,this._rotation=new Quaternion(0,0,0,1),this._scale=new Vector3(1,1,1),this._worldMatrix=new Matrix4x4,this._forward=new Vector3,this._up=new Vector3,this._right=new Vector3,this._owner=e,this._childs=[]}__class(s,"laya.d3.core.Transform3D",!1,e);var t=s.prototype;return t._updateLocalMatrix=function(){if(!this.pivot||0==this.pivot.x&&0==this.pivot.y&&0==this.pivot.z)Matrix4x4.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);else{var e=s._tempVector30;Vector3.multiply(this.pivot,this._localScale,e);var t=s._tempVector31;Vector3.subtract(e,this.pivot,t);var n=s._tempVector32,i=this.localRotation;Vector3.transformQuat(e,i,n),Vector3.subtract(n,e,n);var r=s._tempVector33;Vector3.subtract(this._localPosition,t,r),Vector3.subtract(r,n,r),Matrix4x4.createAffineTransformation(r,i,this._localScale,this._localMatrix)}},t._onWorldPositionRotationTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._rotationUpdate){this._worldUpdate=this._positionUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionRotationTransform()}},t._onWorldPositionScaleTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._scaleUpdate){this._worldUpdate=this._positionUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionScaleTransform()}},t._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionTransform()}},t._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionRotationTransform()}},t._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldPositionScaleTransform()}},t._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldTransform()}},t.translate=function(e,t){void 0===t&&(t=!0),t?(Matrix4x4.createFromQuaternion(this.localRotation,s._tempMatrix0),Vector3.transformCoordinate(e,s._tempMatrix0,s._tempVector30),Vector3.add(this.localPosition,s._tempVector30,this._localPosition),this.localPosition=this._localPosition):(Vector3.add(this.position,e,this._position),this.position=this._position)},t.rotate=function(e,t,n){var i;void 0===t&&(t=!0),void 0===n&&(n=!0),i=n?e:(Vector3.scale(e,Math.PI/180,s._tempVector30),s._tempVector30),Quaternion.createFromYawPitchRoll(i.y,i.x,i.z,s._tempQuaternion0),t?(Quaternion.multiply(this._localRotation,s._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(Quaternion.multiply(s._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},t.lookAt=function(e,t,n){void 0===n&&(n=!1);var i,r=e.elements;if(n){if(i=this._localPosition.elements,Math.abs(i[0]-r[0])<MathUtils3D.zeroTolerance&&Math.abs(i[1]-r[1])<MathUtils3D.zeroTolerance&&Math.abs(i[2]-r[2])<MathUtils3D.zeroTolerance)return;Quaternion.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(i=a.elements,Math.abs(i[0]-r[0])<MathUtils3D.zeroTolerance&&Math.abs(i[1]-r[1])<MathUtils3D.zeroTolerance&&Math.abs(i[2]-r[2])<MathUtils3D.zeroTolerance)return;Quaternion.lookAt(a,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}},__getset(0,t,"up",function(){var e=this.worldMatrix.elements;return this._up.elements[0]=e[4],this._up.elements[1]=e[5],this._up.elements[2]=e[6],this._up}),__getset(0,t,"forward",function(){var e=this.worldMatrix.elements;return this._forward.elements[0]=-e[8],this._forward.elements[1]=-e[9],this._forward.elements[2]=-e[10],this._forward}),__getset(0,t,"dummy",function(){return this._dummy},function(e){this._dummy!=e&&(this._dummy&&(this._dummy._entity=null),e&&(e._entity=this),this._dummy=e)}),__getset(0,t,"parent",function(){return this._parent},function(e){if(this._parent!=e){if(this._parent){var t=this._parent._childs,n=t.indexOf(this);t.splice(n,1)}e&&(e._childs.push(this),e&&this._onWorldTransform()),this._parent=e}}),__getset(0,t,"rotationEuler",null,function(e){Quaternion.createFromYawPitchRoll(e.y,e.x,e.z,this._rotation),this.rotation=this._rotation}),__getset(0,t,"scale",function(){return this._scaleUpdate&&(null!=this._parent?Vector3.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1),this._scale},function(e){if(null!=this._parent){var t=this._parent.scale.elements,n=s._tempVector30.elements;n[0]=1/t[0],n[1]=1/t[1],n[2]=1/t[2],Vector3.multiply(e,s._tempVector30,this._localScale)}else e.cloneTo(this._localScale);this.localScale=this._localScale,this._scale=e,this._scaleUpdate=!1}),__getset(0,t,"rotation",function(){return this._rotationUpdate&&(null!=this._parent?Quaternion.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._rotationUpdate=!1),this._rotation},function(e){null!=this._parent?(this._parent.rotation.invert(s._tempQuaternion0),Quaternion.multiply(e,s._tempQuaternion0,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,this._rotation=e,this._rotationUpdate=!1}),__getset(0,t,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(s._tempVector30);var e=s._tempVector30.elements,t=this._localRotationEuler.elements;t[0]=e[1]*s._angleToRandin,t[1]=e[0]*s._angleToRandin,t[2]=e[2]*s._angleToRandin}return this._localRotationEuler},function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,!this.pivot||0==this.pivot.x&&0==this.pivot.y&&0==this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),__getset(0,t,"worldMatrix",function(){return this._worldUpdate&&(null!=this._parent?Matrix4x4.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},function(e){null==this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),Matrix4x4.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix=e,this._worldUpdate=!1}),__getset(0,t,"position",function(){if(this._positionUpdate){if(null!=this._parent){var e=this._parent.position;Vector3.multiply(this._localPosition,this._parent.scale,s._tempVector30),Vector3.transformQuat(s._tempVector30,this._parent.rotation,s._tempVector30),Vector3.add(e,s._tempVector30,this._position)}else this._localPosition.cloneTo(this._position);this._positionUpdate=!1}return this._position},function(e){if(null!=this._parent){Vector3.subtract(e,this._parent.position,this._localPosition);var t=this._parent.scale.elements,n=t[0],i=t[1],r=t[2];if(1!=n||1!=i||1!=r){var a=s._tempVector30,o=a.elements;o[0]=1/n,o[1]=1/i,o[2]=1/r,Vector3.multiply(this._localPosition,a,this._localPosition)}this._parent.rotation.invert(s._tempQuaternion0),Vector3.transformQuat(this._localPosition,s._tempQuaternion0,this._localPosition)}else e.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position=e,this._positionUpdate=!1}),__getset(0,t,"localRotation",function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler.elements;Quaternion.createFromYawPitchRoll(e[1]/s._angleToRandin,e[0]/s._angleToRandin,e[2]/s._angleToRandin,this._localRotation)}return this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,!this.pivot||0==this.pivot.x&&0==this.pivot.y&&0==this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),__getset(0,t,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(e){this._localMatrix=e,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._localUpdate=!1,this._onWorldTransform()}),__getset(0,t,"right",function(){var e=this.worldMatrix.elements;return this._right.elements[0]=e[0],this._right.elements[1]=e[1],this._right.elements[2]=e[2],this._right}),__getset(0,t,"worldNeedUpdate",function(){return this._worldUpdate}),__getset(0,t,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldPositionTransform()}),__getset(0,t,"owner",function(){return this._owner}),__getset(0,t,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._localUpdate=!0,!this.pivot||0==this.pivot.x&&0==this.pivot.y&&0==this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),__getset(0,t,"_isFrontFaceInvert",function(){var e=this.scale,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}),__static(s,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempQuaternion0",function(){return this._tempQuaternion0=new Quaternion},"_tempMatrix0",function(){return this._tempMatrix0=new Matrix4x4},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),s}(EventDispatcher),AnimationTransform3D=function(e){function r(e){r.__super.call(this),this._owner=e,this._childs=[],this._localMatrix=new Float32Array(16),this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0}__class(r,"laya.d3.animation.AnimationTransform3D",!1,e);var t=r.prototype;return t._getlocalMatrix=function(){return this._localUpdate&&(Utils3D._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix},t._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0;for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._onWorldTransform()}},t._setWorldMatrixAndUpdate=function(e){if(this._worldMatrix=e,null==this._parent)throw new Error("don't need to set worldMatrix to root Node.");if(null==this._parent._parent)for(var t=this._getlocalMatrix(),n=0;n<16;++n)this._worldMatrix[n]=t[n];else Utils3D.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);this._worldUpdate=!1},t._setWorldMatrixNoUpdate=function(e){this._worldMatrix=e},t._setWorldMatrixIgnoreUpdate=function(e){this._worldMatrix=e,this._worldUpdate=!1},t.getLocalPosition=function(){return this._localPosition},t.setLocalPosition=function(e){if(this._parent)this._localPosition=e,this._localUpdate=!0,this._onWorldTransform();else{var t=this._entity.owner._transform,n=this._entity.localPosition,i=n.elements;i[0]=e[0],i[1]=e[1],i[2]=e[2],t.localPosition=n}},t.getLocalRotation=function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler;Utils3D._quaternionCreateFromYawPitchRollArray(e[1]/r._angleToRandin,e[0]/r._angleToRandin,e[2]/r._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},t.setLocalRotation=function(e){if(this._parent)this._localRotation=e,Utils3D.quaterionNormalize(this._localRotation,this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform();else{var t=this._entity.owner._transform,n=this._entity.localRotation,i=n.elements;i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],t.localRotation=n}},t.getLocalScale=function(){return this._localScale},t.setLocalScale=function(e){if(this._parent)this._localScale=e,this._localUpdate=!0,this._onWorldTransform();else{var t=this._entity.owner._transform,n=this._entity.localScale,i=n.elements;i[0]=e[0],i[1]=e[1],i[2]=e[2],t.localScale=n}},t.getLocalRotationEuler=function(){if(this._locaEulerlUpdate){Utils3D.getYawPitchRoll(this._localRotation,r._tempVector3);var e=r._tempVector3,t=this._localRotationEuler;t[0]=e[1]*r._angleToRandin,t[1]=e[0]*r._angleToRandin,t[2]=e[2]*r._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},t.setLocalRotationEuler=function(e){if(this._parent)Utils3D._quaternionCreateFromYawPitchRollArray(e[1]/r._angleToRandin,e[0]/r._angleToRandin,e[2]/r._angleToRandin,this._localRotation),this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform();else{var t=this._entity.owner._transform,n=this._entity.localRotationEuler,i=n.elements;i[0]=e[0],i[1]=e[1],i[2]=e[2],t.localRotationEuler=n}},t.getWorldMatrix=function(){if(this._worldUpdate){if(null!=this._parent._parent)Utils3D.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else for(var e=this._getlocalMatrix(),t=0;t<16;++t)this._worldMatrix[t]=e[t];this._worldUpdate=!1}return this._worldMatrix},t.setParent=function(e){if(this._parent!=e){if(this._parent){var t=this._parent._childs,n=t.indexOf(this);t.splice(n,1)}e&&(e._childs.push(this),e&&this._onWorldTransform()),this._parent=e}},__static(r,["_tempVector3",function(){return this._tempVector3=new Float32Array(3)},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),r}(EventDispatcher),Component3D=function(e){function t(){this._destroyed=!1,this._id=0,this._enable=!1,this._owner=null,this.started=!1,t.__super.call(this),this._destroyed=!1,this._id=t._uniqueIDCounter,t._uniqueIDCounter++}__class(t,"laya.d3.component.Component3D",!1,e);var n=t.prototype;return Laya.imps(n,{"laya.resource.IDestroy":!0,"laya.d3.core.render.IUpdate":!0}),n._initialize=function(e){this._owner=e,this._enable=!0,this.started=!1,this._load(e)},n._destroy=function(){this._unload(this._owner),this._owner=null,this._destroyed=!0},n._load=function(e){},n._start=function(e){},n._update=function(e){},n._lateUpdate=function(e){},n._preRenderUpdate=function(e){},n._postRenderUpdate=function(e){},n._unload=function(e){this.offAll()},n._cloneTo=function(e){},__getset(0,n,"destroyed",function(){return this._destroyed}),__getset(0,n,"isSingleton",function(){return t._isSingleton}),__getset(0,n,"enable",function(){return this._enable},function(e){this._enable!=e&&(this._enable=e,this.event("enablechanged",this._enable))}),__getset(0,n,"owner",function(){return this._owner}),__getset(0,n,"id",function(){return this._id}),t._isSingleton=!0,t._uniqueIDCounter=1,t}(EventDispatcher),CollisionManager=function(e){function x(){x.__super.call(this)}return __class(x,"laya.d3.utils.CollisionManager",!1,e),x._onTrigger=function(e,t,n,i,r){var a=0,o=0,s=e.id,l=t.id;if(!e._ignoreCollisonMap[l]){var _=Physics.collisionManager,h=e._runtimeCollisonTestMap[l];if(null!=h)if(h)if(e._collisonTo(t))if(e._runtimeCollisonMap[l]){for(a=0,o=n.length;a<o;a++)n[a].onTriggerStay(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerStay(e);_.event("triggerstay",[e,t])}else{for(e._runtimeCollisonMap[l]=t,e._runtimeCollisonTestMap[l]=!1,t._runtimeCollisonMap[s]=e,r&&(t._runtimeCollisonTestMap[s]=!1),a=0,o=n.length;a<o;a++)n[a].onTriggerEnter(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerEnter(e);_.event("triggerenter",[e,t])}else{var c=e._runtimeCollisonMap;if(c[l]){for(delete c[l],delete e._runtimeCollisonTestMap[l],delete t._runtimeCollisonMap[s],r&&delete t._runtimeCollisonTestMap[s],a=0,o=n.length;a<o;a++)n[a].onTriggerExit(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerExit(e);_.event("triggerexit",[e,t])}}else{for(a=0,o=n.length;a<o;a++)n[a].onTriggerStay(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerStay(e);_.event("triggerstay",[e,t])}else if(e._collisonTo(t)){for(e._runtimeCollisonMap[l]=t,e._runtimeCollisonTestMap[l]=!1,t._runtimeCollisonMap[s]=e,r&&(t._runtimeCollisonTestMap[s]=!1),a=0,o=n.length;a<o;a++)n[a].onTriggerEnter(t);for(a=0,o=i.length;a<o;a++)i[a].onTriggerEnter(e);_.event("triggerenter",[e,t])}}},x._triggerCollision=function(){for(var e=Layer._collsionTestList,t=e.length,n=Physics._layerCollsionMatrix,i=0;i<t;i++)for(var r=e[i],a=Layer.getLayerByNumber(r),o=a._colliders,s=a._nonRigidbodyOffset,l=t-1;i<=l;l--){var _=e[l];if(n[r][30-_]){var h,c,u,d=0,f=0,m=0,p=0,g=Layer.getLayerByNumber(_),E=g._colliders,v=g._nonRigidbodyOffset;if(a!=g){for(d=0;d<s;d++)if((h=o[d]).enable){for(u=h.owner._scripts,m=0,p=v;m<p;m++)(c=E[m]).enable&&x._onTrigger(h,c,u,c.owner._scripts,!0);for(m=v,p=E.length;m<p;m++)(c=E[m]).enable&&x._onTrigger(h,c,u,c.owner._scripts,!1)}for(d=s,f=o.length;d<f;d++)if((h=o[d]).enable)for(u=h.owner._scripts,m=0,p=g._nonRigidbodyOffset;m<p;m++)(c=E[m]).enable&&x._onTrigger(c,h,u,c.owner._scripts,!1)}else for(d=0;d<s;d++)if((h=o[d]).enable){for(u=h.owner._scripts,m=d+1,p=s;m<p;m++)(c=E[m]).enable&&x._onTrigger(h,c,u,c.owner._scripts,!0);for(m=s,p=o.length;m<p;m++)(c=E[m]).enable&&x._onTrigger(h,c,u,c.owner._scripts,!1)}}}},x}(EventDispatcher),SplineCurvePosition=function(r){function e(){e.__super.call(this)}__class(e,"laya.d3.core.glitter.SplineCurvePosition",!1,r);var t=e.prototype;return t._CalcVelocity=function(e,t,n){Vector3.subtract(e,t,n),Vector3.scale(n,.5,n)},t.Init=function(e,t,n,i){this._CalcVelocity(t,e,this._tempVector30),this._CalcVelocity(i,n,this._tempVector31),r.prototype.Init.call(this,t,this._tempVector30,i,this._tempVector31)},e}(SplineCurvePositionVelocity),SubMeshRenderElement=function(e){function t(){this._batchIndexStart=0,this._batchIndexEnd=0,this._skinAnimationDatas=null,t.__super.call(this)}return __class(t,"laya.d3.core.render.SubMeshRenderElement",!1,RenderElement),t}(),HemisphereShape=function(n){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",!1,n);var t=e.prototype;return t._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-this.radius;var n=e.max.elements;n[0]=n[1]=this.radius,n[2]=0},t._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=-1,t[2]=0;var n=e.max.elements;n[0]=n[1]=n[2]=1},t.generatePositionAndDirection=function(e,t,n,i){var r=e.elements;n?(n.seed=i[16],this.emitFromShell?ShapeUtils._randomPointUnitSphere(e,n):ShapeUtils._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?ShapeUtils._randomPointUnitSphere(e):ShapeUtils._randomPointInsideUnitSphere(e),Vector3.scale(e,this.radius,e);var a=r[2];a<0&&(r[2]=-1*a),this.randomDirection?n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(t,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(t):e.cloneTo(t)},t.cloneTo=function(e){n.prototype.cloneTo.call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection},e}(BaseShape),CircleShape=function(n){function o(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,o.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}__class(o,"laya.d3.core.particleShuriKen.module.shape.CircleShape",!1,n);var e=o.prototype;return e._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[2]=-this.radius,t[1]=0;var n=e.max.elements;n[0]=n[2]=this.radius,n[1]=0},e._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=-1,t[2]=0;var n=e.max.elements;n[0]=n[1]=1,n[2]=0},e.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=o._tempPositionPoint.elements;n?(n.seed=i[16],this.emitFromEdge?ShapeUtils._randomPointUnitArcCircle(this.arc,o._tempPositionPoint,n):ShapeUtils._randomPointInsideUnitArcCircle(this.arc,o._tempPositionPoint,n),i[16]=n.seed):this.emitFromEdge?ShapeUtils._randomPointUnitArcCircle(this.arc,o._tempPositionPoint):ShapeUtils._randomPointInsideUnitArcCircle(this.arc,o._tempPositionPoint),r[0]=-a[0],r[1]=a[1],r[2]=0,Vector3.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(t,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(t):e.cloneTo(t)},e.cloneTo=function(e){n.prototype.cloneTo.call(this,e);var t=e;t.radius=this.radius,t.arc=this.arc,t.emitFromEdge=this.emitFromEdge,t.randomDirection=this.randomDirection},__static(o,["_tempPositionPoint",function(){return this._tempPositionPoint=new Vector2}]),o}(BaseShape),BoxShape=function(n){function e(){this.x=NaN,this.y=NaN,this.z=NaN,e.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.BoxShape",!1,n);var t=e.prototype;return t._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=.5*-this.x,t[1]=.5*-this.y,t[2]=.5*-this.z;var n=e.max.elements;n[0]=.5*this.x,n[1]=.5*this.y,n[2]=.5*this.z},t._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=0,t[1]=0,t[2]=0;var n=e.max.elements;n[0]=0,n[1]=1,n[2]=0},t.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=t.elements;n?(n.seed=i[16],ShapeUtils._randomPointInsideHalfUnitBox(e,n),i[16]=n.seed):ShapeUtils._randomPointInsideHalfUnitBox(e),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(t,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(t):(a[0]=0,a[1]=0,a[2]=1)},t.cloneTo=function(e){n.prototype.cloneTo.call(this,e);var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.randomDirection=this.randomDirection},e}(BaseShape),ConeShape=function(n){function u(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,u.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}__class(u,"laya.d3.core.particleShuriKen.module.shape.ConeShape",!1,n);var e=u.prototype;return e._getShapeBoundBox=function(e){var t=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),i=e.min.elements;i[0]=i[1]=-t,i[2]=0;var r=e.max.elements;r[0]=r[1]=t,r[2]=n},e._getSpeedBoundBox=function(e){var t=Math.sin(this.angle),n=e.min.elements;n[0]=n[1]=-t,n[2]=0;var i=e.max.elements;i[0]=n[1]=t,i[2]=1},e.generatePositionAndDirection=function(e,t,n,i){var r,a=e.elements,o=t.elements,s=u._tempPositionPoint.elements,l=NaN,_=NaN,h=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:n?(n.seed=i[16],ShapeUtils._randomPointInsideUnitCircle(u._tempPositionPoint,n),i[16]=n.seed):ShapeUtils._randomPointInsideUnitCircle(u._tempPositionPoint),l=s[0],_=s[1],a[0]=l*this.radius,a[1]=_*this.radius,a[2]=0,this.randomDirection?(n?(n.seed=i[17],ShapeUtils._randomPointInsideUnitCircle(u._tempDirectionPoint,n),i[17]=n.seed):ShapeUtils._randomPointInsideUnitCircle(u._tempDirectionPoint),r=u._tempDirectionPoint.elements,o[0]=r[0]*c,o[1]=r[1]*c):(o[0]=l*c,o[1]=_*c),o[2]=h;break;case 1:n?(n.seed=i[16],ShapeUtils._randomPointUnitCircle(u._tempPositionPoint,n),i[16]=n.seed):ShapeUtils._randomPointUnitCircle(u._tempPositionPoint),l=s[0],_=s[1],a[0]=l*this.radius,a[1]=_*this.radius,a[2]=0,this.randomDirection?(n?(n.seed=i[17],ShapeUtils._randomPointInsideUnitCircle(u._tempDirectionPoint,n),i[17]=n.seed):ShapeUtils._randomPointInsideUnitCircle(u._tempDirectionPoint),r=u._tempDirectionPoint.elements,o[0]=r[0]*c,o[1]=r[1]*c):(o[0]=l*c,o[1]=_*c),o[2]=h;break;case 2:n?(n.seed=i[16],ShapeUtils._randomPointInsideUnitCircle(u._tempPositionPoint,n)):ShapeUtils._randomPointInsideUnitCircle(u._tempPositionPoint),l=s[0],_=s[1],a[0]=l*this.radius,a[1]=_*this.radius,o[a[2]=0]=l*c,o[1]=_*c,o[2]=h,Vector3.normalize(t,t),n?(Vector3.scale(t,this.length*n.getFloat(),t),i[16]=n.seed):Vector3.scale(t,this.length*Math.random(),t),Vector3.add(e,t,e),this.randomDirection&&(n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(t,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(t));break;case 3:n?(n.seed=i[16],ShapeUtils._randomPointUnitCircle(u._tempPositionPoint,n)):ShapeUtils._randomPointUnitCircle(u._tempPositionPoint),l=s[0],_=s[1],a[0]=l*this.radius,a[1]=_*this.radius,o[a[2]=0]=l*c,o[1]=_*c,o[2]=h,Vector3.normalize(t,t),n?(Vector3.scale(t,this.length*n.getFloat(),t),i[16]=n.seed):Vector3.scale(t,this.length*Math.random(),t),Vector3.add(e,t,e),this.randomDirection&&(n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(t,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(t));break;default:throw new Error("ConeShape:emitType is invalid.")}},e.cloneTo=function(e){n.prototype.cloneTo.call(this,e);var t=e;t.angle=this.angle,t.radius=this.radius,t.length=this.length,t.emitType=this.emitType,t.randomDirection=this.randomDirection},__static(u,["_tempPositionPoint",function(){return this._tempPositionPoint=new Vector2},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new Vector2}]),u}(BaseShape),SphereShape=function(n){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.SphereShape",!1,n);var t=e.prototype;return t._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-this.radius;var n=e.max.elements;n[0]=n[1]=n[2]=this.radius},t._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-1;var n=e.max.elements;n[0]=n[1]=n[2]=1},t.generatePositionAndDirection=function(e,t,n,i){n?(n.seed=i[16],this.emitFromShell?ShapeUtils._randomPointUnitSphere(e,n):ShapeUtils._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?ShapeUtils._randomPointUnitSphere(e):ShapeUtils._randomPointInsideUnitSphere(e),Vector3.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(t,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(t):e.cloneTo(t)},t.cloneTo=function(e){n.prototype.cloneTo.call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection},e}(BaseShape),ShaderCompile3D=function(e){function g(e,t,n,i,r,a){this._name=NaN,this._attributeMap=null,this._renderElementUniformMap=null,this._materialUniformMap=null,this._spriteUniformMap=null,this._cameraUniformMap=null,this._sceneUniformMap=null,this.sharders=null,this._spriteDefineCounter=3,this._spriteInt2name=[],this._spriteName2Int={},this._materialDefineCounter=1,this._materialInt2name=[],this._materialName2Int={},this._conchShader=null,this._name=e,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this._spriteInt2name[ParallelSplitShadowMap.SHADERDEFINE_RECEIVE_SHADOW]="RECEIVESHADOW",this._spriteInt2name[RenderableSprite3D.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV]="SCALEOFFSETLIGHTINGMAPUV",this._spriteInt2name[RenderableSprite3D.SAHDERDEFINE_LIGHTMAP]="LIGHTMAP",this._spriteInt2name[SkinnedMeshSprite3D.SHADERDEFINE_BONE]="BONE",this._materialInt2name[BaseMaterial.SHADERDEFINE_ALPHATEST]="ALPHATEST";g.__super.call(this,e,t,n,null,{}),this._attributeMap=i;var o;for(o in r){var s=r[o];switch(s[1]){case 0:this._renderElementUniformMap[o]=s[0];break;case 1:this._materialUniformMap[o]=s[0];break;case 2:this._spriteUniformMap[o]=s[0];break;case 3:this._cameraUniformMap[o]=s[0];break;case 4:this._sceneUniformMap[o]=s[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}}__class(g,"laya.d3.shader.ShaderCompile3D",!1,e);var t=g.prototype;return t._definesToNameDic=function(e,t){for(var n={},i=1,r=0;r<32&&!(e<(i=1<<r));r++)if(e&i){var a=t[i];a&&(n[a]="")}return n},t.withCompile=function(e,t,n){var i,r,a;if(r=this.sharders[e])if(a=r[t]){if(i=a[n])return i}else a=r[t]=[];else a=(r=this.sharders[e]=[])[t]=[];var o,s=this._definesToNameDic(e,g._globalInt2name),l=this._definesToNameDic(t,this._spriteInt2name),_=this._definesToNameDic(n,this._materialInt2name);if(laya.d3.shader.ShaderCompile3D.debugMode){var h="";for(o in s)h+=o+" ";var c="";for(o in l)c+=o+" ";var u="";for(o in _)u+=o+" ";console.log("ShaderCompile3DDebugMode---(Name:"+Shader3D.nameKey.getName(this._name)+" PublicDefine:"+e+" SpriteDefine:"+t+" MaterialDefine:"+n+" PublicDefineGroup:"+h+" SpriteDefineGroup:"+c+"MaterialDefineGroup: "+u+")---ShaderCompile3DDebugMode")}var d={},f="";if(s)for(o in s)f+="#define "+o+"\n",d[o]=!0;if(l)for(o in l)f+="#define "+o+"\n",d[o]=!0;if(_)for(o in _)f+="#define "+o+"\n",d[o]=!0;var m=this._VS.toscript(d,[]),p=this._PS.toscript(d,[]);return i=Shader3D.create(f+m.join("\n"),f+p.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap),a[n]=i},t.precompileShaderWithShaderDefine=function(e,t,n){this.withCompile(e,t,n)},t.addMaterialDefines=function(e){var t=e.defines;for(var n in t){var i=t[n],r=parseInt(n);this._materialInt2name[r]=i,this._materialName2Int[i]=r}},t.addSpriteDefines=function(e){var t=e.defines;for(var n in t){var i=t[n],r=parseInt(n);this._spriteInt2name[r]=i,this._spriteName2Int[i]=r}},t.getMaterialDefineByName=function(e){return this._materialName2Int[e]},t.registerMaterialDefine=function(e){var t=Math.pow(2,this._materialDefineCounter++);return this._materialInt2name[t]=e,this._materialName2Int[e]=t},t.registerSpriteDefine=function(e){var t=Math.pow(2,this._spriteDefineCounter++);return this._spriteInt2name[t]=e,this._spriteName2Int[e]=t},g._globalRegDefine=function(e,t){g._globalInt2name[t]=e},g.add=function(e,t,n,i,r){return laya.d3.shader.ShaderCompile3D._preCompileShader[e]=new g(e,t,n,i,r,ShaderCompile.includes)},g.get=function(e){return laya.d3.shader.ShaderCompile3D._preCompileShader[Shader3D.nameKey.getID(e)]},g._preCompileShader={},g._globalInt2name=[],g.debugMode=!1,g.SHADERDEFINE_HIGHPRECISION=1,g.SHADERDEFINE_FOG=4,g.SHADERDEFINE_DIRECTIONLIGHT=8,g.SHADERDEFINE_POINTLIGHT=16,g.SHADERDEFINE_SPOTLIGHT=32,g.SHADERDEFINE_UV0=64,g.SHADERDEFINE_COLOR=128,g.SHADERDEFINE_UV1=256,g.SAHDERDEFINE_DEPTHFOG=131072,g}(ShaderCompile),SkyBox=function(e){function d(){d.__super.call(this),d._nameNumber++,this.loadShaderParams(),this.createResource(),this.alphaBlending=1,this.colorIntensity=1}__class(d,"laya.d3.resource.models.SkyBox",!1,e);var t=d.prototype;return t._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(t,0,0),this._shader},t.createResource=function(){this._numberVertices=36,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),t=d._vertexDeclaration.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Vector3(-.5,.5,.5),r=new Vector3(-.5,-.5,.5),a=new Vector3(.5,.5,.5),o=new Vector3(.5,-.5,.5),s=new Vector3(-.5,.5,-.5),l=new Vector3(.5,.5,-.5),_=new Vector3(-.5,-.5,-.5),h=new Vector3(.5,-.5,-.5),c=0;c=this._addVertex(n,c,i),c=this._addVertex(n,c,r),c=this._addVertex(n,c,a),c=this._addVertex(n,c,r),c=this._addVertex(n,c,o),c=this._addVertex(n,c,a),c=this._addVertex(n,c,s),c=this._addVertex(n,c,l),c=this._addVertex(n,c,_),c=this._addVertex(n,c,_),c=this._addVertex(n,c,l),c=this._addVertex(n,c,h),c=this._addVertex(n,c,i),c=this._addVertex(n,c,l),c=this._addVertex(n,c,s),c=this._addVertex(n,c,i),c=this._addVertex(n,c,a),c=this._addVertex(n,c,l),c=this._addVertex(n,c,r),c=this._addVertex(n,c,_),c=this._addVertex(n,c,h),c=this._addVertex(n,c,r),c=this._addVertex(n,c,h),c=this._addVertex(n,c,o),c=this._addVertex(n,c,i),c=this._addVertex(n,c,_),c=this._addVertex(n,c,r),c=this._addVertex(n,c,s),c=this._addVertex(n,c,_),c=this._addVertex(n,c,i),c=this._addVertex(n,c,a),c=this._addVertex(n,c,o),c=this._addVertex(n,c,h),c=this._addVertex(n,c,l),c=this._addVertex(n,c,a),c=this._addVertex(n,c,h);for(var u=0;u<36;u++)e[u]=u;this._vertexBuffer=new VertexBuffer3D(d._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(e)},t._addVertex=function(e,t,n){var i=n.elements;return e[t+0]=i[0],e[t+1]=i[1],e[t+2]=i[2],t+3},t.loadShaderParams=function(){this._sharderNameID=Shader3D.nameKey.getID("SkyBox"),this._shaderCompile=ShaderCompile3D._preCompileShader[this._sharderNameID]},t._render=function(e){this._textureCube&&this._textureCube.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(d._tempMatrix4x40),d._tempMatrix4x40.transpose(),Matrix4x4.multiply(e._projectionMatrix,d._tempMatrix4x40,d._tempMatrix4x41),e.camera._shaderValues.setValue(4,d._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.textureCube),this._shader.uploadAttributes(d._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),WebGL.mainContext.drawElements(4,36,5123,0),Stat.trianglesFaces+=12,Stat.drawCall++)},t.destroy=function(){e.prototype.destroy.call(this),this._textureCube&&(this._textureCube._removeReference(),this._textureCube=null)},__getset(0,t,"textureCube",function(){return this._textureCube},function(e){this._textureCube!=e&&(this._textureCube&&this._textureCube._removeReference(),(this._textureCube=e)&&e._addReference())}),d._nameNumber=1,__static(d,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Matrix4x4},"_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(12,[new VertexElement(0,"vector3",0)])}]),d}(Sky),SkyDome=function(e){function f(){this._stacks=16,this._slices=16,this._radius=1,f.__super.call(this),f._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}__class(f,"laya.d3.resource.models.SkyDome",!1,e);var t=f.prototype;return t._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(t,0,0),this._shader},t.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=f._vertexDeclaration.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=Math.PI/this._stacks,r=2*Math.PI/this._slices,a=0,o=0,s=0,l=0;l<this._stacks+1;l++)for(var _=Math.sin(l*i),h=Math.cos(l*i),c=0;c<this._slices+1;c++){var u=_*Math.sin(c*r),d=_*Math.cos(c*r);n[o+0]=u*this._radius,n[o+1]=h*this._radius,n[o+2]=d*this._radius,n[o+3]=-c/this._slices+.75,n[o+4]=l/this._stacks,o+=t,l!=this._stacks-1&&(e[s++]=a+1,e[s++]=a,e[s++]=a+(this._slices+1),e[s++]=a+(this._slices+1),e[s++]=a,e[s++]=a+this._slices,a++)}this._vertexBuffer=new VertexBuffer3D(f._vertexDeclaration,this._numberVertices,35044),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044),this._vertexBuffer.setData(n),this._indexBuffer.setData(e)},t.loadShaderParams=function(){this._sharderNameID=Shader3D.nameKey.getID("SkyDome"),this._shaderCompile=ShaderCompile3D._preCompileShader[this._sharderNameID]},t._render=function(e){this._texture&&this._texture.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(f._tempMatrix4x40),f._tempMatrix4x40.transpose(),Matrix4x4.multiply(e._projectionMatrix,f._tempMatrix4x40,f._tempMatrix4x41),e.camera._shaderValues.setValue(4,f._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.texture),this._shader.uploadAttributes(f._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),WebGL.mainContext.drawElements(4,this._indexBuffer.indexCount,5123,0),Stat.trianglesFaces+=this._numberIndices/3,Stat.drawCall++)},t.onEnvDescLoaded=function(e){var t="",n=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));0<n&&(t=e.substr(0,n+1));var i=Laya.loader.getRes(e);null!=i.ev&&this.__ownerCamera?this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,i.ev)):this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,0)),this.texture=Texture2D.load(t+i.skytex),this.environmentSpecular=DataTexture2D.load(t+i.prefiltedEnv);var r=new Float32Array(i.IrradianceMat);this.envDiffuseSHRed=r.slice(0,16),this.envDiffuseSHGreen=r.slice(16,32),this.envDiffuseSHBlue=r.slice(32,48)},t.loadEnvInfo=function(e){Laya.loader.load(e,Handler.create(this,__bind(this,this.onEnvDescLoaded),[e]))},t.destroy=function(){e.prototype.destroy.call(this),this._texture&&(this._texture._removeReference(),this._texture=null)},__getset(0,t,"texture",function(){return this._texture},function(e){this._texture!=e&&(this._texture&&this._texture._removeReference(),(this._texture=e)&&e._addReference())}),f._nameNumber=1,__static(f,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Matrix4x4},"_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(20,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector2",2)])}]),f}(Sky),SubMeshStaticBatch=function(e){function a(e,t,n,i,r){this._batchOwnerIndices=null,this._batchOwners=null,this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=null,this._vertexBuffer=null,this._indexBuffer=null,a.__super.call(this,e,t,n),this._batchOwnerIndices=[],this._batchOwners=[],this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=i,this._material=r}__class(a,"laya.d3.graphics.SubMeshStaticBatch",!1,StaticBatch);var t=a.prototype;return t._compareBatchRenderElement=function(e,t){return e._batchIndexStart>t._batchIndexStart},t._addCombineBatchRenderObjTest=function(e){var t=e.renderObj._vertexCount;return!(65535<(0<t?this._currentCombineVertexCount+t:this._currentCombineVertexCount+e.renderObj._getVertexBuffer().vertexCount))},t._addCombineBatchRenderObj=function(e){var t=e.renderObj,n=t._vertexCount;this._initBatchRenderElements.push(e),e._staticBatch=this,0<n?(this._currentCombineIndexCount+=t._indexCount,this._currentCombineVertexCount+=n):(this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount),this._needFinishCombine=!0},t._deleteCombineBatchRenderObj=function(e){var t=e.renderObj,n=this._initBatchRenderElements.indexOf(e);if(-1!=n){this._initBatchRenderElements.splice(n,1),e._staticBatch=null;var i=t._vertexCount;this._currentCombineVertexCount=0<i?(this._currentCombineIndexCount=this._currentCombineIndexCount-t._indexCount,this._currentCombineVertexCount-i):(this._currentCombineIndexCount=this._currentCombineIndexCount-t._getIndexBuffer().indexCount,this._currentCombineVertexCount-t._getVertexBuffer().vertexCount),this._needFinishCombine=!0}},t._finishInit=function(){if(this._needFinishCombine){var e=0,t=0;0<=this._initBatchRenderElements[0]._sprite3D._render.lightmapIndex?this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration):this._material instanceof laya.d3.core.material.StandardMaterial&&this._material.ambientTexture&&(this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration));var n=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),i=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy()),this._vertexBuffer=VertexBuffer3D.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=IndexBuffer3D.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._initBatchRenderElements.length;r<a;r++){var o=this._initBatchRenderElements[r],s=o.renderObj,l=s._getStaticBatchBakedVertexs(this._rootOwner?this._rootOwner._transform:null,o._sprite3D),_=s.getIndices(),h=o._sprite3D.transform._isFrontFaceInvert,c=e/(this._vertexDeclaration.vertexStride/4)-s._vertexStart,u=t,d=u+_.length;o._batchIndexStart=u,o._batchIndexEnd=d,i.set(_,t);var f=0;if(h)for(f=u;f<d;f+=3){i[f]=c+i[f];var m=i[f+1],p=i[f+2];i[f+1]=c+p,i[f+2]=c+m}else for(f=u;f<d;f+=3)i[f]=c+i[f],i[f+1]=c+i[f+1],i[f+2]=c+i[f+2];t+=_.length,n.set(l,e),e+=l.length}this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this._needFinishCombine=!1}},t._getCombineRenderElementFromPool=function(){return this._combineRenderElementPool[this._combineRenderElementPoolIndex++]||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new SubMeshRenderElement)},t._getRenderElement=function(e,t,n){for(var i,r,a=this._batchRenderElements.length,o=!0,s=0;s<a;s++){var l,_,h=(r=this._batchRenderElements[s])._sprite3D._render;if(0!=s&&(o=(l=(i=this._batchRenderElements[s-1])._sprite3D._render).lightmapIndex!=h.lightmapIndex||l.receiveShadow!=h.receiveShadow||i._batchIndexEnd!=r._batchIndexStart),o){(_=this._getCombineRenderElementFromPool()).renderObj=this,_._material=this._material,_._batchIndexStart=r._batchIndexStart,_._batchIndexEnd=r._batchIndexEnd;var c=h.lightmapIndex,u=c+1,d=this._batchOwnerIndices[u];d||(d=this._batchOwnerIndices[u]=[]);var f,m=d[r._render.receiveShadow?1:0];null==m?(d[h.receiveShadow?1:0]=this._batchOwners.length,(f=new MeshSprite3D(null,"StaticBatchMeshSprite3D"))._scene=t,f._transform=this._rootOwner?this._rootOwner._transform:null,f._render.lightmapIndex=c,f._render.receiveShadow=r._render.receiveShadow,this._batchOwners.push(f)):f=this._batchOwners[m],f._render._renderUpdate(n),_._sprite3D=f,e.push(_)}else _._batchIndexEnd=r._batchIndexEnd}},t._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=e.renderElement,n=t._batchIndexStart,i=t._batchIndexEnd-n;WebGL.mainContext.drawElements(4,i,5123,2*n),Stat.drawCall++,Stat.trianglesFaces+=i/3},t.dispose=function(){this._batchOwnerIndices=null,this._batchOwners=null,this._vertexDeclaration=null,this._vertexBuffer.destroy(),this._indexBuffer.destroy()},t._getVertexBuffer=function(e){return void 0===e&&(e=0),this._vertexBuffer},a}(),MeshSprite3DStaticBatchManager=function(e){function f(){f.__super.call(this)}__class(f,"laya.d3.graphics.MeshSprite3DStaticBatchManager",!1,StaticBatchManager);var t=f.prototype;return t._getStaticBatch=function(e,t,n,i){var r,a;return a=e?e.id.toString()+n.id.toString()+t.id.toString()+i.toString():n.id.toString()+t.id.toString()+i.toString(),this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new SubMeshStaticBatch(a,this,e,t,n),r},t._initStaticBatchs=function(e){var t,n;this._initBatchRenderElements.sort(f._sortPrepareStaticBatch);for(var i,r=!1,a=0,o=0,s=this._initBatchRenderElements.length;o<s;o++){var l,_=this._initBatchRenderElements[o],h=_.renderObj._getVertexBuffer(0);_._sprite3D;if(n==h.vertexDeclaration&&t==_._material)if(r)i._addCombineBatchRenderObjTest(_)?(l=_._staticBatch)!=i&&(l&&l._deleteCombineBatchRenderObj(_),i._addCombineBatchRenderObj(_)):(r=!1,a++);else{var c=this._initBatchRenderElements[o-1],u=c.renderObj,d=_.renderObj;r=!(65535<u._getVertexBuffer().vertexCount+d._getVertexBuffer().vertexCount)&&(i=this._getStaticBatch(e,n,t,a),(l=c._staticBatch)!=i&&(l&&l._deleteCombineBatchRenderObj(c),i._addCombineBatchRenderObj(c)),(l=_._staticBatch)!=i&&(l&&l._deleteCombineBatchRenderObj(_),i._addCombineBatchRenderObj(_)),!0)}else r=!1,a=0;t=_._material,n=h.vertexDeclaration}},f._sortPrepareStaticBatch=function(e,t){var n=e._render,i=t._render,r=n.lightmapIndex-i.lightmapIndex;if(0!=r)return r;var a=n.receiveShadow-i.receiveShadow;if(0!=a)return a;var o=e._mainSortID-t._mainSortID;return 0==o?e.renderObj.triangleCount-t.renderObj.triangleCount:o},f}(),ComponentNode=function(e){function t(){this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,this._scripts=null,t.__super.call(this),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[],this._scripts=[]}__class(t,"laya.d3.core.ComponentNode",!1,e);var n=t.prototype;return n.addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1==n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=ClassUtils.getInstance(e);return t.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.Script&&this._scripts.push(i),i._initialize(this),i},n._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),r instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(r),1),n.splice(t,1),0==n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,o=this._componentsMap.length;a<o;a++)for(var s=(n=this._typeComponentsIndices[a]).length-1;0<=s;s--){var l=n[s];if(!(i<l))break;n[s]=--l}r._destroy()},n.getComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);return-1==n?null:this._components[this._typeComponentsIndices[n][t]]},n.getComponentsByType=function(e,t){var n=this._componentsMap.indexOf(e);if(-1!=n){var i=this._typeComponentsIndices[n],r=i.length;t.length=r;for(var a=0;a<r;a++)t[a]=this._components[i[a]]}else t.length=0},n.getComponentByIndex=function(e){return this._components[e]},n.removeComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);-1!=n&&this._removeComponent(n,t)},n.removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!=t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(t,i)},n.removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;e<t;this._componentsMap.length<t?t--:e++)this.removeComponentsByType(this._componentsMap[e])},n._updateComponents=function(e){for(var t=0,n=this._components.length;t<n;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.enable&&i._update(e)}},n._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},n._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},n._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},t}(Node),BaseMaterial=function(i){function e(){e.__super.call(this),this._shaderDefineValue=0,this._disablePublicShaderDefine=0,this._shaderValues=new ValusArray,this._values=[],this.renderQueue=1,this._alphaTest=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new Vector4(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=513,this.depthWrite=!0}__class(e,"laya.d3.core.material.BaseMaterial",!1,i);var t=e.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0}),t._addShaderDefine=function(e){this._shaderDefineValue|=e},t._removeShaderDefine=function(e){this._shaderDefineValue&=~e},t._addDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine|=e},t._removeDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine&=~e},t._setBuffer=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},t._getBuffer=function(e){return this._values[e]},t._setMatrix4x4=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t},t._getMatrix4x4=function(e){return this._values[e]},t._setInt=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},t._getInt=function(e){return this._values[e]},t._setNumber=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},t._getNumber=function(e){return this._values[e]},t._setBool=function(e,t){this._shaderValues.setValue(e,t),this._values[e]=t},t._getBool=function(e){return this._values[e]},t._setVector2=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t},t._getVector2=function(e){return this._values[e]},t._setColor=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t},t._getColor=function(e){return this._values[e]},t._setTexture=function(e,t){var n=this._values[e];this._values[e]=t,this._shaderValues.setValue(e,t),0<this.referenceCount&&(n&&n._removeReference(),t&&t._addReference())},t._getTexture=function(e){return this._values[e]},t._upload=function(){this._shader.uploadMaterialUniforms(this._shaderValues.data)},t._getShader=function(e,t,n){var i=(e|t)&~this._disablePublicShaderDefine;return this._shader=this._shaderCompile.withCompile(i,n,this._shaderDefineValue),this._shader},t._setRenderStateBlendDepth=function(){var e=WebGL.mainContext;switch(WebGLContext.setDepthMask(e,this.depthWrite),0==this.depthTest?WebGLContext.setDepthTest(e,!1):(WebGLContext.setDepthTest(e,!0),WebGLContext.setDepthFunc(e,this.depthTest)),this.blend){case 0:WebGLContext.setBlend(e,!1);break;case 1:WebGLContext.setBlend(e,!0),WebGLContext.setBlendFunc(e,this.srcBlend,this.dstBlend);break;case 2:WebGLContext.setBlend(e,!0)}},t._setRenderStateFrontFace=function(e,t){var n=WebGL.mainContext,i=0;switch(this.cull){case 0:WebGLContext.setCullFace(n,!1);break;case 1:WebGLContext.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2305:2304:t&&t._isFrontFaceInvert?2304:2305,WebGLContext.setFrontFace(n,i);break;case 2:WebGLContext.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2304:2305:t&&t._isFrontFaceInvert?2305:2304,WebGLContext.setFrontFace(n,i)}},t.onAsynLoaded=function(e,t,n){var i=t[0],r=t[1];switch(i.version){case"LAYAMATERIAL:01":var a=0,o=0,s=i.props;for(var l in s)switch(l){case"vectors":var _=s[l];for(a=0,o=_.length;a<o;a++){var h=_[a],c=h.value;switch(c.length){case 2:this[h.name]=new Vector2(c[0],c[1]);break;case 3:this[h.name]=new Vector3(c[0],c[1],c[2]);break;case 4:this[h.name]=new Vector4(c[0],c[1],c[2],c[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var u=s[l];for(a=0,o=u.length;a<o;a++){var d=u[a],f=d.path;f&&(this[d.name]=Loader.getRes(r[f]))}break;case"defines":var m=s[l];for(a=0,o=m.length;a<o;a++){var p=this._shaderCompile.getMaterialDefineByName(m[a]);this._addShaderDefine(p)}break;default:this[l]=s[l]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this._endLoaded()},t._addReference=function(){i.prototype._addReference.call(this);for(var e=0,t=this._values.length;e<t;e++){var n=this._values[e];n&&n instanceof laya.d3.resource.BaseTexture&&n._addReference()}},t._removeReference=function(){i.prototype._removeReference.call(this);for(var e=0,t=this._values.length;e<t;e++){var n=this._values[e];n&&n instanceof laya.d3.resource.BaseTexture&&n._removeReference()}},t.disposeResource=function(){this.blendConstColor=null,this._shader=null,this._shaderValues=null;for(var e=0,t=this._values.length;e<t;e++){var n=this._values[e];n&&n instanceof laya.d3.resource.BaseTexture&&n._removeReference()}this._values=null},t.setShaderName=function(e){var t=Shader3D.nameKey.getID(e);if(-1==t)throw new Error("BaseMaterial: unknown shader name.");this._shaderCompile=ShaderCompile3D._preCompileShader[t]},t.cloneTo=function(e){var t=e;t.name=this.name,t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.renderQueue=this.renderQueue,t._shader=this._shader,t._disablePublicShaderDefine=this._disablePublicShaderDefine,t._shaderDefineValue=this._shaderDefineValue;var n,i=0,r=t._shaderValues;t._shaderValues.data.length=this._shaderValues.data.length;var a=this._values.length,o=t._values;for(i=0,n=o.length=a;i<n;i++){var s=this._values[i];if(s)if("number"==typeof s)o[i]=s,r.data[i]=s;else if("number"==typeof s&&Math.floor(s)==s)o[i]=s,r.data[i]=s;else if("boolean"==typeof s)o[i]=s,r.data[i]=s;else if(s instanceof laya.d3.math.Vector2){var l=o[i]||(o[i]=new Vector2);s.cloneTo(l),r.data[i]=l.elements}else if(s instanceof laya.d3.math.Vector3){var _=o[i]||(o[i]=new Vector3);s.cloneTo(_),r.data[i]=_.elements}else if(s instanceof laya.d3.math.Vector4){var h=o[i]||(o[i]=new Vector4);s.cloneTo(h),r.data[i]=h.elements}else if(s instanceof laya.d3.math.Matrix4x4){var c=o[i]||(o[i]=new Matrix4x4);s.cloneTo(c),r.data[i]=c.elements}else s instanceof laya.d3.resource.BaseTexture&&(o[i]=s,r.data[i]=s)}},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},__getset(0,t,"alphaTest",function(){return this._alphaTest},function(e){(this._alphaTest=e)?this._addShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST):this._removeShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST)}),__getset(0,t,"alphaTestValue",function(){return this._getNumber(0)},function(e){this._setNumber(0,e)}),e.__init__=function(){e.SHADERDEFINE_ALPHATEST=e.shaderDefines.registerDefine("ALPHATEST")},e.CULL_NONE=0,e.CULL_FRONT=1,e.CULL_BACK=2,e.BLEND_DISABLE=0,e.BLEND_ENABLE_ALL=1,e.BLEND_ENABLE_SEPERATE=2,e.BLENDPARAM_ZERO=0,e.BLENDPARAM_ONE=1,e.BLENDPARAM_SRC_COLOR=768,e.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,e.BLENDPARAM_DST_COLOR=774,e.BLENDPARAM_ONE_MINUS_DST_COLOR=775,e.BLENDPARAM_SRC_ALPHA=770,e.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,e.BLENDPARAM_DST_ALPHA=772,e.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,e.BLENDPARAM_SRC_ALPHA_SATURATE=776,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_SUBTRACT=1,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.DEPTHTEST_OFF=0,e.DEPTHTEST_NEVER=512,e.DEPTHTEST_LESS=513,e.DEPTHTEST_EQUAL=514,e.DEPTHTEST_LEQUAL=515,e.DEPTHTEST_GREATER=516,e.DEPTHTEST_NOTEQUAL=517,e.DEPTHTEST_GEQUAL=518,e.DEPTHTEST_ALWAYS=519,e.SHADERDEFINE_ALPHATEST=1,e.ALPHATESTVALUE=0,__static(e,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1}]),e}(Resource),Avatar=function(e){function t(){t.__super.call(this)}__class(t,"laya.d3.core.Avatar",!1,e);var n=t.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0}),n._initCloneToAnimator=function(e,t){t._avatarNodeMap[e.name]=e,t._avatarNodes.push(e);for(var n=0,i=e.getChildCount();n<i;n++)this._initCloneToAnimator(e.getChildByIndex(n),t)},n._parseNode=function(e,t){var n=e.props.name;if(t.name=n,t._parent){var i=e.customProps,r=t.transform;r._localRotationEuler=new Float32Array(3),r.setLocalPosition(new Float32Array(i.translate)),r.setLocalRotation(new Float32Array(i.rotation)),r.setLocalScale(new Float32Array(i.scale)),r._setWorldMatrixAndUpdate(new Float32Array(16))}for(var a=e.child,o=0,s=a.length;o<s;o++){var l=a[o],_=new AnimationNode;t.addChild(_),this._parseNode(l,_)}},n.onAsynLoaded=function(e,t,n){if(this._rootNode=new AnimationNode,t.version){this._version=t.version;var i=t.rootNode;i&&this._parseNode(i,this._rootNode)}else this._parseNode(t,this._rootNode);this._endLoaded()},n._cloneDatasToAnimator=function(e){var t=this._rootNode.clone();t.transform._setWorldMatrixIgnoreUpdate(null);e._avatarNodeMap={},e._avatarNodes=[],this._initCloneToAnimator(t,e)},n.cloneTo=function(e){var t=e,n=this._rootNode.clone();t._rootNode=n},n.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.load=function(e){return Laya.loader.create(e,null,null,t)},t}(Resource),AnimationClip=function(e){function t(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._duration=NaN,this._frameRate=0,this._animationEvents=null,this._publicClipDatas=null,this.islooping=!1,t.__super.call(this),this._fullKeyframeIndicesCache={},this._animationDatasCache=[],this._avatarDatasCache=[],this._skinnedDatasCache=[],this._animationEvents=[]}__class(t,"laya.d3.animation.AnimationClip",!1,e);var n=t.prototype;return n.duration=function(){return this._duration},n._hermiteInterpolate=function(e,t,n,i){for(var r=e.data,a=e.outTangent,o=e.next,s=o.data,l=o.inTangent,_=!1,h=NaN,c=NaN,u=NaN,d=NaN,f=0,m=i.length;f<m;f++){var p=a[f],g=l[f];if(Number.isFinite(p)&&Number.isFinite(g)){if(!_){var E=t*t,v=E*t;h=2*v-3*E+1,c=v-2*E+t,u=v-E,d=-2*v+3*E,_=!0}i[f]=h*r[f]+c*p*n+u*g*n+d*s[f]}else i[f]=r[f]}},n._getFullKeyframeIndicesWithCache=function(e){return this._fullKeyframeIndicesCache[e]},n._cacheFullKeyframeIndices=function(e,t){this._fullKeyframeIndicesCache[e]=t},n._getAnimationDataWithCache=function(e,t){var n=this._animationDatasCache[e];return n?n[t]:null},n._cacheAnimationData=function(e,t,n){(this._animationDatasCache[e]||(this._animationDatasCache[e]=[]))[t]=n},n._getAvatarDataWithCache=function(e,t,n){var i=this._avatarDatasCache[e.id];if(i){var r=i[t];return r?r[n]:null}return null},n._cacheAvatarData=function(e,t,n,i){var r=this._avatarDatasCache[e.id]||(this._avatarDatasCache[e.id]=[]);(r[t]||(r[t]=[]))[n]=i},n._evaluateAnimationlDatasCacheMode=function(e,t,n,i,r){for(var a=0,o=0,s=0,l=r?r.length:this._nodes.length;s<l;s++){var _=r?r[s]:s,h=this._nodes[_],c=h._cacheProperty;if(e[_]){var u,d=t[_],f=d[n.currentFrameIndex],m=0;if(-1!=f){var p=h.keyFrames[f];if(p.next){r&&!c?(u=i[_])||(u=i[_]=new Float32Array(h.keyFrameWidth)):(u=new Float32Array(h.keyFrameWidth),i[s]=u);var g=NaN,E=p.duration;g=0!=E?(n.currentFrameTime-p.startTime)/E:0,this._hermiteInterpolate(p,g,E,u)}else{if(r&&!c)(u=i[_])||(u=i[_]=new Float32Array(h.keyFrameWidth));else{if(-1!=(m=n._lastFrameIndex)&&d[m]==f)continue;u=new Float32Array(h.keyFrameWidth),i[s]=u}var v=p.data;for(a=0,o=u.length;a<o;a++)u[a]=v[a]}}else{if(r&&!c)(u=i[_])||(u=i[_]=new Float32Array(h.keyFrameWidth));else{if(-1!=(m=n._lastFrameIndex)&&d[m]==f)continue;u=new Float32Array(h.keyFrameWidth),i[s]=u}var x=h.keyFrames[0].data;for(a=0,o=u.length;a<o;a++)u[a]=x[a]}}}},n._evaluateAnimationlDatasRealTime=function(e,t,n,i){var r=0,a=0,o=this._nodes;if(!this._realTimeCurrentFrameIndexes){for(this._realTimeCurrentFrameIndexes=new Int32Array(o.length),r=0,a=o.length;r<a;r++)this._realTimeCurrentFrameIndexes[r]=-1;this._realTimeCurrentTimes=new Float32Array(o.length)}for(r=0,a=i?i.length:this._nodes.length;r<a;r++){var s=i?i[r]:r,l=o[s];t<this._realTimeCurrentTimes[s]&&(this._realTimeCurrentFrameIndexes[s]=-1),this._realTimeCurrentTimes[s]=t;for(var _=this._realTimeCurrentFrameIndexes[s]+1,h=l.keyFrames,c=h.length;_<c;){if(h[_].startTime>t){this._realTimeCurrentFrameIndexes[s]=_-1;break}_++}_==c&&(this._realTimeCurrentFrameIndexes[s]=c-1);var u=0,d=0,f=n[s];f||(f=n[s]=new Float32Array(l.keyFrameWidth));var m=h[this._realTimeCurrentFrameIndexes[s]];if(m){if(m.next){var p=m.duration,g=NaN;g=0!=p?(t-m.startTime)/p:0,this._hermiteInterpolate(m,g,p,f)}else{var E=m.data;for(u=0,d=f.length;u<d;u++)f[u]=E[u]}}else{var v=l.keyFrames[0].data;for(u=0,d=f.length;u<d;u++)f[u]=v[u]}var x=e[s];x&&(i?AnimationNode._propertySetFuncs[l.propertyNameID](x,null,f):AnimationNode._propertySetFuncs[l.propertyNameID](null,x,f))}},n._binarySearchEventIndex=function(e){for(var t=0,n=this._animationEvents.length-1,i=0;t<=n;){i=Math.floor((t+n)/2);var r=this._animationEvents[i].time;if(r==e)return i;e<r?n=i-1:t=i+1}return t},n.addEvent=function(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)},n.onAsynLoaded=function(e,t,n){var i=new Byte(t);switch(this._version=i.readUTFString(),this._version){case"LAYAANIMATION:01":AnimationClipParser01.parse(this,i);break;case"LAYAANIMATION:02":AnimationClipParser02.parse(this,i)}this.completeCreate(),this._endLoaded()},n.disposeResource=function(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._publicClipDatas=null},t.load=function(e){return Laya.loader.create(e,null,null,t)},t}(Resource),TerrainHeightData=function(e){function a(){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,a.__super.call(this)}return __class(a,"laya.d3.terrain.TerrainHeightData",!1,e),a.prototype.onAsynLoaded=function(e,t,n){var i;this._width=n[0],this._height=n[1],this._bitType=n[2],this._value=n[3];var r=NaN;8==this._bitType?(i=new Uint8Array(t),r=1/255):16==this._bitType&&(i=new Int16Array(t),r=1/32766),this._terrainHeightData=new Float32Array(this._height*this._width);for(var a=0,o=this._height*this._width;a<o;a++)this._terrainHeightData[a]=i[a]*r*this._value/2;this._endLoaded()},a.load=function(e,t,n,i,r){return Laya.loader.create(e,null,null,a,[t,n,i,r],1,!1)},a}(Resource),TerrainRes=function(e){function t(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,t.__super.call(this)}__class(t,"laya.d3.terrain.TerrainRes",!1,e);var n=t.prototype;return n.parseData=function(e){var t=e[0],n=e[1];if(this._version=t.version,1==this._version){this._cameraCoordinateInverse=t.cameraCoordinateInverse,this._gridSize=t.gridSize,this._chunkNumX=t.chunkNumX,this._chunkNumZ=t.chunkNumZ;var i=t.heightData;if(this._heightDataX=i.numX,this._heightDataZ=i.numZ,this._heightDataBitType=i.bitType,this._heightDataValue=i.value,this._heightDataUrl=n[i.url],this._materialInfo=new MaterialInfo,t.material){var r=t.material.ambient,a=t.material.diffuse,o=t.material.specular;this._materialInfo.ambientColor=new Vector3(r[0],r[1],r[2]),this._materialInfo.diffuseColor=new Vector3(a[0],a[1],a[2]),this._materialInfo.specularColor=new Vector4(o[0],o[1],o[2],o[3])}var s=t.detailTexture;this._detailTextureInfos=__newvec(s.length);for(var l=0;l<s.length;l++){var _=s[l],h=new DetailTextureInfo;h.diffuseTexture=n[_.diffuse],h.normalTexture=_.normal?n[_.normal]:null,_.scale?h.scale=new Vector2(_.scale[0],_.scale[1]):h.scale=new Vector2(1,1),_.offset?h.offset=new Vector2(_.offset[0],_.offset[1]):h.offset=new Vector2(0,0),this._detailTextureInfos[l]=h}var c=t.alphaMap;for(this._alphaMaps=__newvec(c.length),l=0;l<this._alphaMaps.length;l++)this._alphaMaps[l]=t.alphaMap[l];var u=t.normalMap;for(this._normalMaps=__newvec(u.length),l=0;l<this._normalMaps.length;l++)this._normalMaps[l]=t.normalMap[l];var d=t.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=d.length)return alert("terrain data error"),!1;for(this._chunkInfos=__newvec(d.length),l=0;l<d.length;l++){var f=d[l],m=new ChunkInfo,p=f.alphaMap.length,g=f.detailID.length;if(p!=g)return alert("terrain chunk data error"),!1;m.alphaMap=__newvec(p),m.detailID=__newvec(g),m.normalMap=n[this._normalMaps[f.normalMap]];for(var E=0;E<p;E++){m.alphaMap[E]=n[this._alphaMaps[f.alphaMap[E]]];var v=f.detailID[E],x=v.length;m.detailID[E]=new Uint8Array(x);for(var S=0;S<x;S++)m.detailID[E][S]=v[S]}this._chunkInfos[l]=m}this._heightData=Loader.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData)}return!0},n.onLoadTerrainComplete=function(e){this._endLoaded()},n.onAsynLoaded=function(e,t,n){this.parseData(t)},t.load=function(e){return Laya.loader.create(e,null,null,t,null,1,!1)},t}(Resource),BaseTexture=function(e){function t(){this._type=0,this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._format=0,this._source=null,t.__super.call(this),this._conchTexture,this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}__class(t,"laya.d3.resource.BaseTexture",!1,e);var n=t.prototype;return __getset(0,n,"defaulteTexture",function(){return SolidColorTexture2D.grayTexture}),__getset(0,n,"source",function(){return this.activeResource(),this._source}),__getset(0,n,"format",function(){return this._format}),__getset(0,n,"magFifter",function(){return this._magFifter},function(e){(this._magFifter=e)!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(e)}),__getset(0,n,"mipmap",function(){return this._mipmap},function(e){this._mipmap=e,this._mipmap!=e&&this._conchTexture&&this._conchTexture.setMipMap(e)}),__getset(0,n,"size",function(){return this._size}),__getset(0,n,"repeat",function(){return this._repeat},function(e){if(this._repeat!=e&&(this._repeat=e,this._source)){var t=WebGL.mainContext;WebGLContext.bindTexture(t,this._type,this._source),Arith.isPOT(this._width,this._height)&&this._repeat?(t.texParameteri(this._type,10242,10497),t.texParameteri(this._type,10243,10497)):(t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071))}}),__getset(0,n,"height",function(){return this._height}),__getset(0,n,"minFifter",function(){return this._minFifter},function(e){this._minFifter=e,this._minFifter!=e&&this._conchTexture&&this._conchTexture.setMinFifter(e)}),__getset(0,n,"width",function(){return this._width}),t}(Resource),BaseMesh=function(e){function t(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._positions=null,t.__super.call(this),this._boundingBoxCorners=__newvec(8,null)}__class(t,"laya.d3.resource.models.BaseMesh",!1,e);var n=t.prototype;return n._getPositions=function(){throw new Error("未Override,请重载该属性！")},n._generateBoundingObject=function(){this._boundingSphere=new BoundSphere(new Vector3,0),BoundSphere.createfromPoints(this._positions,this._boundingSphere),this._boundingBox=new BoundBox(new Vector3,new Vector3),BoundBox.createfromPoints(this._positions,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},n.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},n.getRenderElement=function(e){throw new Error("未Override,请重载该属性！")},__getset(0,n,"boundingBoxCorners",function(){return this._boundingBoxCorners}),__getset(0,n,"boundingBox",function(){return this._boundingBox}),__getset(0,n,"boundingSphere",function(){return this._boundingSphere}),__getset(0,n,"subMeshCount",function(){return this._subMeshCount}),t}(Resource),TrailFilter=function(t){function n(e){this._owner=null,this._trailRenderElements=null,this._minVertexDistance=NaN,this._widthMultiplier=NaN,this._time=NaN,this._widthCurve=null,this._colorGradient=null,this._textureMode=0,this._curtime=0,this._curSubTrailFinishCurTime=0,this._curSubTrailFinished=!1,this._hasLifeSubTrail=!1,this._trailTotalLength=0,this._trailSupplementLength=0,this._trailDeadLength=0,this._isStart=!1,this._trailRenderElementIndex=0,n.__super.call(this),this._curSubTrailFinishPosition=new Vector3,this._curSubTrailFinishDirection=new Vector3,this._owner=e,this._trailRenderElements=[],this.addRenderElement()}__class(n,"laya.d3.core.trail.TrailFilter",!1,t);var e=n.prototype;return e.getRenderElementsCount=function(){return this._trailRenderElements.length},e.addRenderElement=function(){for(var e=0;e<this._trailRenderElements.length;e++)if(1==this._trailRenderElements[e]._isDead)return this._trailRenderElements[e].reActivate(),e;var t=new TrailRenderElement(this);return this._trailRenderElements.push(t),this._trailRenderElements.length-1},e.getRenderElement=function(e){return this._trailRenderElements[e]},e._update=function(e){this._curtime+=e.elapsedTime/1e3,this._owner._render._setShaderValueNumber(3,this._curtime),this._curSubTrailFinished&&(this._curSubTrailFinished=!1,this._trailRenderElementIndex=this.addRenderElement(),this.event("trailfilterchange",[this._trailRenderElementIndex,this._trailRenderElements[this._trailRenderElementIndex]]))},e.reset=function(){for(var e=0;e<this._trailRenderElements.length;e++)this._trailRenderElements[e].reActivate();this._isStart=!1,this._hasLifeSubTrail=!1,this._curSubTrailFinished=!1,this._curSubTrailFinishCurTime=0,this._trailTotalLength=0,this._trailSupplementLength=0,this._trailDeadLength=0},e._destroy=function(){t.prototype._destroy.call(this);for(var e=0;e<this._trailRenderElements.length;e++)this._trailRenderElements[e]._destroy();this._trailRenderElements=null,this._widthCurve=null,this._colorGradient=null,this._curSubTrailFinishPosition=null,this._curSubTrailFinishDirection=null},__getset(0,e,"textureMode",function(){return this._textureMode},function(e){this._textureMode=e}),__getset(0,e,"colorGradient",function(){return this._colorGradient},function(e){this._colorGradient=e,this._owner._render._setShaderValueBuffer(7,e._colorKeyData),this._owner._render._setShaderValueBuffer(8,e._alphaKeyData),0==e.mode?this._owner._render._addShaderDefine(TrailSprite3D.SHADERDEFINE_GRADIENTMODE_BLEND):this._owner._render._removeShaderDefine(TrailSprite3D.SHADERDEFINE_GRADIENTMODE_BLEND)}),__getset(0,e,"widthCurve",function(){return this._widthCurve},function(e){this._widthCurve=e;var t,n=new Float32Array(4*e.length),i=0,r=0;for(i=0,t=e.length;i<t;i++)n[r++]=e[i].time,n[r++]=e[i].inTangent,n[r++]=e[i].outTangent,n[r++]=e[i].value;this._owner._render._setShaderValueBuffer(5,n),this._owner._render._setShaderValueInt(6,e.length)}),__getset(0,e,"widthMultiplier",function(){return this._widthMultiplier},function(e){this._widthMultiplier=e}),__getset(0,e,"minVertexDistance",function(){return this._minVertexDistance},function(e){this._minVertexDistance=e}),__getset(0,e,"time",function(){return this._time},function(e){this._time=e,this._owner._render._setShaderValueNumber(4,e)}),n}(GeometryFilter),TrailRenderer=function(e){function t(e){t.__super.call(this,e)}__class(t,"laya.d3.core.trail.TrailRenderer",!1,BaseRender);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._renderUpdate=function(e){return!0},t}(),MeshFilter=function(e){function t(e){this._owner=null,this._sharedMesh=null,t.__super.call(this),this._owner=e}__class(t,"laya.d3.core.MeshFilter",!1,e);var n=t.prototype;return n._sharedMeshLoaded=function(){this.event("loaded")},n._destroy=function(){e.prototype._destroy.call(this),this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)},__getset(0,n,"_originalBoundingBoxCorners",function(){return this._sharedMesh.boundingBoxCorners}),__getset(0,n,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),__getset(0,n,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),__getset(0,n,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox}),__getset(0,n,"sharedMesh",function(){return this._sharedMesh},function(e){var t=this._sharedMesh;t&&t._removeReference(),(this._sharedMesh=e)._addReference(),this.event("meshchanged",[this,t,e]),e.loaded||this._sharedMesh.once("loaded",this,__bind(this,this._sharedMeshLoaded))}),t}(GeometryFilter),ShurikenParticleRender=function(e){function t(e){this._finalGravity=new Vector3,this._tempRotationMatrix=new Matrix4x4,t.__super.call(this,e),this._defaultBoundBox=new BoundBox(new Vector3,new Vector3),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}__class(t,"laya.d3.core.particleShuriKen.ShurikenParticleRender",!1,e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._owner.particleSystem._boundingSphere,t=NaN,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),o=Math.abs(i[2]);t=a<=r&&o<=r?r:o<=a?a:o,Vector3.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t},n._renderUpdate=function(e){var t=this._owner.particleSystem;if(!Laya.stage.isVisibility||!t.isAlive)return!1;var n=this._owner.transform;switch(t.simulationSpace){case 0:break;case 1:this._setShaderValueColor(0,n.position),this._setShaderValueColor(1,n.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(t.scaleMode){case 0:var i=n.scale;this._setShaderValueColor(4,i),this._setShaderValueColor(5,i);break;case 1:var r=n.localScale;this._setShaderValueColor(4,r),this._setShaderValueColor(5,r);break;case 2:this._setShaderValueColor(4,n.scale),this._setShaderValueColor(5,Vector3.ONE)}var a=this._finalGravity.elements,o=Physics.gravity.elements,s=t.gravityModifier;return a[0]=o[0]*s,a[1]=o[1]*s,a[2]=o[2]*s,this._setShaderValueBuffer(7,a),this._setShaderValueInt(11,t.simulationSpace),this._setShaderValueBool(8,t.threeDStartRotation),this._setShaderValueInt(6,t.scaleMode),this._setShaderValueInt(9,this.stretchedBillboardLengthScale),this._setShaderValueInt(10,this.stretchedBillboardSpeedScale),this._setShaderValueNumber(12,t._currentTime),Laya3D.debugMode&&this._renderRenderableBoundBox(),!0},n._destroy=function(){e.prototype._destroy.call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)},__getset(0,n,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),__getset(0,n,"mesh",function(){return this._mesh},function(e){this._mesh!=e&&(this._mesh&&this._mesh._removeReference(),(this._mesh=e)&&e._addReference(),this._owner.particleSystem._initBufferDatas())}),__getset(0,n,"renderMode",function(){return this._renderMode},function(e){if(this._renderMode!=e){switch(this._renderMode){case 0:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e){case 0:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),t}(BaseRender),ShurikenParticleSystem=function(e){function Y(e){Y.__super.call(this),this._tempRotationMatrix=new Matrix4x4,this._uvLength=new Vector2,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=e,this._ownerRender=e.particleRender,this._boundingBoxCorners=__newvec(8,null),this._boundingSphere=new BoundSphere(new Vector3,Number.MAX_VALUE),this._boundingBox=new BoundBox(new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new GradientDataNumber,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new GradientDataNumber,this._startLifeTimeGradientMax=new GradientDataNumber,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new Vector3(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new Vector3(0,0,0),this.startSizeConstantMaxSeparate=new Vector3(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new Vector3(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new Vector3(0,0,0),this.startRotationConstantMaxSeparate=new Vector3(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new Vector4(1,1,1,1),this.startColorConstantMin=new Vector4(1,1,1,1),this.startColorConstantMax=new Vector4(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new Rand(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(Y._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new Emission,this._emission.enbale=!0,this._owner.on("activeinhierarchychanged",this,__bind(this,this._onOwnerActiveHierarchyChanged))}__class(Y,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",!1,e);var t=Y.prototype;return Laya.imps(t,{"laya.d3.core.IClone":!0,"laya.d3.core.render.IRenderable":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._generateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},t._generateBoundingBox=function(){var e=this._owner.particleRender,t=this._boundingBox.min,n=this._boundingBox.max,i=0,r=0,a=NaN;switch(this.startLifetimeType){case 0:a=this.startLifetimeConstant;break;case 1:a=-Number.MAX_VALUE;var o=o;for(i=0,r=o.gradientCount;i<r;i++)a=Math.max(a,o.getValueByIndex(i));break;case 2:a=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:a=-Number.MAX_VALUE;var s=s;for(i=0,r=s.gradientCount;i<r;i++)a=Math.max(a,s.getValueByIndex(i));var l=l;for(i=0,r=l.gradientCount;i<r;i++)a=Math.max(a,l.getValueByIndex(i))}var _,h,c,u,d=NaN,f=NaN;switch(this.startSpeedType){case 0:d=f=this.startSpeedConstant;break;case 1:break;case 2:d=this.startLifetimeConstantMin,f=this.startLifetimeConstantMax}this._shape&&this._shape.enable||(_=h=Vector3.ZERO,c=Vector3.ZERO,u=Vector3.UnitZ);var m,p,g=new Vector3(c.x*d,c.y*d,c.z*d),E=new Vector3(u.x*f,u.y*f,u.z*f);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var v=this._velocityOverLifetime.velocity;switch(v.type){case 0:v.constant;break;case 1:new Vector3(v.gradientX.getAverageValue(),v.gradientY.getAverageValue(),v.gradientZ.getAverageValue());break;case 2:v.constantMin,v.constantMax;break;case 3:new Vector3(v.gradientXMin.getAverageValue(),v.gradientYMin.getAverageValue(),v.gradientZMin.getAverageValue()),new Vector3(v.gradientXMax.getAverageValue(),v.gradientYMax.getAverageValue(),v.gradientZMax.getAverageValue())}}var x,S,D=this._owner.transform,T=D.position,M=Y._tempVector39,V=M.elements,R=e.renderMode;switch(this.scaleMode){case 0:var A=D.scale;m=A,V[0]=A.x,V[1]=A.z,V[2]=A.y,1==R&&(p=A);break;case 1:var C=D.localScale;m=C,V[0]=C.x,V[1]=C.z,V[2]=C.y,1==R&&(p=C);break;case 2:m=D.scale,V[0]=V[1]=V[2]=1,1==R&&(p=Vector3.ONE)}switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(x=new Vector3(g.x*a,g.y*a,g.z*a),S=new Vector3(E.x*a,E.y*a,E.z*a),2!=this.scaleMode?(Vector3.add(_,x,t),Vector3.multiply(m,t,t),Vector3.add(h,S,n),Vector3.multiply(m,n,n)):(Vector3.multiply(m,_,t),Vector3.add(t,x,t),Vector3.multiply(m,h,n),Vector3.add(n,S,n))),this.simulationSpace){case 0:break;case 1:Vector3.add(t,T,t),Vector3.add(n,T,n)}var I=NaN,y=NaN;switch(this.startSizeType){case 0:if(this.threeDStartSize){var N=N;I=Math.max(N.x,N.y),1==R&&(y=N.y)}else I=this.startSizeConstant,1==R&&(y=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var P=P;I=Math.max(P.x,P.y),1==R&&(y=P.y)}else I=this.startSizeConstantMax,1==R&&(y=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){this._sizeOverLifetime.size;I*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var L=Y._tempVector30,w=L.elements,O=NaN,b=NaN;switch(R){case 0:O=I*Y.halfKSqrtOf2,Vector3.scale(M,I,L),Vector3.subtract(t,L,t),Vector3.add(n,L,n);break;case 1:var F=Y._tempVector31,B=Y._tempVector32,U=Y._tempVector33,H=Y._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(Vector3.multiply(p,E,B),Vector3.multiply(p,g,U));var G=y*e.stretchedBillboardLengthScale,z=Vector3.scalarLength(B)*e.stretchedBillboardSpeedScale+G,W=Vector3.scalarLength(U)*e.stretchedBillboardSpeedScale+G,k=Y._tempVector35,X=Y._tempVector36;Vector3.normalize(B,k),Vector3.scale(k,z,H),Vector3.subtract(S,H,H),Vector3.normalize(U,X),Vector3.scale(X,W,F),Vector3.add(x,F,F),O=I*Y.halfKSqrtOf2,Vector3.scale(M,O,L);var Z=Y._tempVector37,K=Y._tempVector38;Vector3.scale(k,.5,Z),Vector3.scale(X,.5,K),Vector3.multiply(Z,M,Z),Vector3.multiply(K,M,K),Vector3.add(t,K,t),Vector3.min(t,H,t),Vector3.subtract(t,L,t),Vector3.subtract(n,Z,n),Vector3.max(n,F,n),Vector3.add(n,L,n);break;case 2:b=.5*(I*=Math.cos(.7853981633974483)),w[0]=M.x*b,w[1]=M.z*b,Vector3.subtract(t,L,t),Vector3.add(n,L,n);break;case 3:b=.5*(I*=Math.cos(.7853981633974483)),Vector3.scale(M,b,L),Vector3.subtract(t,L,t),Vector3.add(n,L,n)}this._boundingBox.getCorners(this._boundingBoxCorners)},t._updateEmission=function(){if(Laya.stage.isVisibility&&this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount==Stat.loopCount||this._isPaused?0:Laya.timer.delta/1e3;e=Math.min(Y._maxElapsedTime,e),this._updateParticles(e)}},t._updateParticles=function(e){(4!=this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime))},t._updateParticlesSimulationRestart=function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0;var t=this._currentTime=e;t<this._playStartDelay?this._totalDelayTime=t:this._emission.enbale&&this._advanceTime(e,e)},t._addUpdateEmissionToTimer=function(){Laya.timer.frameLoop(1,this,__bind(this,this._updateEmission))},t._removeUpdateEmissionToTimer=function(){Laya.timer.clear(this,__bind(this,this._updateEmission))},t._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},t._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},t._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&e<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},t._burst=function(e,t){for(var n=0,i=this._emission._bursts,r=i.length;this._burstsIndex<r;this._burstsIndex++){var a=i[this._burstsIndex],o=a.time;if(!(e<=o&&o<t))break;var s=0;this.autoRandomSeed?s=MathUtil.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],s=MathUtil.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),n+=s}return n},t._advanceTime=function(e,t){var n=0,i=this._emissionTime;this._emissionTime+=e;var r=0;if(this._emissionTime>this.duration){if(!this.looping){for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);return this._isPlaying=!1,void this.stop()}r+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(i,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);var a=this.emission.emissionRate;if(0<a){var o=1/a;for(this._frameRateTime+=o,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=o;this._frameRateTime=Math.floor(t/o)*o}},t._initBufferDatas=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var e=this._ownerRender,t=e.renderMode;if(-1!=t&&0<this.maxParticles){var n,i,r=0,a=0,o=0,s=0,l=0,_=e.mesh;if(4==t){if(_){if(1<_._vertexBuffers.length)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");i=VertexShurikenParticleMesh.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=_._vertexBuffers[0].vertexCount;var h=this._bufferMaxParticles*this._vertexStride,c=h%65535;if(1<Math.floor(h/65535)+1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");this._vertexBuffer=VertexBuffer3D.create(i,c,35048),this._vertices=new Float32Array(this._floatCountPerVertex*c),this._indexStride=_._indexBuffer.indexCount;var u=_._indexBuffer.getData(),d=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=IndexBuffer3D.create("ushort",d,35044),n=new Uint16Array(d),r=s=0;r<this._bufferMaxParticles;r++){var f=r*this._vertexStride;for(a=0,o=u.length;a<o;a++)n[s++]=f+u[a]}this._indexBuffer.setData(n)}}else{for(i=VertexShurikenParticleBillboard.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,this._vertexBuffer=VertexBuffer3D.create(i,this._bufferMaxParticles*this._vertexStride,35048),this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),r=0;r<this._bufferMaxParticles;r++)l=r*this._floatCountPerVertex*this._vertexStride,this._vertices[l]=-.5,this._vertices[l+1]=-.5,this._vertices[l+2]=0,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=-.5,this._vertices[l+2]=1,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=.5,this._vertices[l+2]=1,this._vertices[l+3]=0,l+=this._floatCountPerVertex,this._vertices[l]=-.5,this._vertices[l+1]=.5,this._vertices[l+2]=0,this._vertices[l+3]=0;for(this._indexStride=6,this._indexBuffer=IndexBuffer3D.create("ushort",6*this._bufferMaxParticles,35044),n=new Uint16Array(6*this._bufferMaxParticles),r=0;r<this._bufferMaxParticles;r++){s=6*r;var m=r*this._vertexStride,p=m+2;n[s++]=m,n[s++]=p,n[s++]=m+1,n[s++]=m,n[s++]=m+3,n[s++]=p}this._indexBuffer.setData(n)}}},t._destroy=function(){e.prototype._destroy.call(this),this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},t.emit=function(e){var t=Y._tempPosition,n=Y._tempDirection;if(this._shape&&this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(t,n):this._shape.generatePositionAndDirection(t,n,this._rand,this._randomSeeds);else{var i=t.elements,r=n.elements;i[0]=i[1]=i[2]=0,r[0]=r[1]=0,r[2]=1}return this.addParticle(t,n,e)},t.addParticle=function(e,t,n){Vector3.normalize(t,t);var i=this._firstFreeElement+1;if(i>=this._bufferMaxParticles&&(i=0),i==this._firstRetiredElement)return!1;if(ShurikenParticleData.create(this,this._ownerRender,this._owner.transform),this._currentTime-n>=ShurikenParticleData.startLifeTime)return!0;var r=NaN,a=NaN,o=NaN,s=NaN,l=NaN,_=NaN,h=NaN,c=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(c){var u=this._velocityOverLifetime.velocity.type;2==u||3==u?this.autoRandomSeed?(r=Math.random(),a=Math.random(),o=Math.random()):(this._rand.seed=this._randomSeeds[9],r=this._rand.getFloat(),a=this._rand.getFloat(),o=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):c=!1}else c=!1;var d=this._colorOverLifetime&&this._colorOverLifetime.enbale;d?3==this._colorOverLifetime.color.type?this.autoRandomSeed?s=Math.random():(this._rand.seed=this._randomSeeds[10],s=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):d=!1:d=!1;var f=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;f?3==this._sizeOverLifetime.size.type?this.autoRandomSeed?l=Math.random():(this._rand.seed=this._randomSeeds[11],l=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):f=!1:f=!1;var m=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(m){var p=this._rotationOverLifetime.angularVelocity.type;2==p||3==p?this.autoRandomSeed?_=Math.random():(this._rand.seed=this._randomSeeds[12],_=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):m=!1}else m=!1;var g=this._textureSheetAnimation&&this._textureSheetAnimation.enable;g?3==this._textureSheetAnimation.frame.type?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[15],h=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):g=!1:g=!1;var E,v=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,x=ShurikenParticleData.startUVInfo[0],S=ShurikenParticleData.startUVInfo[1],D=ShurikenParticleData.startUVInfo[2],T=ShurikenParticleData.startUVInfo[3],M=e.elements,V=t.elements,R=0,A=0,C=0,I=0,y=0,N=this._ownerRender;if(4==N.renderMode){var P=N.mesh._vertexBuffers[0];E=P.getData();var L=P.vertexDeclaration;A=L.getVertexElementByUsage(0).offset/4;var w=L.getVertexElementByUsage(1);C=w?w.offset/4:-1;var O=L.getVertexElementByUsage(2);I=O?O.offset/4:-1,R=L.vertexStride/4,y=0}else{this._vertices[v+2]=D,this._vertices[v+3]=T+S;var b=v+this._floatCountPerVertex;this._vertices[b+2]=D+x,this._vertices[b+3]=T+S;var F=b+this._floatCountPerVertex;this._vertices[F+2]=D+x,this._vertices[F+3]=T;var B=F+this._floatCountPerVertex;this._vertices[B+2]=D,this._vertices[B+3]=T}for(var U=v,H=v+this._floatCountPerVertex*this._vertexStride;U<H;U+=this._floatCountPerVertex){var G=0;if(4==N.renderMode){G=U;var z=R*y++,W=z+A;this._vertices[G++]=E[W++],this._vertices[G++]=E[W++],this._vertices[G++]=E[W],this._vertices[G++]=-1==C?(this._vertices[G++]=1,this._vertices[G++]=1,this._vertices[G++]=1):(W=z+C,this._vertices[G++]=E[W++],this._vertices[G++]=E[W++],this._vertices[G++]=E[W++],E[W]),this._vertices[G++]=-1==I?this._vertices[G++]=0:(W=z+I,this._vertices[G++]=D+E[W++]*x,T+E[W]*S)}else G=U+4;switch(this._vertices[G++]=M[0],this._vertices[G++]=M[1],this._vertices[G++]=M[2],this._vertices[G++]=ShurikenParticleData.startLifeTime,this._vertices[G++]=V[0],this._vertices[G++]=V[1],this._vertices[G++]=V[2],this._vertices[G++]=n,this._vertices[G++]=ShurikenParticleData.startColor[0],this._vertices[G++]=ShurikenParticleData.startColor[1],this._vertices[G++]=ShurikenParticleData.startColor[2],this._vertices[G++]=ShurikenParticleData.startColor[3],this._vertices[G++]=ShurikenParticleData.startSize[0],this._vertices[G++]=ShurikenParticleData.startSize[1],this._vertices[G++]=ShurikenParticleData.startSize[2],this._vertices[G++]=ShurikenParticleData.startRotation[0],this._vertices[G++]=ShurikenParticleData.startRotation[1],this._vertices[G++]=ShurikenParticleData.startRotation[2],this._vertices[G++]=ShurikenParticleData.startSpeed,d&&(this._vertices[G+1]=s),f&&(this._vertices[G+2]=l),m&&(this._vertices[G+3]=_),g&&(this._vertices[G+4]=h),c&&(this._vertices[G+5]=r,this._vertices[G+6]=a,this._vertices[G+7]=o),this.simulationSpace){case 0:G+=8,this._vertices[G++]=ShurikenParticleData.simulationWorldPostion[0],this._vertices[G++]=ShurikenParticleData.simulationWorldPostion[1],this._vertices[G++]=ShurikenParticleData.simulationWorldPostion[2],this._vertices[G++]=ShurikenParticleData.simulationWorldRotation[0],this._vertices[G++]=ShurikenParticleData.simulationWorldRotation[1],this._vertices[G++]=ShurikenParticleData.simulationWorldRotation[2],this._vertices[G++]=ShurikenParticleData.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=i,!0},t.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),0<this._firstFreeElement&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},t._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0)},t._render=function(e){var t=0,n=WebGL.mainContext;this._firstActiveElement<this._firstFreeElement?(t=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,n.drawElements(4,t,5123,2*this._firstActiveElement*this._indexStride),Stat.trianglesFaces+=t/3,Stat.drawCall++):(t=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,n.drawElements(4,t,5123,2*this._firstActiveElement*this._indexStride),Stat.trianglesFaces+=t/3,Stat.drawCall++,0<this._firstFreeElement&&(t=this._firstFreeElement*this._indexStride,n.drawElements(4,t,5123,0),Stat.trianglesFaces+=t/3,Stat.drawCall++))},t.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,t=this._randomSeeds.length;e<t;e++)this._randomSeeds[e]=this.randomSeed[0]+Y._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=Stat.loopCount,this.event("played")},t.pause=function(){this._isPaused=!0,this.event("paused")},t.simulate=function(e,t){void 0===t&&(t=!0),this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()},t.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0,this.event("stopped")},t.cloneTo=function(e){var t=e;t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.maxParticles=this.maxParticles,this._emission&&(t._emission=this._emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t._getVertexBuffers=function(){return null},__getset(0,t,"_originalBoundingBoxCorners",function(){return this._boundingBoxCorners}),__getset(0,t,"_originalBoundingBox",function(){return this._boundingBox}),__getset(0,t,"_originalBoundingSphere",function(){return this._boundingSphere}),__getset(0,t,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(e){var t=this._ownerRender;if(e){var n=e.frame,i=n.type;if(e.enable)switch(i){case 1:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1==i||3==i){t._setShaderValueInt(48,e.cycles);var r=e.tiles,a=this._uvLength.elements;a[0]=1/r.x,a[1]=1/r.y,t._setShaderValueVector2(49,this._uvLength)}switch(i){case 1:t._setShaderValueBuffer(50,n.frameOverTimeData._elements);break;case 3:t._setShaderValueBuffer(50,n.frameOverTimeDataMin._elements),t._setShaderValueBuffer(51,n.frameOverTimeDataMax._elements)}}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),t._setShaderValueInt(48,void 0),t._setShaderValueVector2(49,null),t._setShaderValueBuffer(50,null),t._setShaderValueBuffer(51,null);this._textureSheetAnimation=e}),__getset(0,t,"colorOverLifetime",function(){return this._colorOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.color;if(e.enbale)switch(n.type){case 1:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var i=n.gradient;t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements);break;case 3:var r=n.gradientMin,a=n.gradientMax;t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements)}}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements),t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements);this._colorOverLifetime=e}),__getset(0,t,"_vertexBufferCount",function(){return 1}),__getset(0,t,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.angularVelocity;if(!n)return;var i=n.separateAxes,r=n.type;if(e.enbale)switch(i?t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:i?t._setShaderValueColor(35,n.constantSeparate):t._setShaderValueNumber(34,n.constant);break;case 1:i?(t._setShaderValueBuffer(37,n.gradientX._elements),t._setShaderValueBuffer(38,n.gradientY._elements),t._setShaderValueBuffer(39,n.gradientZ._elements),t._setShaderValueBuffer(40,n.gradientW._elements)):t._setShaderValueBuffer(36,n.gradient._elements);break;case 2:i?(t._setShaderValueColor(35,n.constantMinSeparate),t._setShaderValueColor(42,n.constantMaxSeparate)):(t._setShaderValueNumber(34,n.constantMin),t._setShaderValueNumber(41,n.constantMax));break;case 3:i?(t._setShaderValueBuffer(37,n.gradientXMin._elements),t._setShaderValueBuffer(44,n.gradientXMax._elements),t._setShaderValueBuffer(38,n.gradientYMin._elements),t._setShaderValueBuffer(45,n.gradientYMax._elements),t._setShaderValueBuffer(39,n.gradientZMin._elements),t._setShaderValueBuffer(46,n.gradientZMax._elements),t._setShaderValueBuffer(40,n.gradientWMin._elements),t._setShaderValueBuffer(47,n.gradientWMax._elements)):(t._setShaderValueBuffer(36,n.gradientMin._elements),t._setShaderValueBuffer(43,n.gradientMax._elements))}}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),t._setShaderValueColor(35,null),t._setShaderValueColor(42,null),t._setShaderValueNumber(34,void 0),t._setShaderValueNumber(41,void 0),t._setShaderValueBuffer(37,null),t._setShaderValueBuffer(44,null),t._setShaderValueBuffer(38,null),t._setShaderValueBuffer(45,null),t._setShaderValueBuffer(39,null),t._setShaderValueBuffer(46,null),t._setShaderValueBuffer(40,null),t._setShaderValueBuffer(47,null),t._setShaderValueBuffer(36,null),t._setShaderValueBuffer(43,null);this._rotationOverLifetime=e}),__getset(0,t,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax},function(e){if(3==this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=this._startLifeTimeGradientMin.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}),__getset(0,t,"isPaused",function(){return this._isPaused}),__getset(0,t,"startLifetimeType",function(){return this._startLifetimeType},function(e){var t=0,n=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,n=i.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var r=r;for(t=0,n=r.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(t));var a=a;for(t=0,n=a.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}),__getset(0,t,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax},function(e){2==this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}),__getset(0,t,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),__getset(0,t,"startLifeTimeGradient",function(){return this._startLifeTimeGradient},function(e){if(1==this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}),__getset(0,t,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin},function(e){if(3==this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,n=this._startLifeTimeGradientMax.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}),__getset(0,t,"isAlive",function(){return!!(this._isPlaying||0<this.aliveParticleCount)}),__getset(0,t,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.size,i=n.separateAxes,r=n.type;if(e.enbale)switch(r){case 0:i?t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:i?(t._setShaderValueBuffer(27,n.gradientX._elements),t._setShaderValueBuffer(28,n.gradientY._elements),t._setShaderValueBuffer(29,n.gradientZ._elements)):t._setShaderValueBuffer(26,n.gradient._elements);break;case 2:i?(t._setShaderValueBuffer(27,n.gradientXMin._elements),t._setShaderValueBuffer(31,n.gradientXMax._elements),t._setShaderValueBuffer(28,n.gradientYMin._elements),t._setShaderValueBuffer(32,n.gradientYMax._elements),t._setShaderValueBuffer(29,n.gradientZMin._elements),t._setShaderValueBuffer(33,n.gradientZMax._elements)):(t._setShaderValueBuffer(26,n.gradientMin._elements),t._setShaderValueBuffer(30,n.gradientMax._elements))}}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),t._setShaderValueBuffer(27,null),t._setShaderValueBuffer(31,null),t._setShaderValueBuffer(28,null),t._setShaderValueBuffer(32,null),t._setShaderValueBuffer(29,null),t._setShaderValueBuffer(33,null),t._setShaderValueBuffer(26,null),t._setShaderValueBuffer(30,null);this._sizeOverLifetime=e}),__getset(0,t,"isPlaying",function(){return this._isPlaying}),__getset(0,t,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.velocity,i=n.type;if(e.enbale)switch(i){case 0:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:t._setShaderValueColor(13,n.constant);break;case 1:t._setShaderValueBuffer(14,n.gradientX._elements),t._setShaderValueBuffer(15,n.gradientY._elements),t._setShaderValueBuffer(16,n.gradientZ._elements);break;case 2:t._setShaderValueColor(13,n.constantMin),t._setShaderValueColor(17,n.constantMax);break;case 3:t._setShaderValueBuffer(14,n.gradientXMin._elements),t._setShaderValueBuffer(18,n.gradientXMax._elements),t._setShaderValueBuffer(15,n.gradientYMin._elements),t._setShaderValueBuffer(19,n.gradientYMax._elements),t._setShaderValueBuffer(16,n.gradientZMin._elements),t._setShaderValueBuffer(20,n.gradientZMax._elements)}t._setShaderValueInt(21,e.space)}else t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),t._setShaderValueColor(13,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(16,null),t._setShaderValueColor(13,null),t._setShaderValueColor(17,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(18,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(19,null),t._setShaderValueBuffer(16,null),t._setShaderValueBuffer(20,null),t._setShaderValueInt(21,void 0);this._velocityOverLifetime=e}),__getset(0,t,"isEmitting",function(){return this._isEmitting}),__getset(0,t,"startLifetimeConstant",function(){return this._startLifetimeConstant},function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}),__getset(0,t,"triangleCount",function(){return this._indexBuffer?this._indexBuffer.indexCount/3:0}),__getset(0,t,"shape",function(){return this._shape},function(e){this._shape!=e&&(e&&e.enable?this._ownerRender._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SHAPE):this._ownerRender._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SHAPE),this._shape=e)}),__getset(0,t,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),__getset(0,t,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin},function(e){2==this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}),__getset(0,t,"emission",function(){return this._emission}),__getset(0,t,"maxParticles",function(){return this._bufferMaxParticles-1},function(e){var t=e+1;t!=this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._initBufferDatas())}),Y.halfKSqrtOf2=.71,__static(Y,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempVector34",function(){return this._tempVector34=new Vector3},"_tempVector35",function(){return this._tempVector35=new Vector3},"_tempVector36",function(){return this._tempVector36=new Vector3},"_tempVector37",function(){return this._tempVector37=new Vector3},"_tempVector38",function(){return this._tempVector38=new Vector3},"_tempVector39",function(){return this._tempVector39=new Vector3},"_tempPosition",function(){return this._tempPosition=new Vector3},"_tempDirection",function(){return this._tempDirection=new Vector3}]),Y}(GeometryFilter),GlitterRender=function(e){function t(e){t.__super.call(this,e)}__class(t,"laya.d3.core.GlitterRender",!1,BaseRender);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._renderUpdate=function(e){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var t=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,t);var n=this._owner.templet;return this._setShaderValueNumber(3,n.lifeTime),this._setShaderValueNumber(2,n._currentTime),!0},t}(),MeshRender=function(e){function t(e){t.__super.call(this,e),e.meshFilter.on("meshchanged",this,__bind(this,this._onMeshChanged))}__class(t,"laya.d3.core.MeshRender",!1,BaseRender);var n=t.prototype;return n._onMeshChanged=function(e,t,n){n.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:n.once("loaded",this,__bind(this,this._onMeshLoaed))},n._onMeshLoaed=function(e,t){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},n._calculateBoundingSphereByInitSphere=function(e){var t=NaN,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),o=Math.abs(i[2]);t=a<=r&&o<=r?r:o<=a?a:o,Vector3.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t},n._calculateBoundBoxByInitCorners=function(e){for(var t=this._owner.transform.worldMatrix,n=0;n<8;n++)Vector3.transformCoordinate(e[n],t,BaseRender._tempBoundBoxCorners[n]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox)},n._calculateBoundingSphere=function(){var e=this._owner.meshFilter.sharedMesh;null==e||null==e.boundingSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(e.boundingSphere)},n._calculateBoundingBox=function(){var e=this._owner.meshFilter.sharedMesh;null==e||null==e.boundingBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(e.boundingBoxCorners)},n._renderUpdate=function(e){var t=this._owner.transform;if(t){this._setShaderValueMatrix4x4(0,t.worldMatrix);var n=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,n)}else this._setShaderValueMatrix4x4(0,Matrix4x4.DEFAULT),this._setShaderValueMatrix4x4(1,e);return Laya3D.debugMode&&this._renderRenderableBoundBox(),!0},t}(),WaterRender=function(e){function t(e){t.__super.call(this,e)}__class(t,"laya.d3.water.WaterRender",!1,e);var n=t.prototype;return n._calculateBoundingSphere=function(){},n._calculateBoundingBox=function(){},n._destroy=function(){e.prototype._destroy.call(this)},t}(BaseRender),TerrainFilter=function(e){function _(e,t,n,i,r,a,o,s){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._boundingSphere=null,this._boundingBox=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,_.__super.call(this),this._owner=e,this._cameraPos=new Vector3,this._chunkOffsetX=t,this._chunkOffsetZ=n,this._gridSize=i,this._terrainHeightData=r,this._terrainHeightDataWidth=a,this._terrainHeightDataHeight=o,this._leafNum=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM),this._leafs=__newvec(this._leafNum),this._cameraCoordinateInverse=s;for(var l=0;l<this._leafNum;l++)this._leafs[l]=new TerrainLeaf;this.recreateResource()}__class(_,"laya.d3.terrain.TerrainFilter",!1,e);var t=_.prototype;return Laya.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._destroy=function(){e.prototype._destroy.call(this),this._owner=null,this._vertexBuffer&&this._vertexBuffer.destroy(),this._indexBuffer&&this._indexBuffer.destroy()},t.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;var e=TerrainLeaf.LEAF_VERTEXT_COUNT,t=TerrainLeaf.LEAF_MAX_INDEX_COUNT;this._numberVertices=e*this._leafNum,this._maxNumberIndices=t*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices);var n=VertexPositionTerrain.vertexDeclaration,i=n.vertexStride/4,r=new Float32Array(this._numberVertices*i),a=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM,o=0,s=0,l=0;for(o=0;o<this._leafNum;o++)s=o%a,l=Math.floor(o/a),this._leafs[o].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,s*TerrainLeaf.LEAF_GRID_NUM,l*TerrainLeaf.LEAF_GRID_NUM,this._gridSize,r,o*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT,i,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(o=0;o<this._leafNum;o++)s=o%a,l=Math.floor(o/a),this._leafs[o].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,s*TerrainLeaf.LEAF_GRID_NUM,l*TerrainLeaf.LEAF_GRID_NUM,this._gridSize,r,this._leafNum*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT+o*TerrainLeaf.LEAF_SKIRT_VERTEXT_COUNT,i,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new VertexBuffer3D(n,this._numberVertices,35044,!1),this._indexBuffer=new IndexBuffer3D("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(r),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.calcOriginalBoudingBoxAndSphere()},t.setLODLevel=function(e){if(4!=e.length)return!0;var t=(e[0]+1<<24)+(e[1]+1<<16)+(e[2]+1<<8)+(e[3]+1);return this._currentLOD!=t&&(this._currentLOD=t,!0)},t.assembleIndexInit=function(){this._currentNumberIndices=0;for(var e=this._numberTriangle=0,t=0;t<this._leafNum;t++){var n=TerrainLeaf.getPlaneLODIndex(t,0);this._indexArrayBuffer.set(n,e),e+=n.length;var i=TerrainLeaf.getSkirtLODIndex(t,0);this._indexArrayBuffer.set(i,e),e+=i.length,this._currentNumberIndices+=n.length+i.length}this._numberTriangle=this._currentNumberIndices/3},t.isNeedAssemble=function(e,t){var n=Math.min(e.viewport.width,e.viewport.height)/(2*Math.tan(Math.PI*e.fieldOfView/180));return this._perspectiveFactor!=n?(this._perspectiveFactor=n,1):this._LODTolerance!=Terrain.LOD_TOLERANCE_VALUE?(this._LODTolerance=Terrain.LOD_TOLERANCE_VALUE,1):0==Vector3.equals(t,this._cameraPos)?(this._cameraPos.x=t.x,this._cameraPos.y=t.y,this._cameraPos.z=t.z,2):0},t.assembleIndex=function(e,t){var n=this.isNeedAssemble(e,t);if(0<n){for(var i=0;i<this._leafNum;i++)_._TEMP_ARRAY_BUFFER[i]=this._leafs[i].determineLod(t,this._perspectiveFactor,Terrain.LOD_TOLERANCE_VALUE,1==n);if(this.setLODLevel(_._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0;var r=this._numberTriangle=0;for(i=0;i<this._leafNum;i++){var a=_._TEMP_ARRAY_BUFFER[i],o=TerrainLeaf.getPlaneLODIndex(i,a);this._indexArrayBuffer.set(o,r),r+=o.length;var s=TerrainLeaf.getSkirtLODIndex(i,a);this._indexArrayBuffer.set(s,r),r+=s.length,this._currentNumberIndices+=o.length+s.length}return this._numberTriangle=this._currentNumberIndices/3,!0}}return!1},t.calcOriginalBoudingBoxAndSphere=function(){for(var e=new Vector2(2147483647,-2147483647),t=0;t<this._leafNum;t++)e.x=this._leafs[t]._sizeOfY.x<e.x?this._leafs[t]._sizeOfY.x:e.x,e.y=this._leafs[t]._sizeOfY.y>e.y?this._leafs[t]._sizeOfY.y:e.y;var n=new Vector3(this._chunkOffsetX*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize,e.x,this._chunkOffsetZ*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize),i=new Vector3((this._chunkOffsetX+1)*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize,e.y,(this._chunkOffsetZ+1)*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize);TerrainLeaf.__ADAPT_MATRIX__&&(Vector3.transformV3ToV3(n,TerrainLeaf.__ADAPT_MATRIX__,n),Vector3.transformV3ToV3(i,TerrainLeaf.__ADAPT_MATRIX__,i)),this._boundingBox=new BoundBox(n,i);var r=new Vector3;Vector3.subtract(i,n,r),Vector3.scale(r,.5,r);var a=new Vector3;Vector3.add(n,r,a),this._boundingSphere=new BoundSphere(a,Vector3.scalarLength(r)),this._boundingBoxCorners=__newvec(8,null),this._boundingBox.getCorners(this._boundingBoxCorners)},t.calcLeafBoudingBox=function(e){for(var t=0;t<this._leafNum;t++)this._leafs[t].calcLeafBoudingBox(e)},t.calcLeafBoudingSphere=function(e,t){for(var n=0;n<this._leafNum;n++)this._leafs[n].calcLeafBoudingSphere(e,t)},t._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._beforeRender=function(e){if(this._vertexBuffer._bind(),this._indexBuffer._bind(),0==e.renderElement._material.blend){var t=e.camera;this.assembleIndex(t,t.position)&&this._indexBuffer.setData(this._indexArrayBuffer)}return!0},t._getVertexBuffers=function(){return null},t._render=function(e){WebGL.mainContext.drawElements(Terrain.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),Stat.trianglesFaces+=this._numberTriangle,Stat.drawCall++},__getset(0,t,"_vertexBufferCount",function(){return this._numberVertices}),__getset(0,t,"triangleCount",function(){return this._numberTriangle}),__getset(0,t,"_originalBoundingBox",function(){return this._boundingBox}),__getset(0,t,"_originalBoundingSphere",function(){return this._boundingSphere}),__static(_,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM)}]),_}(GeometryFilter),TerrainRender=function(e){function t(e){this._terrainSprite3DOwner=null,t.__super.call(this,e),this._terrainSprite3DOwner=e}__class(t,"laya.d3.terrain.TerrainRender",!1,e);var n=t.prototype;return n._calculateBoundingSphere=function(){var e=this._terrainSprite3DOwner.terrainFilter;if(null==e)this._boundingSphere.toDefault();else{var t=e._originalBoundingSphere,n=NaN,i=this._terrainSprite3DOwner.transform,r=i.scale;n=r.x>=r.y&&r.x>=r.z?r.x:r.y>=r.z?r.y:r.z,Vector3.transformCoordinate(t.center,i.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*n,e.calcLeafBoudingSphere(i.worldMatrix,n)}},n._calculateBoundingBox=function(){var e=this._terrainSprite3DOwner.terrainFilter;if(null==e)this._boundingBox.toDefault();else{for(var t=this._terrainSprite3DOwner.transform.worldMatrix,n=e._boundingBoxCorners,i=0;i<8;i++)Vector3.transformCoordinate(n[i],t,BaseRender._tempBoundBoxCorners[i]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox),e.calcLeafBoudingBox(t)}},n._renderUpdate=function(e){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var t=this._owner.getProjectionViewWorldMatrix(e);return this._setShaderValueMatrix4x4(1,t),!0},n._destroy=function(){e.prototype._destroy.call(this),this._terrainSprite3DOwner=null},t}(BaseRender),GlitterTemplet=function(e){function t(e){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.lifeTime=NaN,this.minSegmentDistance=NaN,this.minInterpDistance=NaN,this.maxSlerpCount=0,this._maxSegments=0,t.__super.call(this),this._tempVector0=new Vector3,this._tempVector1=new Vector3,this._tempVector2=new Vector3,this._tempVector3=new Vector3,this._posModeLastPosition0=new Vector3,this._posModeLastPosition1=new Vector3,this._posModePosition0=new Vector3,this._posModePosition1=new Vector3,this._posVelModePosition0=new Vector3,this._posVelModeVelocity0=new Vector3,this._posVelModePosition1=new Vector3,this._posVelModeVelocity1=new Vector3,this._owner=e,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new Vector3,this._lastPatchAddPos1=new Vector3,this.scLeft=new SplineCurvePositionVelocity,this.scRight=new SplineCurvePositionVelocity,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this._maxSegments=200,this._owner.on("activeinhierarchychanged",this,__bind(this,this._onActiveHierarchyChanged))}__class(t,"laya.d3.resource.tempelet.GlitterTemplet",!1,e);var n=t.prototype;return Laya.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer:null},n._getIndexBuffer=function(){return null},n._initialize=function(){this._vertexBuffer=VertexBuffer3D.create(VertexGlitter.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},n._onActiveHierarchyChanged=function(e){e||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},n._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),0<this._firstFreeElement&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},n._updateSubTextureCoordinates=function(e,t){for(var n=2*e,i=0;i<t;i+=2){var r=n+i,a=r*this._floatCountPerVertex,o=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[o+3]=(this._vertices[a+5]-this._currentTime)/this.lifeTime}},n._retireActiveGlitter=function(){for(var e=this.lifeTime,t=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var n=this._firstActiveElement*t+5;if(this._currentTime-this._vertices[n]<e)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},n._freeRetiredGlitter=function(){for(var e=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement;){if(this._drawCounter-this._vertices[this._firstRetiredElement*e+5]<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)}},n._calcVelocity=function(e,t,n){Vector3.subtract(e,t,n),Vector3.scale(n,.5,n)},n._addNewGlitterSegementToVertexBuffer=function(){var e=0;this._firstActiveElement<this._firstFreeElement?(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),0<this._firstFreeElement&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},n._addGlitter=function(e,t,n){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var i=this._firstFreeElement+1;i>=this.maxSegments&&(i=0,e.cloneTo(this._lastPatchAddPos0),t.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=n,this._needPatch=!0),i==this._firstRetiredElement&&console.log("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=e.elements,a=t.elements,o=0,s=this._firstFreeElement*this._floatCountPerVertex*2;for(o=0;o<3;o++)this._vertices[s+o]=r[o];this._vertices[s+3]=0,this._vertices[s+4]=0,this._vertices[s+5]=n;var l=s+this._floatCountPerVertex;for(o=0;o<3;o++)this._vertices[l+o]=a[o];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=n,this._firstFreeElement=i},n._update=function(e){this._currentTime+=e/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},n._beforeRender=function(e){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer.bindWithIndexBuffer(null),!0)},n._render=function(e){var t=0,n=WebGL.mainContext;this._firstActiveElement<this._firstFreeElement?(t=2*(this._firstFreeElement-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),Stat.trianglesFaces+=t-2,Stat.drawCall++):(t=2*(this.maxSegments-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,t),Stat.trianglesFaces+=t-2,Stat.drawCall++,0<this._firstFreeElement&&(t=2*this._firstFreeElement,n.drawArrays(5,0,t),Stat.trianglesFaces+=t-2,Stat.drawCall++))},n.addVertexPosition=function(e,t){if(this._owner.activeInHierarchy)if(this._numPositionMode<2)0==this._numPositionMode?(e.cloneTo(this._posModeLastPosition0),t.cloneTo(this._posModeLastPosition1)):(e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var n=this._tempVector2;this._calcVelocity(e,this._posModeLastPosition0,n);var i=this._tempVector3;this._calcVelocity(t,this._posModeLastPosition1,i),this.addVertexPositionVelocity(this._posModePosition0,n,this._posModePosition1,i),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)}},n.addVertexPositionVelocity=function(e,t,n,i){if(this._owner.activeInHierarchy){if(0==this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;Vector3.subtract(e,this._posVelModePosition0,r);var a=Vector3.scalarLength(r);Vector3.subtract(n,this._posVelModePosition1,r);var o=Vector3.scalarLength(r),s=0,l=l;if(a<l&&o<l)return;if(1==(s=1+Math.floor(Math.max(a,o)/this.minInterpDistance)))this._addGlitter(e,n,this._currentTime);else{s=Math.min(s,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,e,t),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,n,i);for(var _=1/s,h=_,c=this._currentTime-this._lastTime,u=1;u<=s;u++){var d=this._tempVector0;this.scLeft.Slerp(h,d);var f=this._tempVector1;this.scRight.Slerp(h,f);var m=this._lastTime+c*u/s;this._addGlitter(d,f,m),h+=_}}}this._lastTime=this._currentTime,e.cloneTo(this._posVelModePosition0),t.cloneTo(this._posVelModeVelocity0),n.cloneTo(this._posVelModePosition1),i.cloneTo(this._posVelModeVelocity1)}},n._destroy=function(){e.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._vertices=null,this._vertexBuffer.destroy(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null},n._getVertexBuffers=function(){return null},__getset(0,n,"_originalBoundingSphere",function(){return Laya.superGet(GeometryFilter,this,"_originalBoundingSphere")}),__getset(0,n,"_originalBoundingBox",function(){return Laya.superGet(GeometryFilter,this,"_originalBoundingBox")}),__getset(0,n,"triangleCount",function(){var e=0;return this._firstActiveElement<this._firstFreeElement?e=2*(this._firstFreeElement-this._firstActiveElement)-2:(e=2*(this.maxSegments-this._firstActiveElement)-2,e+=2*this._firstFreeElement-2),e}),__getset(0,n,"_vertexBufferCount",function(){return 1}),__getset(0,n,"maxSegments",function(){return this._maxSegments-1},function(e){var t=e+1;t!=this._maxSegments&&(this._maxSegments=t,this._vertexBuffer&&this._vertexBuffer.destroy(),this._initialize())}),t}(GeometryFilter),Animator=function(n){function h(){h.__super.call(this),this._clipNames=[],this._clips=[],this._playStartFrames=[],this._playEndFrames=[],this._cacheNodesSpriteOwners=[],this._cacheNodesAvatarOwners=[],this._cacheNodesDefaultlValues=[],this._cacheNodesToSpriteMap=[],this._cacheSpriteToNodesMap=[],this._cacheFullFrames=[],this._publicClipsDatas=[],this._playEventIndex=-1,this._updateTransformPropertyLoopCount=-1,this._lastFrameIndex=-1,this._defaultClipIndex=-1,this._cachePlayRate=1,this._currentPlayClip=null,this._currentFrameIndex=-1,this._currentTime=0,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this.isCache=!0,this.cacheFrameRate=60,this.playbackRate=1,this.playOnWake=!0}__class(h,"laya.d3.component.Animator",!1,n);var e=h.prototype;return Laya.imps(e,{"laya.resource.IDestroy":!0}),e._getAvatarOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesAvatarOwners[e];i.length=n;var r=this._cacheNodesDefaultlValues[e];r.length=n;for(var a=0;a<n;a++){for(var o=this._avatarNodes[0],s=t[a],l=s.path,_=0,h=l.length;_<h;_++){var c=l[_];if(""==c)break;if(!(o=o.getChildByName(c)))break}if(o){i[a]=o;var u=AnimationNode._propertyGetFuncs[s.propertyNameID](o);if(u){var d=new Float32Array(s.keyFrameWidth);for(r[a]=d,_=0,h=u.length;_<h;_++)d[_]=u[_]}}}},e._handleSpriteOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesSpriteOwners[e];i.length=n;var r=this._cacheNodesDefaultlValues[e];r.length=n;for(var a=0;a<n;a++){var o=this._owner,s=t[a],l=s.path,_=0,h=0;for(_=0,h=l.length;_<h;_++){var c=l[_];if(""==c)break;if(!(o=o.getChildByName(c)))break}if(o){i[a]=o;var u=AnimationNode._propertyGetFuncs[s.propertyNameID](null,o);if(u){var d=new Float32Array(s.keyFrameWidth);for(r[a]=d,_=0,h=u.length;_<h;_++)d[_]=u[_]}}}},e._offClipAndAvatarRelateEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,__bind(this,this._getAvatarOwnersByClip)):e.off("loaded",this,__bind(this,this._getAvatarOwnersAndInitDatasAsync))},e._getAvatarOwnersByClipAsync=function(e,t){t.loaded?this._getAvatarOwnersByClip(e):t.once("loaded",this,__bind(this,this._getAvatarOwnersByClip),[e])},e._offGetSpriteOwnersByClipAsyncEvent=function(e){e.loaded||e.off("loaded",this,__bind(this,this._getSpriteOwnersByClipAsync))},e._getSpriteOwnersByClipAsync=function(e,t){t.loaded?this._handleSpriteOwnersByClip(e):t.once("loaded",this,__bind(this,this._handleSpriteOwnersByClip),[e])},e._getAvatarOwnersAndInitDatasAsync=function(){for(var e=0,t=this._clips.length;e<t;e++)this._getAvatarOwnersByClipAsync(e,this._clips[e]);for(this._avatar._cloneDatasToAnimator(this),e=0,t=this._avatarNodes.length;e<t;e++)this._checkAnimationNode(this._avatarNodes[e],this._owner)},e._offGetClipCacheFullKeyframeIndicesEvent=function(e){e.loaded||e.off("loaded",this,__bind(this,this._computeCacheFullKeyframeIndices))},e._computeCacheFullKeyframeIndices=function(e){var t=this._clips[e],n=this._cacheFrameRateInterval*this._cachePlayRate,i=t._getFullKeyframeIndicesWithCache(n);if(i)this._cacheFullFrames[e]=i;else{i=this._cacheFullFrames[e]=[];var r=t._nodes,a=r.length;i.length=a;for(var o=Math.ceil(t._duration/n-1e-5)+1,s=0;s<a;s++){var l=r[s],_=new Int32Array(o);_.fill(-1);for(var h=l.keyFrames,c=0,u=h.length;c<u;c++)for(var d=h[c],f=d.startTime,m=f+d.duration;f<=m;){_[Math.ceil(f/n-1e-5)]=c,f+=n}i[s]=_}t._cacheFullKeyframeIndices(n,i)}},e._updateAnimtionPlayer=function(){this._updatePlayer(Laya.timer.delta/1e3)},e._onOwnerActiveHierarchyChanged=function(){this._owner.activeInHierarchy?(Laya.timer.frameLoop(1,this,__bind(this,this._updateAnimtionPlayer)),this.playOnWake&&this.clip&&this.play()):(0!=this.playState&&(this._stoped=!0),Laya.timer.clear(this,__bind(this,this._updateAnimtionPlayer)))},e._eventScript=function(e,t){for(var n=this._currentPlayClip._animationEvents,i=n.length;this._playEventIndex<i;this._playEventIndex++){var r=n[this._playEventIndex],a=r.time;if(!(e<=a&&a<t))break;for(var o=this._owner._scripts,s=0,l=o.length;s<l;s++){var _=o[s],h=_[r.eventName];h&&h.apply(_,r.params)}}},e._setPlayParams=function(e,t){var n=this._currentTime;this._currentTime=e,this._currentFrameIndex=Math.max(Math.floor(this.currentPlayTime/t-1e-5),0),this._currentFrameTime=this._currentFrameIndex*t,this._eventScript(n,e)},e._setPlayParamsWhenStop=function(e,t){var n=this._currentTime;this._currentTime=e,this._currentFrameIndex=Math.max(Math.floor(e/t-1e-5),0),this._currentFrameTime=this._currentFrameIndex*t,this._eventScript(n,e),this._currentPlayClip=null},e._revertKeyframeNodes=function(e,t){var n=this._cacheNodesDefaultlValues[t],i=e._nodes;if(this._avatar)for(var r=this._cacheNodesAvatarOwners[t],a=0,o=r.length;a<o;a++){var s=r[a];s&&AnimationNode._propertySetFuncs[i[a].propertyNameID](s,null,n[a])}else{var l=this._cacheNodesSpriteOwners[t];for(a=0,o=l.length;a<o;a++){var _=l[a];_&&AnimationNode._propertySetFuncs[i[a].propertyNameID](null,_,n[a])}}},e._onAnimationStop=function(){var e,t,n,i=0,r=0;this._lastFrameIndex=-1;var a=this._currentPlayClip._nodes;if(this._avatar){var o=this._cacheNodesAvatarOwners[this._currentPlayClipIndex];for(i=0,r=o.length;i<r;i++){var s=o[i];n=(t=(e=a[i]).keyFrames)[t.length-1].data,s&&AnimationNode._propertySetFuncs[e.propertyNameID](s,null,n)}}else{var l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];for(i=0,r=l.length;i<r;i++){var _=l[i];n=(t=(e=a[i]).keyFrames)[t.length-1].data,_&&AnimationNode._propertySetFuncs[e.propertyNameID](null,_,n)}}},e._setAnimationClipPropertyToAnimationNode=function(e,t,n){for(var i=0,r=t.length;i<r;i++){var a=t[i],o=e[a];if(o){var s=this._currentPlayClip._nodes[a],l=n[a];l&&AnimationNode._propertySetFuncs[s.propertyNameID](o,null,l)}}},e._setAnimationClipPropertyToSprite3D=function(e,t){for(var n=0,i=e.length;n<i;n++){var r=e[n];if(r){var a=this._currentPlayClip._nodes[n],o=t[n];o&&AnimationNode._propertySetFuncs[a.propertyNameID](null,r,o)}}},e._handleSpriteOwnersBySprite=function(e,t,n,i){var r=this._clips[e],a=n.join("/"),o=r._nodesMap[a];if(o)for(var s=this._cacheNodesSpriteOwners[e],l=r._nodes,_=this._cacheNodesDefaultlValues[e],h=0,c=o.length;h<c;h++){var u=o[h],d=l.indexOf(u);if(t){s[d]=i;var f=AnimationNode._propertyGetFuncs[u.propertyNameID](null,i);if(f){var m=_[d];m||(_[d]=m=new Float32Array(u.keyFrameWidth));for(var p=0,g=f.length;p<g;p++)m[p]=f[p]}}else s[d]=null}},e._evaluateAvatarNodesCacheMode=function(e,t,n,i,r){t._evaluateAnimationlDatasCacheMode(e,this._cacheFullFrames[this._currentPlayClipIndex],this,n,r),this._setAnimationClipPropertyToAnimationNode(e,r,n);for(var a=0,o=this._avatarNodes.length;a<o;a++){var s=this._avatarNodes[a].transform;if(s._worldUpdate){var l=new Float32Array(16);i[a]=l,s._setWorldMatrixAndUpdate(l)}else{var _=s.getWorldMatrix();i[a]=_||h.deafaultMatrix}}},e._evaluateAvatarNodesRealTime=function(e,t,n,i,r){t._evaluateAnimationlDatasRealTime(e,this.currentPlayTime,n,r),this._setAnimationClipPropertyToAnimationNode(e,r,n);for(var a=0,o=this._avatarNodes.length;a<o;a++){var s=this._avatarNodes[a].transform;s._worldUpdate?s._setWorldMatrixNoUpdate(i[a]):i[a]=h.deafaultMatrix}},e._updateAvatarNodesToSpriteCacheMode=function(e,t){for(var n=0,i=this._cacheSpriteToNodesMap.length;n<i;n++){var r=this._cacheSpriteToNodesMap[n],a=t[r];if(a!=h.deafaultMatrix){var o=this._avatarNodes[r].transform._entity,s=o.worldMatrix;Utils3D.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,a,s),o.worldMatrix=s}}},e._updateAvatarNodesToSpriteRealTime=function(){for(var e=0,t=this._cacheSpriteToNodesMap.length;e<t;e++){var n=this._avatarNodes[this._cacheSpriteToNodesMap[e]],i=n.transform._entity,r=n.transform;if(r._worldUpdate){var a=h._tempMatrix4x40;r._setWorldMatrixAndUpdate(a);var o=i.worldMatrix;Utils3D.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,a,o),i.worldMatrix=o}}},e._updatePlayer=function(e){if(null!=this._currentPlayClip&&!this._stoped&&this._currentPlayClip.loaded){var t=this._cacheFrameRateInterval*this._cachePlayRate,n=0;this._startUpdateLoopCount!=Stat.loopCount&&(n=e*this.playbackRate,this._elapsedPlaybackTime+=n);var i=this._currentPlayClip._frameRate,r=this._playStartFrames[this._currentPlayClipIndex]/i,a=Math.min(this._playEndFrames[this._currentPlayClipIndex]/i,this._currentPlayClip._duration)-r;if(!this._currentPlayClip.islooping&&this._elapsedPlaybackTime>=a)return this._onAnimationStop(),this._setPlayParamsWhenStop(a,t),void this.event("stopped");if(n+=this._currentTime,0<a)if(a<=n)for(;(n-=a)<a&&(this._setPlayParams(n,t),this.event("complete")),this._playEventIndex=0,this._eventScript(0,n),a<=n;);else this._setPlayParams(n,t);else this._currentTime=this._currentFrameTime=this._currentFrameIndex=this._playEventIndex=0,this.event("complete")}},e._update=function(e){var t=this._currentPlayClip;if(2==this.playState&&t&&t.loaded){var n=this.playbackRate*Laya.timer.scale,i=this._cachePlayRate;this._canCache=this.isCache&&i<=n;var r,a=-1;if(this._canCache){if(a=this._currentFrameIndex,this._lastFrameIndex==a)return;if(r=t._getAnimationDataWithCache(i,a),this._avatar){var o=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],s=t._cachePropertyMap,l=s.length;0<l&&(r||((r=[]).length=l,t._cacheAnimationData(i,a,r),t._evaluateAnimationlDatasCacheMode(o,this._cacheFullFrames[this._currentPlayClipIndex],this,r,s)),this._setAnimationClipPropertyToAnimationNode(o,s,r)),this._curAvatarNodeDatas=t._getAvatarDataWithCache(this._avatar,this._cachePlayRate,a),this._curAvatarNodeDatas||(this._curAvatarNodeDatas=[],this._curAvatarNodeDatas.length=this._avatarNodes.length,t._cacheAvatarData(this._avatar,this._cachePlayRate,a,this._curAvatarNodeDatas),this._evaluateAvatarNodesCacheMode(o,t,t._publicClipDatas,this._curAvatarNodeDatas,t._unCachePropertyMap)),this._updateAvatarNodesToSpriteCacheMode(t,this._curAvatarNodeDatas)}else{var _=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];r||((r=[]).length=this._currentPlayClip._nodes.length,t._evaluateAnimationlDatasCacheMode(_,this._cacheFullFrames[this._currentPlayClipIndex],this,r,null),t._cacheAnimationData(i,a,r)),this._setAnimationClipPropertyToSprite3D(_,r)}}else if(r=t._publicClipDatas,this._avatar){if(t._evaluateAnimationlDatasRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],this.currentPlayTime,r,t._cachePropertyMap),!this._publicAvatarNodeDatas){this._publicAvatarNodeDatas=[];var h=this._avatarNodes.length;this._publicAvatarNodeDatas.length=h;for(var c=1;c<h;c++)this._publicAvatarNodeDatas[c]=new Float32Array(16)}this._curAvatarNodeDatas=this._publicAvatarNodeDatas,this._evaluateAvatarNodesRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],t,r,this._curAvatarNodeDatas,t._unCachePropertyMap),this._updateAvatarNodesToSpriteRealTime()}else t._evaluateAnimationlDatasRealTime(this._cacheNodesSpriteOwners[this._currentPlayClipIndex],this.currentPlayTime,r,null);this._lastFrameIndex=a}},e._checkAnimationNode=function(e,t){e.name!=t.name||t._transform.dummy||t._isLinkSpriteToAnimationNode(this,e,!0);for(var n=0,i=t._childs.length;n<i;n++)this._checkAnimationNode(e,t.getChildAt(n))},e._load=function(e){e.activeInHierarchy&&Laya.timer.frameLoop(1,this,__bind(this,this._updateAnimtionPlayer)),this._owner.on("activeinhierarchychanged",this,__bind(this,this._onOwnerActiveHierarchyChanged))},e._unload=function(e){n.prototype._unload.call(this,e),e.activeInHierarchy&&Laya.timer.clear(this,__bind(this,this._updateAnimtionPlayer)),this._owner.off("activeinhierarchychanged",this,__bind(this,this._onOwnerActiveHierarchyChanged)),this._curAvatarNodeDatas=null},e._destroy=function(){n.prototype._destroy.call(this);for(var e=0,t=this._clips.length;e<t;e++)this._clips[e]._removeReference();this._currentPlayClip=null,this._clipNames=null,this._cacheNodesSpriteOwners=null,this._cacheNodesAvatarOwners=null,this._cacheNodesDefaultlValues=null,this._clips=null,this._cacheFullFrames=null},e._cloneTo=function(e){var t=e;t.avatar=this.avatar;this._clips.length;for(var n=0,i=this._clips.length;n<i;n++)t.addClip(this._clips[n]);this.clip&&(t.clip=this.clip)},e.addClip=function(e,t,n,i){void 0===n&&(n=0),void 0===i&&(i=4294967295),t=t||e.name;var r=this._clipNames.indexOf(t);if(-1!=r){if(this._clips[r]!=e)throw new Error("Animation:this playName has exist with another clip.")}else{var a=this._clips.indexOf(e);if(n<0||i<0)throw new Error("Animator:startFrame and endFrame must large than zero.");if(i<n)throw new Error("Animator:startFrame must less than endFrame.");this._clipNames.push(t),this._clips.push(e),this._playStartFrames.push(n),this._playEndFrames.push(i),this._cacheNodesSpriteOwners.push([]),this._cacheNodesAvatarOwners.push([]),this._cacheNodesDefaultlValues.push([]),this._publicClipsDatas.push([]),e._addReference(),a=this._clips.length-1,this._avatar?this._avatar.loaded?this._getAvatarOwnersByClipAsync(a,e):this._avatar.once("loaded",this,__bind(this,this._getAvatarOwnersByClipAsync),[a,e]):this._getSpriteOwnersByClipAsync(a,e),e.loaded?this._computeCacheFullKeyframeIndices(a):e.once("loaded",this,__bind(this,this._computeCacheFullKeyframeIndices),[a])}},e.removeClip=function(e){var t=this._clips.indexOf(e);-1!=t&&(this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,e):this._offGetSpriteOwnersByClipAsyncEvent(e),this._offGetClipCacheFullKeyframeIndicesEvent(e),this._clipNames.splice(t,1),this._clips.splice(t,1),this._playStartFrames.splice(t,1),this._playEndFrames.splice(t,1),this._cacheNodesSpriteOwners.splice(t,1),this._cacheNodesAvatarOwners.splice(t,1),this._cacheNodesDefaultlValues.splice(t,1),this._publicClipsDatas.splice(t,1),e._removeReference())},e.removeClipByName=function(e){var t=this._clipNames.indexOf(e);if(-1!=t){var n=this._clips[t];this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,n):this._offGetSpriteOwnersByClipAsyncEvent(n),this._offGetClipCacheFullKeyframeIndicesEvent(n),this._clipNames.splice(t,1),this._clips.splice(t,1),this._playStartFrames.splice(t,1),this._playEndFrames.splice(t,1),this._cacheNodesSpriteOwners.splice(t,1),this._cacheNodesAvatarOwners.splice(t,1),this._cacheNodesDefaultlValues.splice(t,1),this._publicClipsDatas.splice(t,1)}},e.getClip=function(e){var t=this._clipNames.indexOf(e);return-1!=t?this._clips[t]:null},e.getClipCount=function(){return this._clips.length},e.play=function(e,t){if(void 0===t&&(t=1),!e&&-1==this._defaultClipIndex)throw new Error("Animator:must have  default clip value,please set clip property.");this._currentPlayClip=e?(this._currentPlayClipIndex=this._clipNames.indexOf(e),this._clips[this._currentPlayClipIndex]):(this._currentPlayClipIndex=this._defaultClipIndex,this._clips[this._defaultClipIndex]),this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this._playEventIndex=0,this.playbackRate=t,this._stoped=!1,this._currentFrameIndex=0,this._startUpdateLoopCount=Stat.loopCount,this._lastPlayAnimationClip&&this._lastPlayAnimationClip!=this._currentPlayClip&&this._revertKeyframeNodes(this._lastPlayAnimationClip,this._lastPlayAnimationClipIndex),this._updatePlayer(0),this._lastPlayAnimationClip=this._currentPlayClip,this._lastPlayAnimationClipIndex=this._currentPlayClipIndex},e.stop=function(){0!=this.playState&&(this._stoped=!0,this.event("stopped"))},e.linkSprite3DToAvatarNode=function(e,t){if(this._avatar){var n=this._avatarNodeMap[e];return!!n&&(t._isLinkSpriteToAnimationNode(this,n,!0),!0)}return!1},e.unLinkSprite3DToAvatarNode=function(e){if(this._avatar){var t=e.transform.dummy;if(t){var n=this._avatarNodeMap[t._owner.name];return e._isLinkSpriteToAnimationNode(this,n,!1),!0}return!1}return!1},__getset(0,e,"playbackTime",null,function(e){if(null!=this._currentPlayClip&&this._currentPlayClip&&this._currentPlayClip.loaded){this._startUpdateLoopCount=Stat.loopCount;var t=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=e,this._currentFrameIndex=Math.floor(this.currentPlayTime/t),this._currentFrameTime=this._currentFrameIndex*t}}),__getset(0,e,"currentFrameTime",function(){return this._currentFrameTime}),__getset(0,e,"playState",function(){return null==this._currentPlayClip?0:this._stoped?0:2}),__getset(0,e,"currentPlayTime",function(){return this._currentTime+this._playStartFrames[this._currentPlayClipIndex]/this._currentPlayClip._frameRate}),__getset(0,e,"currentPlayClip",function(){return this._currentPlayClip}),__getset(0,e,"cachePlayRate",function(){return this._cachePlayRate},function(e){if(this._cachePlayRate!=e){this._cachePlayRate=e;for(var t=0,n=this._clips.length;t<n;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),__getset(0,e,"cacheFrameRate",function(){return this._cacheFrameRate},function(e){if(this._cacheFrameRate!=e){this._cacheFrameRate=e,this._cacheFrameRateInterval=1/this._cacheFrameRate;for(var t=0,n=this._clips.length;t<n;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),__getset(0,e,"paused",function(){return this._stoped},function(e){(this._stoped=e)&&this.event("paused")}),__getset(0,e,"clip",function(){return this._clips[this._defaultClipIndex]},function(e){var t=e?this._clips.indexOf(e):-1;this._defaultClipIndex!=t&&(-1!=this._defaultClipIndex&&this.removeClip(this._clips[this._defaultClipIndex]),-1!=t&&this.addClip(e,e.name),this._defaultClipIndex=t)}),__getset(0,e,"currentFrameIndex",function(){return this._currentFrameIndex}),__getset(0,e,"avatar",function(){return this._avatar},function(e){if(this._avatar!=e){var t=this._avatar;this._avatar=e;for(var n=this._clips.length,i=0;i<n;i++)this._offClipAndAvatarRelateEvent(t,this._clips[i]);e&&(e.loaded?this._getAvatarOwnersAndInitDatasAsync():e.once("loaded",this,__bind(this,this._getAvatarOwnersAndInitDatasAsync)))}}),__static(h,["deafaultMatrix",function(){return this.deafaultMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Float32Array(16)}]),h}(Component3D),AttachPoint=function(t){function e(){this._attachSkeleton=null,this._extenData=null,this.attachBones=null,this.matrixs=null,e.__super.call(this),this.attachBones=[],this.matrixs=[]}__class(e,"laya.d3.component.AttachPoint",!1,t);var n=e.prototype;return n._load=function(e){t.prototype._load.call(this,e),this._attachSkeleton=e.getComponentByType(SkinAnimations)},n._update=function(e){if(this._attachSkeleton&&!this._attachSkeleton.destroyed&&0!=this._attachSkeleton.player.state&&this._attachSkeleton.curBonesDatas){var t=this._attachSkeleton.player,n=this._attachSkeleton.templet;this.matrixs.length=this.attachBones.length;for(var i=this._attachSkeleton.curBonesDatas,r=this.owner.transform.worldMatrix,a=0,o=this.attachBones.length;a<o;a++){var s=16*n.getNodeIndexWithName(t.currentAnimationClipIndex,this.attachBones[a]),l=this.matrixs[a];l||(l=this.matrixs[a]=new Matrix4x4);for(var _=l.elements,h=0;h<16;h++)_[h]=i[s+h];Matrix4x4.multiply(r,l,l)}this.event("complete")}},e}(Component3D),KeyframeAnimations=function(t){function e(){this._player=null,this._templet=null,e.__super.call(this),this._player=new AnimationPlayer}__class(e,"laya.d3.component.animation.KeyframeAnimations",!1,t);var n=e.prototype;return n._updateAnimtionPlayer=function(){this._player._update(Laya.timer.delta)},n._addUpdatePlayerToTimer=function(){Laya.timer.frameLoop(1,this,__bind(this,this._updateAnimtionPlayer))},n._removeUpdatePlayerToTimer=function(){Laya.timer.clear(this,__bind(this,this._updateAnimtionPlayer))},n._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},n._load=function(e){e.activeInHierarchy&&this._addUpdatePlayerToTimer(),e.on("activeinhierarchychanged",this,__bind(this,this._onOwnerActiveHierarchyChanged))},n._unload=function(e){t.prototype._unload.call(this,e),e.activeInHierarchy&&this._removeUpdatePlayerToTimer(),e.off("activeinhierarchychanged",this,__bind(this,this._onOwnerActiveHierarchyChanged)),this._player._destroy(),this._player=null,this._templet=null},__getset(0,n,"nodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)}),__getset(0,n,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),__getset(0,n,"templet",function(){return this._templet},function(e){this._templet!=e&&(0!=this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),__getset(0,n,"player",function(){return this._player}),__getset(0,n,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),__getset(0,n,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=Laya.loader.create(e,null,null,AnimationTemplet);this._templet!=t&&(0!=this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this.event("animationchanged",this))}),e}(Component3D),Script=function(e){function t(){t.__super.call(this)}__class(t,"laya.d3.component.Script",!1,Component3D);var n=t.prototype;return n.onTriggerEnter=function(e){},n.onTriggerExit=function(e){},n.onTriggerStay=function(e){},__getset(0,n,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!1,t}(),Collider=function(e){function t(){t.__super.call(this),this._isRigidbody=!1,this._runtimeCollisonMap={},this._runtimeCollisonTestMap={},this._ignoreCollisonMap={},this.isTrigger=!0}__class(t,"laya.d3.component.physics.Collider",!1,e);var n=t.prototype;return n._clearCollsionMap=function(){for(var e in this._runtimeCollisonMap){var t=this._runtimeCollisonMap[e];delete t._runtimeCollisonMap[this.id],t._isRigidbody&&delete t._runtimeCollisonTestMap[this.id];var n=t.id;delete this._runtimeCollisonMap[n],this._isRigidbody&&delete this._runtimeCollisonTestMap[n]}},n._unload=function(e){for(var t in this._runtimeCollisonMap){var n=this._runtimeCollisonMap[t];delete n._runtimeCollisonMap[this.id],n._isRigidbody&&delete n._runtimeCollisonTestMap[this.id],delete this._ignoreCollisonMap[t]._ignoreCollisonMap[this.id]}},n._setIsRigidbody=function(e){if(this._isRigidbody!=e){this._isRigidbody=e;var t=this._owner;if(t.displayedInStage){var n=t.layer;n._removeCollider(this),n._addCollider(this)}}},n._getType=function(){return-1},n._collisonTo=function(e){return!1},n.raycast=function(e,t,n){throw void 0===n&&(n=179e306),new Error("Collider:Must override it.")},__getset(0,n,"isSingleton",function(){return t._isSingleton}),__getset(0,n,"enable",e.prototype._$get_enable,function(e){this._enable!=e&&(this._owner.displayedInStage&&(e||this._clearCollsionMap()),this._enable=e,this.event("enablechanged",this._enable))}),t._isSingleton=!1,t}(Component3D),Rigidbody=function(e){function t(){t.__super.call(this)}return __class(t,"laya.d3.component.Rigidbody",!1,e),__getset(0,t.prototype,"enable",e.prototype._$get_enable,function(e){if(this._enable!=e){for(var t=this._owner._colliders,n=0,i=t.length;n<i;n++){var r=t[n];r._setIsRigidbody(e);var a=r._runtimeCollisonMap,o=r._runtimeCollisonTestMap;if(!e)for(var s in a)delete o[s]}this._enable=e,this.event("enablechanged",this._enable)}}),t}(Component3D),Scene=function(t){function i(){this._time=0,this._enableLightCount=3,this._customRenderQueneIndex=11,this.enableLight=!0,i.__super.call(this),this._renderState=new RenderState,this._lights=[],this._quenes=[],this._cameraPool=[],this._renderableSprite3Ds=[],this.__loaded=!0,this._lightmaps=[],this._shaderValues=new ValusArray,this.parallelSplitShadowMaps=[],this._dynamicBatchManager=new DynamicBatchManager,this._cullingRenders=[],this._cullingRendersLength=0,this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new Vector3(.7,.7,.7),this.ambientColor=new Vector3(.212,.227,.259),WebGL.shaderHighPrecision&&this.addShaderDefine(ShaderCompile3D.SHADERDEFINE_HIGHPRECISION),this.on("display",this,__bind(this,this._display)),this.on("undisplay",this,__bind(this,this._unDisplay)),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[]}__class(i,"laya.d3.core.scene.Scene",!1,t);var e=i.prototype;return Laya.imps(e,{"laya.resource.ICreateResource":!0,"laya.webgl.submit.ISubmit":!0}),e._setUrl=function(e){this._url=e},e._getGroup=function(){return this._group},e._setGroup=function(e){this._group=e},e._display=function(){Laya.stage._scenes.push(this),Laya.stage._scenes.sort(i._sortScenes);for(var e=0,t=this._childs.length;e<t;e++){var n=this._childs[e];n.active&&n._activeHierarchy()}},e._unDisplay=function(){var e=Laya.stage._scenes;e.splice(e.indexOf(this),1);for(var t=0,n=this._childs.length;t<n;t++){var i=this._childs[t];i.active&&i._inActiveHierarchy()}},e._addChild3D=function(e){e.transform._onWorldTransform(),e._setBelongScene(this),this.displayedInStage&&e.active&&e._activeHierarchy()},e._removeChild3D=function(e){e.transform.parent=null,this.displayedInStage&&e.active&&e._inActiveHierarchy(),e._setUnBelongScene()},e.initOctree=function(e,t,n,i,r){void 0===r&&(r=6),this.treeSize=new Vector3(e,t,n),this.treeLevel=r,this.treeRoot=new OctreeNode(this,0),this.treeRoot.init(i,this.treeSize)},e._prepareUpdateToRenderState=function(e,t){t.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,t.scene=this},e._prepareSceneToRender=function(e){var t=this._lights.length;if(0<t)for(var n=0,i=0;i<t&&!(this._lights[i]._prepareToScene(e)&&++n>=this._enableLightCount);i++);},e._updateChilds=function(e){for(var t=0,n=this._childs.length;t<n;++t)this._childs[t]._update(e)},e._preRenderScene=function(e,t,n){var i,r=t._viewMatrix,a=t._projectionMatrix,o=t._projectionViewMatrix,s=0,l=t.camera;for(l.useOcclusionCulling?this.treeRoot?FrustumCulling.renderObjectCullingOctree(n,this,l,r,a,o):FrustumCulling.renderObjectCulling(n,this,l,r,a,o):FrustumCulling.renderObjectCullingNoBoundFrustum(this,l,r,a,o),s=0,i=this._quenes.length;s<i;s++)this._quenes[s]&&this._quenes[s]._preRender(t)},e._clear=function(e,t){var n=t._viewport,i=t.camera,r=n.x,a=i.renderTargetSize.height-n.y-n.height,o=n.width,s=n.height;e.viewport(r,a,o,s);var l=256,_=i.renderTarget;switch(i.clearFlag){case 0:var h=i.clearColor;if(h){e.enable(3089),e.scissor(r,a,o,s);var c=h.elements;e.clearColor(c[0],c[1],c[2],c[3]),l|=16384}if(_)switch(h||(l=16384),_.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}e.clear(l),h&&e.disable(3089);break;case 1:case 2:if(_)switch(l=16384,_.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}e.clear(l);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},e._renderScene=function(e,t){var n,i,r=t.camera,a=0;for(a=0;a<2;a++)(i=this._quenes[a])&&(r.renderTarget?i._render(t,!0):i._render(t,!1));if(1==r.clearFlag){var o=r.sky;o&&(WebGLContext.setCullFace(e,!1),WebGLContext.setDepthFunc(e,515),WebGLContext.setDepthMask(e,!1),o._render(t),WebGLContext.setDepthFunc(e,513),WebGLContext.setDepthMask(e,!0))}for(a=2,n=this._quenes.length;a<n;a++)(i=this._quenes[a])&&(i._sortAlpha(t.camera.transform.position),r.renderTarget?i._render(t,!0):i._render(t,!1))},e._set3DRenderConfig=function(e){e.disable(3042),WebGLContext._blend=!1,e.blendFunc(770,771),WebGLContext._sFactor=770,WebGLContext._dFactor=771,e.disable(2929),WebGLContext._depthTest=!1,e.enable(2884),WebGLContext._cullFace=!0,e.depthMask(1),WebGLContext._depthMask=!0,e.frontFace(2304),WebGLContext._frontFace=2304},e._set2DRenderConfig=function(e){WebGLContext.setBlend(e,!0),WebGLContext.setBlendFunc(e,1,771),WebGLContext.setDepthTest(e,!1),WebGLContext.setCullFace(e,!1),WebGLContext.setDepthMask(e,!0),WebGLContext.setFrontFace(e,2305),e.viewport(0,0,RenderState2D.width,RenderState2D.height)},e._parseCustomProps=function(e,t,n,i){var r=i.customProps.lightmaps,a=r.length,o=this._lightmaps;o.length=a;for(var s=0;s<a;s++)o[s]=Loader.getRes(t[r[s].replace(".exr",".png")]);this.setlightmaps(o);var l=i.customProps.ambientColor;l&&(this.ambientColor=new Vector3(l[0],l[1],l[2]));var _=i.customProps.fogColor;_&&(this.fogColor=new Vector3(_[0],_[1],_[2]))},e._addLight=function(e){this._lights.indexOf(e)<0&&this._lights.push(e)},e._removeLight=function(e){var t=this._lights.indexOf(e);0<=t&&this._lights.splice(t,1)},e._updateScene=function(){var e=this._renderState;this._prepareUpdateToRenderState(WebGL.mainContext,e),this._updateComponents(e),this._updateChilds(e),this._lateUpdateComponents(e),this._time+=e.elapsedTime/1e3,this._shaderValues.setValue(22,this._time)},e._updateSceneConch=function(){var e=this._renderState;this._prepareUpdateToRenderState(WebGL.mainContext,e),this._updateComponents(e),this._lateUpdateComponents(e),this._prepareSceneToRender(e);for(var t=0,n=this._cameraPool.length;t<n;t++){var i=this._cameraPool[t];(e.camera=i)._prepareCameraToRender()}},e._preRenderShadow=function(e,t,n,i,r){this.treeRoot?FrustumCulling.renderShadowObjectCullingOctree(this,t,n,i,r):FrustumCulling.renderShadowObjectCulling(this,t,n,i,r);for(var a=0,o=n.length;a<o;a++)n[a]&&n[a]._preRender(e)},e._renderShadowMap=function(e,t,n){var i=this.parallelSplitShadowMaps[0];i._calcAllLightCameraInfo(n);var r,a,o,s=i.PSSMNum;if(this._preRenderShadow(t,i._lightCulling,i._shadowQuenes,i._lightVPMatrix[0],s),this.addShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_CAST_SHADOW),1<s)for(var l=0;l<s;l++)r=i.getRenderTarget(l+1),i.beginRenderTarget(l+1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,r.width,r.height),t.camera=o=i.getLightCamera(l),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),t._projectionViewMatrix=i._lightVPMatrix[l+1],(a=i._shadowQuenes[l])._preRender(t),a._renderShadow(t,!1),i.endRenderTarget(l+1);else r=i.getRenderTarget(1),i.beginRenderTarget(1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,r.width,r.height),t.camera=o=i.getLightCamera(0),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),t._projectionViewMatrix=i._lightVPMatrix[0],(a=i._shadowQuenes[0])._preRender(t),a._renderShadow(t,!0),i.endRenderTarget(1);this.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_CAST_SHADOW)},e.addTreeNode=function(e){this.treeRoot.addTreeNode(e)},e.removeTreeNode=function(e){this.treeSize&&e._treeNode&&e._treeNode.removeObject(e)},e.setlightmaps=function(e){this._lightmaps=e;for(var t=0,n=this._renderableSprite3Ds.length;t<n;t++)this._renderableSprite3Ds[t]._render._applyLightMapParams()},e.getlightmaps=function(){return this._lightmaps},e.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e==this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),0<=t&&t<=this._childs.length){if(e._parent==this){var n=this.getChildIndex(e);this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()}else e.parent&&e.parent.removeChild(e),this._childs==Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),(e.parent=this)._addChild3D(e);return e}throw new Error("appendChildAt:The index is out of bounds")},e.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e==this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),e._parent==this){var t=this.getChildIndex(e);t!=this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged())}else e.parent&&e.parent.removeChild(e),this._childs==Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),(e.parent=this)._childChanged(),this._addChild3D(e);return e},e.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._removeChild3D(t),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null),t},e.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&0<this._childs.length){var n=this._childs;if(0==e&&a<=t){var i=n;this._childs=Node.ARRAY_EMPTY}else i=n.splice(e,t-e);for(var r=0,a=i.length;r<a;r++)this._removeChild3D(i[r]),i[r].parent=null,this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}return this},e.addFrustumCullingObject=function(e){this.treeRoot?this.addTreeNode(e):(this._cullingRendersLength==this._cullingRenders.length?this._cullingRenders.push(e):this._cullingRenders[this._cullingRendersLength]=e,e._indexInSceneFrustumCullingObjects=this._cullingRendersLength++)},e.removeFrustumCullingObject=function(e){if(this.treeRoot)this.removeTreeNode(e);else{this._cullingRendersLength--;var t=e._indexInSceneFrustumCullingObjects;if(t!=this._cullingRendersLength){var n=this._cullingRenders[this._cullingRendersLength];(this._cullingRenders[t]=n)._indexInSceneFrustumCullingObjects=t,e._indexInSceneFrustumCullingObjects=-1}}},e.getRenderQueue=function(e){return this._quenes[e]||(this._quenes[e]=new RenderQueue(this))},e.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new RenderQueue(this)},e.addShaderDefine=function(e){this._shaderDefineValue|=e},e.removeShaderDefine=function(e){this._shaderDefineValue&=~e},e.addScript=function(e){return this._addComponent(e)},e.getScriptByType=function(e,t){return void 0===t&&(t=0),this._getComponentByType(e,t)},e.getScriptsByType=function(e,t){this._getComponentsByType(e,t)},e.getScriptByIndex=function(e){return this._getComponentByIndex(e)},e.removeScriptByType=function(e,t){void 0===t&&(t=0),this._removeComponentByType(e,t)},e.removeScriptsByType=function(e){this._removeComponentByType(e)},e.removeAllScript=function(){this._removeAllComponent()},e.render=function(e,t,n){(Render._context.ctx._renderKey=0)<this._childs.length&&e.addRenderObject(this)},e.renderSubmit=function(){var e=WebGL.mainContext,t=this._renderState;this._set3DRenderConfig(e),this._prepareSceneToRender(this._renderState);var n,i=0,r=0;if(Laya3D.debugMode||OctreeNode.debugMode)for(i=0,r=this._cameraPool.length;i<r;i++)n=this._cameraPool[i],Laya3D._debugPhasorSprite.begin(1,n),n.activeInHierarchy&&n._renderCamera(e,t,this),Laya3D._debugPhasorSprite.end();else for(i=0,r=this._cameraPool.length;i<r;i++)(n=this._cameraPool[i]).activeInHierarchy&&n._renderCamera(e,t,this);return this._set2DRenderConfig(e),1},e.onAsynLoaded=function(e,t,n){var i=t[0];if("Scene"!=i.type)throw new Error("Scene: the .lh file root type must be Scene,please use other function to  load  this file.");var r=t[1];Utils3D._createNodeByJson(this,i,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0},e.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._renderState=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._cullingRenders=null,this._dynamicBatchManager=null,this._quenes=null,this._cameraPool=null,this._renderableSprite3Ds=null,this.treeRoot=null,this.treeSize=null,this.parallelSplitShadowMaps=null,this._typeComponentsIndices=null,this._components=null,Loader.clearRes(this.url),this.loaded||Laya3D._cancelLoadByUrl(this.url))},e.getRenderType=function(){return 0},e.releaseRender=function(){},e._addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1==n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=ClassUtils.getInstance(e);t.push(this._components.length),this._components.push(i);return i._initialize(this),i},e._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),n.splice(t,1),0==n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,o=this._componentsMap.length;a<o;a++)for(var s=(n=this._typeComponentsIndices[a]).length-1;0<=s;s--){var l=n[s];if(!(i<l))break;n[s]=--l}r._destroy()},e._getComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);return-1==n?null:this._components[this._typeComponentsIndices[n][t]]},e._getComponentsByType=function(e,t){var n=this._componentsMap.indexOf(e);if(-1!=n){var i=this._typeComponentsIndices[n],r=i.length;t.length=r;for(var a=0;a<r;a++)t[a]=this._components[i[a]]}else t.length=0},e._getComponentByIndex=function(e){return this._components[e]},e._removeComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);-1!=n&&this._removeComponent(n,t)},e._removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!=t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(t,i)},e._removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;e<t;this._componentsMap.length<t?t--:e++)this._removeComponentsByType(this._componentsMap[e])},e._updateComponents=function(e){for(var t=0,n=this._components.length;t<n;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.enable&&i._update(e)}},e._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},e._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},e._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},__getset(0,e,"renderableSprite3Ds",function(){return this._renderableSprite3Ds.slice()}),__getset(0,e,"fogStart",function(){return this._fogStart},function(e){this._fogStart=e,this._shaderValues.setValue(1,e)}),__getset(0,e,"fogRange",function(){return this._fogRange},function(e){this._fogRange=e,this._shaderValues.setValue(2,e)}),__getset(0,e,"fogColor",function(){return this._fogColor},function(e){this._fogColor=e,this._shaderValues.setValue(0,e.elements)}),__getset(0,e,"scene",function(){return this}),__getset(0,e,"ambientColor",function(){return this._ambientColor},function(e){this._ambientColor=e,this._shaderValues.setValue(21,e.elements)}),__getset(0,e,"_loaded",null,function(e){this.__loaded=e}),__getset(0,e,"enableDepthFog",function(){return this._enableDepthFog},function(e){this._enableDepthFog!=e&&((this._enableDepthFog=e)?(this.addShaderDefine(ShaderCompile3D.SAHDERDEFINE_DEPTHFOG),this.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)):this.removeShaderDefine(ShaderCompile3D.SAHDERDEFINE_DEPTHFOG))}),__getset(0,e,"loaded",function(){return this.__loaded}),__getset(0,e,"enableFog",function(){return this._enableFog},function(e){this._enableFog!=e&&((this._enableFog=e)?(this.addShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG),this.removeShaderDefine(ShaderCompile3D.SAHDERDEFINE_DEPTHFOG)):this.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG))}),__getset(0,e,"url",function(){return this._url}),i._sortScenes=function(e,t){if(e.parent!=Laya.stage||t.parent!=Laya.stage)return e.parent!=Laya.stage&&t.parent!=Laya.stage?i._sortScenes(e.parent,t.parent):e.parent==Laya.stage?-1:1;var n=Laya.stage._childs;return n.indexOf(e)-n.indexOf(t)},i.load=function(e){return Laya.loader.create(e,null,null,i)},i.FOGCOLOR=0,i.FOGSTART=1,i.FOGRANGE=2,i.LIGHTDIRECTION=3,i.LIGHTDIRCOLOR=4,i.POINTLIGHTPOS=5,i.POINTLIGHTRANGE=6,i.POINTLIGHTATTENUATION=7,i.POINTLIGHTCOLOR=8,i.SPOTLIGHTPOS=9,i.SPOTLIGHTDIRECTION=10,i.SPOTLIGHTSPOT=11,i.SPOTLIGHTRANGE=12,i.SPOTLIGHTATTENUATION=13,i.SPOTLIGHTCOLOR=14,i.SHADOWDISTANCE=15,i.SHADOWLIGHTVIEWPROJECT=16,i.SHADOWMAPPCFOFFSET=17,i.SHADOWMAPTEXTURE1=18,i.SHADOWMAPTEXTURE2=19,i.SHADOWMAPTEXTURE3=20,i.AMBIENTCOLOR=21,i.TIME=22,i}(Sprite),Sprite3D=function(e){function t(e){t.__super.call(this),this.__loaded=!0,this._projectionViewWorldUpdateLoopCount=-1,this._activeInHierarchy=!1,this._projectionViewWorldMatrix=new Matrix4x4,this._shaderValues=new ValusArray,this._colliders=[],this._id=++t._uniqueIDCounter,this._transform=new Transform3D(this),this.name=e||"Sprite3D-"+t._nameNumberCounter++,this.layer=Layer.currentCreationLayer,this.active=!0}__class(t,"laya.d3.core.Sprite3D",!1,ComponentNode);var n=t.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.render.IUpdate":!0}),n._setUrl=function(e){this._url=e},n._getGroup=function(){return this._group},n._setGroup=function(e){this._group=e},n._addChild3D=function(e){e.transform.parent=this.transform,this._hierarchyAnimator&&(!e._hierarchyAnimator&&e._setHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(e,!0,[e.name])),this._scene&&(e._setBelongScene(this._scene),this._activeInHierarchy&&e._active&&e._activeHierarchy())},n._removeChild3D=function(e){e.transform.parent=null,this._scene&&(this._activeInHierarchy&&e._active&&e._inActiveHierarchy(),e._setUnBelongScene()),this._hierarchyAnimator&&(e._hierarchyAnimator==this._hierarchyAnimator&&e._clearHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(e,!1,[e.name]))},n._parseBaseCustomProps=function(e){var t=this.transform.localPosition;t.fromArray(e.translate),this.transform.localPosition=t;var n=this.transform.localRotation;n.fromArray(e.rotation),this.transform.localRotation=n;var i=this.transform.localScale;i.fromArray(e.scale),this.transform.localScale=i;var r=e.layer;null!=r&&(this.layer=Layer.getLayerByNumber(r))},n._parseCustomComponent=function(e,t,n){for(var i in n){var r=n[i];switch(i){case"Animator":var a=this.addComponent(Animator);if(r.avatarPath)a.avatar=Loader.getRes(t[r.avatarPath]);else{var o=r.avatar;if(o){a.avatar=Loader.getRes(t[o.path]);var s=o.linkSprites;s&&e.once("hierarchyloaded",this,__bind(this,this._onRootNodeHierarchyLoaded),[a,s])}}for(var l=r.clipPaths,_=l.length,h=0;h<_;h++)a.addClip(Loader.getRes(t[l[h]]));a.clip=Loader.getRes(t[l[0]]);var c=r.playOnWake;null!=c&&(a.playOnWake=c);break;case"Rigidbody":this.addComponent(Rigidbody);break;case"SphereCollider":var u=this.addComponent(SphereCollider);u.isTrigger=r.isTrigger;var d=u.center;d.fromArray(r.center),u.center=d,u.radius=r.radius;break;case"BoxCollider":var f=this.addComponent(BoxCollider);f.isTrigger=r.isTrigger,f.center.fromArray(r.center);var m=f.size;m.fromArray(r.size),f.size=m;break;case"MeshCollider":this.addComponent(MeshCollider)}}},n._onRootNodeHierarchyLoaded=function(e,t){for(var n in t){for(var i=this,r=t[n],a=0,o=r.length;a<o;a++){var s=r[a];if(""==s)break;if(!(i=i.getChildByName(s)))break}i&&e.linkSprite3DToAvatarNode(n,i)}},n._setHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(e);for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==t&&r._setHierarchyAnimator(e,t)}},n._clearHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(t);for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==e&&r._clearHierarchyAnimator(e,t)}},n._getAnimatorToLinkSprite3D=function(e,t,n){var i=this.getComponentByType(Animator);if(i&&(i.avatar?i.avatar._version||e._setAnimatorToLinkAvatar(i,t):e._setAnimatorToLinkSprite3DNoAvatar(i,t,n)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D){n.unshift(this._parent.name);var r=this._parent;r._hierarchyAnimator&&r._getAnimatorToLinkSprite3D(e,t,n)}},n._setAnimatorToLinkSprite3DNoAvatar=function(e,t,n){var i=0,r=0;for(i=0,r=e.getClipCount();i<r;i++)e._handleSpriteOwnersBySprite(i,t,n,this);for(i=0,r=this._childs.length;i<r;i++){var a=this._childs[i],o=n.length;n.push(a.name),a._setAnimatorToLinkSprite3DNoAvatar(e,t,n),n.splice(o,1)}},n._changeHierarchyAnimator=function(e){this._hierarchyAnimator=e},n._isLinkSpriteToAnimationNode=function(e,t,n){var i=e._avatarNodes.indexOf(t),r=e._cacheSpriteToNodesMap;if(n)this._transform.dummy=t.transform,e._cacheNodesToSpriteMap[i]=r.length,r.push(i);else{this._transform.dummy=null;var a=e._cacheNodesToSpriteMap[i];e._cacheNodesToSpriteMap[i]=null,r.splice(a,1)}},n._setBelongScene=function(e){this._scene=e;for(var t=0,n=this._childs.length;t<n;t++)this._childs[t]._setBelongScene(e)},n._setUnBelongScene=function(){this._scene=null;for(var e=0,t=this._childs.length;e<t;e++)this._childs[e]._setUnBelongScene()},n._activeHierarchy=function(){var e=0,t=0;for(this._activeInHierarchy=!0,this._addSelfRenderObjects(),e=0,t=this._colliders.length;e<t;e++)this._layer._addCollider(this._colliders[e]);for(this.event("activeinhierarchychanged",!0),e=0,t=this._childs.length;e<t;e++){var n=this._childs[e];n._active&&n._activeHierarchy()}},n._inActiveHierarchy=function(){var e=0,t=0;for(this._activeInHierarchy=!1,this._clearSelfRenderObjects(),e=0,t=this._colliders.length;e<t;e++){var n=this._colliders[e];n._clearCollsionMap(),this._layer._removeCollider(n)}for(this.event("activeinhierarchychanged",!1),e=0,t=this._childs.length;e<t;e++){var i=this._childs[e];i._active&&i._inActiveHierarchy()}},n.addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1==n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=ClassUtils.getInstance(e);if(t.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.physics.Collider)this.getComponentByType(Rigidbody)&&(i._isRigidbody=!0),this._activeInHierarchy&&this._layer._addCollider(i),this._colliders.push(i);else if(i instanceof laya.d3.component.Animator){var r=i;this._setHierarchyAnimator(r,this._parent?this._parent._hierarchyAnimator:null),this._setAnimatorToLinkSprite3DNoAvatar(r,!0,[])}else if(i instanceof laya.d3.component.Rigidbody)for(var a=0,o=this._colliders.length;a<o;a++)this._colliders[a]._setIsRigidbody(!0);return i instanceof laya.d3.component.Script&&this._scripts.push(i),i._initialize(this),i},n._removeComponent=function(e,t){var n=0,i=0,r=this._typeComponentsIndices[e],a=r[t],o=this._components[a];if(o instanceof laya.d3.component.physics.Collider){var s=o;this._activeInHierarchy&&this._layer._removeCollider(s),this._colliders.splice(this._colliders.indexOf(s),1)}else if(o instanceof laya.d3.component.Animator){var l=o;this._clearHierarchyAnimator(l,this._parent?this._parent._hierarchyAnimator:null)}else if(o instanceof laya.d3.component.Rigidbody)for(n=0,i=this._colliders.length;n<i;n++){var _=this._colliders[n];_._setIsRigidbody(!1);var h=_._runtimeCollisonMap,c=_._runtimeCollisonTestMap;for(var u in h)delete c[u]}for(this._components.splice(a,1),o instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(o),1),r.splice(t,1),0==r.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1)),n=0,i=this._componentsMap.length;n<i;n++)for(var d=(r=this._typeComponentsIndices[n]).length-1;0<=d;d--){var f=r[d];if(!(a<f))break;r[d]=--f}o._destroy()},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._parseCustomProps=function(e,t,n,i){},n._updateChilds=function(e){var t=this._childs.length;if(0!=t)for(var n=0;n<t;++n)this._childs[n]._update(e)},n._getSortID=function(e,t){return 1e3*t.id+e._getVertexBuffer().vertexDeclaration.id},n._update=function(e){(e.owner=this)._activeInHierarchy&&(this._updateComponents(e),this._lateUpdateComponents(e),Stat.spriteCount++,this._childs.length&&this._updateChilds(e))},n.getProjectionViewWorldMatrix=function(e){return Matrix4x4.multiply(e,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},n.loadHierarchy=function(e){this.addChild(laya.d3.core.Sprite3D.load(e))},n.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e==this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),0<=t&&t<=this._childs.length){if(e._parent==this){var n=this.getChildIndex(e);this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()}else e.parent&&e.parent.removeChild(e),this._childs==Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),(e.parent=this)._addChild3D(e);return e}throw new Error("appendChildAt:The index is out of bounds")},n.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e==this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),e._parent==this){var t=this.getChildIndex(e);t!=this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged())}else e.parent&&e.parent.removeChild(e),this._childs==Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),(e.parent=this)._childChanged(),this._addChild3D(e);return e},n.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._removeChild3D(t),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null),t},n.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&0<this._childs.length){var n=this._childs;if(0==e&&a<=t){var i=n;this._childs=Node.ARRAY_EMPTY}else i=n.splice(e,t-e);for(var r=0,a=i.length;r<a;r++)this._removeChild3D(i[r]),i[r].parent=null,this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}return this},n.onAsynLoaded=function(e,t,n){var i=t[0];if("Sprite3D"!=i.type)throw new Error("Sprite3D: The .lh file root type must be Sprite3D,please use other function to  load  this file.");var r=t[1];Utils3D._createNodeByJson(this,i,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0},n.cloneTo=function(e){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var t=e;t.name=this.name,t._destroyed=this._destroyed,t.timer=this.timer,t._$P=this._$P,t.active=this._active;var n=t.transform.localPosition,i=t.transform.position;this.transform.localPosition.cloneTo(n),this.transform.position.cloneTo(i),t.transform.localPosition=n,t.transform.position=i;var r=t.transform.localRotation;this.transform.localRotation.cloneTo(r),t.transform.localRotation=r;var a=t.transform.localScale;this.transform.localScale.cloneTo(a),t.transform.localScale=a,t.isStatic=this.isStatic;var o=0,s=0;for(o=0,s=this._componentsMap.length;o<s;o++){var l=t.addComponent(this._componentsMap[o]);this._components[o]._cloneTo(l)}for(o=0,s=this._childs.length;o<s;o++)t.addChild(this._childs[o].clone())},n.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},n.destroy=function(e){if(void 0===e&&(e=!0),!this.destroyed){laya.display.Node.prototype.destroy.call(this,e);var t,n=0;for(n=0,t=this._components.length;n<t;n++)this._components[n]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this._transform=null,this._colliders=null,Loader.clearRes(this.url),this.loaded||Laya3D._cancelLoadByUrl(this.url)}},n._handleSpriteToAvatar=function(e,t){e._avatarNodes;var n=e._avatarNodeMap[this.name];n&&n.name==this.name&&!this._transform.dummy&&this._isLinkSpriteToAnimationNode(e,n,t)},n._setAnimatorToLinkAvatar=function(e,t){this._handleSpriteToAvatar(e,t);for(var n=0,i=this._childs.length;n<i;n++){this._childs[n]._setAnimatorToLinkAvatar(e,t)}},__getset(0,n,"url",function(){return this._url}),__getset(0,n,"transform",function(){return this._transform}),__getset(0,n,"scene",function(){return this._scene}),__getset(0,n,"_loaded",null,function(e){this.__loaded=e}),__getset(0,n,"activeInHierarchy",function(){return this._activeInHierarchy}),__getset(0,n,"loaded",function(){return this.__loaded}),__getset(0,n,"layer",function(){return this._layer},function(e){if(this._layer!=e){if(!e)throw new Error("Layer value can be null.");if(this._activeInHierarchy){var t=0,n=this._colliders.length;if(this._layer)for(t=0;t<n;t++)this._layer._removeCollider(this._colliders[t]);for(t=0;t<n;t++)e._addCollider(this._colliders[t])}this._layer=e,this.event("layerchanged",e)}}),__getset(0,n,"id",function(){return this._id}),__getset(0,n,"componentsCount",function(){return this._components.length}),__getset(0,n,"active",function(){return this._active},function(e){this._active!=e&&(this._active=e,this._parent&&(this._parent==this._scene&&this._parent.displayedInStage||this._parent._activeInHierarchy)&&(e?this._activeHierarchy():this._inActiveHierarchy()))}),t.instantiate=function(e,t,n,i,r){void 0===n&&(n=!0);var a=e.clone();t&&t.addChild(a);var o=a.transform;if(n){var s=o.worldMatrix;e.transform.worldMatrix.cloneTo(s),o.worldMatrix=s}else i&&(o.position=i),r&&(o.rotation=r);return a},t.load=function(e){return Laya.loader.create(e,null,null,t)},t.WORLDMATRIX=0,t.MVPMATRIX=1,t._uniqueIDCounter=0,t._nameNumberCounter=0,t}(),Shader3D=function(e){function _(e,t,n,i,r,a,o,s){if(this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],_.__super.call(this),!e||!t)throw"Shader Error";this._id=++_._count,this._vs=e,this._ps=t,this._attributeMap=n,this._sceneUniformMap=i,this._cameraUniformMap=r,this._spriteUniformMap=a,this._materialUniformMap=o,this._renderElementUniformMap=s,this.recreateResource()}__class(_,"laya.d3.shader.Shader3D",!1,e);var t=_.prototype;return t.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},t.disposeResource=function(){WebGL.mainContext.deleteShader(this._vshader),WebGL.mainContext.deleteShader(this._pshader),WebGL.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},t._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var e=[this._vs,this._ps],t=WebGL.mainContext;if(this._program=t.createProgram(),this._vshader=_._createShader(t,e[0],35633),this._pshader=_._createShader(t,e[1],35632),t.attachShader(this._program,this._vshader),t.attachShader(this._program,this._pshader),t.linkProgram(this._program),!Render.isConchApp&&ShaderCompile3D.debugMode&&!t.getProgramParameter(this._program,35714))throw t.getProgramInfoLog(this._program);var n,i=0,r=0,a=0;for(a=Render.isConchApp?t.getProgramParameterEx(this._vs,this._ps,"",35721):t.getProgramParameter(this._program,35721),i=0;i<a;i++){var o=null;n={vartype:"attribute",ivartype:0,attrib:o=Render.isConchApp?t.getActiveAttribEx(this._vs,this._ps,"",i):t.getActiveAttrib(this._program,i),location:t.getAttribLocation(this._program,o.name),name:o.name,type:o.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._attributeParams.push(n)}var s=0;for(s=Render.isConchApp?t.getProgramParameterEx(this._vs,this._ps,"",35718):t.getProgramParameter(this._program,35718),i=0;i<s;i++){var l=null;l=Render.isConchApp?t.getActiveUniformEx(this._vs,this._ps,"",i):t.getActiveUniform(this._program,i),0<(n={vartype:"uniform",ivartype:1,attrib:o,location:t.getUniformLocation(this._program,l.name),name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0}).name.indexOf("[0]")&&(n.name=n.name.substr(0,n.name.length-3),n.isArray=!0,n.location=t.getUniformLocation(this._program,n.name)),this._uniformParams.push(n)}for(i=0,r=this._attributeParams.length;i<r;i++)(n=this._attributeParams[i]).indexOfParams=i,n.index=1,n.value=[n.location,null],n.codename=n.name,n.name=null!=this._attributeMap[n.codename]?this._attributeMap[n.codename]:n.codename,this._attributeParamsMap.push(n.name),this._attributeParamsMap.push(n),n._this=this,n.uploadedValue=[],n.fun=this._attribute;for(i=0,r=this._uniformParams.length;i<r;i++)switch((n=this._uniformParams[i]).indexOfParams=i,n.index=1,n.value=[n.location,null],n.codename=n.name,null!=this._sceneUniformMap[n.codename]?(n.name=this._sceneUniformMap[n.codename],this._sceneUniformParamsMap.push(n.name),this._sceneUniformParamsMap.push(n)):null!=this._cameraUniformMap[n.codename]?(n.name=this._cameraUniformMap[n.codename],this._cameraUniformParamsMap.push(n.name),this._cameraUniformParamsMap.push(n)):null!=this._spriteUniformMap[n.codename]?(n.name=this._spriteUniformMap[n.codename],this._spriteUniformParamsMap.push(n.name),this._spriteUniformParamsMap.push(n)):null!=this._materialUniformMap[n.codename]?(n.name=this._materialUniformMap[n.codename],this._materialUniformParamsMap.push(n.name),this._materialUniformParamsMap.push(n)):null!=this._renderElementUniformMap[n.codename]?(n.name=this._renderElementUniformMap[n.codename],this._renderElementUniformParamsMap.push(n.name),this._renderElementUniformParamsMap.push(n)):console.log("Shader:can't find uinform name:"+n.codename+" in shader file."),n._this=this,n.uploadedValue=[],n.type){case 5124:n.fun=n.isArray?this._uniform1iv:this._uniform1i;break;case 5126:n.fun=n.isArray?this._uniform1fv:this._uniform1f;break;case 35664:n.fun=n.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:n.fun=n.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:n.fun=n.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:n.fun=this._uniform_sampler2D;break;case 35680:n.fun=this._uniform_samplerCube;break;case 35676:n.fun=this._uniformMatrix4fv;break;case 35670:n.fun=this._uniform1i;break;case 35674:n.fun=this._uinformMatrix2fv;break;case 35675:n.fun=this._uinformMatrix3fv;break;default:throw new Error("compile shader err!")}}},t._attribute=function(e,t){var n=WebGL.mainContext,i=Buffer._enableAtributes,r=e.location;return i[r]||n.enableVertexAttribArray(r),n.vertexAttribPointer(r,t[0],t[1],t[2],t[3],t[4]),i[r]=Buffer._bindVertexBuffer,1},t._uniform1f=function(e,t){var n=e.uploadedValue;return n[0]!=t?(WebGL.mainContext.uniform1f(e.location,n[0]=t),1):0},t._uniform1fv=function(e,t){if(t.length<4){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]||n[2]!=t[2]||n[3]!=t[3]?(WebGL.mainContext.uniform1fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return WebGL.mainContext.uniform1fv(e.location,t),1},t._uniform_vec2=function(e,t){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]?(WebGL.mainContext.uniform2f(e.location,n[0]=t[0],n[1]=t[1]),1):0},t._uniform_vec2v=function(e,t){if(t.length<2){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]||n[2]!=t[2]||n[3]!=t[3]?(WebGL.mainContext.uniform2fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return WebGL.mainContext.uniform2fv(e.location,t),1},t._uniform_vec3=function(e,t){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]||n[2]!=t[2]?(WebGL.mainContext.uniform3f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},t._uniform_vec3v=function(e,t){return WebGL.mainContext.uniform3fv(e.location,t),1},t._uniform_vec4=function(e,t){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]||n[2]!=t[2]||n[3]!=t[3]?(WebGL.mainContext.uniform4f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},t._uniform_vec4v=function(e,t){return WebGL.mainContext.uniform4fv(e.location,t),1},t._uniformMatrix2fv=function(e,t){return WebGL.mainContext.uniformMatrix2fv(e.location,!1,t),1},t._uniformMatrix3fv=function(e,t){return WebGL.mainContext.uniformMatrix3fv(e.location,!1,t),1},t._uniformMatrix4fv=function(e,t){return WebGL.mainContext.uniformMatrix4fv(e.location,!1,t),1},t._uinformMatrix2fv=function(e,t){return WebGL.mainContext.uniformMatrix2fv(e.location,!1,t),1},t._uinformMatrix3fv=function(e,t){return WebGL.mainContext.uniformMatrix3fv(e.location,!1,t),1},t._uniform1i=function(e,t){var n=e.uploadedValue;return n[0]!=t?(WebGL.mainContext.uniform1i(e.location,n[0]=t),1):0},t._uniform1iv=function(e,t){return WebGL.mainContext.uniform1iv(e.location,t),1},t._uniform_ivec2=function(e,t){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]?(WebGL.mainContext.uniform2i(e.location,n[0]=t[0],n[1]=t[1]),1):0},t._uniform_ivec2v=function(e,t){return WebGL.mainContext.uniform2iv(e.location,t),1},t._uniform_vec3i=function(e,t){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]||n[2]!=t[2]?(WebGL.mainContext.uniform3i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},t._uniform_vec3vi=function(e,t){return WebGL.mainContext.uniform3iv(e.location,t),1},t._uniform_vec4i=function(e,t){var n=e.uploadedValue;return n[0]!=t[0]||n[1]!=t[1]||n[2]!=t[2]||n[3]!=t[3]?(WebGL.mainContext.uniform4i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},t._uniform_vec4vi=function(e,t){return WebGL.mainContext.uniform4iv(e.location,t),1},t._uniform_sampler2D=function(e,t){var n=t.source||t.defaulteTexture.source,i=WebGL.mainContext,r=e.uploadedValue;if(null!=r[0])return i.activeTexture(_._TEXTURES[r[0]]),n&&WebGLContext.bindTexture(i,3553,n),0;if(7<this._curActTexIndex)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return r[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),i.activeTexture(_._TEXTURES[this._curActTexIndex]),n&&WebGLContext.bindTexture(i,3553,n),this._curActTexIndex++,1},t._uniform_samplerCube=function(e,t){var n=t.source||t.defaulteTexture.source,i=WebGL.mainContext,r=e.uploadedValue;if(null!=r[0])return i.activeTexture(_._TEXTURES[r[0]]),n?WebGLContext.bindTexture(i,34067,n):WebGLContext.bindTexture(i,34067,SolidColorTextureCube.grayTexture.source),0;if(7<this._curActTexIndex)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return r[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),i.activeTexture(_._TEXTURES[this._curActTexIndex]),n?WebGLContext.bindTexture(i,34067,n):WebGLContext.bindTexture(i,34067,SolidColorTextureCube.grayTexture.source),this._curActTexIndex++,1},t._noSetValue=function(e){console.log("no....:"+e.name)},t.bind=function(){return BaseShader.activeShader=this,(BaseShader.bindShader=this).activeResource(),WebGLContext.UseProgram(this._program)},t.uploadAttributes=function(e,t){for(var n,i,r=0,a=0,o=this._attributeParamsMap.length;a<o;a+=2)i=this._attributeParamsMap[a+1],null!=(n=e[this._attributeParamsMap[a]])&&(t&&t[i.name]&&t[i.name].bind(),r+=i.fun.call(this,i,n));Stat.shaderCall+=r},t.uploadAttributesX=function(e,t){for(var n,i,r=0,a=0,o=this._attributeParamsMap.length;a<o;a+=2)i=this._attributeParamsMap[a+1],null!=(n=e[this._attributeParamsMap[a]])&&(t._bind(),r+=i.fun.call(this,i,n));Stat.shaderCall+=r},t.uploadSceneUniforms=function(e){for(var t,n,i=0,r=0,a=this._sceneUniformParamsMap.length;r<a;r+=2)n=this._sceneUniformParamsMap[r+1],null!=(t=e[this._sceneUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));Stat.shaderCall+=i},t.uploadCameraUniforms=function(e){for(var t,n,i=0,r=0,a=this._cameraUniformParamsMap.length;r<a;r+=2)n=this._cameraUniformParamsMap[r+1],null!=(t=e[this._cameraUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));Stat.shaderCall+=i},t.uploadSpriteUniforms=function(e){for(var t,n,i=0,r=0,a=this._spriteUniformParamsMap.length;r<a;r+=2)n=this._spriteUniformParamsMap[r+1],null!=(t=e[this._spriteUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));Stat.shaderCall+=i},t.uploadMaterialUniforms=function(e){for(var t,n,i=0,r=0,a=this._materialUniformParamsMap.length;r<a;r+=2)n=this._materialUniformParamsMap[r+1],null!=(t=e[this._materialUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));Stat.shaderCall+=i},t.uploadRenderElementUniforms=function(e){for(var t,n,i=0,r=0,a=this._renderElementUniformParamsMap.length;r<a;r+=2)n=this._renderElementUniformParamsMap[r+1],null!=(t=e[this._renderElementUniformParamsMap[r]])&&(i+=n.fun.call(this,n,t));Stat.shaderCall+=i},_.create=function(e,t,n,i,r,a,o,s){return new _(e,t,n,i,r,a,o,s)},_.addInclude=function(e,t){ShaderCompile.addInclude(e,t)},_._createShader=function(e,t,n){var i=e.createShader(n);if(e.shaderSource(i,t),e.compileShader(i),ShaderCompile3D.debugMode&&!e.getShaderParameter(i,35713))throw e.getShaderInfoLog(i);return i},_.PERIOD_RENDERELEMENT=0,_.PERIOD_MATERIAL=1,_.PERIOD_SPRITE=2,_.PERIOD_CAMERA=3,_.PERIOD_SCENE=4,_._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,33991],_._count=0,__static(_,["shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new StringKey}]),_}(BaseShader),TrailMaterial=function(e){function t(){t.__super.call(this),this.setShaderName("Trail"),this._setColor(2,new Vector4(1,1,1,1))}__class(t,"laya.d3.core.trail.TrailMaterial",!1,BaseMaterial);var n=t.prototype;return __getset(0,n,"tilingOffset",function(){return this._getColor(3)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,e)}),__getset(0,n,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),__getset(0,n,"tintColor",function(){return this._getColor(2)},function(e){this._setColor(2,e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSETEXTURE=t.shaderDefines.registerDefine("DIFFUSETEXTURE"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET")},t.load=function(e){return Laya.loader.create(e,null,null,t)},t.SHADERDEFINE_DIFFUSETEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.TINTCOLOR=2,t.TILINGOFFSET=3,__static(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(),ShurikenParticleMaterial=function(s){function l(){l.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this.renderMode=6}__class(l,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",!1,s);var e=l.prototype;return e.onAsynLoaded=function(e,t,n){var i=t[0];if(i.version)s.prototype.onAsynLoaded.call(this,e,t,n);else{var r=t[1],a=i.props;for(var o in a)this[o]=a[o];l._parseShurikenParticleMaterial(r,this,i),this._endLoaded()}},__getset(0,e,"tilingOffset",function(){return this._getColor(3)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,e)}),__getset(0,e,"tintColor",function(){return this._getColor(2)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._setColor(2,e)}),__getset(0,e,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),__getset(0,e,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),l.__init__=function(){l.SHADERDEFINE_DIFFUSEMAP=l.shaderDefines.registerDefine("DIFFUSEMAP"),l.SHADERDEFINE_TINTCOLOR=l.shaderDefines.registerDefine("TINTCOLOR"),l.SHADERDEFINE_ADDTIVEFOG=l.shaderDefines.registerDefine("ADDTIVEFOG"),l.SHADERDEFINE_TILINGOFFSET=l.shaderDefines.registerDefine("TILINGOFFSET")},l.load=function(e){return Laya.loader.create(e,null,null,l)},l._parseShurikenParticleMaterial=function(e,t,n){var i=n.customProps,r=i.diffuseTexture.texture2D;r&&(t.diffuseTexture=Loader.getRes(e[r]));var a=i.tintColor;a&&(t.tintColor=new Vector4(a[0],a[1],a[2],a[3]))},l.RENDERMODE_OPAQUE=1,l.RENDERMODE_OPAQUEDOUBLEFACE=2,l.RENDERMODE_CUTOUT=3,l.RENDERMODE_CUTOUTDOUBLEFACE=4,l.RENDERMODE_TRANSPARENT=13,l.RENDERMODE_TRANSPARENTDOUBLEFACE=14,l.RENDERMODE_ADDTIVE=15,l.RENDERMODE_ADDTIVEDOUBLEFACE=16,l.RENDERMODE_DEPTHREAD_TRANSPARENT=5,l.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,l.RENDERMODE_DEPTHREAD_ADDTIVE=7,l.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,l.RENDERMODE_NONDEPTH_TRANSPARENT=9,l.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,l.RENDERMODE_NONDEPTH_ADDTIVE=11,l.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,l.SHADERDEFINE_DIFFUSEMAP=0,l.SHADERDEFINE_TINTCOLOR=0,l.SHADERDEFINE_TILINGOFFSET=0,l.SHADERDEFINE_ADDTIVEFOG=0,l.DIFFUSETEXTURE=1,l.TINTCOLOR=2,l.TILINGOFFSET=3,__static(l,["defaultMaterial",function(){return this.defaultMaterial=new l},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),l}(BaseMaterial),ExtendTerrainMaterial=function(e){function t(){t.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1}__class(t,"laya.d3.core.material.ExtendTerrainMaterial",!1,BaseMaterial);var n=t.prototype;return n._setDetailNum=function(e){switch(e){case 1:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}},n.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},__getset(0,n,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),__getset(0,n,"specularColor",function(){return this._getColor(13)},function(e){this._setColor(13,e)}),__getset(0,n,"ambientColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),__getset(0,n,"albedo",function(){return this._getColor(14)},function(e){this._setColor(14,e)}),__getset(0,n,"diffuseColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),__getset(0,n,"diffuseScaleOffset2",null,function(e){this._setColor(7,e)}),__getset(0,n,"diffuseScaleOffset4",null,function(e){this._setColor(9,e)}),__getset(0,n,"diffuseScaleOffset5",null,function(e){this._setColor(10,e)}),__getset(0,n,"diffuseScaleOffset3",null,function(e){this._setColor(8,e)}),__getset(0,n,"diffuseTexture5",function(){return this._getTexture(5)},function(e){this._setTexture(5,e),this._setDetailNum(5)}),__getset(0,n,"diffuseScaleOffset1",null,function(e){this._setColor(6,e)}),__getset(0,n,"diffuseTexture4",function(){return this._getTexture(4)},function(e){this._setTexture(4,e),this._setDetailNum(4)}),__getset(0,n,"diffuseTexture3",function(){return this._getTexture(3)},function(e){this._setTexture(3,e),this._setDetailNum(3)}),__getset(0,n,"diffuseTexture2",function(){return this._getTexture(2)},function(e){this._setTexture(2,e),this._setDetailNum(2)}),__getset(0,n,"diffuseTexture1",null,function(e){this._setTexture(1,e),this._setDetailNum(1)}),__getset(0,n,"splatAlphaTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),t.__init__=function(){t.SHADERDEFINE_DETAIL_NUM1=t.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM1"),t.SHADERDEFINE_DETAIL_NUM2=t.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM2"),t.SHADERDEFINE_DETAIL_NUM3=t.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM3"),t.SHADERDEFINE_DETAIL_NUM4=t.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM4"),t.SHADERDEFINE_DETAIL_NUM5=t.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM5")},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_TRANSPARENT=2,t.SPLATALPHATEXTURE=0,t.DIFFUSETEXTURE1=1,t.DIFFUSETEXTURE2=2,t.DIFFUSETEXTURE3=3,t.DIFFUSETEXTURE4=4,t.DIFFUSETEXTURE5=5,t.DIFFUSESCALEOFFSET1=6,t.DIFFUSESCALEOFFSET2=7,t.DIFFUSESCALEOFFSET3=8,t.DIFFUSESCALEOFFSET4=9,t.DIFFUSESCALEOFFSET5=10,t.MATERIALAMBIENT=11,t.MATERIALDIFFUSE=12,t.MATERIALSPECULAR=13,t.MATERIALALBEDO=14,t.SHADERDEFINE_DETAIL_NUM1=0,t.SHADERDEFINE_DETAIL_NUM2=0,t.SHADERDEFINE_DETAIL_NUM3=0,t.SHADERDEFINE_DETAIL_NUM4=0,t.SHADERDEFINE_DETAIL_NUM5=0,__static(t,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(),WaterMaterial=function(i){function t(){this._useVertexDeep=!1,t.__super.call(this),this.setShaderName("Water")}__class(t,"laya.d3.core.material.WaterMaterial",!1,i);var e=t.prototype;return e.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},e.onAsynLoaded=function(e,t,n){i.prototype.onAsynLoaded.call(this,e,t,n)},__getset(0,e,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),__getset(0,e,"useRefractTexture",null,function(e){e?this._addShaderDefine(t.SHADERDEFINE_USE_REFRACT_TEX):this._removeShaderDefine(t.SHADERDEFINE_USE_REFRACT_TEX)}),__getset(0,e,"useFoam",null,function(e){e?this._addShaderDefine(t.SHADERDEFINE_USE_FOAM):this._removeShaderDefine(t.SHADERDEFINE_USE_FOAM)}),__getset(0,e,"deepScale",function(){return this._getNumber(20)},function(e){this._setNumber(20,e)}),__getset(0,e,"seaColor",function(){return this._getBuffer(19)},function(e){this._setBuffer(19,e)}),__getset(0,e,"waveMainDir",function(){return this._getNumber(14)},function(e){this._setNumber(14,e*Math.PI/180)}),__getset(0,e,"waveInfoD",function(){return this._getBuffer(13)},function(e){this._setBuffer(13,e)}),__getset(0,e,"scrsize",null,function(e){this._setBuffer(15,e)}),__getset(0,e,"currentTm",function(){return this._getNumber(8)},function(e){this._setNumber(8,e)}),__getset(0,e,"deepColorTexture",function(){return this._getTexture(10)},function(e){this._setTexture(10,e)}),__getset(0,e,"detailTexture",function(){return this._getTexture(9)},function(e){this._setTexture(9,e)}),__getset(0,e,"foamTexture",function(){return this._getTexture(17)},function(e){this._setTexture(17,e)}),__getset(0,e,"useVertexDeep",function(){return this._useVertexDeep},function(e){(this._useVertexDeep=e)?this._addShaderDefine(t.SHADERDEFINE_USEVERTEXHEIGHT):this._removeShaderDefine(t.SHADERDEFINE_USEVERTEXHEIGHT)}),__getset(0,e,"skyTexture",function(){return this._getTexture(11)},function(e){this._setTexture(11,e)}),__getset(0,e,"windSpeed",function(){return 0},function(e){}),__getset(0,e,"waterInfoTexture",function(){return this._getTexture(16)},function(e){this._setTexture(16,e)}),__getset(0,e,"geoWaveUVScale",function(){return this._getNumber(18)},function(e){this._setNumber(18,e)}),__getset(0,e,"vertexDispTexture",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),__getset(0,e,"underWaterTexture",function(){return this._getTexture(3)},function(e){this._setTexture(3,e)}),__getset(0,e,"waveInfo",function(){return this._getBuffer(12)},function(e){this._setBuffer(12,e)}),__getset(0,e,"normalTexture",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),__getset(0,e,"windDir",function(){return 0},function(e){}),__getset(0,e,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),t.__init__=function(){t.SHADERDEFINE_CUBE_ENV=t.shaderDefines.registerDefine("CUBE_ENV"),t.SHADERDEFINE_HDR_ENV=t.shaderDefines.registerDefine("HDR_ENV"),t.SHADERDEFINE_SHOW_NORMAL=t.shaderDefines.registerDefine("SHOW_NORMAL"),t.SHADERDEFINE_USEVERTEXHEIGHT=t.shaderDefines.registerDefine("USE_VERTEX_DEEPINFO"),t.SHADERDEFINE_USE_FOAM=t.shaderDefines.registerDefine("USE_FOAM"),t.SHADERDEFINE_USE_REFRACT_TEX=t.shaderDefines.registerDefine("USE_REFR_TEX")},t.load=function(e){return Laya.loader.create(e,null,null,t)},t.DIFFUSETEXTURE=1,t.NORMALTEXTURE=2,t.UNDERWATERTEXTURE=3,t.VERTEXDISPTEXTURE=4,t.UVANIAGE=5,t.UVMATRIX=6,t.UVAGE=7,t.CURTM=8,t.DETAILTEXTURE=9,t.DEEPCOLORTEXTURE=10,t.SKYTEXTURE=11,t.WAVEINFO=12,t.WAVEINFOD=13,t.WAVEMAINDIR=14,t.SCRSIZE=15,t.WATERINFO=16,t.FOAMTEXTURE=17,t.GEOWAVE_UV_SCALE=18,t.SEA_COLOR=19,t.WAVEINFODEEPSCALE=20,t.SHADERDEFINE_SHOW_NORMAL=0,t.SHADERDEFINE_CUBE_ENV=0,t.SHADERDEFINE_HDR_ENV=0,t.SHADERDEFINE_USE_FOAM=0,t.SHADERDEFINE_USE_REFRACT_TEX=0,t.SHADERDEFINE_USEVERTEXHEIGHT=0,t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,__static(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(BaseMaterial),PBRStandardMaterial=function(e){function t(){t.__super.call(this),this.setShaderName("PBRStandard"),this._setColor(7,new Vector4(1,1,1,1)),this._setColor(8,new Vector4(0,0,0,0)),this._setNumber(9,0),this._setNumber(10,.5),this._setNumber(11,1),this._setNumber(12,0),this._setNumber(13,1),this._setNumber(14,1),this._setNumber(15,.001),this._setBool(16,!1),this._setNumber(0,.5)}__class(t,"laya.d3.core.material.PBRStandardMaterial",!1,BaseMaterial);var n=t.prototype;return __getset(0,n,"tilingOffset",function(){return this._getColor(17)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(17,e)}),__getset(0,n,"emissionColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),__getset(0,n,"enableEmission",function(){return this._getBool(16)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION),this._setBool(16,e)}),__getset(0,n,"smoothnessSource",function(){return this._getNumber(12)},function(e){1==e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA):(this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA),e=0),this._setNumber(12,e)}),__getset(0,n,"smoothnessTextureScale",function(){return this._getNumber(11)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(11,e)}),__getset(0,n,"parallaxTextureScale",function(){return this._getNumber(15)},function(e){e=Math.max(.005,Math.min(.08,e)),this._setNumber(15,e)}),__getset(0,n,"metallicGlossTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._setTexture(2,e)}),__getset(0,n,"occlusionTextureStrength",function(){return this._getNumber(13)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(13,e)}),__getset(0,n,"metallic",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),__getset(0,n,"occlusionTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._setTexture(5,e)}),__getset(0,n,"emissionTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._setTexture(6,e)}),__getset(0,n,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),__getset(0,n,"normalTextureScale",function(){return this._getNumber(14)},function(e){this._setNumber(14,e)}),__getset(0,n,"normalTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE),this._setTexture(3,e)}),__getset(0,n,"smoothness",function(){return this._getNumber(10)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(10,e)}),__getset(0,n,"parallaxTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._setTexture(4,e)}),__getset(0,n,"albedoColor",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSETEXTURE=t.shaderDefines.registerDefine("DIFFUSETEXTURE"),t.SHADERDEFINE_METALLICGLOSSTEXTURE=t.shaderDefines.registerDefine("METALLICGLOSSTEXTURE"),t.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=t.shaderDefines.registerDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),t.SHADERDEFINE_NORMALTEXTURE=t.shaderDefines.registerDefine("NORMALTEXTURE"),t.SHADERDEFINE_PARALLAXTEXTURE=t.shaderDefines.registerDefine("PARALLAXTEXTURE"),t.SHADERDEFINE_OCCLUSIONTEXTURE=t.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),t.SHADERDEFINE_EMISSION=t.shaderDefines.registerDefine("EMISSION"),t.SHADERDEFINE_EMISSIONTEXTURE=t.shaderDefines.registerDefine("EMISSIONTEXTURE"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET")},t.SmoothnessSource_MetallicGlossTexture_Alpha=0,t.SmoothnessSource_DiffuseTexture_Alpha=1,t.SHADERDEFINE_DIFFUSETEXTURE=0,t.SHADERDEFINE_NORMALTEXTURE=0,t.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,t.SHADERDEFINE_METALLICGLOSSTEXTURE=0,t.SHADERDEFINE_OCCLUSIONTEXTURE=0,t.SHADERDEFINE_PARALLAXTEXTURE=0,t.SHADERDEFINE_EMISSION=0,t.SHADERDEFINE_EMISSIONTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.METALLICGLOSSTEXTURE=2,t.NORMALTEXTURE=3,t.PARALLAXTEXTURE=4,t.OCCLUSIONTEXTURE=5,t.EMISSIONTEXTURE=6,t.DIFFUSECOLOR=7,t.EMISSIONCOLOR=8,t.METALLIC=9,t.SMOOTHNESS=10,t.SMOOTHNESSSCALE=11,t.SMOOTHNESSSOURCE=12,t.OCCLUSIONSTRENGTH=13,t.NORMALSCALE=14,t.PARALLAXSCALE=15,t.ENABLEEMISSION=16,t.TILINGOFFSET=17,__static(t,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(),GlitterMaterial=function(t){function n(){n.__super.call(this),this.setShaderName("GLITTER"),this.renderMode=1,this._setColor(3,new Vector4(1,1,1,1)),this._setColor(2,new Vector4(1,1,1,1))}__class(n,"laya.d3.core.material.GlitterMaterial",!1,t);var e=n.prototype;return e.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},__getset(0,e,"color",function(){return this._getColor(3)},function(e){this._setColor(3,e)}),__getset(0,e,"albedo",function(){return this._getColor(2)},function(e){this._setColor(2,e)}),__getset(0,e,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),__getset(0,e,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),n.load=function(e){return Laya.loader.create(e,null,null,n)},n.RENDERMODE_OPAQUE=1,n.RENDERMODE_OPAQUEDOUBLEFACE=2,n.RENDERMODE_TRANSPARENT=13,n.RENDERMODE_TRANSPARENTDOUBLEFACE=14,n.RENDERMODE_ADDTIVE=15,n.RENDERMODE_ADDTIVEDOUBLEFACE=16,n.RENDERMODE_DEPTHREAD_TRANSPARENT=5,n.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,n.RENDERMODE_DEPTHREAD_ADDTIVE=7,n.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,n.RENDERMODE_NONDEPTH_TRANSPARENT=9,n.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,n.RENDERMODE_NONDEPTH_ADDTIVE=11,n.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,n.DIFFUSETEXTURE=1,n.ALBEDO=2,n.UNICOLOR=3,__static(n,["defaultMaterial",function(){return this.defaultMaterial=new n}]),n}(BaseMaterial),StandardMaterial=function(s){function l(){this._transformUV=null,l.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new Vector3(.6,.6,.6)),this._setColor(10,new Vector3(1,1,1)),this._setColor(11,new Vector4(1,1,1,8)),this._setColor(12,new Vector3(1,1,1)),this._setColor(7,new Vector4(1,1,1,1)),this._setNumber(0,.5),this._setColor(15,new Vector4(1,1,0,0)),this.renderMode=1}__class(l,"laya.d3.core.material.StandardMaterial",!1,s);var e=l.prototype;return e.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},e.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},e.onAsynLoaded=function(e,t,n){var i=t[0];if(i.version)s.prototype.onAsynLoaded.call(this,e,t,n);else{var r=t[1],a=i.props;for(var o in a)this[o]=a[o];l._parseStandardMaterial(r,this,i),this._endLoaded()}},e.cloneTo=function(e){s.prototype.cloneTo.call(this,e);var t=e;this._transformUV&&(t._transformUV=this._transformUV.clone())},__getset(0,e,"ambientTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(5,e)}),__getset(0,e,"emissiveTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(4,e)}),__getset(0,e,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(13,e.matrix),e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,e.matrix.elements,0)}),__getset(0,e,"reflectTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(6,e)}),__getset(0,e,"specularTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,e)}),__getset(0,e,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),__getset(0,e,"albedoColor",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),__getset(0,e,"specularColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),__getset(0,e,"normalTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,e)}),__getset(0,e,"reflectColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),__getset(0,e,"diffuseColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),__getset(0,e,"albedo",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),__getset(0,e,"ambientColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),__getset(0,e,"tilingOffset",function(){return this._getColor(15)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(15,e)}),__getset(0,e,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(l.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),l.__init__=function(){l.SHADERDEFINE_DIFFUSEMAP=l.shaderDefines.registerDefine("DIFFUSEMAP"),l.SHADERDEFINE_NORMALMAP=l.shaderDefines.registerDefine("NORMALMAP"),l.SHADERDEFINE_SPECULARMAP=l.shaderDefines.registerDefine("SPECULARMAP"),l.SHADERDEFINE_EMISSIVEMAP=l.shaderDefines.registerDefine("EMISSIVEMAP"),l.SHADERDEFINE_AMBIENTMAP=l.shaderDefines.registerDefine("AMBIENTMAP"),l.SHADERDEFINE_REFLECTMAP=l.shaderDefines.registerDefine("REFLECTMAP"),l.SHADERDEFINE_UVTRANSFORM=l.shaderDefines.registerDefine("UVTRANSFORM"),l.SHADERDEFINE_TILINGOFFSET=l.shaderDefines.registerDefine("TILINGOFFSET"),l.SHADERDEFINE_ADDTIVEFOG=l.shaderDefines.registerDefine("ADDTIVEFOG")},l.load=function(e){return Laya.loader.create(e,null,null,l)},l._parseStandardMaterial=function(e,t,n){var i=n.customProps,r=i.ambientColor;t.ambientColor=new Vector3(r[0],r[1],r[2]);var a=i.diffuseColor;t.diffuseColor=new Vector3(a[0],a[1],a[2]);var o=i.specularColor;t.specularColor=new Vector4(o[0],o[1],o[2],o[3]);var s=i.reflectColor;t.reflectColor=new Vector3(s[0],s[1],s[2]);var l=i.albedoColor;l&&(t.albedo=new Vector4(l[0],l[1],l[2],l[3]));var _=i.diffuseTexture.texture2D;_&&(t.diffuseTexture=Loader.getRes(e[_]));var h=i.normalTexture.texture2D;h&&(t.normalTexture=Loader.getRes(e[h]));var c=i.specularTexture.texture2D;c&&(t.specularTexture=Loader.getRes(e[c]));var u=i.emissiveTexture.texture2D;u&&(t.emissiveTexture=Loader.getRes(e[u]));var d=i.ambientTexture.texture2D;d&&(t.ambientTexture=Loader.getRes(e[d]));var f=i.reflectTexture.texture2D;f&&(t.reflectTexture=Loader.getRes(e[f]))},l.RENDERMODE_OPAQUE=1,l.RENDERMODE_OPAQUEDOUBLEFACE=2,l.RENDERMODE_CUTOUT=3,l.RENDERMODE_CUTOUTDOUBLEFACE=4,l.RENDERMODE_TRANSPARENT=13,l.RENDERMODE_TRANSPARENTDOUBLEFACE=14,l.RENDERMODE_ADDTIVE=15,l.RENDERMODE_ADDTIVEDOUBLEFACE=16,l.RENDERMODE_DEPTHREAD_TRANSPARENT=5,l.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,l.RENDERMODE_DEPTHREAD_ADDTIVE=7,l.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,l.RENDERMODE_NONDEPTH_TRANSPARENT=9,l.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,l.RENDERMODE_NONDEPTH_ADDTIVE=11,l.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,l.SHADERDEFINE_DIFFUSEMAP=0,l.SHADERDEFINE_NORMALMAP=0,l.SHADERDEFINE_SPECULARMAP=0,l.SHADERDEFINE_EMISSIVEMAP=0,l.SHADERDEFINE_AMBIENTMAP=0,l.SHADERDEFINE_REFLECTMAP=0,l.SHADERDEFINE_UVTRANSFORM=0,l.SHADERDEFINE_TILINGOFFSET=0,l.SHADERDEFINE_ADDTIVEFOG=0,l.DIFFUSETEXTURE=1,l.NORMALTEXTURE=2,l.SPECULARTEXTURE=3,l.EMISSIVETEXTURE=4,l.AMBIENTTEXTURE=5,l.REFLECTTEXTURE=6,l.ALBEDO=7,l.UVANIAGE=8,l.MATERIALAMBIENT=9,l.MATERIALDIFFUSE=10,l.MATERIALSPECULAR=11,l.MATERIALREFLECT=12,l.UVMATRIX=13,l.UVAGE=14,l.TILINGOFFSET=15,__static(l,["defaultMaterial",function(){return this.defaultMaterial=new l},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),l}(BaseMaterial),PBRMaterial=function(i){function n(){if(this._transformUV=null,n.__super.call(this),!laya.d3.core.material.PBRMaterial.pbrlutTex){var e=Browser.window.__pbrlutdata;if(!e)throw alert("no pbr lutdata, need pbrlut.js"),"no pbr lutdata, need pbrlut.js";var t=DataTexture2D.create(new Uint32Array(e).buffer,256,256,9728,9728,!1);laya.d3.core.material.PBRMaterial.pbrlutTex=t}this._setTexture(4,laya.d3.core.material.PBRMaterial.pbrlutTex),this.setShaderName("PBR"),this._setNumber(0,.5),this.use_groundtruth=!1}__class(n,"laya.d3.core.material.PBRMaterial",!1,i);var e=n.prototype;return e.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},e.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},e.onAsynLoaded=function(e,t,n){i.prototype.onAsynLoaded.call(this,e,t,n)},e.radicalInverse_VdC=function(e){var t,n=new Uint32Array(1);return t=(16711935&(t=(252645135&(t=(858993459&(t=(1431655765&(t=(t=e)<<16|t>>>16))<<1|(2863311530&t)>>>1))<<2|(3435973836&t)>>>2))<<4|(4042322160&t)>>>4))<<8|(4278255360&t)>>>8,n[0]=t,2.3283064365386963e-10*n[0]},e.createHammersleyTex=function(e,t){var n=new Uint8Array(e*t*4),i=0,r=0;for(r=0;r<e*t;r++){var a=this.radicalInverse_VdC(r);n[i++]=255*a,n[i++]=0,n[i++]=0,n[i++]=255}return n},__getset(0,e,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),__getset(0,e,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(8,e.matrix),this._conchMaterial&&this._conchMaterial.setShaderValue(8,e.matrix.elements,0)}),__getset(0,e,"normalTexture",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),__getset(0,e,"pbrlutTexture",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),__getset(0,e,"pbrInfoTexture",function(){return this._getTexture(3)},function(e){this._setTexture(3,e),this._addShaderDefine(n.SHADERDEFINE_HAS_PBRINFO)}),__getset(0,e,"diffuseTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),__getset(0,e,"testClipZ",null,function(e){this._addShaderDefine(n.SHADERDEFINE_TEST_CLIPZ)}),__getset(0,e,"metaless",function(){return this._getNumber(7)},function(e){this._setNumber(7,e),this._addShaderDefine(n.SHADERDEFINE_FIX_METALESS)}),__getset(0,e,"roughness",function(){return this._getNumber(6)},function(e){this._setNumber(6,e),this._addShaderDefine(n.SHADERDEFINE_FIX_ROUGHNESS)}),__getset(0,e,"use_groundtruth",null,function(e){if(e){if(this._addShaderDefine(n.SHADERDEFINE_USE_GROUNDTRUTH),!laya.d3.core.material.PBRMaterial.HammersleyNoiseTex){var t=this.createHammersleyTex(32,32);laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=DataTexture2D.create(t.buffer,32,32,9728,9728,!1)}this._setTexture(15,n.HammersleyNoiseTex)}else laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=null,this._removeShaderDefine(n.SHADERDEFINE_USE_GROUNDTRUTH)}),__getset(0,e,"has_tangent",null,function(e){this._addShaderDefine(n.SHADERDEFINE_HAS_TANGENT)}),n.__init__=function(){n.SHADERDEFINE_FIX_METALESS=n.shaderDefines.registerDefine("FIX_METALESS"),n.SHADERDEFINE_FIX_ROUGHNESS=n.shaderDefines.registerDefine("FIX_ROUGHNESS"),n.SHADERDEFINE_HAS_TANGENT=n.shaderDefines.registerDefine("HAS_TANGENT"),n.SHADERDEFINE_HAS_PBRINFO=n.shaderDefines.registerDefine("HAS_PBRINFO"),n.SHADERDEFINE_USE_GROUNDTRUTH=n.shaderDefines.registerDefine("USE_GROUNDTRUTH"),n.SHADERDEFINE_TEST_CLIPZ=n.shaderDefines.registerDefine("CLIPZ")},n.load=function(e){return Laya.loader.create(e,null,null,n)},n.DIFFUSETEXTURE=1,n.NORMALTEXTURE=2,n.PBRINFOTEXTURE=3,n.PBRLUTTEXTURE=4,n.UVANIAGE=5,n.MATERIALROUGHNESS=6,n.MATERIALMETALESS=7,n.UVMATRIX=8,n.UVAGE=9,n.AOOBJPOS=14,n.HSNOISETEXTURE=15,n.SHADERDEFINE_FIX_ROUGHNESS=0,n.SHADERDEFINE_FIX_METALESS=0,n.SHADERDEFINE_HAS_TANGENT=0,n.SHADERDEFINE_TEST_CLIPZ=0,n.SHADERDEFINE_HAS_PBRINFO=0,n.SHADERDEFINE_USE_GROUNDTRUTH=0,n.RENDERMODE_OPAQUE=1,n.RENDERMODE_OPAQUEDOUBLEFACE=2,n.RENDERMODE_CUTOUT=3,n.RENDERMODE_CUTOUTDOUBLEFACE=4,n.RENDERMODE_TRANSPARENT=13,n.pbrlutTex=null,n.HammersleyNoiseTex=null,__static(n,["defaultMaterial",function(){return this.defaultMaterial=new n},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),n}(BaseMaterial),BlinnPhongMaterial=function(n){function t(){t.__super.call(this),this.setShaderName("BLINNPHONG"),this._albedoIntensity=1,this._albedoColor=new Vector4(1,1,1,1),this._setColor(6,new Vector4(1,1,1,1)),this._setColor(8,new Vector3(1,1,1)),this._setNumber(9,.078125),this._setColor(10,new Vector3(1,1,1)),this._setNumber(0,.5),this._setColor(11,new Vector4(1,1,0,0)),this._enableLighting=!0,this.renderMode=0,this._setColor(12,new Vector4(1,1,1,1))}__class(t,"laya.d3.core.material.BlinnPhongMaterial",!1,n);var e=t.prototype;return e.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},e.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},e.cloneTo=function(e){n.prototype.cloneTo.call(this,e);var t=e;t._enableLighting=this._enableLighting,t._albedoIntensity=this._albedoIntensity,this._albedoColor.cloneTo(t._albedoColor)},__getset(0,e,"glowingEdgeColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),__getset(0,e,"enableLighting",function(){return this._enableLighting},function(e){this._enableLighting!=e&&(e?this._removeDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT):this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=e)}),__getset(0,e,"reflectTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(5,e)}),__getset(0,e,"specularTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,e)}),__getset(0,e,"normalTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,e)}),__getset(0,e,"albedoIntensity",function(){return this._albedoIntensity},function(e){if(this._albedoIntensity!=e){var t=this._getColor(6);Vector4.scale(this._albedoColor,e,t),this._albedoIntensity=e}}),__getset(0,e,"reflectColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),__getset(0,e,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),__getset(0,e,"shininess",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),__getset(0,e,"enableGlowingEdge",null,function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_GLOWINGEDGE):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_GLOWINGEDGE)}),__getset(0,e,"specularColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),__getset(0,e,"tilingOffset",function(){return this._getColor(11)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(11,e)}),__getset(0,e,"albedoColor",function(){return this._albedoColor},function(e){var t=this._getColor(6);Vector4.scale(e,this._albedoIntensity,t),this._albedoColor=e}),__getset(0,e,"renderMode",null,function(e){switch(e){case 0:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 1:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this.depthTest=513,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this.depthTest=513,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSEMAP=t.shaderDefines.registerDefine("DIFFUSEMAP"),t.SHADERDEFINE_NORMALMAP=t.shaderDefines.registerDefine("NORMALMAP"),t.SHADERDEFINE_SPECULARMAP=t.shaderDefines.registerDefine("SPECULARMAP"),t.SHADERDEFINE_REFLECTMAP=t.shaderDefines.registerDefine("REFLECTMAP"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET"),t.SHADERDEFINE_ADDTIVEFOG=t.shaderDefines.registerDefine("ADDTIVEFOG"),t.SHADERDEFINE_GLOWINGEDGE=t.shaderDefines.registerDefine("GLOWINGEDGE")},t.load=function(e){return Laya.loader.create(e,null,null,t)},t.SPECULARSOURCE_DIFFUSEMAPALPHA=0,t.SPECULARSOURCE_SPECULARMAP=0,t.RENDERMODE_OPAQUE=0,t.RENDERMODE_CUTOUT=1,t.RENDERMODE_TRANSPARENT=2,t.RENDERMODE_ADDTIVE=3,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_NORMALMAP=0,t.SHADERDEFINE_SPECULARMAP=0,t.SHADERDEFINE_REFLECTMAP=0,t.SHADERDEFINE_TILINGOFFSET=0,t.SHADERDEFINE_ADDTIVEFOG=0,t.SHADERDEFINE_GLOWINGEDGE=0,t.ALBEDOTEXTURE=1,t.NORMALTEXTURE=2,t.SPECULARTEXTURE=3,t.EMISSIVETEXTURE=4,t.REFLECTTEXTURE=5,t.ALBEDOCOLOR=6,t.MATERIALSPECULAR=8,t.SHININESS=9,t.MATERIALREFLECT=10,t.TILINGOFFSET=11,t.GLOWINGEDGECOLOR=12,__static(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(BaseMaterial),TerrainMaterial=function(t){function n(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,n.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new Vector2,this._diffuseScale2=new Vector2,this._diffuseScale3=new Vector2,this._diffuseScale4=new Vector2,this.ambientColor=new Vector3(.6,.6,.6),this.diffuseColor=new Vector3(1,1,1),this.specularColor=new Vector4(.2,.2,.2,32)}__class(n,"laya.d3.core.material.TerrainMaterial",!1,t);var e=n.prototype;return e.setDiffuseScale1=function(e,t){this._diffuseScale1.x=e,this._diffuseScale1.y=t,this._setColor(6,this._diffuseScale1)},e.setDiffuseScale2=function(e,t){this._diffuseScale2.x=e,this._diffuseScale2.y=t,this._setColor(7,this._diffuseScale2)},e.setDiffuseScale3=function(e,t){this._diffuseScale3.x=e,this._diffuseScale3.y=t,this._setColor(8,this._diffuseScale3)},e.setDiffuseScale4=function(e,t){this._diffuseScale4.x=e,this._diffuseScale4.y=t,this._setColor(9,this._diffuseScale4)},e.setDetailNum=function(e){switch(e){case 1:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3)}},e.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},e.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},__getset(0,e,"diffuseTexture4",function(){return this._getTexture(5)},function(e){this._setTexture(5,e)}),__getset(0,e,"diffuseTexture3",function(){return this._getTexture(4)},function(e){this._setTexture(4,e)}),__getset(0,e,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("TerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),__getset(0,e,"diffuseTexture2",function(){return this._getTexture(3)},function(e){this._setTexture(3,e)}),__getset(0,e,"diffuseTexture1",function(){return this._getTexture(2)},function(e){this._setTexture(2,e)}),__getset(0,e,"specularColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),__getset(0,e,"normalTexture",function(){return this._getTexture(1)},function(e){this._setTexture(1,e)}),__getset(0,e,"diffuseColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),__getset(0,e,"splatAlphaTexture",function(){return this._getTexture(0)},function(e){this._setTexture(0,e)}),__getset(0,e,"ambientColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),n.__init__=function(){n.SHADERDEFINE_DETAIL_NUM1=n.shaderDefines.registerDefine("DETAIL_NUM1"),n.SHADERDEFINE_DETAIL_NUM2=n.shaderDefines.registerDefine("DETAIL_NUM2"),n.SHADERDEFINE_DETAIL_NUM4=n.shaderDefines.registerDefine("DETAIL_NUM4"),n.SHADERDEFINE_DETAIL_NUM3=n.shaderDefines.registerDefine("DETAIL_NUM3")},n.load=function(e){return Laya.loader.create(e,null,null,n)},n.RENDERMODE_OPAQUE=1,n.RENDERMODE_TRANSPARENT=2,n.SPLATALPHATEXTURE=0,n.NORMALTEXTURE=1,n.DIFFUSETEXTURE1=2,n.DIFFUSETEXTURE2=3,n.DIFFUSETEXTURE3=4,n.DIFFUSETEXTURE4=5,n.DIFFUSESCALE1=6,n.DIFFUSESCALE2=7,n.DIFFUSESCALE3=8,n.DIFFUSESCALE4=9,n.MATERIALAMBIENT=10,n.MATERIALDIFFUSE=11,n.MATERIALSPECULAR=12,n.SHADERDEFINE_DETAIL_NUM1=0,n.SHADERDEFINE_DETAIL_NUM2=0,n.SHADERDEFINE_DETAIL_NUM3=0,n.SHADERDEFINE_DETAIL_NUM4=0,__static(n,["defaultMaterial",function(){return this.defaultMaterial=new n},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),n}(BaseMaterial),PBRSpecularMaterial=function(e){function t(){t.__super.call(this),this.setShaderName("PBRSpecular"),this._setColor(7,new Vector4(1,1,1,1)),this._setColor(9,new Vector4(0,0,0,0)),this._setColor(8,new Vector4(.2,.2,.2,.2)),this._setNumber(10,.5),this._setNumber(11,1),this._setNumber(12,0),this._setNumber(13,1),this._setNumber(14,1),this._setNumber(15,.001),this._setBool(16,!1),this._setNumber(0,.5)}__class(t,"laya.d3.core.material.PBRSpecularMaterial",!1,BaseMaterial);var n=t.prototype;return __getset(0,n,"tilingOffset",function(){return this._getColor(17)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(17,e)}),__getset(0,n,"emissionColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),__getset(0,n,"enableEmission",function(){return this._getBool(16)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION),this._setBool(16,e)}),__getset(0,n,"smoothnessSource",function(){return this._getNumber(12)},function(e){1==e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA):(this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA),e=0),this._setNumber(12,e)}),__getset(0,n,"smoothnessTextureScale",function(){return this._getNumber(11)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(11,e)}),__getset(0,n,"specularColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),__getset(0,n,"specularTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE),this._setTexture(2,e)}),__getset(0,n,"occlusionTextureStrength",function(){return this._getNumber(13)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(13,e)}),__getset(0,n,"occlusionTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._setTexture(5,e)}),__getset(0,n,"emissionTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._setTexture(6,e)}),__getset(0,n,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),__getset(0,n,"normalTextureScale",function(){return this._getNumber(14)},function(e){this._setNumber(14,e)}),__getset(0,n,"parallaxTextureScale",function(){return this._getNumber(15)},function(e){e=Math.max(.005,Math.min(.08,e)),this._setNumber(15,e)}),__getset(0,n,"normalTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE),this._setTexture(3,e)}),__getset(0,n,"smoothness",function(){return this._getNumber(10)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(10,e)}),__getset(0,n,"parallaxTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._setTexture(4,e)}),__getset(0,n,"albedoColor",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSETEXTURE=t.shaderDefines.registerDefine("DIFFUSETEXTURE"),t.SHADERDEFINE_SPECULARTEXTURE=t.shaderDefines.registerDefine("SPECULARTEXTURE"),t.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=t.shaderDefines.registerDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),t.SHADERDEFINE_NORMALTEXTURE=t.shaderDefines.registerDefine("NORMALTEXTURE"),t.SHADERDEFINE_PARALLAXTEXTURE=t.shaderDefines.registerDefine("PARALLAXTEXTURE"),t.SHADERDEFINE_OCCLUSIONTEXTURE=t.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),t.SHADERDEFINE_EMISSION=t.shaderDefines.registerDefine("EMISSION"),t.SHADERDEFINE_EMISSIONTEXTURE=t.shaderDefines.registerDefine("EMISSIONTEXTURE"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET")},t.SmoothnessSource_MetallicGlossTexture_Alpha=0,t.SmoothnessSource_DiffuseTexture_Alpha=1,t.SHADERDEFINE_DIFFUSETEXTURE=0,t.SHADERDEFINE_NORMALTEXTURE=0,t.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,t.SHADERDEFINE_SPECULARTEXTURE=0,t.SHADERDEFINE_OCCLUSIONTEXTURE=0,t.SHADERDEFINE_PARALLAXTEXTURE=0,t.SHADERDEFINE_EMISSION=0,t.SHADERDEFINE_EMISSIONTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.SPECULARTEXTURE=2,t.NORMALTEXTURE=3,t.PARALLAXTEXTURE=4,t.OCCLUSIONTEXTURE=5,t.EMISSIONTEXTURE=6,t.DIFFUSECOLOR=7,t.SPECULARCOLOR=8,t.EMISSIONCOLOR=9,t.SMOOTHNESS=10,t.SMOOTHNESSSCALE=11,t.SMOOTHNESSSOURCE=12,t.OCCLUSIONSTRENGTH=13,t.NORMALSCALE=14,t.PARALLAXSCALE=15,t.ENABLEEMISSION=16,t.TILINGOFFSET=17,__static(t,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(),OutlineMaterial=function(e){function t(){t.__super.call(this),this.setShaderName("OutlineShader"),this._setNumber(2,.01581197),this._setNumber(3,1)}__class(t,"laya.d3.extension.cartoonRender.OutlineMaterial",!1,BaseMaterial);var n=t.prototype;return __getset(0,n,"outlineLightness",function(){return this._getNumber(3)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(3,e)}),__getset(0,n,"outlineWidth",function(){return this._getNumber(2)},function(e){e=Math.max(0,Math.min(.05,e)),this._setNumber(2,e)}),__getset(0,n,"outlineTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE),this._setTexture(1,e)}),t.__init__=function(){t.SHADERDEFINE_OUTLINETEXTURE=t.shaderDefines.registerDefine("OUTLINETEXTURE")},t.initShader=function(){var e=Shader3D.nameKey.add("OutlineShader"),t=ShaderCompile3D.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform float u_OutlineWidth;\n\nvarying vec2 v_Texcoord0;\n\nvoid main()\n{\n\tv_Texcoord0 = a_Texcoord0;\n\t\n\tvec4 position = vec4(a_Position.xyz + a_Normal * u_OutlineWidth, 1.0);\n\tgl_Position = u_MvpMatrix * position;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\n\n#ifdef OUTLINETEXTURE\n\tuniform sampler2D u_OutlineTexture;\n#endif\nuniform float u_OutlineLightness;\n\nvoid main()\n{\n\tvec4 outlineTextureColor = vec4(1.0);\n\t#ifdef OUTLINETEXTURE\n\t\toutlineTextureColor = texture2D(u_OutlineTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec3 finalColor = outlineTextureColor.rgb * u_OutlineLightness;\n\t\n\tgl_FragColor = vec4(finalColor,0.0);\n}\n",{a_Position:0,a_Normal:3,a_Texcoord0:2},{u_MvpMatrix:[1,2],u_OutlineTexture:[1,1],u_OutlineWidth:[2,1],u_OutlineLightness:[3,1]});laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE=t.registerMaterialDefine("OUTLINETEXTURE")},t.OUTLINETEXTURE=1,t.OUTLINEWIDTH=2,t.OUTLINELIGHTNESS=3,t.SHADERDEFINE_OUTLINETEXTURE=0,__static(t,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(),CartoonMaterial=function(e){function t(){t.__super.call(this),this.setShaderName("CartoonShader"),this._setColor(5,new Vector4(.6663285,.6544118,1,1)),this._setNumber(6,0),this._setNumber(7,.7956449),this._setNumber(8,.9820514),this._setNumber(9,1)}__class(t,"laya.d3.extension.cartoonRender.CartoonMaterial",!1,BaseMaterial);var n=t.prototype;return __getset(0,n,"specularIntensity",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),__getset(0,n,"specularRange",function(){return this._getNumber(8)},function(e){e=Math.max(.9,Math.min(1,e)),this._setNumber(8,e)}),__getset(0,n,"shadowIntensity",function(){return this._getNumber(7)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(7,e)}),__getset(0,n,"shadowColor",function(){return this._getColor(5)},function(e){this._setColor(5,e)}),__getset(0,n,"shadowRange",function(){return this._getNumber(6)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(6,e)}),__getset(0,n,"specularTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE),this._setTexture(2,e)}),__getset(0,n,"tilingOffset",function(){return this._getColor(4)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(4,e)}),__getset(0,n,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._setTexture(1,e)}),t.__init__=function(){t.SHADERDEFINE_ALBEDOTEXTURE=t.shaderDefines.registerDefine("DIFFUSETEXTURE"),t.SHADERDEFINE_SPECULARTEXTURE=t.shaderDefines.registerDefine("SPECULARTEXTURE")},t.initShader=function(){var e=Shader3D.nameKey.add("CartoonShader"),t=ShaderCompile3D.add(e,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\t\n\tmat3 worldMat = mat3(u_WorldMat);\n\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\tv_Normal = worldMat * a_Normal;\n\tv_Texcoord0 = a_Texcoord0;\n\t\n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n\nuniform vec4 u_ShadowColor;\nuniform float u_ShadowRange;\nuniform float u_ShadowIntensity;\nuniform float u_SpecularRange;\nuniform float u_SpecularIntensity;\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main()\n{\n\tvec3 normal = normalize(v_Normal);\n\tvec3 viewdir = normalize(v_ViewDir);\n\tvec3 lightDir = normalize(u_DirectionLight.Direction);\n\t\n\tvec4 albedoTextureColor = vec4(1.0);\n\t#ifdef ALBEDOTEXTURE\n\t\talbedoTextureColor = texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec4 specularTextureColor = vec4(1.0); \n\t#ifdef SPECULARTEXTURE\n\t\tspecularTextureColor = texture2D(u_SpecularTexture, v_Texcoord0);\n\t#endif\n\t\n\tspecularTextureColor = specularTextureColor;\n\t\n\t//specularTextureColor = vec4(1.0, 1.0, 1.0, 1.0);\n\t\n\tfloat specTexColorG = specularTextureColor.g;\n\t\n\t//Overlay BlendMode 叠加\n\tvec3 albedoColor;\n\talbedoColor.r = albedoTextureColor.r > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.r) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.r * specTexColorG;\n\talbedoColor.g = albedoTextureColor.g > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.g) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.g * specTexColorG;\n\talbedoColor.b = albedoTextureColor.b > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.b) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.b * specTexColorG;\n\t\n\talbedoColor = clamp(albedoColor, 0.0, 1.0);\n\t\n\tfloat nl = max(dot(normal, -lightDir), 0.0);\n\t\n\tfloat shadowValue = nl + specTexColorG - 0.5;\n\tfloat shadow = step(shadowValue, u_ShadowRange);\n\tif(u_ShadowRange > (shadowValue + 0.01))\n\t\tshadow = 1.0;\n\telse if(u_ShadowRange < (shadowValue - 0.01))\n\t\tshadow = 0.0;\n\telse\n\t\tshadow = (u_ShadowRange - (shadowValue - 0.01)) / 0.02;\n\t\t\n\tshadow = clamp(shadow, 0.0, 1.0);\n\t\n\t//specularTextureColor.r 影响高光范围\n\tfloat specular = step(u_SpecularRange, clamp(pow(nl, specularTextureColor.r), 0.0, 1.0));\n\t//specularTextureColor.b 影响高光强度\n\tspecular = step(0.1, specular * specularTextureColor.b);\n\t\n\tvec3 albedoAreaColor = (1.0 - shadow) * albedoColor;\n\tvec3 shadowAreaColor = shadow * albedoColor * u_ShadowColor.rgb * u_ShadowIntensity;\n\tvec3 speculAreaColor = (1.0 - shadow) * albedoColor * u_SpecularIntensity * specular;\n\t\n\tvec3 finalColor = albedoAreaColor + speculAreaColor + shadowAreaColor;\n\t\n\tgl_FragColor = vec4(finalColor, 1.0);\n}\n",{a_Position:0,a_Normal:3,a_Texcoord0:2},{u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlbedoTexture:[1,1],u_SpecularTexture:[2,1],u_ShadowColor:[5,1],u_ShadowRange:[6,1],u_ShadowIntensity:[7,1],u_SpecularRange:[8,1],u_SpecularIntensity:[9,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4]});laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE=t.registerMaterialDefine("ALBEDOTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE=t.registerMaterialDefine("SPECULARTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET=t.registerMaterialDefine("TILINGOFFSET")},t.ALBEDOTEXTURE=1,t.SPECULARTEXTURE=2,t.TILINGOFFSET=4,t.SHADOWCOLOR=5,t.SHADOWRANGE=6,t.SHADOWINTENSITY=7,t.SPECULARRANGE=8,t.SPECULARINTENSITY=9,t.SHADERDEFINE_ALBEDOTEXTURE=0,t.SHADERDEFINE_SPECULARTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,__static(t,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(BaseMaterial.shaderDefines)}]),t}(),WaterDetailMaterial=function(e){function t(){this._startTm=0,t.__super.call(this),laya.d3.water.WaterDetailMaterial.init(),this.setShaderName("WaterDetail"),this.cull=0,this._startTm=Laya.timer.currTimer}__class(t,"laya.d3.water.WaterDetailMaterial",!1,BaseMaterial);var n=t.prototype;return __getset(0,n,"texWaveUVScale",function(){return this._getNumber(15)},function(e){this._setNumber(15,e)}),__getset(0,n,"waveInfoD",function(){return this._getBuffer(13)},function(e){this._setBuffer(13,e)}),__getset(0,n,"waveInfo",function(){return this._getBuffer(12)},function(e){this._setBuffer(12,e)}),__getset(0,n,"currentTm",function(){return this._getNumber(1)},function(e){this._setNumber(1,e-this._startTm)}),t.init=function(){if(!laya.d3.water.WaterDetailMaterial._bInited){laya.d3.water.WaterDetailMaterial._bInited=!0;var e=Shader3D.nameKey.add("WaterDetail");ShaderCompile3D.add(e,"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\n\nvoid main() {\n\tvec3 pos = a_position;\n\tif(pos.z!=0.)pos.y=pos.z;\n\tpos.z=0.5;\n\tgl_Position = vec4(pos,1.);\n    vUv = uv;\n\t//vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t//vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\t//vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n}\n",'precision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\nuniform float u_curTm;\n\n#include "WaveFunction.glsl"\n\nvoid main() {\n\tvec3 wave_N,wave_B,wave_T;\n\tcalcWave(u_curTm, vUv,wave_B,wave_T,wave_N);\n\tgl_FragColor.rgb = normalize(wave_N)*0.5+vec3(0.5);// vec3(0.1,.4,0.1);\n    gl_FragColor.a = 1.0;\n}\n',{a_position:0,a_normal:3,uv:2},{u_curTm:[1,1],u_WaveInfo:[12,1],u_WaveInfoD:[13,1],TEXWAVE_UV_SCALE:[15,1]})}},t.CURTM=1,t.WAVEINFO=12,t.WAVEINFOD=13,t.WAVEMAINDIR=14,t.TEXWAVE_UV_SCALE=15,t._bInited=!1,t}(),VertexBuffer3D=function(a){function r(e,t,n,i){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===i&&(i=!1),r.__super.call(this),this._vertexDeclaration=e,this._vertexCount=t,this._bufferUsage=n,this._bufferType=34962,this._canRead=i,this.memorySize=this._byteLength=this._vertexDeclaration.vertexStride*t,this._bind(),Buffer._gl.bufferData(this._bufferType,this._byteLength,this._bufferUsage),i&&(this._buffer=new Float32Array(this._byteLength/4))}__class(r,"laya.d3.graphics.VertexBuffer3D",!1,a);var e=r.prototype;return e.bindWithIndexBuffer=function(e){e&&e._bind(),this._bind()},e.setData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295),0==n&&4294967295==i||(e=new Float32Array(e.buffer,4*n,i)),this._bind(),Buffer._gl.bufferSubData(this._bufferType,4*t,e),this._canRead)if(0!=t||0!=n||4294967295!=i){var r=this._buffer.length-t;r<i&&(i=r);for(var a=0;a<i;a++)this._buffer[t+a]=e[a]}else this._buffer=e},e.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},e.disposeResource=function(){for(var e=WebGL.mainContext,t=this._vertexDeclaration.getVertexElements(),n=Buffer._enableAtributes,i=0,r=t.length;i<r;i++)n[i]==this._glBuffer&&(e.disableVertexAttribArray(i),n[i]=null);a.prototype.disposeResource.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},__getset(0,e,"canRead",function(){return this._canRead}),__getset(0,e,"vertexCount",function(){return this._vertexCount}),__getset(0,e,"vertexDeclaration",function(){return this._vertexDeclaration}),r.create=function(e,t,n,i){return void 0===n&&(n=35044),void 0===i&&(i=!1),new r(e,t,n,i)},r}(Buffer),IndexBuffer3D=function(e){function a(e,t,n,i){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===n&&(n=35044),void 0===i&&(i=!1),a.__super.call(this),this._indexType=e,this._indexCount=t,this._bufferUsage=n,this._bufferType=34963,this._canRead=i;var r;if("ushort"==e)this._indexTypeByteCount=2;else{if("ubyte"!=e)throw new Error("unidentification index type.");this._indexTypeByteCount=1}r=this._indexTypeByteCount*t,this._byteLength=r,this._bind(),Buffer._gl.bufferData(this._bufferType,r,this._bufferUsage),this.memorySize=i?("ushort"==e?this._buffer=new Uint16Array(t):"ubyte"==e&&(this._buffer=new Uint8Array(t)),2*r):r}__class(a,"laya.d3.graphics.IndexBuffer3D",!1,e);var t=a.prototype;return t.setData=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0==n&&4294967295==i||(e=new Uint16Array(e.buffer,n*r,i))):"ubyte"==this._indexType&&(r=1,0==n&&4294967295==i||(e=new Uint8Array(e.buffer,n*r,i))),this._bind(),Buffer._gl.bufferSubData(this._bufferType,t*r,e),this._canRead)if(0!=t||0!=n||4294967295!=i){var a=this._buffer.length-t;a<i&&(i=a);for(var o=0;o<i;o++)this._buffer[t+o]=e[o]}else this._buffer=e},t.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},t.disposeResource=function(){e.prototype.disposeResource.call(this),this._buffer=null,this.memorySize=0},__getset(0,t,"canRead",function(){return this._canRead}),__getset(0,t,"indexCount",function(){return this._indexCount}),__getset(0,t,"indexTypeByteCount",function(){return this._indexTypeByteCount}),__getset(0,t,"indexType",function(){return this._indexType}),a.INDEXTYPE_UBYTE="ubyte",a.INDEXTYPE_USHORT="ushort",a.create=function(e,t,n,i){return void 0===n&&(n=35044),void 0===i&&(i=!1),new a(e,t,n,i)},a}(Buffer),SolidColorTexture2D=function(e){function t(e){this._color=null,this._pixels=null,t.__super.call(this),this._type=3553,this._width=1,this._height=1,this._size=new Size(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}__class(t,"laya.d3.resource.SolidColorTexture2D",!1,BaseTexture);var n=t.prototype;return n._createWebGlTexture=function(){var e=WebGL.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;WebGLContext.bindTexture(e,this._type,t),e.texImage2D(this._type,0,6408,n,i,0,6408,5121,this._pixels);var o=this._minFifter,s=this._magFifter,l=this._repeat?10497:33071,_=Arith.isPOT(n,i);_?(this._mipmap?-1!=o||(o=9987):-1!=o||(o=9729),-1!=s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this._mipmap&&e.generateMipmap(this._type)):(-1!=o||(o=9729),-1!=s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&WebGLContext.bindTexture(e,r,a),this.memorySize=_?n*i*4*(1+1/3):n*i*4},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.disposeResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},__static(t,["magentaTexture",function(){return this.magentaTexture=new t(new Vector4(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new t(new Vector4(.5,.5,.5,1))}]),t}(),SolidColorTextureCube=function(e){function t(e){this._color=null,this._pixels=null,this._texCount=6,t.__super.call(this),this._type=34067,this._width=1,this._height=1,this._size=new Size(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}__class(t,"laya.d3.resource.SolidColorTextureCube",!1,BaseTexture);var n=t.prototype;return n._createWebGlTexture=function(){var e=WebGL.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;WebGLContext.bindTexture(e,this._type,t),e.texImage2D(34069,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34070,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34071,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34072,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34073,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34074,0,6408,n,i,0,6408,5121,this._pixels);var o=this.minFifter,s=this.magFifter,l=this._repeat?10497:33071,_=Arith.isPOT(n,i);_?(this.mipmap?-1!=o||(o=9987):-1!=o||(o=9729),-1!=s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this.mipmap&&e.generateMipmap(this._type)):(-1!=o||(o=9729),-1!=s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&WebGLContext.bindTexture(e,r,a),this.memorySize=_?n*i*4*(1+1/3)*this._texCount:n*i*4*this._texCount},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.disposeResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},__static(t,["magentaTexture",function(){return this.magentaTexture=new t(new Vector4(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new t(new Vector4(.5,.5,.5,1))}]),t}(),Texture2D=function(e){function r(e,t,n,i){this._canRead=!1,this._image=null,this._pixels=null,void 0===e&&(e=!1),void 0===t&&(t=!0),void 0===n&&(n=6408),void 0===i&&(i=!0),r.__super.call(this),this._type=3553,this._repeat=t,this._canRead=e,this._format=n,this._mipmap=i}__class(r,"laya.d3.resource.Texture2D",!1,BaseTexture);var t=r.prototype;return t._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var e=WebGL.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;switch(WebGLContext.bindTexture(e,this._type,t),this._format){case 6407:case 6408:this._canRead?e.texImage2D(this._type,0,this._format,n,i,0,this._format,5121,this._pixels):e.texImage2D(this._type,0,this._format,this._format,5121,this._image);break;case WebGL.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:e.compressedTexImage2D(this._type,0,this._format,this._width,this._height,0,this._image)}var o=this._minFifter,s=this._magFifter,l=this._repeat?10497:33071,_=Arith.isPOT(n,i);_?(this._mipmap?-1!=o||(o=9987):-1!=o||(o=9729),-1!=s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this._mipmap&&e.generateMipmap(this._type)):(-1!=o||(o=9729),-1!=s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&WebGLContext.bindTexture(e,r,a),this._image.onload=null,this._image=null,this.memorySize=_?n*i*4*(1+1/3):n*i*4},t.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},t.onAsynLoaded=function(e,t,n){if(n){var i=n[0];void 0!==i&&(this._canRead=i);var r=n[1];void 0!==r&&(this._repeat=r);var a=n[2];void 0!==a&&(this._format=a);var o=n[3];null!=o&&(this._mipmap=o)}switch(this._format){case 6407:case 6408:var s=(this._image=t).width,l=t.height;this._width=s,this._height=l,this._size=new Size(s,l),this._canRead&&(Render.isConchApp?t instanceof window.HTMLElement&&(this._pixels=new Uint8Array(t.getImageData(0,0,s,l))):(Browser.canvas.size(s,l),Browser.canvas.clear(),Browser.context.drawImage(t,0,0,s,l),this._pixels=new Uint8Array(Browser.context.getImageData(0,0,s,l).data.buffer)));break;case WebGL.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:var _=new Byte(t);_.readUTFBytes(4),_.readUTFBytes(2),_.getInt16();_.endian="bigEndian",this._width=_.getInt16(),this._height=_.getInt16(),this._size=new Size(this._width,this._height);_.getInt16(),_.getInt16();this._image=new Uint8Array(t,_.pos)}this.recreateResource(),this._endLoaded()},t.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},t.disposeResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},__getset(0,t,"src",function(){return this.url}),__getset(0,t,"_src",function(){return this.url}),r.load=function(e){return Laya.loader.create(e,null,null,r)},r}(),PrimitiveMesh=function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,t.__super.call(this)}__class(t,"laya.d3.resource.models.PrimitiveMesh",!1,BaseMesh);var n=t.prototype;return Laya.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(e){return void 0===e&&(e=0),0==e?this._vertexBuffer:null},n._getVertexBuffers=function(){return null},n._getIndexBuffer=function(){return this._indexBuffer},n._getPositions=function(){var e,t=[],n=this._vertexBuffer.vertexDeclaration.getVertexElements(),i=0;for(i=0;i<n.length;i++){var r=n[i];if("vector3"==r.elementFormat&&0==r.elementUsage){e=r;break}}var a=this._vertexBuffer.getData();for(i=0;i<a.length;i+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var o=i+e.offset/4,s=new Vector3(a[o+0],a[o+1],a[o+2]);t.push(s)}return t},n.getRenderElement=function(e){return this},n.getRenderElementsCount=function(){return 1},n.disposeResource=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this.memorySize=0},n._beforeRender=function(e){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},n._render=function(e){WebGL.mainContext.drawElements(4,this._numberIndices,5123,0),Stat.drawCall++,Stat.trianglesFaces+=this._numberIndices/3},__getset(0,n,"triangleCount",function(){return this._indexBuffer.indexCount/3}),__getset(0,n,"_vertexBufferCount",function(){return 1}),t}(),RenderTexture=function(e){function _(e,t,n,i,r,a,o,s,l){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===n&&(n=6408),void 0===i&&(i=5121),void 0===r&&(r=33189),void 0===a&&(a=!1),void 0===o&&(o=!1),void 0===s&&(s=-1),void 0===l&&(l=-1),_.__super.call(this),this._type=3553,this._width=e,this._height=t,this._size=new Size(e,t),this._surfaceFormat=n,this._surfaceType=i,this._depthStencilFormat=r,this._mipmap=a,this._repeat=o,this._minFifter=s,this._magFifter=l,this.activeResource(),this._alreadyResolved=!0}__class(_,"laya.d3.resource.RenderTexture",!1,BaseTexture);var t=_.prototype;return t.recreateResource=function(){var e=WebGL.mainContext;this._frameBuffer=e.createFramebuffer(),this._source=e.createTexture();var t=WebGLContext.curBindTexTarget,n=WebGLContext.curBindTexValue;WebGLContext.bindTexture(e,this._type,this._source),e.texImage2D(this._type,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var i=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071;if(Arith.isPOT(this._width,this._height)?(this._mipmap?-1!=i||(i=9987):-1!=i||(i=9729),-1!=r||(r=9729),e.texParameteri(this._type,10241,i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,a),e.texParameteri(this._type,10243,a),this._mipmap&&e.generateMipmap(this._type)):(-1!=i||(i=9729),-1!=r||(r=9729),e.texParameteri(this._type,10241,i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),e.bindFramebuffer(36160,this._frameBuffer),e.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,this._depthStencilBuffer),e.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:e.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:e.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:e.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}e.bindFramebuffer(36160,null),t&&n&&WebGLContext.bindTexture(e,t,n),e.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},t.start=function(){WebGL.mainContext.bindFramebuffer(36160,this.frameBuffer),(_._currentRenderTarget=this)._alreadyResolved=!1},t.end=function(){WebGL.mainContext.bindFramebuffer(36160,null),_._currentRenderTarget=null,this._alreadyResolved=!0},t.getData=function(e,t,n,i){var r=WebGL.mainContext;if(r.bindFramebuffer(36160,this._frameBuffer),!(36053==r.checkFramebufferStatus(36160)))return r.bindFramebuffer(36160,null),null;var a=new Uint8Array(this._width*this._height*4);return r.readPixels(e,t,n,i,this._surfaceFormat,this._surfaceType,a),r.bindFramebuffer(36160,null),a},t.disposeResource=function(){if(this._frameBuffer){var e=WebGL.mainContext;e.deleteTexture(this._source),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},__getset(0,t,"source",function(){return this._alreadyResolved?Laya.superGet(BaseTexture,this,"source"):null}),__getset(0,t,"frameBuffer",function(){return this._frameBuffer}),__getset(0,t,"depthStencilBuffer",function(){return this._depthStencilBuffer}),__getset(0,t,"surfaceType",function(){return this._surfaceType}),__getset(0,t,"depthStencilFormat",function(){return this._depthStencilFormat}),__getset(0,t,"surfaceFormat",function(){return this._surfaceFormat}),_._currentRenderTarget=null,_}(),DataTexture2D=function(e){function f(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,f.__super.call(this),this._type=3553}__class(f,"laya.d3.resource.DataTexture2D",!1,BaseTexture);var t=f.prototype;return t.genDebugMipmaps=function(){var e=[];return e.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),e.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),e.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),e.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),e.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),e.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),e.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),e.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),e.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),e.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),e},t._onTextureLoaded=function(e){},t._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var e=WebGL.mainContext;e.getExtension("EXT_shader_texture_lod");var t=this._source=e.createTexture(),n=this._width,i=this._height,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;if(WebGLContext.bindTexture(e,this._type,t),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var o=0;e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null);for(var s=0;s<this._mipmaps.length;s++){if(this._mipmaps[s].byteLength!=l*_*4)throw"mipmap size error  level:"+s;e.texSubImage2D(this._type,0,f.simLodRect[o++],f.simLodRect[o++],f.simLodRect[o++],f.simLodRect[o++],6408,5121,new Uint8Array(this._mipmaps[s]))}this.minFifter=9729,this.magFifter=9729}else{var l=this._width,_=this._height;for(o=0,e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null),s=0;s<this._mipmaps.length;s++){if(this._mipmaps[s].byteLength!=l*_*4)throw"mipmap size error  level:"+s;e.texImage2D(this._type,s,6408,l,_,0,6408,5121,new Uint8Array(this._mipmaps[s])),(l/=2)<1&&(l=1),(_/=2)<1&&(_=1),this.minFifter=9987,this.magFifter=9729}}this.mipmap=!1}else e.texImage2D(this._type,0,6408,n,i,0,6408,5121,new Uint8Array(this._buffer));var h=this._minFifter,c=this._magFifter,u=this._repeat?10497:33071,d=Arith.isPOT(n,i);if(!d)throw"data texture must be POT";this._mipmap||this._mipmaps?-1!=h||(h=9987):-1!=h||(h=9729),-1!=c||(c=9729),e.texParameteri(this._type,10241,h),e.texParameteri(this._type,10240,c),e.texParameteri(this._type,10242,u),this._mipmaps?e.texParameteri(this._type,10243,33071):e.texParameteri(this._type,10243,u),this._mipmap&&e.generateMipmap(this._type),r&&a&&WebGLContext.bindTexture(e,r,a),this.src&&0<this.src.length&&(this._buffer=null),this.memorySize=d?n*i*4*(1+1/3):n*i*4,this._recreateLock=!1},t.recreateResource=function(){if(this._buffer||null!=this._src&&""!=this._src)if(this._needReleaseAgain=!1,this._buffer||this._mipmaps){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0}},t.onAsynLoaded=function(e,t,n){var i;n&&(i=n[0].call(this,t)),i&&(this._width=i.width,this._height=i.height,this._buffer=i.data),this._src=e,this._size=new Size(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._endLoaded()},t.getPixels=function(){return new Uint8Array(this._buffer)},t.disposeResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},__getset(0,t,"src",function(){return this._src}),f.create=function(e,t,n,i,r,a){if(void 0===i&&(i=9729),void 0===r&&(r=9729),void 0===a&&(a=!0),!e||e.byteLength<t*n*4)throw"DataTexture2D create error";var o=new f;return o._buffer=e,o._width=t,o._height=n,o._mipmap=a,o._magFifter=i,o._minFifter=r,o._size=new Size(o._width,o._height),o._conchTexture?alert("怎么给runtime传递datatexture数据"):o.activeResource(),o},f.load=function(e,t,n,i,r){if(void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=9729),void 0===r&&(r=9729),"mipmaps"==Utils.getFileExtension(e)){var a=Laya.loader.create(e,null,null,f,[function(e){this._mipmaps=[];var t=new Uint32Array(e);this._width=t[0];var n=512;if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,n=1024),this._width!=n)throw console.error("现在只支持512x256的环境贴图。当前的是"+t[0]),"现在只支持512x256的环境贴图。当前的是"+t[0];this._height=t[1];for(var i=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var o=i*r*4;if(a+o>e.byteLength)throw"load mipmaps data size error ";var s=new Uint8Array(e,a,o);if(this._mipmaps.push(s),a+=o,1==i&&1==r)break;(i/=2)<1&&(i=1),(r/=2)<1&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){a.simLodInfo=new Float32Array(40);for(var o=0;o<a.simLodInfo.length;)a.simLodInfo[o]=(f.simLodRect[o]+.5)/1024,o++,a.simLodInfo[o]=(f.simLodRect[o]+.5)/256,o++,a.simLodInfo[o]=Math.max(f.simLodRect[o]-1,.1)/1024,o++,a.simLodInfo[o]=Math.max(f.simLodRect[o]-1.5,.1)/256,o++}return a}if("number"==typeof t)return Laya.loader.create(e,null,null,f,[function(e){return this._width=t,this._height=n,this._buffer=e,null}]);if("function"==typeof t)return Laya.loader.create(e,null,null,f,[t]);throw new Error("unknown params.")},f.lodasatlas=!1,__static(f,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]),f}(),Mesh=function(e){function t(){this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,this._skinnedDatas=null,t.__super.call(this),this._subMeshes=[],this._materials=[],this._vertexBuffers=[]}__class(t,"laya.d3.resource.models.Mesh",!1,BaseMesh);var n=t.prototype;return n._getPositions=function(){var e,t,n,i,r,a=[],o=0,s=0,l=0;if(0!=this._vertexBuffers.length){var _=this._vertexBuffers.length;for(o=0;o<_;o++){for(n=(e=this._vertexBuffers[o]).vertexDeclaration.getVertexElements(),s=0;s<n.length;s++)if("vector3"==(i=n[s]).elementFormat&&0==i.elementUsage){t=i;break}for(r=e.getData(),s=0;s<r.length;s+=e.vertexDeclaration.vertexStride/4)l=s+t.offset/4,a.push(new Vector3(r[l+0],r[l+1],r[l+2]))}}else{var h=this._subMeshes.length;for(o=0;o<h;o++){for(n=(e=this._subMeshes[o]._getVertexBuffer()).vertexDeclaration.getVertexElements(),s=0;s<n.length;s++)if("vector3"==(i=n[s]).elementFormat&&0==i.elementUsage){t=i;break}for(r=e.getData(),s=0;s<r.length;s+=e.vertexDeclaration.vertexStride/4)l=s+t.offset/4,a.push(new Vector3(r[l+0],r[l+1],r[l+2]))}}return a},n._setSubMeshes=function(e){this._subMeshes=e,this._subMeshCount=e.length;for(var t=0;t<this._subMeshCount;t++)e[t]._indexInMesh=t;this._positions=this._getPositions(),this._generateBoundingObject()},n.onAsynLoaded=function(e,t,n){var i=t[0],r=t[1];MeshReader.read(i,this,this._materials,this._subMeshes,r),this.completeCreate(),this._endLoaded()},n.getSubMesh=function(e){return this._subMeshes[e]},n.getSubMeshCount=function(){return this._subMeshes.length},n.getRenderElementsCount=function(){return this._subMeshes.length},n.getRenderElement=function(e){return this._subMeshes[e]},n.disposeResource=function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].dispose();this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null},__getset(0,n,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),__getset(0,n,"materials",function(){return this._materials.slice()}),t.load=function(e){return Laya.loader.create(e,null,null,t)},t}(),TextureCube=function(e){function t(){t.__super.call(this),this._type=34067}__class(t,"laya.d3.resource.TextureCube",!1,BaseTexture);var n=t.prototype;return n._onTextureLoaded=function(e){this._images=e;for(var t=2147483647,n=2147483647,i=0;i<6;i++){var r=e[i];t=Math.min(t,r.width),n=Math.min(n,r.height)}this._width=t,this._height=n,this._size=new Size(t,n)},n._createWebGlTexture=function(){var e=0;for(e=0;e<6;e++)if(!this._images[e])throw"create GLTextur err:no data:"+this._images[e];var t=WebGL.mainContext,n=this._source=t.createTexture(),i=this._width,r=this._height,a=WebGLContext.curBindTexTarget,o=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,this._type,n),t.texImage2D(34069,0,6408,6408,5121,this._images[0]),t.texImage2D(34070,0,6408,6408,5121,this._images[1]),t.texImage2D(34071,0,6408,6408,5121,this._images[2]),t.texImage2D(34072,0,6408,6408,5121,this._images[3]),t.texImage2D(34073,0,6408,6408,5121,this._images[4]),t.texImage2D(34074,0,6408,6408,5121,this._images[5]);var s=this.minFifter,l=this.magFifter,_=this._repeat?10497:33071,h=Arith.isPOT(i,r);for(h?(this.mipmap?-1!=s||(s=9987):-1!=s||(s=9729),-1!=l||(l=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,l),t.texParameteri(this._type,10242,_),t.texParameteri(this._type,10243,_),this.mipmap&&t.generateMipmap(this._type)):(-1!=s||(s=9729),-1!=l||(l=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,l),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),a&&o&&WebGLContext.bindTexture(t,a,o),e=0;e<6;e++)this._images[e].onload=null,this._images[e]=null;this.memorySize=h?i*r*4*(1+1/3)*6:i*r*4*6},n.recreateResource=function(){null!=this._url&&(this._createWebGlTexture(),this.completeCreate())},n.onAsynLoaded=function(e,t,n){this._onTextureLoaded(t),this.activeResource(),this._endLoaded()},n.disposeResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},__getset(0,n,"defaulteTexture",function(){return SolidColorTextureCube.grayTexture}),t.load=function(e){return Laya.loader.create(e,null,null,t)},t}(),SkinnedMeshRender=function(i){function p(e){this._hasIndependentBound=!0,p.__super.call(this,e),this._owner.transform.off("worldmatrixneedchanged",this,__bind(this,this._onWorldMatNeedChange)),this._cacheAnimationNodeIndex=[],this._cacheAnimationNode=[],this._localBoundingBoxCorners=__newvec(8,null),this._owner.meshFilter.on("meshchanged",this,__bind(this,this._$3__onMeshChanged))}__class(p,"laya.d3.core.SkinnedMeshRender",!1,i);var e=p.prototype;return e._getCacheAnimationNodes=function(){var e=this._cacheMesh._boneNames,t=e.length;this._cacheAnimationNode.length=t,this._cacheAnimationNodeIndex.length=t;for(var n=this._cacheAnimator._avatarNodes,i=this._cacheAnimator._avatarNodeMap,r=0;r<t;r++){var a=i[e[r]];this._cacheAnimationNode[r]=a,this._cacheAnimationNodeIndex[r]=n.indexOf(a)}},e._offComputeBoneIndexToMeshEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,__bind(this,this._getCacheAnimationNodes)):e.off("loaded",this,__bind(this,this._computeBoneIndexToMeshWithAsyncMesh))},e._computeBoneIndexToMeshWithAsyncAvatar=function(){this._cacheAvatar.loaded?this._computeBoneIndexToMeshWithAsyncMesh():this._cacheAvatar.once("loaded",this,__bind(this,this._computeBoneIndexToMeshWithAsyncMesh))},e._computeBoneIndexToMeshWithAsyncMesh=function(){this._cacheMesh.loaded?this._getCacheAnimationNodes():this._cacheMesh.on("loaded",this,__bind(this,this._getCacheAnimationNodes))},e._$3__onMeshChanged=function(e,t,n){this._cacheMesh=n,t&&!t.loaded&&n.off("loaded",this,__bind(this,this._onMeshLoaded)),n.loaded?this._onMeshLoaded(n):n.on("loaded",this,__bind(this,this._onMeshLoaded)),this._cacheAvatar&&(t&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,t),n&&this._computeBoneIndexToMeshWithAsyncAvatar())},e._onMeshLoaded=function(e){var t=e.subMeshCount;this._subSkinnedDatas=[],this._subSkinnedDatas.length=t;for(var n=0;n<t;n++)for(var i=this._subSkinnedDatas[n]=[],r=e.getSubMesh(n)._boneIndicesList,a=0,o=r.length;a<o;a++)i[a]=new Float32Array(16*r[a].length)},e._setCacheAnimator=function(e){this._cacheAnimator=e,this._rootBone&&(this._rootIndex=e._avatarNodes.indexOf(e._avatarNodeMap[this._rootBone]))},e._setRootBone=function(e){this._rootBone=e,this._cacheAnimator&&(this._rootIndex=this._cacheAnimator._avatarNodes.indexOf(this._cacheAnimator._avatarNodeMap[e]))},e._setCacheAvatar=function(e){this._cacheAvatar!=e&&(this._cacheMesh?(this._cacheAvatar&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,this._cacheMesh),(this._cacheAvatar=e)&&(this._addShaderDefine(SkinnedMeshSprite3D.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=e)},e._calculateBoundingBox=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var e=this._owner.transform,t=e.worldMatrix;if(this._cacheAnimator._canCache){var n=this._cacheAnimator._curAvatarNodeDatas;Utils3D.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,n[this._rootIndex],t)}else Utils3D.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheAnimator._avatarNodeMap[this._rootBone].transform.getWorldMatrix(),t);e.worldMatrix=t,null==this._cacheAnimator._avatarNodeMap[this._rootBone]||null==this._localBoundBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(this._localBoundingBoxCorners)}}else i.prototype._calculateBoundingBox.call(this)},e._calculateBoundingSphere=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var e=this._owner.transform,t=e.worldMatrix;if(this._cacheAnimator._canCache){var n=this._cacheAnimator._curAvatarNodeDatas;Utils3D.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,n[this._rootIndex],t)}else Utils3D.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheAnimator._avatarNodeMap[this._rootBone].transform.getWorldMatrix(),t);e.worldMatrix=t,null==this._cacheAnimator._avatarNodeMap[this._rootBone]||null==this.localBoundSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(this.localBoundSphere)}}else i.prototype._calculateBoundingSphere.call(this)},e._updateOctreeNode=function(){var e=this._treeNode;e&&e.updateObject(this)},e._renderUpdate=function(e){var t,n=this._cacheAnimator,i=this._cacheMesh.subMeshCount,r=this._owner.transform;if(n){var a=n._canCache,o=this._cacheAnimator._curAvatarNodeDatas,s=n.owner;if(this._setShaderValueMatrix4x4(0,s._transform.worldMatrix),t=s.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,t),this._cacheMesh&&this._cacheMesh.loaded&&this._cacheAvatar&&this._cacheAvatar.loaded){var l=0,_=0,h=this._cacheMesh._inverseBindPoses,c=this._cacheMesh._skinnedDatas;if(a)for(l=0,_=h.length;l<_;l++)Utils3D._mulMatrixArray(o[this._cacheAnimationNodeIndex[l]],h[l],c,16*l);else for(l=0,_=h.length;l<_;l++)Utils3D._mulMatrixArray(this._cacheAnimationNode[l].transform.getWorldMatrix(),h[l],c,16*l);for(l=0;l<i;l++){for(var u=this._cacheMesh.getSubMesh(l)._boneIndicesList,d=u.length,f=this._subSkinnedDatas[l],m=0;m<d;m++)p._splitAnimationDatas(u[m],c,f[m]);this._renderElements[l]._skinAnimationDatas=f}}}else this._setShaderValueMatrix4x4(0,r.worldMatrix),t=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,t);return Laya3D.debugMode&&this._renderRenderableBoundBox(),!0},__getset(0,e,"boundingBox",function(){return this._calculateBoundingBox(),this._boundingBox}),__getset(0,e,"boundingSphere",function(){return this._calculateBoundingSphere(),this._boundingSphere}),__getset(0,e,"boundingBoxCenter",function(){var e=this.boundingBox;return Vector3.add(e.min,e.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenter}),__getset(0,e,"localBoundBox",function(){return this._localBoundBox},function(e){(this._localBoundBox=e).getCorners(this._localBoundingBoxCorners)}),p._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;i<r;i++)for(var o=e[i]<<4,s=0;s<16;s++,a++)n[a]=t[o+s]},p}(MeshRender),SkinAnimations=function(n){function D(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._boneIndexToMeshList=null,this._oldVersion=!1,D.__super.call(this),this._boneIndexToMeshList=[]}__class(D,"laya.d3.component.animation.SkinAnimations",!1,n);var e=D.prototype;return e._computeBoneIndexToMeshOnTemplet=function(){this._templet.loaded?this._computeBoneIndexToMeshOnMesh():this._templet.once("loaded",this,__bind(this,this._computeBoneIndexToMeshOnMesh))},e._computeBoneIndexToMeshOnMesh=function(){"LAYAANIMATION:02"==this._templet._aniVersion?this._oldVersion=!1:this._oldVersion=!0;var e=this._owner.meshFilter.sharedMesh;e.loaded?this._computeBoneIndexToMesh(e):e.on("loaded",this,__bind(this,this._computeBoneIndexToMesh))},e._computeBoneIndexToMesh=function(e){var t=e._boneNames;if(t)for(var n=t.length,i=this._templet._anis,r=0,a=i.length;r<a;r++){var o=this._boneIndexToMeshList[r];o||(o=this._boneIndexToMeshList[r]=[]),o.length=n;for(var s=i[r],l=0;l<n;l++)o[l]=s.bone3DMap[t[l]]}},e._getAnimationDatasWithCache=function(e,t,n,i,r){var a=n[i];if(a){var o=a[e];if(o){var s=o[t.id];return s?s[r]:null}return null}return null},e._setAnimationDatasWithCache=function(e,t,n,i,r,a){var o=n[i]||(n[i]={}),s=o[e]||(o[e]={});(s[t.id]||(s[t.id]=[]))[r]=a},e._onAnimationPlayMeshLoaded=function(){for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!1},e._onAnimationPlay=function(){this._ownerMesh._render._addShaderDefine(SkinnedMeshSprite3D.SHADERDEFINE_BONE);var e=this._ownerMesh.meshFilter.sharedMesh;e.loaded?this._onAnimationPlayMeshLoaded():e.once("loaded",this,__bind(this,this._onAnimationPlayMeshLoaded))},e._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh._render._removeShaderDefine(SkinnedMeshSprite3D.SHADERDEFINE_BONE));for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;t<n;t++)e[t]._canDynamicBatch=!0},e._load=function(e){n.prototype._load.call(this,e),this._ownerMesh=e,this._player.on("played",this,__bind(this,this._onAnimationPlay)),this._player.on("stopped",this,__bind(this,this._onAnimationStop)),this._owner.meshFilter.on("meshchanged",this,__bind(this,this._computeBoneIndexToMeshOnTemplet))},e._update=function(e){var t=this._ownerMesh.meshFilter.sharedMesh;if(2==this._player.state&&this._templet&&this._templet.loaded&&t.loaded){var n=this._player.playbackRate*Laya.timer.scale,i=this._player.cachePlayRate,r=this._player.isCache&&i<=n,a=r?this.currentFrameIndex:-1;if(-1==a||this._lastFrameIndex!=a){var o=this.currentAnimationClipIndex,s=this._templet._animationDatasCache[0],l=this._templet._animationDatasCache[1];if(r){var _=this._getAnimationDatasWithCache(i,t,l,o,a);if(_)return this._curAnimationDatas=_,this._curBonesDatas=this._templet.getAnimationDataWithCache(i,s,o,a),void(this._lastFrameIndex=a)}var h=!1;r&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(i,s,o,a),h=!!this._curBonesDatas);var c=this._templet.getNodes(o),u=16*c.length,d=t.InverseAbsoluteBindPoses;this._oldVersion?this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(u)):this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(16*d.length));var f,m,p=0,g=0,E=0,v=t.getSubMeshCount();if(r){for(this._curAnimationDatas=[],this._curAnimationDatas.length=v,p=0;p<v;p++)for(f=this._curAnimationDatas[p]=[],E=(m=t.getSubMesh(p))._boneIndicesList.length,f.length=E,g=0;g<E;g++)f[g]=new Float32Array(16*m._boneIndicesList[g].length);h||(this._curBonesDatas=new Float32Array(u))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],this._tempCurAnimationData.length=v,p=0;p<v;p++)for(f=this._tempCurAnimationData[p]=[],E=(m=t.getSubMesh(p))._boneIndicesList.length,f.length=E,g=0;g<E;g++)f[g]=new Float32Array(16*m._boneIndicesList[g].length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(u)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}if(this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(o))),r?this._templet.getOriginalData(o,this._curOriginalData,this._player._fullFrames[o],a,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(o,this._curOriginalData,this._player.currentPlayTime),this._oldVersion)r&&h?Utils3D._computeAnimationDatasByArrayAndMatrixFastOld(d,this._curBonesDatas,this._curMeshAnimationData):Utils3D._computeBoneAndAnimationDatasByBindPoseMatrxixOld(c,this._curOriginalData,d,this._curBonesDatas,this._curMeshAnimationData);else{var x=this._boneIndexToMeshList[o];r&&h?Utils3D._computeAnimationDatasByArrayAndMatrixFast(d,this._curBonesDatas,this._curMeshAnimationData,x):Utils3D._computeBoneAndAnimationDatasByBindPoseMatrxix(c,this._curOriginalData,d,this._curBonesDatas,this._curMeshAnimationData,x)}for(p=0;p<v;p++){var S=t.getSubMesh(p)._boneIndicesList;for(E=S.length,f=this._curAnimationDatas[p],g=0;g<E;g++)D._splitAnimationDatas(S[g],this._curMeshAnimationData,f[g])}r&&(this._setAnimationDatasWithCache(i,t,l,o,a,this._curAnimationDatas),h||this._templet.setAnimationDataWithCache(i,s,o,a,this._curBonesDatas)),this._lastFrameIndex=a}}},e._preRenderUpdate=function(e){var t=e.renderElement.renderObj;this._curAnimationDatas?t._skinAnimationDatas=this._curAnimationDatas[t._indexInMesh]:t._skinAnimationDatas=null},e._unload=function(e){2==this.player.state&&this._ownerMesh._render._removeShaderDefine(SkinnedMeshSprite3D.SHADERDEFINE_BONE),this._templet&&!this._templet.loaded&&this._templet.off("loaded",this,__bind(this,this._computeBoneIndexToMeshOnMesh));var t=this._ownerMesh.meshFilter.sharedMesh;t.loaded||t.off("loaded",this,__bind(this,this._onAnimationPlayMeshLoaded)),n.prototype._unload.call(this,e),this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null},__getset(0,e,"templet",n.prototype._$get_templet,function(e){this._templet!=e&&(0!=this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._computeBoneIndexToMeshOnTemplet(),this._curOriginalData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),__getset(0,e,"curBonesDatas",function(){return this._curBonesDatas}),D._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;i<r;i++)for(var o=0;o<16;o++,a++)n[a]=t[(e[i]<<4)+o]},D}(KeyframeAnimations),RigidAnimations=function(t){function e(){this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,e.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}__class(e,"laya.d3.component.animation.RigidAnimations",!1,t);var n=e.prototype;return n._init=function(){for(var e=this._templet.getNodes(this.currentAnimationClipIndex),t=this._owner,n=e.length,i=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;a<n;a++){var o=r.slice(i+1,i+1+r[i]);i+=r[i]+1;for(var s=1;s<o.length;s++){o[s];t=t._childs[o[s]]}var l=t.getChildByName(e[a].name);if(!l)break;this._animationSprites[a]=l;var _=this._animationSpritesInitLocalMatrix[a];_||(_=this._animationSpritesInitLocalMatrix[a]=new Matrix4x4),l.transform.localMatrix.cloneTo(_),t=this._owner}},n._animtionPlay=function(){this._templet.loaded?this._init():this._templet.once("loaded",this,__bind(this,this._init))},n._animtionStop=function(){if(this._lastFrameIndex=-1,this._player.returnToZeroStopped){this._curAnimationDatas=null;for(var e=0;e<this._animationSprites.length;e++)this._animationSprites[e].transform.localMatrix=this._animationSpritesInitLocalMatrix[e]}},n._effectAnimation=function(e){for(var t=0,n=this._animationSprites.length;t<n;t++){for(var i=this._animationSprites[t],r=i.transform.localMatrix,a=r.elements,o=0;o<16;o++)a[o]=this._curAnimationDatas[16*t+o];i.transform.localMatrix=r}},n._load=function(e){t.prototype._load.call(this,e),this._player.on("stopped",this,__bind(this,this._animtionStop)),this._player.on("played",this,__bind(this,this._animtionPlay))},n._update=function(e){if(2==this._player.state&&this._templet&&this._templet.loaded){var t=this._player.playbackRate*Laya.timer.scale,n=this._player.cachePlayRate,i=this._player.isCache&&n<=t,r=i?this.currentFrameIndex:-1;if(-1==r||this._lastFrameIndex!=r){var a=this.currentAnimationClipIndex,o=this._templet.getNodes(a),s=this._templet._animationDatasCache;if(i){var l=this._templet.getAnimationDataWithCache(n,s,a,r);if(l)return this._curAnimationDatas=l,this._lastFrameIndex=r,void this._effectAnimation(o)}var _=16*o.length;this._curAnimationDatas=i?new Float32Array(_):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(_)),this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(a))),i?this._templet.getOriginalData(a,this._curOriginalData,this._player._fullFrames[a],r,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(a,this._curOriginalData,this._player.currentPlayTime),Utils3D._computeRootAnimationData(o,this._curOriginalData,this._curAnimationDatas),i&&this._templet.setAnimationDataWithCache(n,s,a,r,this._curAnimationDatas),this._lastFrameIndex=r,this._effectAnimation(o)}}},n._unload=function(e){t.prototype._unload.call(this,e),this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._curAnimationDatas=null},__getset(0,n,"templet",t.prototype._$get_templet,function(e){this._templet!=e&&(0!=this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),__getset(0,n,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=Laya.loader.create(e,null,null,AnimationTemplet);this._templet!=t&&(0!=this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),e}(KeyframeAnimations),SphereCollider=function(e){function t(){this._originalBoundSphere=null,this._transformBoundSphere=null,t.__super.call(this),this._needUpdate=!1}__class(t,"laya.d3.component.physics.SphereCollider",!1,Collider);var n=t.prototype;return n._updateCollider=function(){if(this._needUpdate){var e=NaN,t=this._owner.transform,n=t.scale;e=n.x>=n.y&&n.x>=n.z?n.x:n.y>=n.z?n.y:n.z,Vector3.transformCoordinate(this._originalBoundSphere.center,t.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*e,this._needUpdate=!1}},n._onWorldMatrixChanged=function(){for(var e in this._needUpdate=!0,this._runtimeCollisonMap)this._runtimeCollisonTestMap[e]=!0,this._runtimeCollisonMap[e]._runtimeCollisonTestMap[this.id]=!0},n._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),this._originalBoundSphere=new BoundSphere(new Vector3(0,0,0),.5),this._transformBoundSphere=new BoundSphere(new Vector3(0,0,0),.5),e.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatrixChanged)),this._needUpdate=!0},n._getType=function(){return 0},n._collisonTo=function(e){switch(e._getType()){case 0:return 0!=Collision.sphereContainsSphere(this.boundSphere,e.boundSphere);case 1:return 0!=e.boundBox.containsSphere(this.boundSphere);case 2:var t=e;if(0==Collision.sphereContainsBox(this.boundSphere,t._boundBox))return!1;for(var n=t.mesh._positions,i=0,r=n.length;i<r;i++)if(1==Collision.sphereContainsPoint(this.boundSphere,n[i]))return!0;return!1;default:throw new Error("SphereCollider:unknown collider type.")}},n._cloneTo=function(e){var t=e;t.radius=this.radius;var n=t.center;this.center.cloneTo(n),t.center=n},n.raycast=function(e,t,n){void 0===n&&(n=179e306),this._updateCollider();var i=this._transformBoundSphere.intersectsRayPoint(e,t.position);return-1!=i&&i<=n?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},__getset(0,n,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere}),__getset(0,n,"radius",function(){return this._originalBoundSphere.radius},function(e){this._originalBoundSphere.radius=e}),__getset(0,n,"center",function(){return this._originalBoundSphere.center},function(e){this._originalBoundSphere.center=e}),t}(),MeshCollider=function(e){function S(){this._transformBoundingBox=null,this._mesh=null,S.__super.call(this),this._transformBoundingBox=new BoundBox(new Vector3,new Vector3),this._needUpdate=!1}__class(S,"laya.d3.component.physics.MeshCollider",!1,Collider);var t=S.prototype;return t._updateBoundBoxCollider=function(){if(this._needUpdate){for(var e=this._owner.transform.worldMatrix,t=this._mesh.boundingBoxCorners,n=0;n<8;n++)Vector3.transformCoordinate(t[n],e,S._tempBoundBoxCorners[n]);BoundBox.createfromPoints(S._tempBoundBoxCorners,this._transformBoundingBox),this._needUpdate=!1}},t._raycastMesh=function(e,t,n,i){void 0===i&&(i=179e306);var r=t.transform.worldMatrix,a=S._tempMatrix4x40;r.invert(a);var o=e.origin,s=e.direction,l=S._tempRay0;Vector3.transformCoordinate(o,a,l.origin),Vector3.TransformNormal(s,a,l.direction);for(var _=Number.MAX_VALUE,h=0,c=this._mesh.getRenderElementsCount();h<c;h++){var u=this._mesh.getRenderElement(h),d=u._getVertexBuffer(0),f=d.getData(),m=u._getIndexBuffer().getData(),p=S._tempRaycastHit;if(Picker.rayIntersectsPositionsAndIndices(l,f,d.vertexDeclaration,m,p)){Vector3.transformCoordinate(p.position,r,p.position);var g=S._tempVector30;Vector3.subtract(o,p.position,g);var E=Vector3.scalarLength(g);if(E<i&&E<_){p.distance=E,p.sprite3D=t;var v=p.trianglePositions;Vector3.transformCoordinate(v[0],r,v[0]),Vector3.transformCoordinate(v[1],r,v[1]),Vector3.transformCoordinate(v[2],r,v[2]);var x=p.triangleNormals;return Vector3.transformCoordinate(x[0],r,x[0]),Vector3.transformCoordinate(x[1],r,x[1]),Vector3.transformCoordinate(x[2],r,x[2]),_=E,p.cloneTo(n),!0}return!1}}return!1},t._onWorldMatrixChanged=function(){this._needUpdate=!0},t._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),e.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatrixChanged)),this._needUpdate=!0},t._getType=function(){return 2},t._collisonTo=function(e){var t=0,n=0,i=this.mesh._positions;switch(e._getType()){case 0:var r=e;if(0==Collision.sphereContainsBox(r.boundSphere,this._boundBox))return!1;for(t=0,n=i.length;t<n;t++)if(1==Collision.sphereContainsPoint(r.boundSphere,i[t]))return!0;return!1;case 1:var a=e;if(0==a.boundBox.containsBoundBox(this._boundBox))return!1;for(t=0,n=i.length;t<n;t++)if(1==a.boundBox.containsPoint(i[t]))return!0;return!1;case 2:var o=e;return 1!=Collision.intersectsBoxAndBox(o._boundBox,this._boundBox);default:throw new Error("MeshCollider:unknown collider type.")}},t._cloneTo=function(e){e.mesh=this._mesh},t.raycast=function(e,t,n){if(void 0===n&&(n=179e306),null==this._mesh||!this._mesh.loaded)return!1;var i=Collision.intersectsRayAndBoxRD(e,this._boundBox);return!!(-1!=i&&i<=n&&this._raycastMesh(e,this._owner,t,n))||(t.distance=-1,t.sprite3D=null,!1)},__getset(0,t,"mesh",function(){return this._mesh},function(e){this._mesh=e}),__getset(0,t,"_boundBox",function(){return this._updateBoundBoxCollider(),this._transformBoundingBox}),__static(S,["_tempRay0",function(){return this._tempRay0=new Ray(new Vector3,new Vector3)},"_tempVector30",function(){return this._tempVector30=new Vector3},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_tempRaycastHit",function(){return this._tempRaycastHit=new RaycastHit},"_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]}]),S}(),BoxCollider=function(e){function l(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,l.__super.call(this),this._needUpdate=!1}__class(l,"laya.d3.component.physics.BoxCollider",!1,Collider);var t=l.prototype;return t._updateCollider=function(){if(this._needUpdate){var e=this._transformOrientedBoundBox.transformation,t=this._owner.transform,n=t.rotation,i=t.scale,r=this.center.elements;0==r[0]&&0==r[1]&&0==r[2]?Matrix4x4.createAffineTransformation(t.position,n,Vector3.ONE,e):(Vector3.multiply(this.center,i,l._deviationV3),Vector3.transformQuat(l._deviationV3,n,l._deviationV3),Vector3.add(t.position,l._deviationV3,l._deviationV3),Matrix4x4.createAffineTransformation(l._deviationV3,n,Vector3.ONE,e)),this._transformOrientedBoundBox.transformation=e;var a=this._transformOrientedBoundBox.extents.elements,o=this._size.elements,s=i.elements;a[0]=.5*o[0]*s[0],a[1]=.5*o[1]*s[1],a[2]=.5*o[2]*s[2],this._needUpdate=!1}},t._onWorldMatrixChanged=function(){for(var e in this._needUpdate=!0,this._runtimeCollisonMap)this._runtimeCollisonTestMap[e]=!0,this._runtimeCollisonMap[e]._runtimeCollisonTestMap[this.id]=!0},t._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),this._transformOrientedBoundBox=new OrientedBoundBox(new Vector3,new Matrix4x4),this._size=new Vector3,this.center=new Vector3,e.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatrixChanged)),this._needUpdate=!0},t._getType=function(){return 1},t._collisonTo=function(e){switch(e._getType()){case 0:return 0!=this.boundBox.containsSphere(e.boundSphere);case 1:return 0!=this.boundBox.containsOrientedBoundBox(e.boundBox);case 2:var t=e;if(0==this.boundBox.containsBoundBox(t._boundBox))return!1;for(var n=e.mesh._positions,i=0,r=n.length;i<r;i++)if(1==this.boundBox.containsPoint(n[i]))return!0;return!1;default:throw new Error("BoxCollider:unknown collider type.")}},t._cloneTo=function(e){var t=e,n=t.size;this.size.cloneTo(n),t.size=n,this.center.cloneTo(t.center)},t.raycast=function(e,t,n){void 0===n&&(n=179e306),this._updateCollider();var i=this._transformOrientedBoundBox.intersectsRay(e,t.position);return-1!=i&&i<=n?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},t.setFromBoundBox=function(e){OrientedBoundBox.createByBoundBox(e,this._transformOrientedBoundBox);var t=this._transformOrientedBoundBox.extents;this._size=new Vector3(2*t.x,2*t.y,2*t.z),this.center=new Vector3,Vector3.add(e.min,e.max,this.center),Vector3.scale(this.center,.5,this.center),this._needUpdate=!0},__getset(0,t,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),__getset(0,t,"size",function(){return this._size},function(e){this._size=e,this._needUpdate=!0}),__static(l,["_deviationV3",function(){return this._deviationV3=new Vector3},"_obbCenterV3",function(){return this._obbCenterV3=new Vector3}]),l}(),RenderableSprite3D=function(n){function t(e){this._render=null,this._geometryFilter=null,t.__super.call(this,e)}__class(t,"laya.d3.core.RenderableSprite3D",!1,n);var e=t.prototype;return e._addToInitStaticBatchManager=function(){},e._setBelongScene=function(e){n.prototype._setBelongScene.call(this,e),e._renderableSprite3Ds.push(this),this._render._applyLightMapParams()},e._setUnBelongScene=function(){var e=this._scene._renderableSprite3Ds,t=e.indexOf(this);e.splice(t,1),this._render._removeShaderDefine(laya.d3.core.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),n.prototype._setUnBelongScene.call(this)},e._update=function(e){(e.owner=this)._activeInHierarchy&&(this._updateComponents(e),this._render._updateOctreeNode(),this._lateUpdateComponents(e),Stat.spriteCount++,this._childs.length&&this._updateChilds(e))},e.destroy=function(e){void 0===e&&(e=!0),n.prototype.destroy.call(this,e),this._render._destroy(),this._render=null},t.__init__=function(){t.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=t.shaderDefines.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),t.SAHDERDEFINE_LIGHTMAP=t.shaderDefines.registerDefine("LIGHTMAP")},t.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=2,t.SAHDERDEFINE_LIGHTMAP=4,t.LIGHTMAPSCALEOFFSET=2,t.LIGHTMAP=3,__static(t,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1}]),t}(Sprite3D),BaseCamera=function(t){function n(e,t){n.__super.call(this),void 0===e&&(e=.3),void 0===t&&(t=1e3),this._tempVector3=new Vector3,this._position=new Vector3,this._up=new Vector3,this._forward=new Vector3,this._right=new Vector3,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=Size.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=t,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),Laya.stage.on("resize",this,__bind(this,this._onScreenSizeChanged))}__class(n,"laya.d3.core.BaseCamera",!1,t);var e=n.prototype;return e._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;n<t;n++)if(e[n].renderingOrder>e[t].renderingOrder){var i=e[n];e[n]=e[t],e[t]=i}},e._calculateProjectionMatrix=function(){},e._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},e._prepareCameraToRender=function(){Layer._currentCameraCullingMask=this.cullingMask;var e=this._shaderValues;e.setValue(0,this.transform.position.elements),e.setValue(5,this.forward.elements),e.setValue(6,this.up.elements)},e._prepareCameraViewProject=function(e,t){var n=this._shaderValues;n.setValue(1,e.elements),n.setValue(2,t.elements)},e._renderCamera=function(e,t,n){},e.addLayer=function(e){29!=e.number&&30!=e.number&&(this.cullingMask=this.cullingMask|e.mask)},e.removeLayer=function(e){29!=e.number&&30!=e.number&&(this.cullingMask=this.cullingMask&~e.mask)},e.addAllLayers=function(){this.cullingMask=2147483647},e.removeAllLayers=function(){this.cullingMask=0|Layer.getLayerByNumber(29).mask|Layer.getLayerByNumber(30).mask},e.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},e.moveForward=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=e,this.transform.translate(this._tempVector3)},e.moveRight=function(e){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=e,this.transform.translate(this._tempVector3)},e.moveVertical=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=e,this.transform.translate(this._tempVector3,!1)},e._addSelfRenderObjects=function(){var e=this.scene._cameraPool,t=e.length;if(0<t){for(var n=t-1;0<=n;n--)if(this.renderingOrder<=e[n].renderingOrder){e.splice(n+1,0,this);break}}else e.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},e._clearSelfRenderObjects=function(){var e=this.scene._cameraPool;e.splice(e.indexOf(this),1)},e.destroy=function(e){void 0===e&&(e=!0),this._sky&&this._sky.destroy(),this.renderTarget=null,Laya.stage.off("resize",this,__bind(this,this._onScreenSizeChanged)),t.prototype.destroy.call(this,e)},__getset(0,e,"renderingOrder",function(){return this._renderingOrder},function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}),__getset(0,e,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}),__getset(0,e,"orthographic",function(){return this._orthographic},function(e){this._orthographic=e,this._calculateProjectionMatrix()}),__getset(0,e,"renderTargetSize",function(){return this._renderTargetSize},function(e){null!=this.renderTarget&&this._renderTargetSize,this._renderTargetSize=e,this._calculateProjectionMatrix()}),__getset(0,e,"farPlane",function(){return this._farPlane},function(e){this._farPlane=e,this._calculateProjectionMatrix()}),__getset(0,e,"fieldOfView",function(){return this._fieldOfView},function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}),__getset(0,e,"renderTarget",function(){return this._renderTarget},function(e){null!=(this._renderTarget=e)&&(this._renderTargetSize=e.size)}),__getset(0,e,"up",function(){var e=this.transform.worldMatrix.elements,t=this._up.elements;return t[0]=e[4],t[1]=e[5],t[2]=e[6],this._up}),__getset(0,e,"nearPlane",function(){return this._nearPlane},function(e){this._nearPlane=e,this._calculateProjectionMatrix()}),__getset(0,e,"right",function(){var e=this.transform.worldMatrix.elements,t=this._right.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],this._right}),__getset(0,e,"forward",function(){var e=this.transform.worldMatrix.elements,t=this._forward.elements;return t[0]=-e[8],t[1]=-e[9],t[2]=-e[10],this._forward}),__getset(0,e,"position",function(){var e=this.transform.worldMatrix.elements,t=this._position.elements;return t[0]=e[12],t[1]=e[13],t[2]=e[14],this._position}),__getset(0,e,"sky",function(){return this._sky},function(e){(this._sky=e)._ownerCamera=this}),n.CAMERAPOS=0,n.VIEWMATRIX=1,n.PROJECTMATRIX=2,n.VPMATRIX=3,n.VPMATRIX_NO_TRANSLATE=4,n.CAMERADIRECTION=5,n.CAMERAUP=6,n.ENVIRONMENTDIFFUSE=7,n.ENVIRONMENTSPECULAR=8,n.SIMLODINFO=9,n.DIFFUSEIRRADMATR=10,n.DIFFUSEIRRADMATG=11,n.DIFFUSEIRRADMATB=12,n.HDREXPOSURE=13,n.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",n.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",n.CLEARFLAG_SOLIDCOLOR=0,n.CLEARFLAG_SKY=1,n.CLEARFLAG_DEPTHONLY=2,n.CLEARFLAG_NONE=3,__static(n,["_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new Matrix4x4(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new Matrix4x4},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new Matrix4x4}]),n}(Sprite3D),LightSprite=function(e){function t(){this._intensityColor=null,this._intensity=NaN,this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this._lightmapBakedType=0,this.color=null,t.__super.call(this),this._intensity=1,this._intensityColor=new Vector3,this.color=new Vector3(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0,this._lightmapBakedType=t.LIGHTMAPBAKEDTYPE_REALTIME}__class(t,"laya.d3.core.light.LightSprite",!1,Sprite3D);var n=t.prototype;return n._parseCustomProps=function(e,t,n,i){var r=n.color,a=this.color.elements;a[0]=r[0],a[1]=r[1],a[2]=r[2]},n._addSelfRenderObjects=function(){this.lightmapBakedType!=t.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._addLight(this)},n._clearSelfRenderObjects=function(){this.lightmapBakedType!=t.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._removeLight(this)},n._prepareToScene=function(e){return!1},__getset(0,n,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}),__getset(0,n,"lightmapBakedType",function(){return this._lightmapBakedType},function(e){this._lightmapBakedType!=e&&(this._lightmapBakedType=e,this._activeInHierarchy&&(e!=t.LIGHTMAPBAKEDTYPE_BAKED?this._scene._addLight(this):this._scene._removeLight(this)))}),__getset(0,n,"shadowPCFType",function(){return this._shadowMapPCFType},function(e){this._shadowMapPCFType=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(e)}),__getset(0,n,"shadowPSSMCount",function(){return this._shadowMapCount},function(e){this._shadowMapCount=e,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.PSSMNum=e)}),__getset(0,n,"intensity",function(){return this._intensity},function(e){this._intensity=e}),__getset(0,n,"shadow",function(){return this._shadow},function(e){throw new Error("LightSprite: must override it.")}),__getset(0,n,"shadowResolution",function(){return this._shadowMapSize},function(e){this._shadowMapSize=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(e)}),__getset(0,n,"shadowDistance",function(){return this._shadowFarPlane},function(e){this._shadowFarPlane=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(e)}),t.LIGHTMAPBAKEDTYPE_REALTIME=0,t.LIGHTMAPBAKEDTYPE_MIXED=1,t.LIGHTMAPBAKEDTYPE_BAKED=2,t}(),Terrain=function(e){function _(e){this._terrainRes=null,this._lightmapScaleOffset=null,_.__super.call(this),this._lightmapScaleOffset=new Vector4(1,1,0,0),e&&((this._terrainRes=e).loaded?this.buildTerrain(e):e.once("loaded",this,__bind(this,this.buildTerrain)))}__class(_,"laya.d3.terrain.Terrain",!1,Sprite3D);var t=_.prototype;return t._parseCustomProps=function(e,t,n,i){this.terrainRes=Loader.getRes(t[n.dataPath]);var r=n.lightmapIndex;null!=r&&this.setLightmapIndex(r);var a=n.lightmapScaleOffset;a&&this.setLightmapScaleOffset(new Vector4(a[0],a[1],a[2],a[3]))},t.setLightmapIndex=function(e){for(var t=0;t<this._childs.length;t++){this._childs[t].terrainRender.lightmapIndex=e}},t.setLightmapScaleOffset=function(e){if(e){e.cloneTo(this._lightmapScaleOffset);for(var t=0;t<this._childs.length;t++){this._childs[t].terrainRender.lightmapScaleOffset=this._lightmapScaleOffset}}},t.disableLight=function(){for(var e=0,t=this._childs.length;e<t;e++)for(var n=this._childs[e],i=0,r=n._render.sharedMaterials.length;i<r;i++){n._render.sharedMaterials[i].disableLight()}},t.buildTerrain=function(e){for(var t=e._chunkNumX,n=e._chunkNumZ,i=e._heightData,r=0,a=0;a<n;a++)for(var o=0;o<t;o++){for(var s=new TerrainChunk(o,a,e._gridSize,i._terrainHeightData,i._width,i._height,e._cameraCoordinateInverse),l=e._chunkInfos[r++],_=0;_<l.alphaMap.length;_++){var h=l.detailID[_].length,c=0<h?e._detailTextureInfos[l.detailID[_][0]].diffuseTexture:null,u=1<h?e._detailTextureInfos[l.detailID[_][1]].diffuseTexture:null,d=2<h?e._detailTextureInfos[l.detailID[_][2]].diffuseTexture:null,f=3<h?e._detailTextureInfos[l.detailID[_][3]].diffuseTexture:null,m=0<h?e._detailTextureInfos[l.detailID[_][0]].scale:null,p=1<h?e._detailTextureInfos[l.detailID[_][1]].scale:null,g=2<h?e._detailTextureInfos[l.detailID[_][2]].scale:null,E=3<h?e._detailTextureInfos[l.detailID[_][3]].scale:null;s.buildRenderElementAndMaterial(h,l.normalMap,l.alphaMap[_],c,u,d,f,e._materialInfo.ambientColor,e._materialInfo.diffuseColor,e._materialInfo.specularColor,m?m.x:1,m?m.y:1,p?p.x:1,p?p.y:1,g?g.x:1,g?g.y:1,E?E.x:1,E?E.y:1)}s.terrainRender.receiveShadow=!0,s.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(s)}},t.width=function(){return this._terrainRes._chunkNumX*TerrainLeaf.CHUNK_GRID_NUM*this._terrainRes._gridSize},t.depth=function(){return this._terrainRes._chunkNumZ*TerrainLeaf.CHUNK_GRID_NUM*this._terrainRes._gridSize},t.getHeightXZ=function(e,t){if(!this._terrainRes||!this._terrainRes.loaded)return NaN;if(e-=this.transform.position.x,t-=this.transform.position.z,_.__VECTOR3__||(_.__VECTOR3__=new Vector3),_.__VECTOR3__.elements[0]=e,_.__VECTOR3__.elements[1]=0,_.__VECTOR3__.elements[2]=t,Vector3.transformV3ToV3(_.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX_INV__,_.__VECTOR3__),e=_.__VECTOR3__.elements[0],t=_.__VECTOR3__.elements[2],e<0||e>this.width()||t<0||t>this.depth())return NaN;var n=this._terrainRes._gridSize,i=parseInt(""+e/n),r=parseInt(""+t/n),a=e-i*n,o=t-r*n,s=NaN,l=this._terrainRes._heightData;return n<a+o?(s=l._terrainHeightData[(r+1-1)*l._width+i+1])+(l._terrainHeightData[(r+1-1)*l._width+i]-s)*((n-a)/n)+(l._terrainHeightData[(r-1)*l._width+i+1]-s)*((n-o)/n):(s=l._terrainHeightData[Math.max(0,r-1)*l._width+i])+(l._terrainHeightData[Math.min(l._width*l._height-1,(r+1-1)*l._width+i)]-s)*(o/n)+(l._terrainHeightData[Math.min(l._width*l._height-1,Math.max(0,r-1)*l._width+i+1)]-s)*(a/n)},__getset(0,t,"terrainRes",null,function(e){e&&((this._terrainRes=e).loaded?this.buildTerrain(e):e.once("loaded",this,__bind(this,this.buildTerrain)))}),_.load=function(e){return Laya.loader.create(e,null,null,_,null,1,!1)},_.RENDER_LINE_MODEL=!1,_.LOD_TOLERANCE_VALUE=4,_.LOD_DISTANCE_FACTOR=2,_.__VECTOR3__=null,_}(),CylinderMesh=function(e){function i(e,t,n){this._radius=NaN,this._height=NaN,void(this._slices=0)===e&&(e=.5),void 0===t&&(t=2),void 0===n&&(n=32),i.__super.call(this),this._radius=e,this._height=t,this._slices=n,this.recreateResource(),this._positions=this._getPositions(),this._generateBoundingObject()}__class(i,"laya.d3.resource.models.CylinderMesh",!1,PrimitiveMesh);var t=i.prototype;return t.recreateResource=function(){this._numberVertices=this._slices+1+1+2*(this._slices+1)+(this._slices+1+1),this._numberIndices=3*this._slices+6*this._slices+3*this._slices;for(var e=VertexPositionNormalTexture.vertexDeclaration,t=e.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Uint16Array(this._numberIndices),r=2*Math.PI/this._slices,a=this._height/2,o=0,s=0,l=0,_=0,h=0,c=0,u=0,d=0;d<=this._slices;d++)0==d&&(n[c++]=0,n[c++]=a,n[c++]=0,n[c++]=0,n[c++]=1,n[c++]=0,n[c++]=.5,n[c++]=.5),o=d*r,l=Math.cos(o)*this._radius,_=a,h=Math.sin(o)*this._radius,n[c++]=l,n[c++]=_,n[c++]=h,n[c++]=0,n[c++]=1,n[c++]=0,n[c++]=.5+.5*Math.cos(o),n[c++]=.5+.5*Math.sin(o);for(var f=0;f<this._slices;f++)i[u++]=0,i[u++]=f+1,i[u++]=f+2;s+=this._slices+1+1;for(var m=0;m<=this._slices;m++)o=m*r,l=Math.cos(o+Math.PI)*this._radius,_=a,h=Math.sin(o+Math.PI)*this._radius,n[c++]=l,n[c+8*(this._slices+1)-1]=l,n[c++]=_,n[c+8*(this._slices+1)-1]=-_,n[c++]=h,n[c+8*(this._slices+1)-1]=h,n[c++]=l,n[c+8*(this._slices+1)-1]=l,n[c++]=0,n[c+8*(this._slices+1)-1]=0,n[c++]=h,n[c+8*(this._slices+1)-1]=h,n[c++]=1-1*m/this._slices,n[c+8*(this._slices+1)-1]=1-1*m/this._slices,n[c++]=0,n[c+8*(this._slices+1)-1]=1;c+=8*(this._slices+1);for(var p=0;p<this._slices;p++)i[u++]=p+s+(this._slices+1),i[u++]=p+s+1,i[u++]=p+s,i[u++]=p+s+(this._slices+1),i[u++]=p+s+(this._slices+1)+1,i[u++]=p+s+1;s+=2*(this._slices+1);for(var g=0;g<=this._slices;g++)0==g&&(n[c++]=0,n[c++]=-a,n[c++]=0,n[c++]=0,n[c++]=-1,n[c++]=0,n[c++]=.5,n[c++]=.5),o=g*r,l=Math.cos(o+Math.PI)*this._radius,_=-a,h=Math.sin(o+Math.PI)*this._radius,n[c++]=l,n[c++]=_,n[c++]=h,n[c++]=0,n[c++]=-1,n[c++]=0,n[c++]=.5+.5*Math.cos(o),n[c++]=.5+.5*Math.sin(o);for(var E=0;E<this._slices;E++)i[u++]=0+s,i[u++]=E+2+s,i[u++]=E+1+s;s+=this._slices+1+1,this._vertexBuffer=new VertexBuffer3D(e,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},__getset(0,t,"slices",function(){return this._slices},function(e){this._slices!=e&&(this._slices=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"height",function(){return this._height},function(e){this._height!=e&&(this._height=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"radius",function(){return this._radius},function(e){this._radius!=e&&(this._radius=e,this.releaseResource(),this.activeResource())}),i}(),CapsuleMesh=function(e){function r(e,t,n,i){this._radius=NaN,this._height=NaN,this._slices=0,void(this._stacks=0)===e&&(e=.5),void 0===t&&(t=2),void 0===n&&(n=16),void 0===i&&(i=32),r.__super.call(this),this._radius=e,this._height=t<2*e?2*e:t,this._stacks=n,this._slices=i,this.recreateResource(),this._positions=this._getPositions(),this._generateBoundingObject()}__class(r,"laya.d3.resource.models.CapsuleMesh",!1,PrimitiveMesh);var t=r.prototype;return t.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this.slices+1)*2+2*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2*2+2*this._slices*3;var e=VertexPositionNormalTexture.vertexDeclaration,t=e.vertexStride/4,n=new Float32Array(this._numberVertices*t),i=new Uint16Array(this._numberIndices),r=Math.PI/2/this._stacks,a=2*Math.PI/this._slices,o=this._height/2-this._radius,s=0,l=0,_=0,h=0,c=0,u=0,d=0,f=0;for(d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)s=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(d*r),_=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),n[h++]=s,n[h++]=l+o,n[h++]=_,n[h++]=s,n[h++]=l,n[h++]=_,n[h++]=1-f/this._slices,n[h++]=(1-d/this._stacks)*(Math.PI*this._radius/2/(this._height+Math.PI*this._radius)),d<this._stacks&&(i[c++]=d*(this._slices+1)+f+(this._slices+1),i[c++]=d*(this._slices+1)+f,i[c++]=d*(this._slices+1)+f+1,i[c++]=d*(this._slices+1)+f+this._slices,i[c++]=d*(this._slices+1)+f,i[c++]=d*(this._slices+1)+f+(this._slices+1));for(u+=(this._stacks+1)*(this._slices+1),d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)s=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(-d*r),_=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),n[h++]=s,n[h++]=l-o,n[h++]=_,n[h++]=s,n[h++]=l,n[h++]=_,n[h++]=1-f/this._slices,n[h++]=(d/this._stacks*(Math.PI*this._radius/2)+(this._height+Math.PI*this._radius/2))/(this._height+Math.PI*this._radius),d<this._stacks&&(i[c++]=u+d*(this._slices+1)+f,i[c++]=u+d*(this._slices+1)+f+(this._slices+1),i[c++]=u+d*(this._slices+1)+f+1,i[c++]=u+d*(this._slices+1)+f,i[c++]=u+d*(this._slices+1)+f+this._slices,i[c++]=u+d*(this._slices+1)+f+(this._slices+1));for(u+=(this._stacks+1)*(this._slices+1),f=0;f<=this._slices;f++)s=this._radius*Math.cos(f*a+Math.PI),l=o,_=this._radius*Math.sin(f*a+Math.PI),n[h++]=s,n[h+8*(this._slices+1)-1]=s,n[h++]=l,n[h+8*(this._slices+1)-1]=-l,n[h++]=_,n[h+8*(this._slices+1)-1]=_,n[h++]=s,n[h+8*(this._slices+1)-1]=s,n[h++]=0,n[h+8*(this._slices+1)-1]=0,n[h++]=_,n[h+8*(this._slices+1)-1]=_,n[h++]=1-1*f/this._slices,n[h+8*(this._slices+1)-1]=1-1*f/this._slices,n[h++]=Math.PI*this._radius/2/(this._height+Math.PI*this._radius),n[h+8*(this._slices+1)-1]=(Math.PI*this._radius/2+this._height)/(this._height+Math.PI*this._radius);for(f=0;f<this._slices;f++)i[c++]=f+u+(this._slices+1),i[c++]=f+u+1,i[c++]=f+u,i[c++]=f+u+(this._slices+1),i[c++]=f+u+(this._slices+1)+1,i[c++]=f+u+1;u+=2*(this._slices+1),this._vertexBuffer=new VertexBuffer3D(e,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},__getset(0,t,"stacks",function(){return this._stacks},function(e){this._stacks!=e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"slices",function(){return this._slices},function(e){this._slices!=e&&(this._slices=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"height",function(){return this._height},function(e){this._height!=e&&(this._height=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"radius",function(){return this._radius},function(e){this._radius!=e&&(this._radius=e,this.releaseResource(),this.activeResource())}),r}(),PlaneMesh=function(e){function r(e,t,n,i){this._long=NaN,this._width=NaN,this._stacks=0,void(this._slices=0)===e&&(e=10),void 0===t&&(t=10),void 0===n&&(n=10),void 0===i&&(i=10),r.__super.call(this),this._long=e,this._width=t,this._stacks=n,this._slices=i,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}__class(r,"laya.d3.resource.models.PlaneMesh",!1,PrimitiveMesh);var t=r.prototype;return t.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=this._stacks*this._slices*2*3;for(var e=new Uint16Array(this._numberIndices),t=VertexPositionNormalTexture.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=this._long/2,a=this._width/2,o=this._long/this._stacks,s=this._width/this._slices,l=0,_=0;_<=this._slices;_++)for(var h=0;h<=this._stacks;h++)i[l++]=h*o-r,i[l++]=0,i[l++]=_*s-a,i[l++]=0,i[l++]=1,i[l++]=0,i[l++]=1*h/this._stacks,i[l++]=1*_/this._slices;var c=0;for(_=0;_<this._slices;_++)for(h=0;h<this._stacks;h++)e[c++]=(_+1)*(this._stacks+1)+h,e[c++]=_*(this._stacks+1)+h,e[c++]=(_+1)*(this._stacks+1)+h+1,e[c++]=_*(this._stacks+1)+h,e[c++]=_*(this._stacks+1)+h+1,e[c++]=(_+1)*(this._stacks+1)+h+1;this._vertexBuffer=new VertexBuffer3D(t,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},__getset(0,t,"stacks",function(){return this._stacks},function(e){this._stacks!=e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"slices",function(){return this._slices},function(e){this._slices!=e&&(this._slices=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"width",function(){return this._width},function(e){this._width!=e&&(this._width=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"long",function(){return this._long},function(e){this._long!=e&&(this._long=e,this.releaseResource(),this.activeResource())}),r}(),QuadMesh=function(e){function n(e,t){this._long=NaN,this._width=NaN,void 0===e&&(e=1),void 0===t&&(t=1),n.__super.call(this),this._long=e,this._width=t,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}__class(n,"laya.d3.resource.models.QuadMesh",!1,PrimitiveMesh);var t=n.prototype;return t.recreateResource=function(){this._numberVertices=4,this._numberIndices=6;var e=VertexPositionNormalTexture.vertexDeclaration,t=(e.vertexStride,this._long/2),n=this._width/2,i=new Float32Array([-t,n,0,0,0,1,0,0,t,n,0,0,0,1,1,0,-t,-n,0,0,0,1,0,1,t,-n,0,0,0,1,1,1]),r=new Uint16Array([0,1,2,3,2,1]);this._vertexBuffer=new VertexBuffer3D(e,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(r),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},__getset(0,t,"width",function(){return this._width},function(e){this._width!=e&&(this._width=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"long",function(){return this._long},function(e){this._long!=e&&(this._long=e,this.releaseResource(),this.activeResource())}),n}(),SphereMesh=function(e){function i(e,t,n){this._radius=NaN,this._slices=0,void(this._stacks=0)===e&&(e=.5),void 0===t&&(t=32),void 0===n&&(n=32),i.__super.call(this),this._radius=e,this._stacks=t,this._slices=n,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}__class(i,"laya.d3.resource.models.SphereMesh",!1,PrimitiveMesh);var t=i.prototype;return t.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var e=new Uint16Array(this._numberIndices),t=VertexPositionNormalTexture.vertexDeclaration,n=t.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,o=0,s=0,l=0,_=0;_<this._stacks+1;_++)for(var h=Math.sin(_*r),c=Math.cos(_*r),u=0;u<this._slices+1;u++){var d=h*Math.sin(u*a+1*Math.PI/2),f=h*Math.cos(u*a+1*Math.PI/2);i[s+0]=d*this._radius,i[s+1]=c*this._radius,i[s+2]=f*this._radius,i[s+3]=d,i[s+4]=c,i[s+5]=f,i[s+6]=u/this._slices,i[s+7]=_/this._stacks,s+=n,_!=this._stacks-1&&(e[l++]=o+(this._slices+1),e[l++]=o,e[l++]=o+1,e[l++]=o+this._slices,e[l++]=o,e[l++]=o+(this._slices+1),o++)}this._vertexBuffer=new VertexBuffer3D(t,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},__getset(0,t,"stacks",function(){return this._stacks},function(e){this._stacks!=e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"slices",function(){return this._slices},function(e){this._slices!=e&&(this._slices=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"radius",function(){return this._radius},function(e){this._radius!=e&&(this._radius=e,this.releaseResource(),this.activeResource())}),i}(),BoxMesh=function(e){function i(e,t,n){this._long=NaN,this._width=NaN,this._height=NaN,void 0===e&&(e=1),void 0===t&&(t=1),void 0===n&&(n=1),i.__super.call(this),this._long=e,this._width=t,this._height=n,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}__class(i,"laya.d3.resource.models.BoxMesh",!1,PrimitiveMesh);var t=i.prototype;return t.recreateResource=function(){this._numberVertices=24,this._numberIndices=36;var e=VertexPositionNormalTexture.vertexDeclaration,t=(e.vertexStride,this._long/2),n=this._height/2,i=this._width/2,r=new Float32Array([-t,n,-i,0,1,0,0,0,t,n,-i,0,1,0,1,0,t,n,i,0,1,0,1,1,-t,n,i,0,1,0,0,1,-t,-n,-i,0,-1,0,0,1,t,-n,-i,0,-1,0,1,1,t,-n,i,0,-1,0,1,0,-t,-n,i,0,-1,0,0,0,-t,n,-i,-1,0,0,0,0,-t,n,i,-1,0,0,1,0,-t,-n,i,-1,0,0,1,1,-t,-n,-i,-1,0,0,0,1,t,n,-i,1,0,0,1,0,t,n,i,1,0,0,0,0,t,-n,i,1,0,0,0,1,t,-n,-i,1,0,0,1,1,-t,n,i,0,0,1,0,0,t,n,i,0,0,1,1,0,t,-n,i,0,0,1,1,1,-t,-n,i,0,0,1,0,1,-t,n,-i,0,0,-1,1,0,t,n,-i,0,0,-1,0,0,t,-n,-i,0,0,-1,0,1,-t,-n,-i,0,0,-1,1,1]),a=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);this._vertexBuffer=new VertexBuffer3D(e,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(r),this._indexBuffer.setData(a),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},__getset(0,t,"height",function(){return this._height},function(e){this._height!=e&&(this._height=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"width",function(){return this._width},function(e){this._width!=e&&(this._width=e,this.releaseResource(),this.activeResource())}),__getset(0,t,"long",function(){return this._long},function(e){this._long!=e&&(this._long=e,this.releaseResource(),this.activeResource())}),i}(),MeshSprite3D=function(n){function i(e,t){i.__super.call(this,t),this._geometryFilter=new MeshFilter(this),this._render=new MeshRender(this),this._geometryFilter.on("meshchanged",this,__bind(this,this._onMeshChanged)),this._render.on("materialchanged",this,__bind(this,this._onMaterialChanged)),e&&(this._geometryFilter.sharedMesh=e)instanceof laya.d3.resource.models.Mesh&&(e.loaded?this._render.sharedMaterials=e.materials:e.once("loaded",this,__bind(this,this._applyMeshMaterials)))}__class(i,"laya.d3.core.MeshSprite3D",!1,n);var e=i.prototype;return e._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new SubMeshRenderElement),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=StandardMaterial.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,n},e._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e];t||(t=StandardMaterial.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,n},e._changeRenderObjectsByMesh=function(){var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;t<e;t++)this._changeRenderObjectByMesh(t)},e._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,__bind(this,this._onMeshLoaded))},e._onMeshLoaded=function(e){e==this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},e._onMaterialChanged=function(e,t,n){t<this._render._renderElements.length&&this._changeRenderObjectByMaterial(t,n)},e._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},e._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},e._parseCustomProps=function(e,t,n,i){var r=this.meshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var o,s,l=n.lightmapScaleOffset;if(l&&(r.lightmapScaleOffset=new Vector4(l[0],l[1],l[2],l[3])),i.instanceParams)(o=i.instanceParams.loadPath)&&(s=Loader.getRes(t[o]),(this.meshFilter.sharedMesh=s).loaded?r.sharedMaterials=s.materials:s.once("loaded",this,__bind(this,this._applyMeshMaterials)));else{(o=n.meshPath)&&(s=Loader.getRes(t[o]),this.meshFilter.sharedMesh=s);var _=n.materials;if(_){var h=r.sharedMaterials,c=_.length;h.length=c;for(var u=0;u<c;u++)h[u]=Loader.getRes(t[_[u].path]);r.sharedMaterials=h}}},e._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},e._addToInitStaticBatchManager=function(){i._staticBatchManager._addInitBatchSprite(this)},e.cloneTo=function(e){var t=e;t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=t._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.lightmapIndex=n.lightmapIndex,i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},e.destroy=function(e){if(void 0===e&&(e=!0),!this.destroyed){var t=this.meshFilter.sharedMesh;t.loaded||t.off("loaded",this,__bind(this,this._applyMeshMaterials)),n.prototype.destroy.call(this,e),this._geometryFilter._destroy()}},__getset(0,e,"meshRender",function(){return this._render}),__getset(0,e,"meshFilter",function(){return this._geometryFilter}),i.__init__=function(){StaticBatchManager._staticBatchManagers.push(i._staticBatchManager)},i.load=function(e){return Laya.loader.create(e,null,null,i)},__static(i,["_staticBatchManager",function(){return this._staticBatchManager=new MeshSprite3DStaticBatchManager}]),i}(RenderableSprite3D),Glitter=function(t){function n(){n.__super.call(this),this._render=new GlitterRender(this),this._render.on("materialchanged",this,__bind(this,this._onMaterialChanged));var e=new GlitterMaterial;this._render.sharedMaterial=e,this._geometryFilter=new GlitterTemplet(this),e.renderMode=8,this._changeRenderObject(0)}__class(n,"laya.d3.core.glitter.Glitter",!1,t);var e=n.prototype;return e._changeRenderObject=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new RenderElement),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=GlitterMaterial.defaultMaterial);var r=this._geometryFilter;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},e._onMaterialChanged=function(e,t,n){t<e._renderElements.length&&this._changeRenderObject(t)},e._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},e._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},e._update=function(e){this._geometryFilter._update(e.elapsedTime),t.prototype._update.call(this,e)},e.addGlitterByPositions=function(e,t){this._geometryFilter.addVertexPosition(e,t)},e.addGlitterByPositionsVelocitys=function(e,t,n,i){this._geometryFilter.addVertexPositionVelocity(e,t,n,i)},e.cloneTo=function(e){var t=e,n=t.templet,i=this._geometryFilter;n.lifeTime=i.lifeTime,n.minSegmentDistance=i.minSegmentDistance,n.minInterpDistance=i.minInterpDistance,n.maxSlerpCount=i.maxSlerpCount,n._maxSegments=i._maxSegments;var r=t._render,a=this._render;r.sharedMaterials=a.sharedMaterials,r.enable=a.enable,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},e.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},__getset(0,e,"glitterRender",function(){return this._render}),__getset(0,e,"templet",function(){return this._geometryFilter}),n.CURRENTTIME=2,n.DURATION=3,n}(RenderableSprite3D),TrailSprite3D=function(t){function e(){e.__super.call(this),this._geometryFilter=new TrailFilter(this),this._render=new TrailRenderer(this),this._changeRenderObjectsByMaterial(this._render,0,TrailMaterial.defaultMaterial),this._render.on("materialchanged",this,__bind(this,this._changeRenderObjectsByMaterial)),this._geometryFilter.on("trailfilterchange",this,__bind(this,this._changeRenderObjectsByRenderElement))}__class(e,"laya.d3.core.trail.TrailSprite3D",!1,t);var n=e.prototype;return n._changeRenderObjectsByMaterial=function(e,t,n){var i=this._geometryFilter.getRenderElementsCount();this._render._renderElements.length=i;for(var r=0;r<i;r++)this._changeRenderObjectByMaterial(r,n)},n._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements;t||(t=TrailMaterial.defaultMaterial);var i=n[e];i||(i=n[e]=new RenderElement),i._sprite3D=this,i.renderObj=this._geometryFilter.getRenderElement(e),i._render=this._render,i._material=t},n._changeRenderObjectsByRenderElement=function(e,t){var n=this._render._renderElements,i=n[e];i||(i=n[e]=new RenderElement),i._sprite3D=this,i.renderObj=t,i._render=this._render,i._material=this._render.sharedMaterial},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._update=function(e){t.prototype._update.call(this,e),this._geometryFilter._update(e)},n._parseCustomProps=function(e,t,n,i){var r=this._render,a=this._geometryFilter,o=0,s=0,l=n.materials;if(l){var _=r.sharedMaterials,h=l.length;for(_.length=h,o=0;o<h;o++)_[o]=Loader.getRes(t[l[o].path]);r.sharedMaterials=_}var c=i.props;a.time=c.time,a.minVertexDistance=c.minVertexDistance,a.widthMultiplier=c.widthMultiplier,a.textureMode=c.textureMode;var u=[],d=n.widthCurve;for(o=0,s=d.length;o<s;o++){var f=new TrailKeyFrame;f.time=d[o].time,f.inTangent=d[o].inTangent,f.outTangent=d[o].outTangent,f.value=d[o].value,u.push(f)}a.widthCurve=u;var m=n.colorGradient,p=new Gradient;p.mode=m.mode;var g,E,v=[],x=m.colorKeys;for(o=0,s=x.length;o<s;o++)E=x[o],g=new GradientColorKey(new Color$1(E.value[0],E.value[1],E.value[2],1),E.time),v.push(g);var S,D,T=[],M=m.alphaKeys;for(o=0,s=M.length;o<s;o++)D=M[o],S=new GradientAlphaKey(D.value,D.time),T.push(S);p.setKeys(v,T),a.colorGradient=p},n.reset=function(){this.trailFilter.reset()},n.cloneTo=function(e){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e);var t,n=0,i=e,r=i.trailFilter;r.time=this.trailFilter.time,r.minVertexDistance=this.trailFilter.minVertexDistance,r.widthMultiplier=this.trailFilter.widthMultiplier;var a=this.trailFilter.widthCurve,o=[];for(n=0,t=a.length;n<t;n++){var s=new TrailKeyFrame;a[n].cloneTo(s),o.push(s)}r.widthCurve=o;var l=new Gradient;this.trailFilter.colorGradient.cloneTo(l),r.colorGradient=l,r.textureMode=this.trailFilter.textureMode,i.trailRender.sharedMaterial=this.trailRender.sharedMaterial},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},__getset(0,n,"trailRender",function(){return this._render}),__getset(0,n,"trailFilter",function(){return this._geometryFilter}),e.__init__=function(){e.SHADERDEFINE_GRADIENTMODE_BLEND=e.shaderDefines.registerDefine("GRADIENTMODE_BLEND")},e.CURTIME=3,e.LIFETIME=4,e.WIDTHCURVE=5,e.WIDTHCURVEKEYLENGTH=6,e.GRADIENTCOLORKEY=7,e.GRADIENTALPHAKEY=8,e.SHADERDEFINE_GRADIENTMODE_BLEND=0,__static(e,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(RenderableSprite3D.shaderDefines)}]),e}(RenderableSprite3D),Camera=function(e){function o(e,t,n){void 0===e&&(e=0),void 0===t&&(t=.3),void 0===n&&(n=1e3),this._viewMatrix=new Matrix4x4,this._projectionMatrix=new Matrix4x4,this._projectionViewMatrix=new Matrix4x4,this._viewport=new Viewport(0,0,0,0),this._normalizedViewport=new Viewport(0,0,1,1),this._aspectRatio=e,this._boundFrustumUpdate=!0,this._boundFrustum=new BoundFrustum(Matrix4x4.DEFAULT),o.__super.call(this,t,n),this.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatrixChanged))}__class(o,"laya.d3.core.Camera",!1,BaseCamera);var t=o.prototype;return t._onWorldMatrixChanged=function(){this._boundFrustumUpdate=!0},t._parseCustomProps=function(e,t,n,i){var r=n.clearColor;this.clearColor=new Vector4(r[0],r[1],r[2],r[3]);var a=n.viewport;this.normalizedViewport=new Viewport(a[0],a[1],a[2],a[3])},t._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.aspectRatio*.5,t=.5*this.orthographicVerticalSize;Matrix4x4.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._projectionMatrix)}else Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._boundFrustumUpdate=!0},t._update=function(e){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,e)},t._renderCamera=function(e,t,n){var i,r;n.parallelSplitShadowMaps[0]&&n._renderShadowMap(e,t,this),(t.camera=this)._prepareCameraToRender(),n._preRenderUpdateComponents(t),i=t._viewMatrix=this.viewMatrix;var a=this._renderTarget;t._projectionViewMatrix=a?(a.start(),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this._projectionMatrix,BaseCamera._invertYProjectionMatrix),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this.projectionViewMatrix,BaseCamera._invertYProjectionViewMatrix),r=t._projectionMatrix=BaseCamera._invertYProjectionMatrix,BaseCamera._invertYProjectionViewMatrix):(r=t._projectionMatrix=this._projectionMatrix,this.projectionViewMatrix),this._prepareCameraViewProject(i,r),t._viewport=this.viewport,n._preRenderScene(e,t,this.boundFrustum),n._clear(e,t),n._renderScene(e,t),n._postRenderUpdateComponents(t),a&&a.end()},t.viewportPointToRay=function(e,t){Picker.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},t.normalizedViewportPointToRay=function(e,t){var n=o._tempVector20,i=this.viewport,r=e.elements,a=n.elements;a[0]=r[0]*i.width,a[1]=r[1]*i.height,Picker.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},t.worldToViewportPoint=function(e,t){Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,t);var n=t.elements;n[0]=n[0]/Laya.stage.clientScaleX,n[1]=n[1]/Laya.stage.clientScaleY},t.worldToNormalizedViewportPoint=function(e,t){Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,t);var n=t.elements;n[0]=n[0]/Laya.stage.clientScaleX,n[1]=n[1]/Laya.stage.clientScaleY},t.convertScreenCoordToOrthographicCoord=function(e,t){if(this._orthographic){var n=RenderState.clientWidth,i=RenderState.clientHeight,r=this.orthographicVerticalSize*this.aspectRatio/n,a=this.orthographicVerticalSize/i,o=e.elements,s=t.elements;return s[0]=(-n/2+o[0])*r,s[1]=(i/2-o[1])*a,s[2]=(this.nearPlane-this.farPlane)*(o[2]+1)/2-this.nearPlane,Vector3.transformCoordinate(t,this.transform.worldMatrix,t),!0}return!1},__getset(0,t,"projectionViewMatrix",function(){return Matrix4x4.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),__getset(0,t,"projectionMatrix",function(){return this._projectionMatrix},function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}),__getset(0,t,"viewport",function(){if(this._viewportExpressedInClipSpace){var e=this._normalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._viewport.x=e.x*n,this._viewport.y=e.y*i,this._viewport.width=e.width*n,this._viewport.height=e.height*i}return this._viewport},function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=e,this._calculateProjectionMatrix()}),__getset(0,t,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),__getset(0,t,"needViewport",function(){var e=this.normalizedViewport;return 0==e.x&&0==e.y&&1==e.width&&1==e.height}),__getset(0,t,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._viewport,t=this.renderTargetSize,n=t.width,i=t.height;this._normalizedViewport.x=e.x/n,this._normalizedViewport.y=e.y/i,this._normalizedViewport.width=e.width/n,this._normalizedViewport.height=e.height/i}return this._normalizedViewport},function(e){e.x<0&&(e.x=0,console.warn("Camera: viewport.x must large than 0.0.")),e.y<0&&(e.y=0,console.warn("Camera: viewport.y must large than 0.0.")),1<e.x+e.width&&(e.width=1-e.x,console.warn("Camera: viewport.width + viewport.x must less than 1.0.")),1<e.y+e.height&&(e.height=1-e.y,console.warn("Camera: viewport.height + viewport.y must less than 1.0.")),this._viewportExpressedInClipSpace=!0,this._normalizedViewport=e,this._calculateProjectionMatrix()}),__getset(0,t,"boundFrustum",function(){return this._boundFrustumUpdate&&(this._boundFrustum.matrix=this.projectionViewMatrix),this._boundFrustum}),__getset(0,t,"aspectRatio",function(){if(0!=this._aspectRatio)return this._aspectRatio;var e=this.viewport;return e.width/e.height},function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}),__static(o,["_tempVector20",function(){return this._tempVector20=new Vector2}]),o}(),ShuriKenParticle3D=function(t){function Ve(e){Ve.__super.call(this),this._render=new ShurikenParticleRender(this),this._render.on("materialchanged",this,__bind(this,this._onMaterialChanged)),this._geometryFilter=new ShurikenParticleSystem(this),this._createRenderElement(0),e&&(this._render.sharedMaterial=e)}__class(Ve,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",!1,t);var e=Ve.prototype;return e._initParticleVelocity=function(e){for(var t=new GradientDataNumber,n=e.velocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},e._initParticleColor=function(e){var t=new GradientDataColor,n=e.alphas,i=0,r=0;for(i=0,r=n.length;i<r;i++){var a=n[i];t.addAlpha(a.key,a.value)}var o=e.rgbs;for(i=0,r=o.length;i<r;i++){var s=o[i],l=s.value;t.addRGB(s.key,new Vector3(l[0],l[1],l[2]))}return t},e._initParticleSize=function(e){for(var t=new GradientDataNumber,n=e.sizes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},e._initParticleRotation=function(e){for(var t=new GradientDataNumber,n=e.angularVelocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value/180*Math.PI)}return t},e._initParticleFrame=function(e){for(var t=new GradientDataInt,n=e.frames,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},e._createRenderElement=function(e){var t=this._render._renderElements[e]=new RenderElement;t._render=this._render;var n=this._render.sharedMaterials[e];n||(n=ShurikenParticleMaterial.defaultMaterial);var i=this._geometryFilter;t._mainSortID=0,t._sprite3D=this,t.renderObj=i,t._material=n},e._onMaterialChanged=function(e,t,n){var i=e._renderElements;t<i.length&&(i[t]._material=n||ShurikenParticleMaterial.defaultMaterial)},e._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},e._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},e._parseCustomProps=function(e,t,n,i){var r,a=Math.PI/180,o=0,s=0,l=this.particleRender,_=n.material;if(_)r=Loader.getRes(t[_.path]);else{var h=n.materialPath;h?r=Loader.getRes(t[h]):(r=new ShurikenParticleMaterial).diffuseTexture=t?Loader.getRes(t[n.texturePath]):Texture2D.load(n.texturePath)}l.sharedMaterial=r;var c=n.meshPath;c&&(l.mesh=Loader.getRes(t[c])),l.renderMode=n.renderMode,l.stretchedBillboardCameraSpeedScale=n.stretchedBillboardCameraSpeedScale,l.stretchedBillboardSpeedScale=n.stretchedBillboardSpeedScale,l.stretchedBillboardLengthScale=n.stretchedBillboardLengthScale,l.sortingFudge=n.sortingFudge?n.sortingFudge:0;var u=this.particleSystem;u.isPerformanceMode=n.isPerformanceMode,u.duration=n.duration,u.looping=n.looping,u.prewarm=n.prewarm,u.startDelayType=n.startDelayType,u.startDelay=n.startDelay,u.startDelayMin=n.startDelayMin,u.startDelayMax=n.startDelayMax,u.startLifetimeType=n.startLifetimeType,u.startLifetimeConstant=n.startLifetimeConstant,u.startLifeTimeGradient=Ve._initStartLife(n.startLifetimeGradient),u.startLifetimeConstantMin=n.startLifetimeConstantMin,u.startLifetimeConstantMax=n.startLifetimeConstantMax,u.startLifeTimeGradientMin=Ve._initStartLife(n.startLifetimeGradientMin),u.startLifeTimeGradientMax=Ve._initStartLife(n.startLifetimeGradientMax),u.startSpeedType=n.startSpeedType,u.startSpeedConstant=n.startSpeedConstant,u.startSpeedConstantMin=n.startSpeedConstantMin,u.startSpeedConstantMax=n.startSpeedConstantMax,u.threeDStartSize=n.threeDStartSize,u.startSizeType=n.startSizeType,u.startSizeConstant=n.startSizeConstant;var d=n.startSizeConstantSeparate,f=u.startSizeConstantSeparate.elements;f[0]=d[0],f[1]=d[1],f[2]=d[2],u.startSizeConstantMin=n.startSizeConstantMin,u.startSizeConstantMax=n.startSizeConstantMax;var m=n.startSizeConstantMinSeparate,p=u.startSizeConstantMinSeparate.elements;p[0]=m[0],p[1]=m[1],p[2]=m[2];var g=n.startSizeConstantMaxSeparate,E=u.startSizeConstantMaxSeparate.elements;E[0]=g[0],E[1]=g[1],E[2]=g[2],u.threeDStartRotation=n.threeDStartRotation,u.startRotationType=n.startRotationType,u.startRotationConstant=n.startRotationConstant*a;var v=n.startRotationConstantSeparate,x=u.startRotationConstantSeparate.elements;x[0]=v[0]*a,x[1]=v[1]*a,x[2]=v[2]*a,u.startRotationConstantMin=n.startRotationConstantMin*a,u.startRotationConstantMax=n.startRotationConstantMax*a;var S=n.startRotationConstantMinSeparate,D=u.startRotationConstantMinSeparate.elements;D[0]=S[0]*a,D[1]=S[1]*a,D[2]=S[2]*a;var T=n.startRotationConstantMaxSeparate,M=u.startRotationConstantMaxSeparate.elements;M[0]=T[0]*a,M[1]=T[1]*a,M[2]=T[2]*a,u.randomizeRotationDirection=n.randomizeRotationDirection,u.startColorType=n.startColorType;var V=n.startColorConstant,R=u.startColorConstant.elements;R[0]=V[0],R[1]=V[1],R[2]=V[2],R[3]=V[3];var A=n.startColorConstantMin,C=u.startColorConstantMin.elements;C[0]=A[0],C[1]=A[1],C[2]=A[2],C[3]=A[3];var I=n.startColorConstantMax,y=u.startColorConstantMax.elements;y[0]=I[0],y[1]=I[1],y[2]=I[2],y[3]=I[3],u.gravityModifier=n.gravityModifier,u.simulationSpace=n.simulationSpace,u.scaleMode=n.scaleMode,u.playOnAwake=n.playOnAwake,u.maxParticles=n.maxParticles;var N=n.autoRandomSeed;null!=N&&(u.autoRandomSeed=N);var P=n.randomSeed;null!=P&&(u.randomSeed[0]=P);var L=n.emission;if(L){var w=u.emission;w.emissionRate=L.emissionRate;var O=L.bursts;if(O)for(o=0,s=O.length;o<s;o++){var b=O[o];w.addBurst(new Burst(b.time,b.min,b.max))}w.enbale=L.enable}else w.enbale=!1;var F=n.shape;if(F){var B;switch(F.shapeType){case 0:var U;B=U=new SphereShape,U.radius=F.sphereRadius,U.emitFromShell=F.sphereEmitFromShell,U.randomDirection=F.sphereRandomDirection;break;case 1:var H;B=H=new HemisphereShape,H.radius=F.hemiSphereRadius,H.emitFromShell=F.hemiSphereEmitFromShell,H.randomDirection=F.hemiSphereRandomDirection;break;case 2:var G;B=G=new ConeShape,G.angle=F.coneAngle*a,G.radius=F.coneRadius,G.length=F.coneLength,G.emitType=F.coneEmitType,G.randomDirection=F.coneRandomDirection;break;case 3:var z;B=z=new BoxShape,z.x=F.boxX,z.y=F.boxY,z.z=F.boxZ,z.randomDirection=F.boxRandomDirection;break;case 7:var W;B=W=new CircleShape,W.radius=F.circleRadius,W.arc=F.circleArc*a,W.emitFromEdge=F.circleEmitFromEdge,W.randomDirection=F.circleRandomDirection;break;default:var k;B=k=new CircleShape,k.radius=F.circleRadius,k.arc=F.circleArc*a,k.emitFromEdge=F.circleEmitFromEdge,k.randomDirection=F.circleRandomDirection}B.enable=F.enable,u.shape=B}var X=n.velocityOverLifetime;if(X){var Z,K=X.velocity;switch(K.type){case 0:var Y=K.constant;Z=GradientVelocity.createByConstant(new Vector3(Y[0],Y[1],Y[2]));break;case 1:Z=GradientVelocity.createByGradient(this._initParticleVelocity(K.gradientX),this._initParticleVelocity(K.gradientY),this._initParticleVelocity(K.gradientZ));break;case 2:var j=K.constantMin,Q=K.constantMax;Z=GradientVelocity.createByRandomTwoConstant(new Vector3(j[0],j[1],j[2]),new Vector3(Q[0],Q[1],Q[2]));break;case 3:Z=GradientVelocity.createByRandomTwoGradient(this._initParticleVelocity(K.gradientXMin),this._initParticleVelocity(K.gradientXMax),this._initParticleVelocity(K.gradientYMin),this._initParticleVelocity(K.gradientYMax),this._initParticleVelocity(K.gradientZMin),this._initParticleVelocity(K.gradientZMax))}var q=new VelocityOverLifetime(Z);q.space=X.space,q.enbale=X.enable,u.velocityOverLifetime=q}var $=n.colorOverLifetime;if($){var J,ee=$.color;switch(ee.type){case 0:var te=ee.constant;J=GradientColor.createByConstant(new Vector4(te[0],te[1],te[2],te[3]));break;case 1:J=GradientColor.createByGradient(this._initParticleColor(ee.gradient));break;case 2:var ne=ee.constantMin,ie=ee.constantMax;J=GradientColor.createByRandomTwoConstant(new Vector4(ne[0],ne[1],ne[2],ne[3]),new Vector4(ie[0],ie[1],ie[2],ie[3]));break;case 3:J=GradientColor.createByRandomTwoGradient(this._initParticleColor(ee.gradientMin),this._initParticleColor(ee.gradientMax))}var re=new ColorOverLifetime(J);re.enbale=$.enable,u.colorOverLifetime=re}var ae=n.sizeOverLifetime;if(ae){var oe,se=ae.size;switch(se.type){case 0:oe=se.separateAxes?GradientSize.createByGradientSeparate(this._initParticleSize(se.gradientX),this._initParticleSize(se.gradientY),this._initParticleSize(se.gradientZ)):GradientSize.createByGradient(this._initParticleSize(se.gradient));break;case 1:if(se.separateAxes){var le=se.constantMinSeparate,_e=se.constantMaxSeparate;oe=GradientSize.createByRandomTwoConstantSeparate(new Vector3(le[0],le[1],le[2]),new Vector3(_e[0],_e[1],_e[2]))}else oe=GradientSize.createByRandomTwoConstant(se.constantMin,se.constantMax);break;case 2:oe=se.separateAxes?GradientSize.createByRandomTwoGradientSeparate(this._initParticleSize(se.gradientXMin),this._initParticleSize(se.gradientYMin),this._initParticleSize(se.gradientZMin),this._initParticleSize(se.gradientXMax),this._initParticleSize(se.gradientYMax),this._initParticleSize(se.gradientZMax)):GradientSize.createByRandomTwoGradient(this._initParticleSize(se.gradientMin),this._initParticleSize(se.gradientMax))}var he=new SizeOverLifetime(oe);he.enbale=ae.enable,u.sizeOverLifetime=he}var ce=n.rotationOverLifetime;if(ce){var ue,de=ce.angularVelocity;switch(de.type){case 0:de.separateAxes||(ue=GradientAngularVelocity.createByConstant(de.constant*a));break;case 1:de.separateAxes||(ue=GradientAngularVelocity.createByGradient(this._initParticleRotation(de.gradient)));break;case 2:if(de.separateAxes){var fe=de.constantMinSeparate,me=de.constantMaxSeparate;ue=GradientAngularVelocity.createByRandomTwoConstantSeparate(new Vector3(fe[0]*a,fe[1]*a,fe[2]*a),new Vector3(me[0]*a,me[1]*a,me[2]*a))}else ue=GradientAngularVelocity.createByRandomTwoConstant(de.constantMin*a,de.constantMax*a);break;case 3:de.separateAxes||(ue=GradientAngularVelocity.createByRandomTwoGradient(this._initParticleRotation(de.gradientMin),this._initParticleRotation(de.gradientMax)))}var pe=new RotationOverLifetime(ue);pe.enbale=ce.enable,u.rotationOverLifetime=pe}var ge=n.textureSheetAnimation;if(ge){var Ee,ve=ge.frame;switch(ve.type){case 0:Ee=FrameOverTime.createByConstant(ve.constant);break;case 1:Ee=FrameOverTime.createByOverTime(this._initParticleFrame(ve.overTime));break;case 2:Ee=FrameOverTime.createByRandomTwoConstant(ve.constantMin,ve.constantMax);break;case 3:Ee=FrameOverTime.createByRandomTwoOverTime(this._initParticleFrame(ve.overTimeMin),this._initParticleFrame(ve.overTimeMax))}var xe,Se=ge.startFrame;switch(Se.type){case 0:xe=StartFrame.createByConstant(Se.constant);break;case 1:xe=StartFrame.createByRandomTwoConstant(Se.constantMin,Se.constantMax)}var De=new TextureSheetAnimation(Ee,xe);De.enable=ge.enable;var Te=ge.tiles;De.tiles=new Vector2(Te[0],Te[1]),De.type=ge.type,De.randomRow=ge.randomRow;var Me=ge.rowIndex;null!=Me&&(De.rowIndex=Me),De.cycles=ge.cycles,u.textureSheetAnimation=De}},e._activeHierarchy=function(){laya.d3.core.Sprite3D.prototype._activeHierarchy.call(this),this.particleSystem.playOnAwake&&this.particleSystem.play()},e._inActiveHierarchy=function(){laya.d3.core.Sprite3D.prototype._inActiveHierarchy.call(this),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)},e.cloneTo=function(e){var t=e,n=t._geometryFilter;this._geometryFilter.cloneTo(n);var i=t._render,r=this._render;i.sharedMaterials=r.sharedMaterials,i.enable=r.enable,i.renderMode=r.renderMode,i.mesh=r.mesh,i.stretchedBillboardCameraSpeedScale=r.stretchedBillboardCameraSpeedScale,i.stretchedBillboardSpeedScale=r.stretchedBillboardSpeedScale,i.stretchedBillboardLengthScale=r.stretchedBillboardLengthScale,i.sortingFudge=r.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},e.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},__getset(0,e,"particleRender",function(){return this._render}),__getset(0,e,"particleSystem",function(){return this._geometryFilter}),Ve.__init__=function(){Ve.SHADERDEFINE_RENDERMODE_BILLBOARD=Ve.shaderDefines.registerDefine("SPHERHBILLBOARD"),Ve.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=Ve.shaderDefines.registerDefine("STRETCHEDBILLBOARD"),Ve.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=Ve.shaderDefines.registerDefine("HORIZONTALBILLBOARD"),Ve.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=Ve.shaderDefines.registerDefine("VERTICALBILLBOARD"),Ve.SHADERDEFINE_COLOROVERLIFETIME=Ve.shaderDefines.registerDefine("COLOROVERLIFETIME"),Ve.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=Ve.shaderDefines.registerDefine("RANDOMCOLOROVERLIFETIME"),Ve.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=Ve.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECONSTANT"),Ve.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=Ve.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECURVE"),Ve.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=Ve.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),Ve.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=Ve.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),Ve.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=Ve.shaderDefines.registerDefine("TEXTURESHEETANIMATIONCURVE"),Ve.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=Ve.shaderDefines.registerDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),Ve.SHADERDEFINE_ROTATIONOVERLIFETIME=Ve.shaderDefines.registerDefine("ROTATIONOVERLIFETIME"),Ve.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=Ve.shaderDefines.registerDefine("ROTATIONOVERLIFETIMESEPERATE"),Ve.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=Ve.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECONSTANT"),Ve.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=Ve.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECURVE"),Ve.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=Ve.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),Ve.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=Ve.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),Ve.SHADERDEFINE_SIZEOVERLIFETIMECURVE=Ve.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVE"),Ve.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=Ve.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVESEPERATE"),Ve.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=Ve.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVES"),Ve.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=Ve.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),Ve.SHADERDEFINE_RENDERMODE_MESH=Ve.shaderDefines.registerDefine("RENDERMODE_MESH"),Ve.SHADERDEFINE_SHAPE=Ve.shaderDefines.registerDefine("SHAPE")},Ve.load=function(e){return Laya.loader.create(e,null,null,Ve)},Ve._initStartLife=function(e){for(var t=new GradientDataNumber,n=e.startLifetimes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t},Ve.SHADERDEFINE_RENDERMODE_BILLBOARD=0,Ve.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,Ve.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,Ve.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,Ve.SHADERDEFINE_COLOROVERLIFETIME=0,Ve.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,Ve.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,Ve.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,Ve.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,Ve.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,Ve.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,Ve.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,Ve.SHADERDEFINE_ROTATIONOVERLIFETIME=0,Ve.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,Ve.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,Ve.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,Ve.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,Ve.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,Ve.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,Ve.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,Ve.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,Ve.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,Ve.SHADERDEFINE_RENDERMODE_MESH=0,Ve.SHADERDEFINE_SHAPE=0,Ve.WORLDPOSITION=0,Ve.WORLDROTATION=1,Ve.POSITIONSCALE=4,Ve.SIZESCALE=5,Ve.SCALINGMODE=6,Ve.GRAVITY=7,Ve.THREEDSTARTROTATION=8,Ve.STRETCHEDBILLBOARDLENGTHSCALE=9,Ve.STRETCHEDBILLBOARDSPEEDSCALE=10,Ve.SIMULATIONSPACE=11,Ve.CURRENTTIME=12,Ve.VOLVELOCITYCONST=13,Ve.VOLVELOCITYGRADIENTX=14,Ve.VOLVELOCITYGRADIENTY=15,Ve.VOLVELOCITYGRADIENTZ=16,Ve.VOLVELOCITYCONSTMAX=17,Ve.VOLVELOCITYGRADIENTXMAX=18,Ve.VOLVELOCITYGRADIENTYMAX=19,Ve.VOLVELOCITYGRADIENTZMAX=20,Ve.VOLSPACETYPE=21,Ve.COLOROVERLIFEGRADIENTALPHAS=22,Ve.COLOROVERLIFEGRADIENTCOLORS=23,Ve.MAXCOLOROVERLIFEGRADIENTALPHAS=24,Ve.MAXCOLOROVERLIFEGRADIENTCOLORS=25,Ve.SOLSIZEGRADIENT=26,Ve.SOLSIZEGRADIENTX=27,Ve.SOLSIZEGRADIENTY=28,Ve.SOLSizeGradientZ=29,Ve.SOLSizeGradientMax=30,Ve.SOLSIZEGRADIENTXMAX=31,Ve.SOLSIZEGRADIENTYMAX=32,Ve.SOLSizeGradientZMAX=33,Ve.ROLANGULARVELOCITYCONST=34,Ve.ROLANGULARVELOCITYCONSTSEPRARATE=35,Ve.ROLANGULARVELOCITYGRADIENT=36,Ve.ROLANGULARVELOCITYGRADIENTX=37,Ve.ROLANGULARVELOCITYGRADIENTY=38,Ve.ROLANGULARVELOCITYGRADIENTZ=39,Ve.ROLANGULARVELOCITYGRADIENTW=40,Ve.ROLANGULARVELOCITYCONSTMAX=41,Ve.ROLANGULARVELOCITYCONSTMAXSEPRARATE=42,Ve.ROLANGULARVELOCITYGRADIENTMAX=43,Ve.ROLANGULARVELOCITYGRADIENTXMAX=44,Ve.ROLANGULARVELOCITYGRADIENTYMAX=45,Ve.ROLANGULARVELOCITYGRADIENTZMAX=46,Ve.ROLANGULARVELOCITYGRADIENTWMAX=47,Ve.TEXTURESHEETANIMATIONCYCLES=48,Ve.TEXTURESHEETANIMATIONSUBUVLENGTH=49,Ve.TEXTURESHEETANIMATIONGRADIENTUVS=50,Ve.TEXTURESHEETANIMATIONGRADIENTMAXUVS=51,__static(Ve,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(RenderableSprite3D.shaderDefines)}]),Ve}(RenderableSprite3D),SkinnedMeshSprite3D=function(t){function n(e,t){this._subMeshOffset=null,n.__super.call(this,t),this._subMeshOffset=[],this._geometryFilter=new MeshFilter(this),this._render=new SkinnedMeshRender(this),this._geometryFilter.on("meshchanged",this,__bind(this,this._onMeshChanged)),this._render.on("materialchanged",this,__bind(this,this._onMaterialChanged)),e&&(this._geometryFilter.sharedMesh=e)}__class(n,"laya.d3.core.SkinnedMeshSprite3D",!1,t);var e=n.prototype;return e._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new SubMeshRenderElement),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=StandardMaterial.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,n},e._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e];t||(t=StandardMaterial.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,n},e._changeRenderObjectsByMesh=function(){var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;t<e;t++)this._changeRenderObjectByMesh(t)},e._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,__bind(this,this._changeRenderObjectsByMesh))},e._onMaterialChanged=function(e,t,n){t<this._render._renderElements.length&&this._changeRenderObjectByMaterial(t,n)},e._parseCustomProps=function(e,t,n,i){var r=this.skinnedMeshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var o,s,l=n.lightmapScaleOffset;if(l&&(r.lightmapScaleOffset=new Vector4(l[0],l[1],l[2],l[3])),i.instanceParams)(o=i.instanceParams.loadPath)&&(s=Loader.getRes(t[o]),(this.meshFilter.sharedMesh=s).loaded?r.sharedMaterials=s.materials:s.once("loaded",this,__bind(this,this._applyMeshMaterials)));else{(o=n.meshPath)&&(s=Loader.getRes(t[o]),this.meshFilter.sharedMesh=s);var _=n.materials;if(_){var h=r.sharedMaterials,c=_.length;h.length=c;for(var u=0;u<c;u++)h[u]=Loader.getRes(t[_[u].path]);r.sharedMaterials=h}var d=n.rootBone;d&&r._setRootBone(d);var f=n.boundBox;if(f){var m=f.min,p=f.max,g=new BoundBox(new Vector3(m[0],m[1],m[2]),new Vector3(p[0],p[1],p[2]));r.localBoundBox=g}else r._hasIndependentBound=!1;var E=n.boundSphere;if(E){var v=E.center,x=new BoundSphere(new Vector3(v[0],v[1],v[2]),E.radius);r.localBoundSphere=x}}},e._changeHierarchyAnimator=function(e){if(e){var t=this.skinnedMeshRender;t._setCacheAnimator(e);var n=e.avatar;n&&t._setCacheAvatar(n)}laya.d3.core.Sprite3D.prototype._changeHierarchyAnimator.call(this,e)},e._clearSelfRenderObjects=function(){this._scene.removeFrustumCullingObject(this._render)},e._addSelfRenderObjects=function(){this._scene.addFrustumCullingObject(this._render)},e._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},e.cloneTo=function(e){var t=e;t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=t._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge,i._rootBone=n._rootBone;var a=n.localBoundSphere;a&&(i.localBoundSphere=a.clone());var o=n.localBoundBox;o&&(i.localBoundBox=o.clone()),i._hasIndependentBound=n._hasIndependentBound,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},e.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy())},__getset(0,e,"skinnedMeshRender",function(){return this._render}),__getset(0,e,"meshFilter",function(){return this._geometryFilter}),n.__init__=function(){n.SHADERDEFINE_BONE=n.shaderDefines.registerDefine("BONE")},n.load=function(e){return Laya.loader.create(e,null,null,n)},n.SHADERDEFINE_BONE=8,n.BONES=0,__static(n,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines$1(RenderableSprite3D.shaderDefines)}]),n}(RenderableSprite3D),VRCamera=function(e){function a(e,t,n,i,r){void 0===e&&(e=.1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=.3),void 0===r&&(r=1e3),this._tempMatrix=new Matrix4x4,this._leftViewMatrix=new Matrix4x4,this._leftProjectionMatrix=new Matrix4x4,this._leftProjectionViewMatrix=new Matrix4x4,this._leftViewport=new Viewport(0,0,0,0),this._leftNormalizedViewport=new Viewport(0,0,.5,1),this._leftAspectRatio=t,this._rightViewMatrix=new Matrix4x4,this._rightProjectionMatrix=new Matrix4x4,this._rightProjectionViewMatrix=new Matrix4x4,this._rightViewport=new Viewport(0,0,0,0),this._rightNormalizedViewport=new Viewport(.5,0,.5,1),this._rightAspectRatio=n,this._pupilDistande=e,this._leftBoundFrustumUpdate=!0,this._leftBoundFrustum=new BoundFrustum(Matrix4x4.DEFAULT),this._rightBoundFrustumUpdate=!0,this._rightBoundFrustum=new BoundFrustum(Matrix4x4.DEFAULT),a.__super.call(this,i,r),this.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatrixChanged))}__class(a,"laya.d3.core.VRCamera",!1,BaseCamera);var t=a.prototype;return t._onWorldMatrixChanged=function(){this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},t._calculatePupilOffset=function(){var e=this._tempVector3;return Vector3.scale(this.right,this._pupilDistande/2,e),e.elements},t._calculateLeftProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize;Matrix4x4.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix)}else Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=!0},t._calculateRightProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.rightAspectRatio*.5,t=.5*this.orthographicVerticalSize;Matrix4x4.createOrthoOffCenterRH(-e,e,t,t,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._rightBoundFrustumUpdate=!0},t._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.leftAspectRatio*.5,t=.5*this.orthographicVerticalSize,n=this.orthographicVerticalSize*this.rightAspectRatio*.5,i=.5*this.orthographicVerticalSize;Matrix4x4.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Matrix4x4.createOrthoOffCenterRH(-n,n,i,i,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},t._renderCamera=function(e,t,n){var i,r;(t.camera=this)._prepareCameraToRender(),n._preRenderUpdateComponents(t),i=t._viewMatrix=this.leftViewMatrix;var a,o,s=this._renderTarget;t._projectionViewMatrix=s?(s.start(),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this._leftProjectionMatrix,BaseCamera._invertYProjectionMatrix),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this.leftProjectionViewMatrix,BaseCamera._invertYProjectionViewMatrix),r=t._projectionMatrix=BaseCamera._invertYProjectionMatrix,BaseCamera._invertYProjectionViewMatrix):(r=t._projectionMatrix=this._leftProjectionMatrix,this.leftProjectionViewMatrix),this._prepareCameraViewProject(i,r),t._viewport=this.leftViewport,n._preRenderScene(e,t,this.leftBoundFrustum),n._clear(e,t),n._renderScene(e,t),a=t._viewMatrix=this.rightViewMatrix,s?(s.start(),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this._rightProjectionMatrix,BaseCamera._invertYProjectionMatrix),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this.rightProjectionViewMatrix,BaseCamera._invertYProjectionViewMatrix),t._projectionMatrix=BaseCamera._invertYProjectionMatrix,o=t._projectionViewMatrix=BaseCamera._invertYProjectionViewMatrix):(o=t._projectionMatrix=this._rightProjectionMatrix,t._projectionViewMatrix=this.rightProjectionViewMatrix),this._prepareCameraViewProject(a,o),t._viewport=this.rightViewport,n._preRenderScene(e,t,this.rightBoundFrustum),n._clear(e,t),n._renderScene(e,t),n._postRenderUpdateComponents(t),s&&s.end()},__getset(0,t,"rightBoundFrustum",function(){return this._rightBoundFrustumUpdate&&(this._rightBoundFrustum.matrix=this.rightProjectionViewMatrix),this._rightBoundFrustum}),__getset(0,t,"rightProjectionViewMatrix",function(){return Matrix4x4.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),__getset(0,t,"leftProjectionViewMatrix",function(){return Matrix4x4.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),__getset(0,t,"rightViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]+=e[0],n[13]+=e[1],n[14]+=e[2],t.invert(this._rightViewMatrix),this._rightViewMatrix}),__getset(0,t,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),__getset(0,t,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),__getset(0,t,"leftViewMatrix",function(){var e=this._calculatePupilOffset(),t=this._tempMatrix;this.transform.worldMatrix.cloneTo(t);var n=t.elements;return n[12]-=e[0],n[13]-=e[1],n[14]-=e[2],t.invert(this._leftViewMatrix),this._leftViewMatrix}),__getset(0,t,"needRightViewport",function(){var e=this.rightNormalizedViewport;return 0==e.x&&0==e.y&&1==e.width&&1==e.height}),__getset(0,t,"normalizedViewport",null,function(e){if(e.x<0||e.y<0||1<e.x+e.width||1<e.x+e.height)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new Viewport(0,0,e.width/2,e.height),this._rightNormalizedViewport=new Viewport(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),__getset(0,t,"leftBoundFrustum",function(){return this._leftBoundFrustumUpdate&&(this._leftBoundFrustum.matrix=this.leftProjectionViewMatrix),this._leftBoundFrustum}),__getset(0,t,"leftNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._leftViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftNormalizedViewport.x=e.x/n,this._leftNormalizedViewport.y=e.y/i,this._leftNormalizedViewport.width=e.width/n,this._leftNormalizedViewport.height=e.height/i}return this._leftNormalizedViewport}),__getset(0,t,"needLeftViewport",function(){var e=this.leftNormalizedViewport;return 0==e.x&&0==e.y&&1==e.width&&1==e.height}),__getset(0,t,"rightViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._rightNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightViewport.x=e.x*n,this._rightViewport.y=e.y*i,this._rightViewport.width=e.width*n,this._rightViewport.height=e.height*i}return this._rightViewport}),__getset(0,t,"rightNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._rightViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._rightNormalizedViewport.x=e.x/n,this._rightNormalizedViewport.y=e.y/i,this._rightNormalizedViewport.width=e.width/n,this._rightNormalizedViewport.height=e.height/i}return this._rightNormalizedViewport}),__getset(0,t,"viewport",null,function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new Viewport(0,0,e.width/2,e.height),this._rightViewport=new Viewport(e.width/2,0,e.width/2,e.height),this._calculateProjectionMatrix()}),__getset(0,t,"rightAspectRatio",function(){if(0!=this._rightAspectRatio)return this._rightAspectRatio;var e=this.rightViewport;return e.width/e.height}),__getset(0,t,"aspectRatio",null,function(e){if(e<0)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=e,this._rightAspectRatio=e,this._calculateRightProjectionMatrix()}),__getset(0,t,"leftViewport",function(){if(this._viewportExpressedInClipSpace){var e=this._leftNormalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._leftViewport.x=e.x*n,this._leftViewport.y=e.y*i,this._leftViewport.width=e.width*n,this._leftViewport.height=e.height*i}return this._leftViewport}),__getset(0,t,"leftAspectRatio",function(){if(0!=this._leftAspectRatio)return this._leftAspectRatio;var e=this.leftViewport;return e.width/e.height}),a}(),TerrainChunk=function(t){function l(e,t,n,i,r,a,o,s){l.__super.call(this,s),this._geometryFilter=new TerrainFilter(this,e,t,n,i,r,a,o),this._render=new TerrainRender(this)}__class(l,"laya.d3.terrain.TerrainChunk",!1,t);var e=l.prototype;return e.buildRenderElementAndMaterial=function(e,t,n,i,r,a,o,s,l,_,h,c,u,d,f,m,p,g){void 0===h&&(h=1),void 0===c&&(c=1),void 0===u&&(u=1),void 0===d&&(d=1),void 0===f&&(f=1),void 0===m&&(m=1),void 0===p&&(p=1),void 0===g&&(g=1);var E=new TerrainMaterial;l&&(E.diffuseColor=l),s&&(E.ambientColor=s),_&&(E.specularColor=_),E.splatAlphaTexture=Loader.getRes(n),E.normalTexture=t?Loader.getRes(t):null,E.diffuseTexture1=i?Loader.getRes(i):null,E.diffuseTexture2=r?Loader.getRes(r):null,E.diffuseTexture3=a?Loader.getRes(a):null,E.diffuseTexture4=o?Loader.getRes(o):null,E.setDiffuseScale1(h,c),E.setDiffuseScale2(u,d),E.setDiffuseScale3(f,m),E.setDiffuseScale4(p,g),E.setDetailNum(e),0!=this._render._renderElements.length&&(E.renderMode=2);var v=new RenderElement;v._mainSortID=0,v._sprite3D=this,v.renderObj=this._geometryFilter,v._material=E,this._render._materials.push(E),this._render._renderElements.push(v)},e._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},e._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},e._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;i<r;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},e.cloneTo=function(e){console.log("Terrain Chunk can't clone")},e.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy())},__getset(0,e,"terrainRender",function(){return this._render}),__getset(0,e,"terrainFilter",function(){return this._geometryFilter}),l.load=function(e){return Laya.loader.create(e,null,null,l,null,1,!1)},l}(RenderableSprite3D),PointLight=function(e){function t(){this._range=NaN,this._attenuation=null,t.__super.call(this),this._range=6,this._attenuation=new Vector3(.6,.6,.6)}__class(t,"laya.d3.core.light.PointLight",!1,LightSprite);var n=t.prototype;return n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(8,null),t.setValue(5,null),t.setValue(6,null),t.setValue(7,null),e.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT)},n._prepareToScene=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT),Vector3.scale(this.color,this._intensity,this._intensityColor),n.setValue(8,this._intensityColor.elements),n.setValue(5,this.transform.position.elements),n.setValue(6,this.range),n.setValue(7,this.attenuation.elements),!0}return t.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT),!1},__getset(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),__getset(0,n,"range",function(){return this._range},function(e){this._range=e}),t}(),DirectionLight=function(e){function t(){this._direction=null,this._updateDirection=!1,t.__super.call(this),this._updateDirection=!1,this._direction=new Vector3,this.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatrixChange))}__class(t,"laya.d3.core.light.DirectionLight",!1,e);var n=t.prototype;return n._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new ParallelSplitShadowMap,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var e=this.scene.parallelSplitShadowMaps;e.splice(e.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,this.scene.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),this.scene.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),this.scene.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3)}},n._addSelfRenderObjects=function(){e.prototype._addSelfRenderObjects.call(this),this._shadow&&this._initShadow()},n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(4,null),t.setValue(3,null),e.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},n._prepareToScene=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT),Vector3.scale(this.color,this._intensity,this._intensityColor),n.setValue(4,this._intensityColor.elements),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),n.setValue(3,this._direction.elements),!0}return t.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT),!1},n._onWorldMatrixChange=function(){this._updateDirection=!0},__getset(0,n,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),this._updateDirection=!1),this._direction},function(e){console.log("Warning: discard property,please use transform's property instead.");var t=this.transform.worldMatrix;t.setForward(e),this.transform.worldMatrix=t,Vector3.normalize(e,e),this._direction=e,this.shadow&&this._parallelSplitShadowMap&&this._parallelSplitShadowMap._setGlobalParallelLightDir(this._direction)}),__getset(0,n,"shadow",e.prototype._$get_shadow,function(e){this._shadow!=e&&(this._shadow=e,this.scene&&this._initShadow())}),t}(LightSprite),SpotLight=function(e){function t(){this._updateDirection=!1,this._direction=null,this._spot=NaN,this._range=NaN,this._attenuation=null,t.__super.call(this),this._updateDirection=!1,this.direction=new Vector3(0,-1,-1),this._attenuation=new Vector3(.6,.6,.6),this._spot=96,this._range=6,this.transform.on("worldmatrixneedchanged",this,__bind(this,this._onWorldMatrixChange))}__class(t,"laya.d3.core.light.SpotLight",!1,LightSprite);var n=t.prototype;return n._onWorldMatrixChange=function(){this._updateDirection=!0},n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(14,null),t.setValue(9,null),t.setValue(10,null),t.setValue(12,null),t.setValue(11,null),t.setValue(13,null),e.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_SPOTLIGHT)},n._prepareToScene=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(ShaderCompile3D.SHADERDEFINE_SPOTLIGHT),Vector3.scale(this.color,this._intensity,this._intensityColor),n.setValue(14,this._intensityColor.elements),n.setValue(9,this.transform.position.elements),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),n.setValue(10,this._direction.elements),n.setValue(12,this.range),n.setValue(11,this.spot),n.setValue(13,this.attenuation.elements),!0}return t.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_SPOTLIGHT),!1},__getset(0,n,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),this._updateDirection=!1),this._direction},function(e){console.log("Warning: discard property,please use transform's property instead.");var t=this.transform.worldMatrix;t.setForward(e),this.transform.worldMatrix=t,this._direction=e}),__getset(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),__getset(0,n,"range",function(){return this._range},function(e){this._range=e}),__getset(0,n,"spot",function(){return this._spot},function(e){this._spot=e}),t}(),MeshTerrainSprite3D=function(e){function v(e,t,n){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,v.__super.call(this,e,n),this._heightMap=t,this._cellSize=new Vector2}__class(v,"laya.d3.core.MeshTerrainSprite3D",!1,MeshSprite3D);var t=v.prototype;return t._disableRotation=function(){var e=this.transform.rotation;e.elements[0]=0,e.elements[1]=0,e.elements[2]=0,e.elements[3]=1,this.transform.rotation=e},t._getScaleX=function(){var e=this.transform.worldMatrix.elements,t=e[0],n=e[1],i=e[2];return Math.sqrt(t*t+n*n+i*i)},t._getScaleZ=function(){var e=this.transform.worldMatrix.elements,t=e[8],n=e[9],i=e[10];return Math.sqrt(t*t+n*n+i*i)},t._initCreateFromMesh=function(e,t){this._heightMap=HeightMap.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var n=this.meshFilter.sharedMesh.boundingBox,i=n.min;n.max;this._minX=i.x,this._minZ=i.z},t._initCreateFromMeshHeightMap=function(e,t,n){var i=this,r=this.meshFilter.sharedMesh.boundingBox;e.loaded?(this._heightMap=HeightMap.createFromImage(e,t,n),this._computeCellSize(r)):e.once("loaded",null,function(){i._heightMap=HeightMap.createFromImage(e,t,n),i._computeCellSize(r)});var a=r.min;r.max;this._minX=a.x,this._minZ=a.z},t._computeCellSize=function(e){var t=e.min,n=e.max,i=t.x,r=t.z,a=n.x-i,o=n.z-r;this._cellSize.elements[0]=a/(this._heightMap.width-1),this._cellSize.elements[1]=o/(this._heightMap.height-1)},t._update=function(e){this._disableRotation(),laya.d3.core.RenderableSprite3D.prototype._update.call(this,e)},t.getHeight=function(e,t){v._tempVector3.elements[0]=e,v._tempVector3.elements[1]=0,v._tempVector3.elements[2]=t,this._disableRotation();var n=this.transform.worldMatrix;n.invert(v._tempMatrix4x4),Vector3.transformCoordinate(v._tempVector3,v._tempMatrix4x4,v._tempVector3),e=v._tempVector3.elements[0],t=v._tempVector3.elements[2];var i=(e-this._minX)/this._cellSize.x,r=(t-this._minZ)/this._cellSize.y,a=Math.floor(r),o=Math.floor(i),s=i-o,l=r-a,_=n.elements,h=_[4],c=_[5],u=_[6],d=Math.sqrt(h*h+c*c+u*u),f=_[13],m=this._heightMap.getHeight(a,o+1),p=this._heightMap.getHeight(a+1,o);if(isNaN(m)||isNaN(p))return NaN;if(s+l<=1){var g=this._heightMap.getHeight(a,o);return isNaN(g)?NaN:(g+s*(m-g)+l*(p-g))*d+f}var E=this._heightMap.getHeight(a+1,o+1);return isNaN(E)?NaN:(E+(1-s)*(p-E)+(1-l)*(m-E))*d+f},__getset(0,t,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),__getset(0,t,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),__getset(0,t,"minZ",function(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}),__getset(0,t,"minX",function(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}),v.createFromMesh=function(e,t,n,i){var r=new v(e,null,i);return e.loaded?r._initCreateFromMesh(t,n):e.once("loaded",r,r._initCreateFromMesh,[t,n]),r},v.createFromMeshAndHeightMap=function(e,t,n,i,r){var a=new v(e,null,r);return e.loaded?a._initCreateFromMeshHeightMap(t,n,i):e.once("loaded",a,a._initCreateFromMeshHeightMap,[t,n,i]),a},__static(v,["_tempVector3",function(){return this._tempVector3=new Vector3},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new Matrix4x4}]),v}();"function"==typeof define&&define.amd&&define("laya.core",["require","exports"],function(e,t){"use strict";for(var n in Object.defineProperty(t,"__esModule",{value:!0}),Laya){var i=Laya[n];i&&i.__isclass&&(t[n]=i)}});