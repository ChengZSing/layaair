var KeyFramesContent=function(){function t(){this.startTime=NaN,this.duration=NaN,this.interpolationData=null,this.data=null,this.nextData=null}return __class(t,"laya.ani.KeyFramesContent",!0),t}(),AnimationParser02=function(){function M(){}return __class(M,"laya.ani.AnimationParser02",!0),M.READ_DATA=function(){M._DATA.offset=M._reader.getUint32(),M._DATA.size=M._reader.getUint32()},M.READ_BLOCK=function(){for(var t=M._BLOCK.count=M._reader.getUint16(),e=M._BLOCK.blockStarts=[],i=M._BLOCK.blockLengths=[],a=0;a<t;a++)e.push(M._reader.getUint32()),i.push(M._reader.getUint32())},M.READ_STRINGS=function(){var t=M._reader.getUint32(),e=M._reader.getUint16(),i=M._reader.pos;M._reader.pos=t+M._DATA.offset;for(var a=0;a<e;a++)M._strings[a]=M._reader.readUTFString();M._reader.pos=i},M.parse=function(t,e){M._templet=t;(M._reader=e).__getBuffer();M.READ_DATA(),M.READ_BLOCK(),M.READ_STRINGS();for(var i=0,a=M._BLOCK.count;i<a;i++){var s=e.getUint16(),r=M._strings[s],n=M["READ_"+r];if(null==n)throw new Error("model file err,no this function:"+s+" "+r);n.call()}},M.READ_ANIMATIONS=function(){var t=M._reader,e=t.__getBuffer(),i=0,a=0,s=0,r=0,n=t.getUint16(),h=[];for(h.length=n,i=0;i<n;i++)h[i]=AnimationTemplet.interpolation[t.getByte()];var l=t.getUint8();for(M._templet._anis.length=l,i=0;i<l;i++){var o=M._templet._anis[i]={};o.nodes=new Array;var u=o.name=M._strings[t.getUint16()];M._templet._aniMap[u]=i,o.bone3DMap={},o.playTime=t.getFloat32();var _=o.nodes.length=t.getInt16();for(a=o.totalKeyframeDatasLength=0;a<_;a++){var c=o.nodes[a]={};c.keyframeWidth=n,c.childs=[];var d=t.getUint16();0<=d&&(c.name=M._strings[d],o.bone3DMap[c.name]=a),c.keyFrame=new Array,c.parentIndex=t.getInt16(),-1==c.parentIndex?c.parent=null:c.parent=o.nodes[c.parentIndex],o.totalKeyframeDatasLength+=n,c.interpolationMethod=h,null!=c.parent&&c.parent.childs.push(c);var p=t.getUint16(),f=null,m=null;for(s=0,r=c.keyFrame.length=p;s<r;s++){(f=c.keyFrame[s]={}).startTime=t.getFloat32(),m&&(m.duration=f.startTime-m.startTime);var x=M._DATA.offset,y=t.getUint32(),g=4*n,v=e.slice(x+y,x+y+g);f.data=new Float32Array(v),m=f}f.duration=0,c.playTime=o.playTime,M._templet._calculateKeyFrame(c,p,n)}}},M._templet=null,M._reader=null,M._strings=[],__static(M,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),M}(),SlotData=function(){function t(){this.name=null,this.displayArr=[]}return __class(t,"laya.ani.bone.SlotData",!0),t.prototype.getDisplayByName=function(t){for(var e=0,i=this.displayArr.length;e<i;e++)if(this.displayArr[e].attachmentName==t)return e;return-1},t}(),SkinSlotDisplayData=function(){function t(){this.name=null,this.attachmentName=null,this.type=0,this.transform=null,this.width=NaN,this.height=NaN,this.texture=null,this.bones=null,this.uvs=null,this.weights=null,this.triangles=null,this.vertices=null,this.lengths=null,this.verLen=0}__class(t,"laya.ani.bone.SkinSlotDisplayData",!0);var e=t.prototype;return e.createTexture=function(t){return this.texture||(this.texture=new Texture(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight),Render.isWebGL||this.uvs[1]>this.uvs[5]&&(this.texture.offsetY=this.texture.sourceHeight-this.texture.height-this.texture.offsetY)),this.texture},e.destory=function(){this.texture&&this.texture.destroy()},t}(),Transform=function(){function t(){this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0,this.mMatrix=null}__class(t,"laya.ani.bone.Transform",!0);var e=t.prototype;return e.initData=function(t){null!=t.x&&(this.x=t.x),null!=t.y&&(this.y=t.y),null!=t.skX&&(this.skX=t.skX),null!=t.skY&&(this.skY=t.skY),null!=t.scX&&(this.scX=t.scX),null!=t.scY&&(this.scY=t.scY)},e.getMatrix=function(){var t;return(t=this.mMatrix?this.mMatrix:this.mMatrix=new Matrix).identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t},e.skew=function(t,e,i){var a=Math.sin(i),s=Math.cos(i),r=Math.sin(e),n=Math.cos(e);return t.setTo(t.a*n-t.b*a,t.a*r+t.b*s,t.c*n-t.d*a,t.c*r+t.d*s,t.tx*n-t.ty*a,t.tx*r+t.ty*s),t},t}(),TfConstraint=function(){function t(t,e){this._data=null,this._bones=null,this.target=null,this.rotateMix=NaN,this.translateMix=NaN,this.scaleMix=NaN,this.shearMix=NaN,this._temp=__newvec(2,0),this._data=t,null==this._bones&&(this._bones=[]),this.target=e[t.targetIndex];var i,a=0;for(a=0,i=t.boneIndexs.length;a<i;a++)this._bones.push(e[t.boneIndexs[a]]);this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.scaleMix=t.scaleMix,this.shearMix=t.shearMix}return __class(t,"laya.ani.bone.TfConstraint",!0),t.prototype.apply=function(){for(var t,e=this.target.resultMatrix.a,i=this.target.resultMatrix.b,a=this.target.resultMatrix.c,s=this.target.resultMatrix.d,r=0,n=this._bones.length;r<n;r++){if(t=this._bones[r],0<this.rotateMix){var h=t.resultMatrix.a,l=t.resultMatrix.b,o=t.resultMatrix.c,u=t.resultMatrix.d,_=Math.atan2(a,e)-Math.atan2(o,h)+this._data.offsetRotation*Math.PI/180;_>Math.PI?_-=2*Math.PI:_<-Math.PI&&(_+=2*Math.PI),_*=this.rotateMix;var c=Math.cos(_),d=Math.sin(_);t.resultMatrix.a=c*h-d*o,t.resultMatrix.b=c*l-d*u,t.resultMatrix.c=d*h+c*o,t.resultMatrix.d=d*l+c*u}if(this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),t.resultMatrix.tx+=(this._temp[0]-t.resultMatrix.tx)*this.translateMix,t.resultMatrix.ty+=(this._temp[1]-t.resultMatrix.ty)*this.translateMix,t.updateChild()),0<this.scaleMix){var p=Math.sqrt(t.resultMatrix.a*t.resultMatrix.a+t.resultMatrix.c*t.resultMatrix.c),f=Math.sqrt(e*e+a*a),m=1e-5<p?(p+(f-p+this._data.offsetScaleX)*this.scaleMix)/p:0;t.resultMatrix.a*=m,t.resultMatrix.c*=m,p=Math.sqrt(t.resultMatrix.b*t.resultMatrix.b+t.resultMatrix.d*t.resultMatrix.d),f=Math.sqrt(i*i+s*s),m=1e-5<p?(p+(f-p+this._data.offsetScaleY)*this.scaleMix)/p:0,t.resultMatrix.b*=m,t.resultMatrix.d*=m}if(0<this.shearMix){l=t.resultMatrix.b,u=t.resultMatrix.d;var x=Math.atan2(u,l);(_=Math.atan2(s,i)-Math.atan2(a,e)-(x-Math.atan2(t.resultMatrix.c,t.resultMatrix.a)))>Math.PI?_-=2*Math.PI:_<-Math.PI&&(_+=2*Math.PI),_=x+(_+this._data.offsetShearY*Math.PI/180)*this.shearMix,m=Math.sqrt(l*l+u*u),t.resultMatrix.b=Math.cos(_)*m,t.resultMatrix.d=Math.sin(_)*m}}},t}(),TfConstraintData=function(){function t(){this.name=null,this.targetIndex=0,this.rotateMix=NaN,this.translateMix=NaN,this.scaleMix=NaN,this.shearMix=NaN,this.offsetRotation=NaN,this.offsetX=NaN,this.offsetY=NaN,this.offsetScaleX=NaN,this.offsetScaleY=NaN,this.offsetShearY=NaN,this.boneIndexs=[]}return __class(t,"laya.ani.bone.TfConstraintData",!0),t}(),MeshTools=function(){function d(){}return __class(d,"laya.ani.bone.MeshTools",!0),d.findEdge=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!0);var a,s=0,r=0;for(a=t.length,r=-1,s=0;s<a;s+=2)(r<0||i==t[r+e]<t[s+e])&&(r=s);return r},d.findBestTriangle=function(t){var e;e=d.findEdge(t,1,!0);var i;i=d.findEdge(t,1,!1);var a;a=d.findEdge(t,0,!0);var s,r;return s=d.findEdge(t,0,!1),(r=d._bestTriangle).length=0,r.push(a,s),r.indexOf(e)<0&&r.push(e),r.indexOf(i)<0&&r.push(i),r},d.solveMesh=function(t,e){var i,a,s,r;(e=e||[]).length=0,i=t.uvs,a=t.vertices;var n,h,l;return n=(r=d.findBestTriangle(i))[0],h=r[1],l=r[2],d._absArr.length=0,d.isNormalUV(t.texture.uv)&&d.adptTexture(t),s=d.solvePoints(t.texture.uv,i[n],i[n+1],i[h]-i[n],i[h+1]-i[n+1],i[l]-i[n],i[l+1]-i[n+1],d._absArr),d.transPoints(s,a[n],a[n+1],a[h]-a[n],a[h+1]-a[n+1],a[l]-a[n],a[l+1]-a[n+1],e)},d.findWrapRect=function(t){var e;e=d.findEdge(t,1,!0);var i;i=d.findEdge(t,1,!1);var a;a=d.findEdge(t,0,!0);var s;s=d.findEdge(t,0,!1);var r;r=t[a];var n;n=t[s];var h;h=t[e+1];var l;return[n,l=t[i+1],r-n,h-l]},d.adptTexture=function(t){var e,i,a;e=d.findWrapRect(t.uvs);var s=(i=t.texture).width,r=i.height;a=Texture.create(i,e[0]*s,e[1]*r,e[2]*s,e[3]*r),t.texture=a},d.isNormalUV=function(t){return 0==t[0]&&0==t[1]&&1==t[4]&&1==t[5]},d.solvePoints=function(t,e,i,a,s,r,n,h){h=h||[];var l,o,u=0;for(l=t.length,u=0;u<l;u+=2)o=d.solve2(t[u],t[u+1],e,i,a,s,r,n),h.push(o[0],o[1]);return h},d.transPoints=function(t,e,i,a,s,r,n,h){h=h||[];var l,o=0;for(l=t.length,o=0;o<l;o+=2)d.transPoint(t[o],t[o+1],e,i,a,s,r,n,h);return h},d.transPoint=function(t,e,i,a,s,r,n,h,l){var o,u;return o=i+s*t+n*e,u=a+r*t+h*e,(l=l||[]).push(o,u),l},d.solve2=function(t,e,i,a,s,r,n,h,l,o){void 0===l&&(l=!1),o=o||[];var u,_;if(0==s)return d.solve2(t,e,i,a,n,h,s,r,!0,o);var c;return u=((c=t-i)-(_=(e-a-c*r/s)/(h-n*r/s))*n)/s,l?o.push(_,u):o.push(u,_),o},d.solve=function(t,e,i,a){return d.solve2(t.x,t.y,e.x,e.y,i.x,i.y,a.x,a.y)},d._bestTriangle=[],d._absArr=[],d}(),Bone=function(){function s(){this.name=null,this.root=null,this.parentBone=null,this.length=10,this.transform=null,this.inheritScale=!0,this.inheritRotation=!0,this.rotation=NaN,this.resultRotation=NaN,this.d=-1,this._tempMatrix=null,this._sprite=null,this.resultTransform=new Transform,this.resultMatrix=new Matrix,this._children=[]}__class(s,"laya.ani.bone.Bone",!0);var t=s.prototype;return t.setTempMatrix=function(t){this._tempMatrix=t;var e,i=0;for(i=0,e=this._children.length;i<e;i++)this._children[i].setTempMatrix(this._tempMatrix)},t.update=function(t){var e;if(this.rotation=this.transform.skX,t)e=this.resultTransform.getMatrix(),Matrix.mul(e,t,this.resultMatrix),this.resultRotation=this.rotation;else if(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone)if(this.inheritRotation&&this.inheritScale)e=this.resultTransform.getMatrix(),Matrix.mul(e,this.parentBone.resultMatrix,this.resultMatrix);else{var i=this.parentBone,a=NaN,s=NaN,r=NaN,n=this.parentBone.resultMatrix;e=this.resultTransform.getMatrix();var h=n.a*e.tx+n.c*e.ty+n.tx,l=n.b*e.tx+n.d*e.ty+n.ty,o=new Matrix;this.inheritRotation?(a=Math.atan2(i.resultMatrix.b,i.resultMatrix.a),s=Math.cos(a),r=Math.sin(a),o.setTo(s,r,-r,s,0,0),Matrix.mul(this._tempMatrix,o,Matrix.TEMP),Matrix.TEMP.copyTo(o),e=this.resultTransform.getMatrix(),Matrix.mul(e,o,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI)):(this.inheritScale,e=this.resultTransform.getMatrix(),Matrix.TEMP.identity(),Matrix.TEMP.d=this.d,Matrix.mul(e,Matrix.TEMP,this.resultMatrix)),this.resultMatrix.tx=h,this.resultMatrix.ty=l}else(e=this.resultTransform.getMatrix()).copyTo(this.resultMatrix);var u,_=0;for(_=0,u=this._children.length;_<u;_++)this._children[_].update()},t.updateChild=function(){var t,e=0;for(e=0,t=this._children.length;e<t;e++)this._children[e].update()},t.setRotation=function(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)},t.updateDraw=function(t,e){s.ShowBones&&!s.ShowBones[this.name]||(this._sprite||(this._sprite=new Sprite,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),Laya.stage.addChild(this._sprite)),this._sprite.x=t+this.resultMatrix.tx,this._sprite.y=e+this.resultMatrix.ty);var i,a=0;for(a=0,i=this._children.length;a<i;a++)this._children[a].updateDraw(t,e)},t.addChild=function(t){this._children.push(t),t.parentBone=this},t.findBone=function(t){if(this.name==t)return this;var e,i,a=0;for(a=0,e=this._children.length;a<e;a++)if(i=this._children[a].findBone(t))return i;return null},t.localToWorld=function(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty},s.ShowBones={},s}(),BoneSlot=function(){function f(){this.name=null,this.parent=null,this.attachmentName=null,this.srcDisplayIndex=-1,this.type="src",this.templet=null,this.currSlotData=null,this.currTexture=null,this.currDisplayData=null,this.displayIndex=-1,this._diyTexture=null,this._parentMatrix=null,this._resultMatrix=null,this._replaceDic={},this._curDiyUV=null,this._curDiyVS=null,this._skinSprite=null,this.deformData=null,this._mVerticleArr=null}__class(f,"laya.ani.bone.BoneSlot",!0);var t=f.prototype;return t.showSlotData=function(t,e){void 0===e&&(e=!0),this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null},t.showDisplayByName=function(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))},t.replaceDisplayByName=function(t,e){if(this.currSlotData){var i;i=this.currSlotData.getDisplayByName(t);var a;a=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(i,a)}},t.replaceDisplayByIndex=function(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.displayIndex==t&&this.showDisplayByIndex(t))},t.showDisplayByIndex=function(t){if(null!=this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&-1<t&&t<this.currSlotData.displayArr.length){if(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData){var e=this.currDisplayData.name;this.currTexture=this.templet.getTexture(e),this.currTexture&&!Render.isConchApp&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture))}}else this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null},t.replaceSkin=function(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)},t.setParentMatrix=function(t){this._parentMatrix=t},t.draw=function(t,e,i,a){if(void 0===i&&(i=!1),void 0===a&&(a=1),(null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var s,r=this.currTexture;switch(this._diyTexture&&(r=this._diyTexture),this.currDisplayData.type){case 0:if(t){var n=this.getDisplayMatrix();if(this._parentMatrix){var h=!1;if(n){var l;if(Matrix.mul(n,this._parentMatrix,Matrix.TEMP),l=i?(null==this._resultMatrix&&(this._resultMatrix=new Matrix),this._resultMatrix):new Matrix,!Render.isWebGL&&this.currDisplayData.uvs||Render.isWebGL&&this._diyTexture&&this.currDisplayData.uvs){var o=f._tempMatrix;o.identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(o.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(h=!0,o.rotate(-Math.PI/2)),Matrix.mul(o,Matrix.TEMP,l)}else Matrix.TEMP.copyTo(l);h?t.drawTexture(r,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,l):t.drawTexture(r,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,l)}}}break;case 1:if(null==(s=i?(null==this._skinSprite&&(this._skinSprite=f.createSkinMesh()),this._skinSprite):f.createSkinMesh()))return;var u;if(null==this.currDisplayData.bones){var _,c=this.currDisplayData.weights;this.deformData&&(c=this.deformData),_=this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=UVTools.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=UVTools.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),this._curDiyUV):this.currDisplayData.uvs,this._mVerticleArr=c;this.currDisplayData.triangles.length;u=this.currDisplayData.triangles,s.init2(r,null,u,this._mVerticleArr,_);var d,p=this.getDisplayMatrix();if(this._parentMatrix)if(p)Matrix.mul(p,this._parentMatrix,Matrix.TEMP),d=i?(null==this._resultMatrix&&(this._resultMatrix=new Matrix),this._resultMatrix):new Matrix,Matrix.TEMP.copyTo(d),s.transform=d}else this.skinMesh(e,s,a);t.drawSkin(s);break;case 2:if(null==(s=i?(null==this._skinSprite&&(this._skinSprite=f.createSkinMesh()),this._skinSprite):f.createSkinMesh()))return;this.skinMesh(e,s,a),t.drawSkin(s)}}},t.skinMesh=function(t,e,i){var a,s=this.currTexture,r=this.currDisplayData.bones;a=this._diyTexture?(s=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=UVTools.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=UVTools.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),this._curDiyUV):this.currDisplayData.uvs;var n,h,l=this.currDisplayData.weights,o=this.currDisplayData.triangles,u=0,_=0,c=0,d=NaN,p=NaN,f=0,m=0,x=[],y=0,g=0;if(this.deformData&&0<this.deformData.length){var v=0;for(y=0,g=r.length;y<g;){for(c=r[y++]+y,_=u=0;y<c;y++)h=t[r[y]],d=l[f]+this.deformData[v++],p=l[f+1]+this.deformData[v++],m=l[f+2],u+=(d*h.a+p*h.c+h.tx)*m,_+=(d*h.b+p*h.d+h.ty)*m,f+=3;x.push(u,_)}}else for(y=0,g=r.length;y<g;){for(c=r[y++]+y,_=u=0;y<c;y++)h=t[r[y]],d=l[f],p=l[f+1],m=l[f+2],u+=(d*h.a+p*h.c+h.tx)*m,_+=(d*h.b+p*h.d+h.ty)*m,f+=3;x.push(u,_)}this._mVerticleArr=x,n=o,e.init2(s,null,n,this._mVerticleArr,a)},t.drawBonePoint=function(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")},t.getDisplayMatrix=function(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null},t.getMatrix=function(){return this._resultMatrix},t.copy=function(){var t=new f;return t.type="copy",t.name=this.name,t.attachmentName=this.attachmentName,t.srcDisplayIndex=this.srcDisplayIndex,t.parent=this.parent,t.displayIndex=this.displayIndex,t.templet=this.templet,t.currSlotData=this.currSlotData,t.currTexture=this.currTexture,t.currDisplayData=this.currDisplayData,t},f.createSkinMesh=function(){return Render.isWebGL||Render.isConchApp?RunDriver.skinAniSprite():Render.isWebGL?null:Skeleton.useSimpleMeshInCanvas?new SimpleSkinMeshCanvas:new SkinMeshCanvas},__static(f,["_tempMatrix",function(){return this._tempMatrix=new Matrix}]),f}(),DrawOrderData=function(){function t(){this.time=NaN,this.drawOrder=[]}return __class(t,"laya.ani.bone.DrawOrderData",!0),t}(),PathConstraint=function(){function F(t,e){this.target=null,this.data=null,this.bones=null,this.position=NaN,this.spacing=NaN,this.rotateMix=NaN,this.translateMix=NaN,this._debugKey=!1,this._spaces=null,this._segments=[],this._curves=[],this.data=t,this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.bones=[];for(var i=this.data.bones,a=0,s=i.length;a<s;a++)this.bones.push(e[i[a]])}__class(F,"laya.ani.bone.PathConstraint",!0);var t=F.prototype;return t.apply=function(t,e){if(this.target){var i=this.translateMix,a=this.translateMix,s=0<a,r=this.data.spacingMode,n="length"==r,h=this.data.rotateMode,l="tangent"==h,o="chainScale"==h,u=[],_=this.bones.length,c=l?_:_+1,d=[];(this._spaces=d)[0]=this.position;var p=this.spacing;if(o||n)for(var f=0,m=c-1;f<m;){var x=this.bones[f],y=x.length,g=y*x.resultMatrix.a,v=y*x.resultMatrix.b;y=Math.sqrt(g*g+v*v),o&&(u[f]=y),d[++f]=n?Math.max(0,y+p):p}else for(f=1;f<c;f++)d[f]=p;var M=this.computeWorldPositions(this.target,t,e,c,l,"percent"==this.data.positionMode,"percent"==r);if(this._debugKey){for(f=0;f<M.length;f++)e.drawCircle(M[f++],M[f++],5,"#00ff00");var D=[];for(f=0;f<M.length;f++)D.push(M[f++],M[f++]);e.drawLines(0,0,D,"#ff0000")}var I=M[0],b=M[1],T=this.data.offsetRotation,N="chain"==h&&0==T,C=NaN;for(f=0,C=3;f<_;f++,C+=3){(x=this.bones[f]).resultMatrix.tx+=(I-x.resultMatrix.tx)*i,x.resultMatrix.ty+=(b-x.resultMatrix.ty)*i;var A=(g=M[C])-I,S=(v=M[C+1])-b;if(o&&0!=(y=u[f])){var w=(Math.sqrt(A*A+S*S)/y-1)*a+1;x.resultMatrix.a*=w,x.resultMatrix.c*=w}if(I=g,b=v,s){var k=x.resultMatrix.a,F=x.resultMatrix.c,P=x.resultMatrix.b,B=x.resultMatrix.d,U=NaN,L=NaN,R=NaN;U=l?M[C-1]:0==d[f+1]?M[C+2]:Math.atan2(S,A),U-=Math.atan2(P,k)-T/180*Math.PI,N&&(L=Math.cos(U),R=Math.sin(U),I+=((y=x.length)*(L*k-R*P)-A)*a,b+=(y*(R*k+L*P)-S)*a),U>Math.PI?U-=2*Math.PI:U<-Math.PI&&(U+=2*Math.PI),U*=a,L=Math.cos(U),R=Math.sin(U),x.resultMatrix.a=L*k-R*P,x.resultMatrix.c=L*F-R*B,x.resultMatrix.b=R*k+L*P,x.resultMatrix.d=R*F+L*B}}}},t.computeWorldVertices2=function(t,e,i,a,s,r){var n,h,l=t.currDisplayData.bones,o=t.currDisplayData.weights,u=t.currDisplayData.triangles,_=0,c=0,d=0,p=0,f=0,m=0,x=0,y=0,g=0,v=0,M=0;if(null!=l){for(_=0;_<i;_+=2)c+=(p=l[c])+1,d+=p;var D=e;for(f=r,m=3*d;f<a;f+=2){for(y=x=0,p=l[c++],p+=c;c<p;c++,m+=3){n=D[l[c]].resultMatrix,g=o[m],v=o[m+1];var I=o[m+2];x+=(g*n.a+v*n.c+n.tx)*I,y+=(g*n.b+v*n.d+n.ty)*I}s[f]=x,s[f+1]=y}}else{var b,T;if(u||(u=o),t.deformData&&(u=t.deformData),b=t.parent,e)for(M=e.length,_=0;_<M;_++)if(e[_].name==b){h=e[_];break}h&&(T=h.resultMatrix),T||(T=F._tempMt);var N=T.tx,C=T.ty,A=T.a,S=T.b,w=T.c,k=T.d;for(h&&(k*=h.d),c=i,f=r;f<a;c+=2,f+=2)g=u[c],v=u[c+1],s[f]=g*A+v*S+N,s[f+1]=-(g*w+v*k+C)}},t.computeWorldPositions=function(t,e,i,a,s,r,n){t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles;var h=[],l=0,o=t.currDisplayData.verLen,u=this.position,_=this._spaces,c=[],d=[],p=o/6,f=-1,m=NaN,x=0,y=0,g=NaN,v=NaN,M=NaN,D=NaN;if(p--,o-=4,this.computeWorldVertices2(t,e,2,o,h,0),this._debugKey)for(l=0;l<h.length;)i.drawCircle(h[l++],h[l++],10,"#ff0000");c=h,this._curves.length=p;var I=this._curves,b=c[m=0],T=c[1],N=0,C=0,A=0,S=0,w=0,k=0,F=NaN,P=NaN,B=NaN,U=NaN,L=NaN,R=NaN,O=NaN,E=NaN,K=0;for(l=0,K=2;l<p;l++,K+=6)N=c[K],C=c[K+1],A=c[K+2],S=c[K+3],L=2*(F=.1875*(b-2*N+A))+(B=.09375*(3*(N-A)-b+(w=c[K+4]))),R=2*(P=.1875*(T-2*C+S))+(U=.09375*(3*(C-S)-T+(k=c[K+5]))),O=.75*(N-b)+F+.16666667*B,E=.75*(C-T)+P+.16666667*U,m+=Math.sqrt(O*O+E*E),O+=L,E+=R,L+=B,R+=U,m+=Math.sqrt(O*O+E*E),O+=L,E+=R,m+=Math.sqrt(O*O+E*E),O+=L+B,E+=R+U,m+=Math.sqrt(O*O+E*E),I[l]=m,b=w,T=k;if(r&&(u*=m),n)for(l=0;l<a;l++)_[l]*=m;var V=this._segments,Y=0,W=0;for(W=y=x=l=0;l<a;l++,x+=3)if((g=u+=v=_[l])<0)this.addBeforePosition(g,c,0,d,x);else if(m<g)this.addAfterPosition(g-m,c,o-4,d,x);else{for(;;y++)if(!((D=I[y])<g)){0==y?g/=D:g=(g-(M=I[y-1]))/(D-M);break}if(y!=f){var X=6*(f=y);for(b=c[X],T=c[X+1],N=c[X+2],C=c[X+3],A=c[X+4],S=c[X+5],L=2*(F=.03*(b-2*N+A))+(B=.006*(3*(N-A)-b+(w=c[X+6]))),R=2*(P=.03*(T-2*C+S))+(U=.006*(3*(C-S)-T+(k=c[X+7]))),O=.3*(N-b)+F+.16666667*B,E=.3*(C-T)+P+.16666667*U,Y=Math.sqrt(O*O+E*E),V[0]=Y,X=1;X<8;X++)O+=L,E+=R,L+=B,R+=U,Y+=Math.sqrt(O*O+E*E),V[X]=Y;O+=L,E+=R,Y+=Math.sqrt(O*O+E*E),V[8]=Y,O+=L+B,E+=R+U,Y+=Math.sqrt(O*O+E*E),V[9]=Y,W=0}for(g*=Y;;W++)if(!((D=V[W])<g)){0==W?g/=D:g=W+(g-(M=V[W-1]))/(D-M);break}this.addCurvePosition(.1*g,b,T,N,C,A,S,w,k,d,x,s||0<l&&0==v)}return d},t.addBeforePosition=function(t,e,i,a,s){var r=e[i],n=e[i+1],h=e[i+2]-r,l=e[i+3]-n,o=Math.atan2(l,h);a[s]=r+t*Math.cos(o),a[s+1]=n+t*Math.sin(o),a[s+2]=o},t.addAfterPosition=function(t,e,i,a,s){var r=e[i+2],n=e[i+3],h=r-e[i],l=n-e[i+1],o=Math.atan2(l,h);a[s]=r+t*Math.cos(o),a[s+1]=n+t*Math.sin(o),a[s+2]=o},t.addCurvePosition=function(t,e,i,a,s,r,n,h,l,o,u,_){0==t&&(t=1e-4);var c=t*t,d=c*t,p=1-t,f=p*p,m=f*p,x=p*t,y=3*x,g=p*y,v=y*t,M=e*m+a*g+r*v+h*d,D=i*m+s*g+n*v+l*d;o[u]=M,o[u+1]=D,o[u+2]=_?Math.atan2(D-(i*f+s*x*2+n*c),M-(e*f+a*x*2+r*c)):0},F.NONE=-1,F.BEFORE=-2,F.AFTER=-3,__static(F,["_tempMt",function(){return this._tempMt=new Matrix}]),F}(),DeformSlotData=function(){function t(){this.deformSlotDisplayList=[]}return __class(t,"laya.ani.bone.DeformSlotData",!0),t}(),EventData=function(){function t(){this.name=null,this.intValue=0,this.floatValue=NaN,this.stringValue=null,this.time=NaN}return __class(t,"laya.ani.bone.EventData",!0),t}(),CanvasMeshRender=function(){function t(){this.mesh=null,this.transform=null,this.context=null,this.mode=0}__class(t,"laya.ani.bone.canvasmesh.CanvasMeshRender",!0);var e=t.prototype;return e.renderToContext=function(t){this.context=t.ctx||t,this.mesh&&(0==this.mode?this._renderWithIndexes(this.mesh):this._renderNoIndexes(this.mesh))},e._renderNoIndexes=function(t){var e=0,i=t.vertices.length/2,a=0;for(e=0;e<i-2;e++)a=2*e,this._renderDrawTriangle(t,a,a+2,a+4)},e._renderWithIndexes=function(t){var e=t.indexes,i=0,a=e.length;for(i=0;i<a;i+=3){var s=2*e[i],r=2*e[i+1],n=2*e[i+2];this._renderDrawTriangle(t,s,r,n)}},e._renderDrawTriangle=function(t,e,i,a){var s=this.context,r=t.uvs,n=t.vertices,h=t.texture,l=h.bitmap,o=l.source,u=h.width,_=h.height,c=l.width,d=l.height,p=NaN,f=NaN,m=NaN,x=NaN,y=NaN,g=NaN;if(t.useUvTransform){var v=t.uvTransform;p=(r[e]*v.a+r[e+1]*v.c+v.tx)*c,f=(r[i]*v.a+r[i+1]*v.c+v.tx)*c,m=(r[a]*v.a+r[a+1]*v.c+v.tx)*c,x=(r[e]*v.b+r[e+1]*v.d+v.ty)*d,y=(r[i]*v.b+r[i+1]*v.d+v.ty)*d,g=(r[a]*v.b+r[a+1]*v.d+v.ty)*d}else p=r[e]*c,f=r[i]*c,m=r[a]*c,x=r[e+1]*d,y=r[i+1]*d,g=r[a+1]*d;var M=n[e],D=n[i],I=n[a],b=n[e+1],T=n[i+1],N=n[a+1];if(0<t.canvasPadding){var C=t.canvasPadding,A=t.canvasPadding,S=(M+D+I)/3,w=(b+T+N)/3,k=M-S,F=b-w,P=Math.sqrt(k*k+F*F);M=S+k/P*(P+C),b=w+F/P*(P+A),F=T-w,D=S+(k=D-S)/(P=Math.sqrt(k*k+F*F))*(P+C),T=w+F/P*(P+A),F=N-w,I=S+(k=I-S)/(P=Math.sqrt(k*k+F*F))*(P+C),N=w+F/P*(P+A)}if(s.save(),this.transform){var B=this.transform;s.transform(B.a,B.b,B.c,B.d,B.tx,B.ty)}s.beginPath(),s.moveTo(M,b),s.lineTo(D,T),s.lineTo(I,N),s.closePath(),s.clip();var U=1/(p*y+x*m+f*g-y*m-x*f-p*g),L=M*y+x*I+D*g-y*I-x*D-M*g,R=p*D+M*m+f*I-D*m-M*f-p*I,O=p*y*I+x*D*m+M*f*g-M*y*m-x*f*I-p*D*g,E=b*y+x*N+T*g-y*N-x*T-b*g,K=p*T+b*m+f*N-T*m-b*f-p*N,V=p*y*N+x*T*m+b*f*g-b*y*m-x*f*N-p*T*g;s.transform(L*U,E*U,R*U,K*U,O*U,V*U),s.drawImage(o,h.uv[0]*c,h.uv[1]*d,u,_,h.uv[0]*c,h.uv[1]*d,u,_),s.restore()},t}(),MeshData=function(){function t(){this.texture=null,this.uvs=[0,0,1,0,1,1,0,1],this.vertices=[0,0,100,0,100,100,0,100],this.indexes=[0,1,3,3,1,2],this.uvTransform=null,this.useUvTransform=!1,this.canvasPadding=1}return __class(t,"laya.ani.bone.canvasmesh.MeshData",!0),t.prototype.getBounds=function(){return Rectangle._getWrapRec(this.vertices)},t}(),DeformAniData=function(){function t(){this.skinName=null,this.deformSlotDataList=[]}return __class(t,"laya.ani.bone.DeformAniData",!0),t}(),UVTools=function(){function t(){}return __class(t,"laya.ani.bone.UVTools",!0),t.getRelativeUV=function(t,e,i){var a=t[0],s=t[2]-t[0],r=t[1],n=t[5]-t[1];i||(i=[]),i.length=e.length;var h,l=0;h=i.length;var o=1/s,u=1/n;for(l=0;l<h;l+=2)i[l]=(e[l]-a)*o,i[l+1]=(e[l+1]-r)*u;return i},t.getAbsoluteUV=function(t,e,i){if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return i?(Utils.copyArray(i,e),i):e;var a=t[0],s=t[2]-t[0],r=t[1],n=t[5]-t[1];i||(i=[]),i.length=e.length;var h,l=0;for(h=i.length,l=0;l<h;l+=2)i[l]=e[l]*s+a,i[l+1]=e[l+1]*n+r;return i},t}(),PathConstraintData=function(){function t(){this.name=null,this.target=null,this.positionMode=null,this.spacingMode=null,this.rotateMode=null,this.offsetRotation=NaN,this.position=NaN,this.spacing=NaN,this.rotateMix=NaN,this.translateMix=NaN,this.bones=[]}return __class(t,"laya.ani.bone.PathConstraintData",!0),t}(),IkConstraint=function(){function at(t,e){this._targetBone=null,this._bones=null,this._data=null,this.name=null,this.mix=NaN,this.bendDirection=NaN,this.isSpine=!0,this._sp=null,this.isDebug=!1,this._data=t,this._targetBone=e[t.targetBoneIndex],this.isSpine=t.isSpine,null==this._bones&&(this._bones=[]);for(var i=this._bones.length=0,a=t.boneIndexs.length;i<a;i++)this._bones.push(e[t.boneIndexs[i]]);this.name=t.name,this.mix=t.mix,this.bendDirection=t.bendDirection}__class(at,"laya.ani.bone.IkConstraint",!0);var t=at.prototype;return t.apply=function(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}},t._applyIk1=function(t,e,i,a){var s=t.parentBone,r=1/(s.resultMatrix.a*s.resultMatrix.d-s.resultMatrix.b*s.resultMatrix.c),n=e-s.resultMatrix.tx,h=i-s.resultMatrix.ty,l=(n*s.resultMatrix.d-h*s.resultMatrix.c)*r-t.transform.x,o=(h*s.resultMatrix.a-n*s.resultMatrix.b)*r-t.transform.y,u=Math.atan2(o,l)*at.radDeg-0-t.transform.skX;t.transform.scX<0&&(u+=180),180<u?u-=360:u<-180&&(u+=360),t.transform.skX=t.transform.skY=t.transform.skX+u*a,t.update()},t.updatePos=function(t,e){this._sp&&this._sp.pos(t,e)},t._applyIk2=function(t,e,i,a,s,r){if(0!=r){var n=t.resultTransform.x,h=t.resultTransform.y,l=t.transform.scX,o=t.transform.scY,u=e.transform.scX,_=0,c=0,d=0;d=l<0?(l=-l,_=180,-1):(_=0,1),o<0&&(o=-o,d=-d),c=u<0?(u=-u,180):0;var p=e.resultTransform.x,f=NaN,m=NaN,x=NaN,y=t.resultMatrix.a,g=t.resultMatrix.c,v=t.resultMatrix.b,M=t.resultMatrix.d,D=Math.abs(l-o)<=1e-4;x=D?(m=y*p+g*(f=e.resultTransform.y)+t.resultMatrix.tx,v*p+M*f+t.resultMatrix.ty):(f=0,m=y*p+t.resultMatrix.tx,v*p+t.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new Sprite,Laya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(i,a,15,"#ffff00"),this._sp.graphics.drawCircle(m,x,15,"#ff00ff")),t.setRotation(Math.atan2(x-t.resultMatrix.ty,m-t.resultMatrix.tx));var I=t.parentBone;y=I.resultMatrix.a,g=I.resultMatrix.c,v=I.resultMatrix.b;var b=1/(y*(M=I.resultMatrix.d)-g*v),T=i-I.resultMatrix.tx,N=a-I.resultMatrix.ty,C=(T*M-N*g)*b-n,A=(N*y-T*v)*b-h,S=((T=m-I.resultMatrix.tx)*M-(N=x-I.resultMatrix.ty)*g)*b-n,w=(N*y-T*v)*b-h,k=Math.sqrt(S*S+w*w),F=e.length*u,P=NaN,B=NaN;if(D){var U=(C*C+A*A-k*k-(F*=l)*F)/(2*k*F);U<-1?U=-1:1<U&&(U=1),B=Math.acos(U)*s,y=k+F*U,g=F*Math.sin(B),P=Math.atan2(A*y-C*g,C*y+A*g)}else{var L=(y=l*F)*y,R=(g=o*F)*g,O=C*C+A*A,E=Math.atan2(A,C),K=-2*R*k,V=R-L;if(0<(M=K*K-4*V*(v=R*k*k+L*O-L*R))){var Y=Math.sqrt(M);K<0&&(Y=-Y);var W=(Y=-(K+Y)/2)/V,X=v/Y,z=Math.abs(W)<Math.abs(X)?W:X;z*z<=O&&(N=Math.sqrt(O-z*z)*s,P=E-Math.atan2(N,z),B=Math.atan2(N/o,(z-k)/l))}var G=0,q=Number.MAX_VALUE,H=0,Q=0,Z=0,j=0,$=0,J=0;j<(M=(T=k+y)*T)&&(Z=0,j=M,$=T),(M=(T=k-y)*T)<q&&(G=Math.PI,q=M,H=T);var tt=Math.acos(-y*k/(L-R));(M=(T=y*Math.cos(tt)+k)*T+(N=g*Math.sin(tt))*N)<q&&(G=tt,q=M,H=T,Q=N),j<M&&(Z=tt,j=M,$=T,J=N),B=O<=(q+j)/2?(P=E-Math.atan2(Q*s,H),G*s):(P=E-Math.atan2(J*s,$),Z*s)}var et=Math.atan2(f,p)*d,it=t.resultTransform.skX;180<(P=(P-et)*at.radDeg+_-it)?P-=360:P<-180&&(P+=360),t.resultTransform.x=n,t.resultTransform.y=h,t.resultTransform.skX=t.resultTransform.skY=it+P*r,it=e.resultTransform.skX,180<(B=((B+et)*at.radDeg-0)*d+c-(it%=360))?B-=360:B<-180&&(B+=360),e.resultTransform.x=p,e.resultTransform.y=f,e.resultTransform.skX=e.resultTransform.skY=e.resultTransform.skY+B*r,t.update()}},t._applyIk3=function(t,e,i,a,s,r){if(0!=r){var n,h,l=e.resultMatrix.a*e.length,o=e.resultMatrix.b*e.length,u=l*l+o*o,_=Math.sqrt(u),c=t.resultMatrix.tx,d=t.resultMatrix.ty,p=e.resultMatrix.tx,f=e.resultMatrix.ty,m=p-c,x=f-d,y=m*m+x*x,g=Math.sqrt(y),v=(m=i-t.resultMatrix.tx)*m+(x=a-t.resultMatrix.ty)*x,M=Math.sqrt(v);if(_+g<=M||M+_<=g||M+g<=_){var D=NaN;p=c+(D=_+g<=M?1:-1)*(i-c)*g/M,f=d+D*(a-d)*g/M}else{var I=(y-u+v)/(2*v),b=Math.sqrt(y-I*I*v)/M,T=c+m*I,N=d+x*I,C=-x*b,A=m*b;f=0<s?(p=T-C,N-A):(p=T+C,N+A)}n=p,h=f,this.isDebug&&(this._sp||(this._sp=new Sprite,Laya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(c,d,15,"#ff00ff"),this._sp.graphics.drawCircle(i,a,15,"#ffff00"),this._sp.graphics.drawCircle(n,h,15,"#ff00ff"));var S,w;S=Math.atan2(h-t.resultMatrix.ty,n-t.resultMatrix.tx),t.setRotation(S),(w=at._tempMatrix).identity(),w.rotate(S),w.scale(t.resultMatrix.getScaleX(),t.resultMatrix.getScaleY()),w.translate(t.resultMatrix.tx,t.resultMatrix.ty),w.copyTo(t.resultMatrix),t.updateChild();var k,F;k=Math.atan2(a-h,i-n),e.setRotation(k),(F=at._tempMatrix).identity(),F.rotate(k),F.scale(e.resultMatrix.getScaleX(),e.resultMatrix.getScaleY()),F.translate(n,h),w.copyTo(e.resultMatrix),e.updateChild()}},__static(at,["radDeg",function(){return this.radDeg=180/Math.PI},"degRad",function(){return this.degRad=Math.PI/180},"_tempMatrix",function(){return this._tempMatrix=new Matrix}]),at}(),SkinData=function(){function t(){this.name=null,this.slotArr=[]}return __class(t,"laya.ani.bone.SkinData",!0),t}(),DeformSlotDisplayData=function(){function t(){this.boneSlot=null,this.slotIndex=-1,this.attachment=null,this.deformData=null,this.frameIndex=0,this.timeList=[],this.vectices=[],this.tweenKeyList=[]}__class(t,"laya.ani.bone.DeformSlotDisplayData",!0);var e=t.prototype;return e.binarySearch1=function(t,e){var i=0,a=t.length-2;if(0==a)return 1;for(var s=a>>>1;;){if(t[Math.floor(s+1)]<=e?i=s+1:a=s,i==a)return i+1;s=i+a>>>1}return 0},e.apply=function(t,e,i){if(void 0===i&&(i=1),t+=.05,!(this.timeList.length<=0)){var a=0;if(!(t<this.timeList[0])){var s=this.vectices[0].length,r=[],n=this.binarySearch1(this.timeList,t);if(this.frameIndex=n,t>=this.timeList[this.timeList.length-1]){var h=this.vectices[this.vectices.length-1];if(i<1)for(a=0;a<s;a++)r[a]+=(h[a]-r[a])*i;else for(a=0;a<s;a++)r[a]=h[a];this.deformData=r}else{this.tweenKeyList[this.frameIndex];var l=this.vectices[this.frameIndex-1],o=this.vectices[this.frameIndex],u=this.timeList[this.frameIndex-1],_=this.timeList[this.frameIndex];i=this.tweenKeyList[n-1]?(t-u)/(_-u):0;var c=NaN;for(a=0;a<s;a++)c=l[a],r[a]=c+(o[a]-c)*i;this.deformData=r}}}},t}(),IkConstraintData=function(){function t(){this.name=null,this.targetBoneName=null,this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneNames=[],this.boneIndexs=[]}return __class(t,"laya.ani.bone.IkConstraintData",!0),t}(),BezierLerp=function(){function u(){}return __class(u,"laya.ani.math.BezierLerp",!0),u.getBezierRate=function(t,e,i,a,s){var r=u._getBezierParamKey(e,i,a,s),n=100*r+t;if(u._bezierResultCache[n])return u._bezierResultCache[n];var h,l=u._getBezierPoints(e,i,a,s,r),o=0;for(h=l.length,o=0;o<h;o+=2)if(t<=l[o])return u._bezierResultCache[n]=l[o+1],l[o+1];return u._bezierResultCache[n]=1},u._getBezierParamKey=function(t,e,i,a){return 100*(100*(100*(100*t+e)+i)+a)},u._getBezierPoints=function(t,e,i,a,s){return u._bezierPointsCache[s]?u._bezierPointsCache[s]:(r=[0,0,t,e,i,a,1,1],n=(new Bezier).getBezierPoints(r,100,3),u._bezierPointsCache[s]=n);var r,n},u._bezierResultCache={},u._bezierPointsCache={},u}(),AnimationNodeContent=function(){function t(){this.name=null,this.parentIndex=0,this.parent=null,this.keyframeWidth=0,this.lerpType=0,this.interpolationMethod=null,this.childs=null,this.keyFrame=null,this.playTime=NaN,this.extenData=null,this.dataOffset=0}return __class(t,"laya.ani.AnimationNodeContent",!0),t}(),AnimationParser01=function(){function t(){}return __class(t,"laya.ani.AnimationParser01",!0),t.parse=function(t,e){var i=e.__getBuffer(),a=0,s=0,r=0,n=0,h=0,l=0,o=0,u=e.readUTFString();t._aniClassName=u;var _,c=e.readUTFString().split("\n"),d=e.getUint8(),p=e.getUint32(),f=e.getUint32();0<p&&(_=i.slice(p,f));var m=new Byte(_);for(0<f&&(t._publicExtData=i.slice(f,i.byteLength)),t._useParent=!!e.getUint8(),t._anis.length=d,a=0;a<d;a++){var x=t._anis[a]=new AnimationContent;x.nodes=new Array;var y=x.name=c[e.getUint16()];t._aniMap[y]=a,x.bone3DMap={},x.playTime=e.getFloat32();var g=x.nodes.length=e.getUint8();for(s=x.totalKeyframeDatasLength=0;s<g;s++){var v=x.nodes[s]=new AnimationNodeContent;v.childs=[];var M=e.getInt16();0<=M&&(v.name=c[M],x.bone3DMap[v.name]=s),v.keyFrame=new Array,v.parentIndex=e.getInt16(),-1==v.parentIndex?v.parent=null:v.parent=x.nodes[v.parentIndex],v.lerpType=e.getUint8();var D=e.getUint32();m.pos=D;var I=v.keyframeWidth=m.getUint16();if(x.totalKeyframeDatasLength+=I,0==v.lerpType||1==v.lerpType)for(v.interpolationMethod=[],v.interpolationMethod.length=I,r=0;r<I;r++)v.interpolationMethod[r]=AnimationTemplet.interpolation[m.getUint8()];null!=v.parent&&v.parent.childs.push(v);var b=e.getUint16();0<b&&(v.extenData=i.slice(e.pos,e.pos+b),e.pos+=b);var T,N=e.getUint16(),C=0;for(r=0,n=v.keyFrame.length=N;r<n;r++){if((T=v.keyFrame[r]=new KeyFramesContent).duration=e.getFloat32(),T.startTime=C,2==v.lerpType){T.interpolationData=[];var A,S=e.getUint8();switch(A=e.getFloat32()){case 254:for(T.interpolationData.length=I,o=0;o<I;o++)T.interpolationData[o]=0;break;case 255:for(T.interpolationData.length=I,o=0;o<I;o++)T.interpolationData[o]=5;break;default:for(T.interpolationData.push(A),l=1;l<S;l++)T.interpolationData.push(e.getFloat32())}}for(T.data=new Float32Array(I),h=0;h<I;h++)T.data[h]=e.getFloat32(),-1e-8<T.data[h]&&T.data[h]<1e-8&&(T.data[h]=0);C+=T.duration}T.startTime=x.playTime,v.playTime=x.playTime,t._calculateKeyFrame(v,N,I)}}},t}(),AnimationContent=function(){function t(){this.nodes=null,this.name=null,this.playTime=NaN,this.bone3DMap=null,this.totalKeyframeDatasLength=0}return __class(t,"laya.ani.AnimationContent",!0),t}(),AnimationState=function(){function t(){}return __class(t,"laya.ani.AnimationState",!0),t.stopped=0,t.paused=1,t.playing=2,t}(),AnimationPlayer=function(t){function e(){this._destroyed=!1,this._templet=null,this._currentTime=NaN,this._currentFrameTime=NaN,this._playStart=NaN,this._playEnd=NaN,this._playDuration=NaN,this._overallDuration=NaN,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=NaN,this._startUpdateLoopCount=NaN,this._currentAnimationClipIndex=0,this._currentKeyframeIndex=0,this._paused=!1,this._cacheFrameRate=0,this._cacheFrameRateInterval=NaN,this._cachePlayRate=NaN,this._fullFrames=null,this.isCache=!0,this.playbackRate=1,this.returnToZeroStopped=!1,e.__super.call(this),this._destroyed=!1,this._currentAnimationClipIndex=-1,this._currentKeyframeIndex=-1,this._currentTime=0,this._overallDuration=Number.MAX_VALUE,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this._cachePlayRate=1,this.cacheFrameRate=60,this.returnToZeroStopped=!1}__class(e,"laya.ani.AnimationPlayer",!1,t);var i=e.prototype;return Laya.imps(i,{"laya.resource.IDestroy":!0}),i._onTempletLoadedComputeFullKeyframeIndices=function(t,e,i){this._templet==i&&this._cachePlayRate==t&&this._cacheFrameRate==e&&this._computeFullKeyframeIndices()},i._computeFullKeyframeIndices=function(){for(var t=this._fullFrames=[],e=this._templet,i=this._cacheFrameRateInterval*this._cachePlayRate,a=0,s=e.getAnimationCount();a<s;a++){for(var r=[],n=0,h=e.getAnimation(a).nodes.length;n<h;n++){for(var l=e.getAnimation(a).nodes[n],o=Math.floor(l.playTime/i+.01),u=new Uint16Array(o+1),_=-1,c=0,d=l.keyFrame.length;c<d;c++){var p=l.keyFrame[c],f=p.startTime,m=f+p.duration+i;do{for(var x=Math.floor(f/i+.5),y=_+1;y<x;y++)u[y]=c;u[_=x]=c,f+=i}while(f<=m)}r.push(u)}t.push(r)}},i._onAnimationTempletLoaded=function(){this.destroyed||this._calculatePlayDuration()},i._calculatePlayDuration=function(){if(0!=this.state){var t=this._templet.getAniDuration(this._currentAnimationClipIndex);0==this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}},i._setPlayParams=function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.max(Math.floor(this.currentPlayTime/e+.01),0),this._currentFrameTime=this._currentKeyframeIndex*e},i._setPlayParamsWhenStop=function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.max(Math.floor(t/e+.01),0),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1},i._update=function(t){if(-1!=this._currentAnimationClipIndex&&!this._paused&&this._templet&&this._templet.loaded){var e=this._cacheFrameRateInterval*this._cachePlayRate,i=0;this._startUpdateLoopCount!=Stat.loopCount&&(i=t*this.playbackRate,this._elapsedPlaybackTime+=i);var a=this.playDuration;if(0!=this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0==this._overallDuration&&this._elapsedPlaybackTime>=a)return this._setPlayParamsWhenStop(a,e),void this.event("stopped");if(i+=this._currentTime,0<a)if(a<=i)do{if(i-=a,this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(a,e),this._stopWhenCircleFinish=!1,void this.event("stopped");i<a&&(this._setPlayParams(i,e),this.event("complete"))}while(a<=i);else this._setPlayParams(i,e);else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(a,e),this._stopWhenCircleFinish=!1,void this.event("stopped");this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event("complete")}}},i._destroy=function(){this.offAll(),this._templet=null,this._fullFrames=null,this._destroyed=!0},i.play=function(t,e,i,a,s){if(void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=2147483647),void 0===a&&(a=0),void 0===s&&(s=0),!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(i<0||a<0||s<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!=s&&s<a)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=e,this._overallDuration=i,this._playStart=a,this._playEnd=s,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=Stat.loopCount,this.event("played"),this._templet.loaded?this._calculatePlayDuration():this._templet.once("loaded",this,__bind(this,this._onAnimationTempletLoaded)),this._update(0)},i.playByFrame=function(t,e,i,a,s,r){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=2147483647),void 0===a&&(a=0),void 0===s&&(s=0),void 0===r&&(r=30);var n=1e3/r;this.play(t,e,i,a*n,s*n)},i.stop=function(t){void 0===t&&(t=!0),t?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event("stopped")):this._stopWhenCircleFinish=!0},__getset(0,i,"state",function(){return-1==this._currentAnimationClipIndex?0:this._paused?1:2}),__getset(0,i,"cacheFrameRateInterval",function(){return this._cacheFrameRateInterval}),__getset(0,i,"paused",function(){return this._paused},function(t){(this._paused=t)&&this.event("paused")}),__getset(0,i,"currentTime",null,function(t){if(-1!=this._currentAnimationClipIndex&&this._templet&&this._templet.loaded){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=Stat.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.max(Math.floor(this.currentPlayTime/e),0),this._currentFrameTime=this._currentKeyframeIndex*e}}),__getset(0,i,"cacheFrameRate",function(){return this._cacheFrameRate},function(t){this._cacheFrameRate!=t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&(this._templet.loaded?this._computeFullKeyframeIndices():this._templet.once("loaded",this,__bind(this,this._onTempletLoadedComputeFullKeyframeIndices),[this._cachePlayRate,t])))}),__getset(0,i,"playDuration",function(){return this._playDuration}),__getset(0,i,"cachePlayRate",function(){return this._cachePlayRate},function(t){this._cachePlayRate!=t&&(this._cachePlayRate=t,this._templet&&(this._templet.loaded?this._computeFullKeyframeIndices():this._templet.once("loaded",this,__bind(this,this._onTempletLoadedComputeFullKeyframeIndices),[t,this._cacheFrameRate])))}),__getset(0,i,"currentPlayTime",function(){return this._currentTime+this._playStart}),__getset(0,i,"currentKeyframeIndex",function(){return this._currentKeyframeIndex}),__getset(0,i,"currentAnimationClipIndex",function(){return this._currentAnimationClipIndex}),__getset(0,i,"destroyed",function(){return this._destroyed}),__getset(0,i,"currentFrameTime",function(){return this._currentFrameTime}),__getset(0,i,"overallDuration",function(){return this._overallDuration}),__getset(0,i,"templet",function(){return this._templet},function(t){0==!this.state&&this.stop(!0),this._templet!=t&&((this._templet=t).loaded?this._computeFullKeyframeIndices():t.once("loaded",this,__bind(this,this._onTempletLoadedComputeFullKeyframeIndices),[this._cachePlayRate,this._cacheFrameRate]))}),__getset(0,i,"playEnd",function(){return this._playEnd}),__getset(0,i,"playStart",function(){return this._playStart}),e}(EventDispatcher),GraphicsAni=function(t){function e(){e.__super.call(this),Render.isConchNode&&(this.drawSkin=function(t){t.transform||(t.transform=Matrix.EMPTY),this._addCmd([t]),this.setSkinMesh&&this.setSkinMesh(t._ps,t.mVBData,t.mEleNum,0,t.mTexture,t.transform)})}return __class(e,"laya.ani.GraphicsAni",!1,t),e.prototype.drawSkin=function(t){var e=[t];this._saveToCmd(Render._context._drawSkin,e)},e.create=function(){return e._caches.pop()||new e},e.recycle=function(t){t.clear(),e._caches.push(t)},e._caches=[],e}(Graphics),SkinMeshCanvas=function(t){function a(){a.__super.call(this),this.mesh=new MeshData}__class(a,"laya.ani.bone.canvasmesh.SkinMeshCanvas",!1,CanvasMeshRender);var e=a.prototype;return e.init2=function(t,e,i,a,s){var r;this.transform&&(this.transform=null),i?r=i:(r=[]).push(0,1,3,3,1,2),this.mesh.texture=t,this.mesh.indexes=r,this.mesh.vertices=a,this.mesh.uvs=s},e.render=function(t,e,i){this.mesh.texture&&(this.transform?(this.transform.translate(e,i),this.renderToContext(t),this.transform.translate(-e,-i)):(this.transform=a._tempMatrix,this.transform.identity(),this.transform.translate(e,i),this.renderToContext(t),this.transform.translate(-e,-i),this.transform=null))},__static(a,["_tempMatrix",function(){return this._tempMatrix=new Matrix}]),a}(),AnimationTemplet=function(t){function y(){this._aniMap={},this.unfixedLastAniIndex=-1,y.__super.call(this),this._anis=new Array}__class(y,"laya.ani.AnimationTemplet",!1,t);var e=y.prototype;return e.parse=function(t){var e=new Byte(t);this._aniVersion=e.readUTFString(),AnimationParser01.parse(this,e)},e._calculateKeyFrame=function(t,e,i){var a=t.keyFrame;a[e]=a[0];for(var s=0;s<e;s++){var r=a[s];r.nextData=0==r.duration?r.data:a[s+1].data}a.length--},e.onAsynLoaded=function(t,e,i){var a=new Byte(e);switch(this._aniVersion=a.readUTFString(),this._aniVersion){case"LAYAANIMATION:02":AnimationParser02.parse(this,a);break;default:AnimationParser01.parse(this,a)}this._endLoaded()},e.disposeResource=function(){this._aniVersion=null,this._anis=null,this._aniMap=null,this._publicExtData=null,this.unfixedCurrentFrameIndexes=null,this.unfixedCurrentTimes=null,this.unfixedKeyframes=null,this._aniClassName=null,this._animationDatasCache=null},e.getAnimationCount=function(){return this._anis.length},e.getAnimation=function(t){return this._anis[t]},e.getAniDuration=function(t){return this._anis[t].playTime},e.getNodes=function(t){return this._anis[t].nodes},e.getNodeIndexWithName=function(t,e){return this._anis[t].bone3DMap[e]},e.getNodeCount=function(t){return this._anis[t].nodes.length},e.getTotalkeyframesLength=function(t){return this._anis[t].totalKeyframeDatasLength},e.getPublicExtData=function(){return this._publicExtData},e.getAnimationDataWithCache=function(t,e,i,a){var s=e[i];if(s){var r=s[t];return r?r[a]:null}return null},e.setAnimationDataWithCache=function(t,e,i,a,s){var r=e[i]||(e[i]={});(r[t]||(r[t]=[]))[a]=s},e.getOriginalData=function(t,e,i,a,s){for(var r=this._anis[t].nodes,n=0,h=0,l=r.length,o=0;h<l;h++){var u,_=r[h];u=_.keyFrame[i[h][a]],_.dataOffset=o;var c=s-u.startTime,d=_.lerpType;if(d)switch(d){case 0:case 1:for(n=0;n<_.keyframeWidth;)n+=_.interpolationMethod[n](_,n,e,o+n,u.data,c,null,u.duration,u.nextData);break;case 2:var p=u.interpolationData,f=p.length,m=0;for(n=0;n<f;){var x=p[n];switch(x){case 6:case 7:n+=y.interpolation[x](_,m,e,o+m,u.data,c,null,u.duration,u.nextData,p,n+1);break;default:n+=y.interpolation[x](_,m,e,o+m,u.data,c,null,u.duration,u.nextData)}m++}}else for(n=0;n<_.keyframeWidth;)n+=_.interpolationMethod[n](_,n,e,o+n,u.data,c,null,u.duration,u.nextData);o+=_.keyframeWidth}},e.getNodesCurrentFrameIndex=function(t,e){var i=this._anis[t].nodes;t!=this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(i.length),this.unfixedCurrentTimes=new Float32Array(i.length),this.unfixedLastAniIndex=t);for(var a=0,s=i.length;a<s;a++){var r=i[a];for(e<this.unfixedCurrentTimes[a]&&(this.unfixedCurrentFrameIndexes[a]=0),this.unfixedCurrentTimes[a]=e;this.unfixedCurrentFrameIndexes[a]<r.keyFrame.length&&!(r.keyFrame[this.unfixedCurrentFrameIndexes[a]].startTime>this.unfixedCurrentTimes[a]);)this.unfixedCurrentFrameIndexes[a]++;this.unfixedCurrentFrameIndexes[a]--}return this.unfixedCurrentFrameIndexes},e.getOriginalDataUnfixedRate=function(t,e,i){var a=this._anis[t].nodes;t!=this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(a.length),this.unfixedCurrentTimes=new Float32Array(a.length),this.unfixedKeyframes=__newvec(a.length),this.unfixedLastAniIndex=t);for(var s=0,r=0,n=a.length,h=0;r<n;r++){var l=a[r];for(i<this.unfixedCurrentTimes[r]&&(this.unfixedCurrentFrameIndexes[r]=0),this.unfixedCurrentTimes[r]=i;this.unfixedCurrentFrameIndexes[r]<l.keyFrame.length&&!(l.keyFrame[this.unfixedCurrentFrameIndexes[r]].startTime>this.unfixedCurrentTimes[r]);)this.unfixedKeyframes[r]=l.keyFrame[this.unfixedCurrentFrameIndexes[r]],this.unfixedCurrentFrameIndexes[r]++;var o=this.unfixedKeyframes[r];l.dataOffset=h;var u=i-o.startTime;if(l.lerpType)switch(l.lerpType){case 0:case 1:for(s=0;s<l.keyframeWidth;)s+=l.interpolationMethod[s](l,s,e,h+s,o.data,u,null,o.duration,o.nextData);break;case 2:var _=o.interpolationData,c=_.length,d=0;for(s=0;s<c;){var p=_[s];switch(p){case 6:case 7:s+=y.interpolation[p](l,d,e,h+d,o.data,u,null,o.duration,o.nextData,_,s+1);break;default:s+=y.interpolation[p](l,d,e,h+d,o.data,u,null,o.duration,o.nextData)}d++}}else for(s=0;s<l.keyframeWidth;)s+=l.interpolationMethod[s](l,s,e,h+s,o.data,u,null,o.duration,o.nextData);h+=l.keyframeWidth}},y._LinearInterpolation_0=function(t,e,i,a,s,r,n,h,l,o){var u=0==h?0:r/h;return i[a]=(1-u)*s[e]+u*l[e],1},y._QuaternionInterpolation_1=function(t,e,i,a,s,r,n,h,l,o){var u=0==h?0:r/h;return MathUtil.slerpQuaternionArray(s,e,l,e,u,i,a),4},y._AngleInterpolation_2=function(t,e,i,a,s,r,n,h,l,o){return 0},y._RadiansInterpolation_3=function(t,e,i,a,s,r,n,h,l,o){return 0},y._Matrix4x4Interpolation_4=function(t,e,i,a,s,r,n,h,l,o){for(var u=0;u<16;u++,e++)i[a+u]=s[e]+r*n[e];return 16},y._NoInterpolation_5=function(t,e,i,a,s,r,n,h,l,o){return i[a]=s[e],1},y._BezierInterpolation_6=function(t,e,i,a,s,r,n,h,l,o,u){return void 0===u&&(u=0),i[a]=s[e]+(l[e]-s[e])*BezierLerp.getBezierRate(r/h,o[u],o[u+1],o[u+2],o[u+3]),5},y._BezierInterpolation_7=function(t,e,i,a,s,r,n,h,l,o,u){return void 0===u&&(u=0),i[a]=o[u+4]+o[u+5]*BezierLerp.getBezierRate((.001*r+o[u+6])/o[u+7],o[u],o[u+1],o[u+2],o[u+3]),9},y.load=function(t){return Laya.loader.create(t,null,null,y)},y.interpolation=[y._LinearInterpolation_0,y._QuaternionInterpolation_1,y._AngleInterpolation_2,y._RadiansInterpolation_3,y._Matrix4x4Interpolation_4,y._NoInterpolation_5,y._BezierInterpolation_6,y._BezierInterpolation_7],y}(Resource),CacheAbleSkinMesh=function(t){function a(){this.isCached=!1,this.canvas=null,this.tex=null,this.rec=null,a.__super.call(this)}__class(a,"laya.ani.bone.canvasmesh.CacheAbleSkinMesh",!1,SkinMeshCanvas);var e=a.prototype;return e.getCanvasPic=function(){var t,e=new HTMLCanvas("2D"),i=e.getContext("2d");return this.rec=this.mesh.getBounds(),e.size(this.rec.width,this.rec.height),t=this.transform,this.transform=a.tempMt,this.transform.identity(),this.transform.translate(-this.rec.x,-this.rec.y),this.renderToContext(i),this.transform.translate(+this.rec.x,+this.rec.y),this.transform=t,new Texture(e)},e.render=function(t,e,i){this.mesh.texture&&(this.isCached||(this.isCached=!0,this.tex=this.getCanvasPic()),this.transform?(this.transform.translate(e,i),this._renderTextureToContext(t),this.transform.translate(-e,-i)):(this.transform=SkinMeshCanvas._tempMatrix,this.transform.identity(),this.transform.translate(e,i),this._renderTextureToContext(t),this.transform.translate(-e,-i),this.transform=null))},e._renderTextureToContext=function(t){var e;if(this.context=t.ctx||t,t.save(),e=this.tex,this.transform){var i=this.transform;t.transform(i.a,i.b,i.c,i.d,i.tx,i.ty)}this.rec=this.mesh.getBounds(),t.translate(this.rec.x,this.rec.y),t.drawTexture(e,0,0,e.width,e.height,0,0),t.restore()},__static(a,["tempMt",function(){return this.tempMt=new Matrix}]),a}(),SimpleSkinMeshCanvas=function(r){function t(){this.cacheOK=!1,this.cacheCmdOK=!1,this.transformCmds=[],this.drawCmds=[],t.__super.call(this),this.tempMesh=new MeshData}__class(t,"laya.ani.bone.canvasmesh.SimpleSkinMeshCanvas",!1,r);var e=t.prototype;return e.init2=function(t,e,i,a,s){r.prototype.init2.call(this,t,e,i,a,s),this.cacheOK=!1,this.cacheCmdOK=!1,this.transformCmds.length=6,this.drawCmds.length=9},e.renderToContext=function(t){if(this.context=t.ctx||t,this.mesh){if(this.mesh.uvs.length<=8)return void(0==this.mode?this._renderWithIndexes(this.mesh):this._renderNoIndexes(this.mesh));this.cacheOK||(this.tempMesh.texture=this.mesh.texture,this.tempMesh.uvs=this.mesh.texture.uv,this.tempMesh.vertices=MeshTools.solveMesh(this.mesh,this.tempMesh.vertices),this.cacheOK=!0),0==this.mode?this._renderWithIndexes(this.tempMesh):this._renderNoIndexes(this.tempMesh)}},e._renderWithIndexes=function(t){if(this.cacheCmdOK)this.renderByCache(t);else{var e=t.indexes,i=0,a=e.length;for(1<a&&(a=1),i=0;i<a;i+=3){var s=2*e[i],r=2*e[i+1],n=2*e[i+2];this._renderDrawTriangle(t,s,r,n)}this.cacheCmdOK=!0}},e._renderDrawTriangle=function(t,e,i,a){var s=this.context,r=t.uvs,n=t.vertices,h=t.texture,l=h.bitmap,o=l.source,u=h.width,_=h.height,c=l.width,d=l.height,p=NaN,f=NaN,m=NaN,x=NaN,y=NaN,g=NaN;if(t.useUvTransform){var v=t.uvTransform;p=(r[e]*v.a+r[e+1]*v.c+v.tx)*c,f=(r[i]*v.a+r[i+1]*v.c+v.tx)*c,m=(r[a]*v.a+r[a+1]*v.c+v.tx)*c,x=(r[e]*v.b+r[e+1]*v.d+v.ty)*d,y=(r[i]*v.b+r[i+1]*v.d+v.ty)*d,g=(r[a]*v.b+r[a+1]*v.d+v.ty)*d}else p=r[e]*c,f=r[i]*c,m=r[a]*c,x=r[e+1]*d,y=r[i+1]*d,g=r[a+1]*d;var M=n[e],D=n[i],I=n[a],b=n[e+1],T=n[i+1],N=n[a+1],C=1/(p*y+x*m+f*g-y*m-x*f-p*g),A=M*y+x*I+D*g-y*I-x*D-M*g,S=p*D+M*m+f*I-D*m-M*f-p*I,w=p*y*I+x*D*m+M*f*g-M*y*m-x*f*I-p*D*g,k=b*y+x*N+T*g-y*N-x*T-b*g,F=p*T+b*m+f*N-T*m-b*f-p*N,P=p*y*N+x*T*m+b*f*g-b*y*m-x*f*N-p*T*g;if(this.transformCmds[0]=A*C,this.transformCmds[1]=k*C,this.transformCmds[2]=S*C,this.transformCmds[3]=F*C,this.transformCmds[4]=w*C,this.transformCmds[5]=P*C,this.drawCmds[0]=o,this.drawCmds[1]=h.uv[0]*c,this.drawCmds[2]=h.uv[1]*d,this.drawCmds[3]=u,this.drawCmds[4]=_,this.drawCmds[5]=h.uv[0]*c,this.drawCmds[6]=h.uv[1]*d,this.drawCmds[7]=u,this.drawCmds[8]=_,s.save(),this.transform){var B=this.transform;s.transform(B.a,B.b,B.c,B.d,B.tx,B.ty)}s.transform.apply(s,this.transformCmds),s.drawImage.apply(s,this.drawCmds),s.restore()},e.renderByCache=function(t){var e=this.context;if(e.save(),this.transform){var i=this.transform;e.transform(i.a,i.b,i.c,i.d,i.tx,i.ty)}e.transform.apply(e,this.transformCmds),e.drawImage.apply(e,this.drawCmds),e.restore()},t}(SkinMeshCanvas),Skeleton=function(e){function i(t,e){this._templet=null,this._player=null,this._curOriginalData=null,this._boneMatrixArray=[],this._lastTime=0,this._currAniName=null,this._currAniIndex=-1,this._pause=!0,this._aniClipIndex=-1,this._clipIndex=-1,this._skinIndex=0,this._skinName="default",this._aniMode=0,this._graphicsCache=null,this._boneSlotDic=null,this._bindBoneBoneSlotDic=null,this._boneSlotArray=null,this._index=-1,this._total=-1,this._indexControl=!1,this._aniPath=null,this._texturePath=null,this._complete=null,this._loadAniMode=0,this._yReverseMatrix=null,this._ikArr=null,this._tfArr=null,this._pathDic=null,this._rootBone=null,this._boneList=null,this._aniSectionDic=null,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,i.__super.call(this),void 0===e&&(e=0),t&&this.init(t,e)}__class(i,"laya.ani.bone.Skeleton",!1,e);var t=i.prototype;return t.init=function(t,e){void 0===e&&(e=0);var i,a,s,r=0,n=0;if(1==e)for(this._graphicsCache=[],r=0,n=t.getAnimationCount();r<n;r++)this._graphicsCache.push([]);if(this._yReverseMatrix=t.yReverseMatrix,this._aniMode=e,this._templet=t,this._player=new AnimationPlayer,this._player.cacheFrameRate=t.rate,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,0<t.ikArr.length)for(this._ikArr=[],r=0,n=t.ikArr.length;r<n;r++)this._ikArr.push(new IkConstraint(t.ikArr[r],this._boneList));if(0<t.pathArr.length)for(null==this._pathDic&&(this._pathDic={}),r=0,n=t.pathArr.length;r<n;r++)i=t.pathArr[r],a=new PathConstraint(i,this._boneList),(s=this._boneSlotDic[i.name])&&((a=new PathConstraint(i,this._boneList)).target=s),this._pathDic[i.name]=a;if(0<t.tfArr.length)for(this._tfArr=[],r=0,n=t.tfArr.length;r<n;r++)this._tfArr.push(new TfConstraint(t.tfArr[r],this._boneList));if(0<t.skinDataArray.length){var h=this._templet.skinDataArray[this._skinIndex];this._skinName=h.name}this._player.on("played",this,__bind(this,this._onPlay)),this._player.on("stopped",this,__bind(this,this._onStop)),this._player.on("paused",this,__bind(this,this._onPause))},t.load=function(t,e,i){void 0===i&&(i=0),this._aniPath=t,this._complete=e,this._loadAniMode=i,Laya.loader.load([{url:t,type:"arraybuffer"}],Handler.create(this,__bind(this,this._onLoaded)))},t._onLoaded=function(){var t,e=Loader.getRes(this._aniPath);null!=e&&(null==Templet.TEMPLET_DICTIONARY&&(Templet.TEMPLET_DICTIONARY={}),(t=Templet.TEMPLET_DICTIONARY[this._aniPath])?t.isParseFail?this._parseFail():t.isParserComplete?this._parseComplete():(t.on("complete",this,__bind(this,this._parseComplete)),t.on("error",this,__bind(this,this._parseFail))):((t=new Templet)._setUrl(this._aniPath),(Templet.TEMPLET_DICTIONARY[this._aniPath]=t).on("complete",this,__bind(this,this._parseComplete)),t.on("error",this,__bind(this,this._parseFail)),t.isParserComplete=!1,t.parseData(null,e)))},t._parseComplete=function(){var t=Templet.TEMPLET_DICTIONARY[this._aniPath];t&&(this.init(t,this._loadAniMode),this.play(0,!0)),this._complete&&this._complete.runWith(this)},t._parseFail=function(){console.log("[Error]:"+this._aniPath+"解析失败")},t._onPlay=function(){this.event("played")},t._onStop=function(){var t,e=this._templet.eventAniArr[this._aniClipIndex];if(e&&this._eventIndex<e.length)for(;this._eventIndex<e.length;this._eventIndex++)(t=e[this._eventIndex]).time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event("label",t);this._eventIndex=0,this._drawOrder=null,this.event("stopped")},t._onPause=function(){this.event("paused")},t._parseSrcBoneMatrix=function(){var t=0,e=0;for(e=this._templet.srcBoneMatrixArr.length,t=0;t<e;t++)this._boneMatrixArray.push(new Matrix);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{null==this._boneSlotDic&&(this._boneSlotDic={}),null==this._bindBoneBoneSlotDic&&(this._bindBoneBoneSlotDic={}),null==this._boneSlotArray&&(this._boneSlotArray=[]);var i,a,s=this._templet.boneSlotArray;for(t=0,e=s.length;t<e;t++)i=s[t],null==(a=this._bindBoneBoneSlotDic[i.parent])&&(this._bindBoneBoneSlotDic[i.parent]=a=[]),this._boneSlotDic[i.name]=i=i.copy(),a.push(i),this._boneSlotArray.push(i)}},t._emitMissedEvents=function(t,e,i){void 0===i&&(i=0);var a=this._templet.eventAniArr[this._player.currentAnimationClipIndex];if(a){var s,r,n=0;for(s=a.length,n=i;n<s;n++)(r=a[n]).time>=this._player.playStart&&r.time<=this._player.playEnd&&this.event("label",r)}},t._update=function(t){if(void 0===t&&(t=!0),!(this._pause||t&&this._indexControl)){var e=this.timer.currTimer,i=this._player.currentKeyframeIndex,a=e-this._lastTime;if(t?this._player._update(a):i=-1,this._lastTime=e,this._player&&(this._index=this._clipIndex=this._player.currentKeyframeIndex,!(this._index<0||0<a&&this._clipIndex==i&&this._lastUpdateAniClipIndex==this._aniClipIndex))){var s;this._lastUpdateAniClipIndex=this._aniClipIndex,i>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0);var r,n=this._templet.eventAniArr[this._aniClipIndex];if(n&&this._eventIndex<n.length&&((s=n[this._eventIndex]).time>=this._player.playStart&&s.time<=this._player.playEnd?this._player.currentPlayTime>=s.time&&(this.event("label",s),this._eventIndex++):this._eventIndex++),0==this._aniMode){if(r=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex))return void(this.graphics!=r&&(this.graphics=r));var h=0,l=0;for(l=this._clipIndex;!this._templet.getGrahicsDataWithCache(this._aniClipIndex,l-1)&&0<l;)l--;if(l<this._clipIndex)for(h=l;h<this._clipIndex;h++)this._createGraphics(h)}else if(1==this._aniMode){if(r=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex))return void(this.graphics!=r&&(this.graphics=r));for(l=this._clipIndex;!this._getGrahicsDataWithCache(this._aniClipIndex,l-1)&&0<l;)l--;if(l<this._clipIndex)for(h=l;h<this._clipIndex;h++)this._createGraphics(h)}this._createGraphics()}}},t._createGraphics=function(t){void 0===t&&(t=-1),-1==t&&(t=this._clipIndex);var e,i,a=t*this._player.cacheFrameRateInterval,s=this._templet.drawOrderAniArr[this._aniClipIndex];if(s&&0<s.length)for(this._drawOrderIndex=0,e=s[this._drawOrderIndex];a>=e.time&&(this._drawOrder=e.drawOrder,this._drawOrderIndex++,!(this._drawOrderIndex>=s.length));)e=s[this._drawOrderIndex];0==this._aniMode||1==this._aniMode?this.graphics=GraphicsAni.create():this.graphics instanceof laya.ani.GraphicsAni?this.graphics.clear():this.graphics=GraphicsAni.create(),i=this.graphics;var r=this._templet.getNodes(this._aniClipIndex);this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,this._player._fullFrames[this._aniClipIndex],t,a);var n,h,l,o,u=this._aniSectionDic[this._aniClipIndex],_=0,c=0,d=0,p=0,f=0,m=this._templet.srcBoneMatrixArr.length;for(f=u[c=0];c<m;c++)o=this._boneList[c],l=this._templet.srcBoneMatrixArr[c],o.resultTransform.scX=l.scX*this._curOriginalData[_++],o.resultTransform.skX=l.skX+this._curOriginalData[_++],o.resultTransform.skY=l.skY+this._curOriginalData[_++],o.resultTransform.scY=l.scY*this._curOriginalData[_++],o.resultTransform.x=l.x+this._curOriginalData[_++],o.resultTransform.y=l.y+this._curOriginalData[_++],8==this._templet.tMatrixDataLen&&(o.resultTransform.skewX=l.skewX+this._curOriginalData[_++],o.resultTransform.skewY=l.skewY+this._curOriginalData[_++]);var x,y={},g={};for(f+=u[1];c<f;c++)y[(x=r[c]).name]=this._curOriginalData[_++],g[x.name]=this._curOriginalData[_++],this._curOriginalData[_++],this._curOriginalData[_++],this._curOriginalData[_++],this._curOriginalData[_++];var v,M,D={},I={};for(f+=u[2];c<f;c++)D[(x=r[c]).name]=this._curOriginalData[_++],I[x.name]=this._curOriginalData[_++],this._curOriginalData[_++],this._curOriginalData[_++],this._curOriginalData[_++],this._curOriginalData[_++];if(this._pathDic)for(f+=u[3];c<f;c++){if(x=r[c],v=this._pathDic[x.name])switch(new Byte(x.extenData).getByte()){case 1:v.position=this._curOriginalData[_++];break;case 2:v.spacing=this._curOriginalData[_++];break;case 3:v.rotateMix=this._curOriginalData[_++],v.translateMix=this._curOriginalData[_++]}}if(this._yReverseMatrix?this._rootBone.update(this._yReverseMatrix):this._rootBone.update(Matrix.TEMP.identity()),this._ikArr)for(c=0,f=this._ikArr.length;c<f;c++)M=this._ikArr[c],D.hasOwnProperty(M.name)&&(M.bendDirection=D[M.name]),I.hasOwnProperty(M.name)&&(M.mix=I[M.name]),M.apply();if(this._pathDic)for(var b in this._pathDic)(v=this._pathDic[b]).apply(this._boneList,i);if(this._tfArr)for(c=0,p=this._tfArr.length;c<p;c++)this._tfArr[c].apply();for(c=0,p=this._boneList.length;c<p;c++)if(o=this._boneList[c],h=this._bindBoneBoneSlotDic[o.name],o.resultMatrix.copyTo(this._boneMatrixArray[c]),h)for(d=0,f=h.length;d<f;d++)(n=h[d])&&n.setParentMatrix(o.resultMatrix);var T,N,C,A,S={},w=this._templet.deformAniArr;if(w&&0<w.length){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,c=0,f=this._boneSlotArray.length;c<f;c++)(n=this._boneSlotArray[c]).deformData=null;var k,F=w[this._aniClipIndex];for(k in T=F.default,this._setDeform(T,S,this._boneSlotArray,a),F)"default"!=k&&k!=this._skinName&&(T=F[k],this._setDeform(T,S,this._boneSlotArray,a));T=F[this._skinName],this._setDeform(T,S,this._boneSlotArray,a)}if(this._drawOrder)for(c=0,f=this._drawOrder.length;c<f;c++)N=y[(n=this._boneSlotArray[this._drawOrder[c]]).name],C=g[n.name],isNaN(C)||(i.save(),i.alpha(C)),isNaN(N)||-2==N||(this._templet.attachmentNames?n.showDisplayByName(this._templet.attachmentNames[N]):n.showDisplayByIndex(N)),S[this._drawOrder[c]]?(A=S[this._drawOrder[c]],n.currDisplayData&&A[n.currDisplayData.attachmentName]?n.deformData=A[n.currDisplayData.attachmentName]:n.deformData=null):n.deformData=null,isNaN(C)?n.draw(i,this._boneMatrixArray,2==this._aniMode):n.draw(i,this._boneMatrixArray,2==this._aniMode,C),isNaN(C)||i.restore();else for(c=0,f=this._boneSlotArray.length;c<f;c++)N=y[(n=this._boneSlotArray[c]).name],C=g[n.name],isNaN(C)||(i.save(),i.alpha(C)),isNaN(N)||-2==N||(this._templet.attachmentNames?n.showDisplayByName(this._templet.attachmentNames[N]):n.showDisplayByIndex(N)),S[c]?(A=S[c],n.currDisplayData&&A[n.currDisplayData.attachmentName]?n.deformData=A[n.currDisplayData.attachmentName]:n.deformData=null):n.deformData=null,isNaN(C)?n.draw(i,this._boneMatrixArray,2==this._aniMode):n.draw(i,this._boneMatrixArray,2==this._aniMode,C),isNaN(C)||i.restore();0==this._aniMode?this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,i):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,i)},t._setDeform=function(t,e,i,a){if(t){var s,r,n,h=0,l=0,o=0;if(t)for(h=0,l=t.deformSlotDataList.length;h<l;h++)for(s=t.deformSlotDataList[h],o=0;o<s.deformSlotDisplayList.length;o++)n=i[(r=s.deformSlotDisplayList[o]).slotIndex],r.apply(a,n),e[r.slotIndex]||(e[r.slotIndex]={}),e[r.slotIndex][r.attachment]=r.deformData}},t.getAnimNum=function(){return this._templet.getAnimationCount()},t.getAniNameByIndex=function(t){return this._templet.getAniNameByIndex(t)},t.getSlotByName=function(t){return this._boneSlotDic[t]},t.showSkinByName=function(t,e){void 0===e&&(e=!0),this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)},t.showSkinByIndex=function(t,e){void 0===e&&(e=!0);for(var i=0;i<this._boneSlotArray.length;i++)this._boneSlotArray[i].showSlotData(null,e);if(this._templet.showSkinByIndex(this._boneSlotDic,t,e)){var a=this._templet.skinDataArray[t];this._skinIndex=t,this._skinName=a.name}this._clearCache()},t.showSlotSkinByIndex=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByIndex(e),this._clearCache()}},t.showSlotSkinByName=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByName(e),this._clearCache()}},t.replaceSlotSkinName=function(t,e,i){if(0!=this._aniMode){var a=this.getSlotByName(t);a&&a.replaceDisplayByName(e,i),this._clearCache()}},t.replaceSlotSkinByIndex=function(t,e,i){if(0!=this._aniMode){var a=this.getSlotByName(t);a&&a.replaceDisplayByIndex(e,i),this._clearCache()}},t.setSlotSkin=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.replaceSkin(e),this._clearCache()}},t._clearCache=function(){if(1==this._aniMode)for(var t=0,e=this._graphicsCache.length;t<e;t++){for(var i=0,a=this._graphicsCache[t].length;i<a;i++){var s=this._graphicsCache[t][i];s!=this.graphics&&GraphicsAni.recycle(s)}this._graphicsCache[t].length=0}},t.play=function(t,e,i,a,s,r){void 0===i&&(i=!0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===r&&(r=!0),this._indexControl=!1;var n=-1,h=NaN;if(h=e?2147483647:0,"string"==typeof t)for(var l=0,o=this._templet.getAnimationCount();l<o;l++){var u=this._templet.getAnimation(l);if(u&&t==u.name){n=l;break}}else n=t;-1<n&&n<this.getAnimNum()&&(this._aniClipIndex=n,(i||this._pause||this._currAniIndex!=n)&&(this._currAniIndex=n,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(n)),this._drawOrder=null,this._eventIndex=0,this._player.play(n,this._player.playbackRate,h,a,s),r&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=Browser.now(),this.timer.frameLoop(1,this,__bind(this,this._update),null,!0)),this._update()))},t.stop=function(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),this.timer.clear(this,__bind(this,this._update)))},t.playbackRate=function(t){this._player&&(this._player.playbackRate=t)},t.paused=function(){this._pause||(this._pause=!0,this._player&&(this._player.paused=!0),this.timer.clear(this,__bind(this,this._update)))},t.resume=function(){this._indexControl=!1,this._pause&&(this._pause=!1,this._player&&(this._player.paused=!1),this._lastTime=Browser.now(),this.timer.frameLoop(1,this,__bind(this,this._update),null,!0))},t._getGrahicsDataWithCache=function(t,e){return this._graphicsCache[t][e]},t._setGrahicsDataWithCache=function(t,e,i){this._graphicsCache[t][e]=i},t.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._templet=null,this._player&&this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._lastTime=0,this.timer.clear(this,__bind(this,this._update))},__getset(0,t,"templet",function(){return this._templet}),__getset(0,t,"player",function(){return this._player}),__getset(0,t,"index",function(){return this._index},function(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,this._update(!1))}),__getset(0,t,"total",function(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}),__getset(0,t,"url",function(){return this._aniPath},function(t){this.load(t)}),i.useSimpleMeshInCanvas=!1,i}(Sprite),MovieClip=function(e){function f(t){this._start=0,this._Pos=0,this._data=null,this._curIndex=0,this._preIndex=0,this._playIndex=0,this._playing=!1,this._ended=!0,this._count=0,this._ids=null,this._loadedImage={},this._idOfSprite=null,this._parentMovieClip=null,this._movieClipList=null,this._labels=null,this.basePath=null,this._atlasPath=null,this._url=null,this._isRoot=!1,this._completeHandler=null,this._endFrame=-1,this.interval=30,this.loop=!1,f.__super.call(this),this._ids={},this._idOfSprite=[],this._reset(),this._playing=!1,(this._parentMovieClip=t)?(this._isRoot=!1,this._movieClipList=t._movieClipList,this._movieClipList.push(this)):(this._movieClipList=[this],this._isRoot=!0,this._setUpNoticeType(1))}__class(f,"laya.ani.swf.MovieClip",!1,e);var t=f.prototype;return t.destroy=function(t){void 0===t&&(t=!0),this._clear(),e.prototype.destroy.call(this,t)},t._setDisplay=function(t){e.prototype._setDisplay.call(this,t),this._isRoot&&this._$3__onDisplay(t)},t._$3__onDisplay=function(t){t?this.timer.loop(this.interval,this,__bind(this,this.updates),null,!0):this.timer.clear(this,__bind(this,this.updates))},t.updates=function(){if(!this._parentMovieClip){var t,e=0;for(t=this._movieClipList.length,e=0;e<t;e++)this._movieClipList[e]&&this._movieClipList[e]._update()}},t.addLabel=function(t,e){this._labels||(this._labels={}),this._labels[e]=t},t.removeLabel=function(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]==t){delete this._labels[e];break}}else this._labels=null},t._update=function(){if(this._data&&this._playing){if(this._playIndex++,this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}if(this._parse(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event("label",this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex){if(this._endFrame=-1,null!=this._completeHandler){var t=this._completeHandler;this._completeHandler=null,t.run()}this.stop()}}},t.stop=function(){this._playing=!1},t.gotoAndStop=function(t){this.index=t,this.stop()},t._clear=function(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){this.timer.clear(this,__bind(this,this.updates));var t,e=0;for(t=this._movieClipList.length,e=0;e<t;e++)this._movieClipList[e]!=this&&this._movieClipList[e]._clear();this._movieClipList.length=0}var i;for(i in this._atlasPath&&Loader.clearRes(this._atlasPath),this._loadedImage)this._loadedImage[i]&&(Loader.clearRes(i),this._loadedImage[i]=!1);this.removeChildren(),this.graphics=null,this._parentMovieClip=null},t.play=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0),this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)},t._displayFrame=function(t){void 0===t&&(t=-1),-1!=t&&(this._curIndex>t&&this._reset(),this._parse(t))},t._reset=function(t){void 0===t&&(t=!0),t&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start},t._parse=function(t){var e,i,a,s=0,r=0,n=0,h=!1,l=this._idOfSprite,o=this._data;for(this._ended&&this._reset(),o.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),o.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(o.getUint16()){case 12:if(s=o.getUint16(),r=this._ids[o.getUint16()],this._Pos=o.pos,o.pos=r,0==(n=o.getUint8())){var u=o.getUint16();if(!(i=l[s])){i=l[s]=new Sprite;var _=new Sprite;_.loadImage(this.basePath+u+".png"),this._loadedImage[this.basePath+u+".png"]=!0,i.addChild(_),_.size(o.getFloat32(),o.getFloat32());var c=o._getMatrix();_.transform=c}i.alpha=1}else 1==n&&((e=l[s])||(l[s]=e=new f(this),e.interval=this.interval,e._ids=this._ids,e.basePath=this.basePath,e._setData(o,r),e._initState(),e.play(0)),e.alpha=1);o.pos=this._Pos;break;case 3:var d=l[o.getUint16()];d&&(this.addChild(d),d.zOrder=o.getUint16(),h=!0);break;case 4:(d=l[o.getUint16()])&&d.removeSelf();break;case 5:l[o.getUint16()][f._ValueList[o.getUint16()]]=o.getFloat32();break;case 6:l[o.getUint16()].visible=0<o.getUint8();break;case 7:var p=(i=l[o.getUint16()]).transform||Matrix.create();p.setTo(o.getFloat32(),o.getFloat32(),o.getFloat32(),o.getFloat32(),o.getFloat32(),o.getFloat32()),i.transform=p;break;case 8:l[o.getUint16()].setPos(o.getFloat32(),o.getFloat32());break;case 9:l[o.getUint16()].setSize(o.getFloat32(),o.getFloat32());break;case 10:l[o.getUint16()].alpha=o.getFloat32();break;case 11:l[o.getUint16()].setScale(o.getFloat32(),o.getFloat32());break;case 98:a=o.getString(),this.event(a),"stop"==a&&this.stop();break;case 99:this._curIndex=o.getUint16(),h&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event("enterframe"),this.event("end"),this.event("complete")),this._reset(!1)}this._playing&&!this._ended&&this.event("enterframe"),this._Pos=o.pos},t._setData=function(t,e){this._data=t,this._start=e+3},t.load=function(t,e,i){var a;void 0===e&&(e=!1),this._url=t=URL.formatURL(t),e&&(this._atlasPath=i||t.split(".swf")[0]+".json"),this.stop(),this._clear(),this._movieClipList=[this],a=[{url:t,type:"arraybuffer"}],this._atlasPath&&a.push({url:this._atlasPath,type:"atlas"}),Laya.loader.load(a,Handler.create(this,__bind(this,this._onLoaded)))},t._onLoaded=function(){var t;(t=Loader.getRes(this._url))?(this.basePath=this._atlasPath?Loader.getAtlas(this._atlasPath).dir:this._url.split(".swf")[0]+"/image/",this._initData(t)):this.event("error","file not find")},t._initState=function(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parse(++this._curIndex);this._playing=t},t._initData=function(t){this._data=new Byte(t);var e=0,i=this._data.getUint16();for(e=0;e<i;e++)this._ids[this._data.getInt16()]=this._data.getInt32();this.interval=1e3/this._data.getUint16(),this._setData(this._data,this._ids[32767]),this._initState(),this.play(0),this.event("loaded"),this._parentMovieClip||this.timer.loop(this.interval,this,__bind(this,this.updates),null,!0)},t.playTo=function(t,e,i){this._completeHandler=i,this._endFrame=e,this.play(t,!1)},__getset(0,t,"url",null,function(t){this.load(t)}),__getset(0,t,"playing",function(){return this._playing}),__getset(0,t,"count",function(){return this._count}),__getset(0,t,"index",function(){return this._playIndex},function(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event("label",this._labels[t])}),f._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"],f}(Sprite),Templet=function(e){function s(){this._mainTexture=null,this._textureJson=null,this._graphicsCache=[],this.srcBoneMatrixArr=[],this.ikArr=[],this.tfArr=[],this.pathArr=[],this.boneSlotDic={},this.bindBoneBoneSlotDic={},this.boneSlotArray=[],this.skinDataArray=[],this.skinDic={},this.subTextureDic={},this.isParseFail=!1,this.yReverseMatrix=null,this.drawOrderAniArr=[],this.eventAniArr=[],this.attachmentNames=null,this.deformAniArr=[],this._isDestroyed=!1,this._rate=30,this.isParserComplete=!1,this.aniSectionDic={},this._skBufferUrl=null,this._textureDic={},this._loadList=null,this._path=null,this.tMatrixDataLen=0,this.mRootBone=null,s.__super.call(this),this.skinSlotDisplayDataArr=[],this.mBoneArr=[]}__class(s,"laya.ani.bone.Templet",!1,e);var t=s.prototype;return t.loadAni=function(t){this._skBufferUrl=t,Laya.loader.load(t,Handler.create(this,__bind(this,this.onComplete)),null,"arraybuffer")},t.onComplete=function(t){if(this._isDestroyed)this.destroy();else{var e=Loader.getRes(this._skBufferUrl);e?(this._path=this._skBufferUrl.slice(0,this._skBufferUrl.lastIndexOf("/"))+"/",this.parseData(null,e)):this.event("error","load failed:"+this._skBufferUrl)}},t.parseData=function(t,e,i){void 0===i&&(i=30),!this._path&&this.url&&(this._path=this.url.slice(0,this.url.lastIndexOf("/"))+"/"),this._mainTexture=t,this._mainTexture&&Render.isWebGL&&t.bitmap&&(t.bitmap.enableMerageInAtlas=!1),this._rate=i,this.parse(e)},t.buildArmature=function(t){return void 0===t&&(t=0),new Skeleton(this,t)},t.parse=function(t){e.prototype.parse.call(this,t),this._endLoaded(),this._aniVersion!=s.LAYA_ANIMATION_VISION&&(console.log("[Error] 版本不一致，请使用IDE版本配套的重新导出"+this._aniVersion+"->"+s.LAYA_ANIMATION_VISION),this._loaded=!1),this.loaded?this._mainTexture?this._parsePublicExtData():this._parseTexturePath():(this.event("error",this),this.isParseFail=!0)},t._parseTexturePath=function(){if(this._isDestroyed)this.destroy();else{var t=0;this._loadList=[];var e,i=new Byte(this.getPublicExtData()),a=0,s=0,r=0,n=i.getInt32(),h=i.readUTFString(),l=h.split("\n");for(t=0;t<n;t++)e=this._path+l[2*t],h=l[2*t+1],i.getFloat32(),i.getFloat32(),a=i.getFloat32(),s=i.getFloat32(),r=i.getFloat32(),isNaN(r)?0:r,r=i.getFloat32(),isNaN(r)?0:r,r=i.getFloat32(),isNaN(r)?a:r,r=i.getFloat32(),isNaN(r)?s:r,-1==this._loadList.indexOf(e)&&this._loadList.push(e);Laya.loader.load(this._loadList,Handler.create(this,__bind(this,this._textureComplete)))}},t._textureComplete=function(){for(var t,e,i=0,a=this._loadList.length;i<a;i++)e=this._loadList[i],t=this._textureDic[e]=Loader.getRes(e),Render.isWebGL&&t&&t.bitmap&&(t.bitmap.enableMerageInAtlas=!1);this._parsePublicExtData()},t._parsePublicExtData=function(){var t=0,e=0,i=0,a=0,s=0;for(t=0,s=this.getAnimationCount();t<s;t++)this._graphicsCache.push([]);var r;r="Dragon"!=this._aniClassName;var n,h,l=new Byte(this.getPublicExtData()),o=0,u=0,_=0,c=0,d=0,p=0,f=0,m=0,x=0,y=l.getInt32(),g=l.readUTFString(),v=g.split("\n");for(t=0;t<y;t++){if(n=this._mainTexture,h=this._path+v[2*t],g=v[2*t+1],null==this._mainTexture&&(n=this._textureDic[h]),!n)return this.event("error",this),void(this.isParseFail=!0);o=l.getFloat32(),u=l.getFloat32(),_=l.getFloat32(),c=l.getFloat32(),x=l.getFloat32(),d=isNaN(x)?0:x,x=l.getFloat32(),p=isNaN(x)?0:x,x=l.getFloat32(),f=isNaN(x)?_:x,x=l.getFloat32(),m=isNaN(x)?c:x,this.subTextureDic[g]=Texture.create(n,o,u,_,c,-d,-p,f,m)}this._mainTexture=n;var M,D,I,b,T,N=l.getUint16();for(t=0;t<N;t++)(M=[]).push(l.getUint16()),M.push(l.getUint16()),M.push(l.getUint16()),M.push(l.getUint16()),this.aniSectionDic[t]=M;var C,A=l.getInt16(),S={};for(t=0;t<A;t++)D=new Bone,0==t?C=D:D.root=C,D.d=r?-1:1,b=l.readUTFString(),T=l.readUTFString(),D.length=l.getFloat32(),1==l.getByte()&&(D.inheritRotation=!1),1==l.getByte()&&(D.inheritScale=!1),D.name=b,T&&((I=S[T])?I.addChild(D):this.mRootBone=D),S[b]=D,this.mBoneArr.push(D);this.tMatrixDataLen=l.getUint16();var w,k,F=l.getUint16(),P=Math.floor(F/this.tMatrixDataLen),B=this.srcBoneMatrixArr;for(t=0;t<P;t++)(w=new Transform).scX=l.getFloat32(),w.skX=l.getFloat32(),w.skY=l.getFloat32(),w.scY=l.getFloat32(),w.x=l.getFloat32(),w.y=l.getFloat32(),8==this.tMatrixDataLen&&(w.skewX=l.getFloat32(),w.skewY=l.getFloat32()),B.push(w),(D=this.mBoneArr[t]).transform=w;var U,L=l.getUint16(),R=0;for(t=0;t<L;t++){for(k=new IkConstraintData,R=l.getUint16(),e=0;e<R;e++)k.boneNames.push(l.readUTFString()),k.boneIndexs.push(l.getInt16());k.name=l.readUTFString(),k.targetBoneName=l.readUTFString(),k.targetBoneIndex=l.getInt16(),k.bendDirection=l.getFloat32(),k.mix=l.getFloat32(),k.isSpine=r,this.ikArr.push(k)}var O,E=l.getUint16(),K=0;for(t=0;t<E;t++){for(U=new TfConstraintData,K=l.getUint16(),e=0;e<K;e++)U.boneIndexs.push(l.getInt16());U.name=l.getUTFString(),U.targetIndex=l.getInt16(),U.rotateMix=l.getFloat32(),U.translateMix=l.getFloat32(),U.scaleMix=l.getFloat32(),U.shearMix=l.getFloat32(),U.offsetRotation=l.getFloat32(),U.offsetX=l.getFloat32(),U.offsetY=l.getFloat32(),U.offsetScaleX=l.getFloat32(),U.offsetScaleY=l.getFloat32(),U.offsetShearY=l.getFloat32(),this.tfArr.push(U)}var V=l.getUint16(),Y=0;for(t=0;t<V;t++){for((O=new PathConstraintData).name=l.readUTFString(),Y=l.getUint16(),e=0;e<Y;e++)O.bones.push(l.getInt16());O.target=l.readUTFString(),O.positionMode=l.readUTFString(),O.spacingMode=l.readUTFString(),O.rotateMode=l.readUTFString(),O.offsetRotation=l.getFloat32(),O.position=l.getFloat32(),O.spacing=l.getFloat32(),O.rotateMix=l.getFloat32(),O.translateMix=l.getFloat32(),this.pathArr.push(O)}var W,X,z,G,q,H=0,Q=0,Z=0,j=NaN,$=0,J=l.getInt16();for(t=0;t<J;t++){var tt=l.getUint8(),et={};this.deformAniArr.push(et);for(var it=0;it<tt;it++)for((W=new DeformAniData).skinName=l.getUTFString(),et[W.skinName]=W,H=l.getInt16(),e=0;e<H;e++)for(X=new DeformSlotData,W.deformSlotDataList.push(X),Q=l.getInt16(),i=0;i<Q;i++)for(z=new DeformSlotDisplayData,X.deformSlotDisplayList.push(z),z.slotIndex=l.getInt16(),z.attachment=l.getUTFString(),Z=l.getInt16(),a=0;a<Z;a++)for(1==l.getByte()?z.tweenKeyList.push(!0):z.tweenKeyList.push(!1),j=l.getFloat32(),z.timeList.push(j),G=[],z.vectices.push(G),$=l.getInt16(),s=0;s<$;s++)G.push(l.getFloat32())}var at,st,rt=l.getInt16(),nt=0,ht=0;for(t=0;t<rt;t++){for(nt=l.getInt16(),q=[],e=0;e<nt;e++){for((at=new DrawOrderData).time=l.getFloat32(),ht=l.getInt16(),i=0;i<ht;i++)at.drawOrder.push(l.getInt16());q.push(at)}this.drawOrderAniArr.push(q)}var lt,ot=l.getInt16(),ut=0;for(t=0;t<ot;t++){for(ut=l.getInt16(),st=[],e=0;e<ut;e++)(lt=new EventData).name=l.getUTFString(),lt.intValue=l.getInt32(),lt.floatValue=l.getFloat32(),lt.stringValue=l.getUTFString(),lt.time=l.getFloat32(),st.push(lt);this.eventAniArr.push(st)}var _t=l.getInt16();if(0<_t)for(this.attachmentNames=[],t=0;t<_t;t++)this.attachmentNames.push(l.getUTFString());var ct,dt,pt=l.getInt16();for(t=0;t<pt;t++)(ct=new BoneSlot).name=l.readUTFString(),ct.parent=l.readUTFString(),ct.attachmentName=l.readUTFString(),ct.srcDisplayIndex=ct.displayIndex=l.getInt16(),(ct.templet=this).boneSlotDic[ct.name]=ct,null==(dt=this.bindBoneBoneSlotDic[ct.parent])&&(this.bindBoneBoneSlotDic[ct.parent]=dt=[]),dt.push(ct),this.boneSlotArray.push(ct);var ft,mt,xt,yt=l.readUTFString().split("\n"),gt=0,vt=l.getUint8(),Mt=0,Dt=0,It=0,bt=0,Tt=0,Nt=0,Ct=0;for(t=0;t<vt;t++){for((ft=new SkinData).name=yt[gt++],Mt=l.getUint8(),e=0;e<Mt;e++){for((mt=new SlotData).name=yt[gt++],ct=this.boneSlotDic[mt.name],Dt=l.getUint8(),i=0;i<Dt;i++){if(xt=new SkinSlotDisplayData,this.skinSlotDisplayDataArr.push(xt),xt.name=yt[gt++],xt.attachmentName=yt[gt++],xt.transform=new Transform,xt.transform.scX=l.getFloat32(),xt.transform.skX=l.getFloat32(),xt.transform.skY=l.getFloat32(),xt.transform.scY=l.getFloat32(),xt.transform.x=l.getFloat32(),xt.transform.y=l.getFloat32(),mt.displayArr.push(xt),xt.width=l.getFloat32(),xt.height=l.getFloat32(),xt.type=l.getUint8(),xt.verLen=l.getUint16(),0<(A=l.getUint16()))for(xt.bones=[],a=0;a<A;a++){var At=l.getUint16();xt.bones.push(At)}if(0<(It=l.getUint16()))for(xt.uvs=[],a=0;a<It;a++)xt.uvs.push(l.getFloat32());if(0<(bt=l.getUint16()))for(xt.weights=[],a=0;a<bt;a++)xt.weights.push(l.getFloat32());if(0<(Tt=l.getUint16()))for(xt.triangles=[],a=0;a<Tt;a++)xt.triangles.push(l.getUint16());if(0<(Nt=l.getUint16()))for(xt.vertices=[],a=0;a<Nt;a++)xt.vertices.push(l.getFloat32());if(0<(Ct=l.getUint16()))for(xt.lengths=[],a=0;a<Ct;a++)xt.lengths.push(l.getFloat32())}ft.slotArr.push(mt)}this.skinDic[ft.name]=ft,this.skinDataArray.push(ft)}1==l.getUint8()?(this.yReverseMatrix=new Matrix(1,0,0,-1,0,0),C&&C.setTempMatrix(this.yReverseMatrix)):C&&C.setTempMatrix(new Matrix),this.showSkinByIndex(this.boneSlotDic,0),this.isParserComplete=!0,this.event("complete",this)},t.getTexture=function(t){var e=this.subTextureDic[t];return e||(e=this.subTextureDic[t.substr(0,t.length-1)]),null==e?this._mainTexture:e},t.showSkinByIndex=function(t,e,i){if(void 0===i&&(i=!0),e<0&&e>=this.skinDataArray.length)return!1;var a,s,r=0,n=0,h=this.skinDataArray[e];if(h){for(r=0,n=h.slotArr.length;r<n;r++)(s=h.slotArr[r])&&(a=t[s.name])&&(a.showSlotData(s,i),i&&"undefined"!=a.attachmentName&&"null"!=a.attachmentName?a.showDisplayByName(a.attachmentName):a.showDisplayByIndex(a.displayIndex));return!0}return!1},t.getSkinIndexByName=function(t){for(var e=0,i=this.skinDataArray.length;e<i;e++)if(this.skinDataArray[e].name==t)return e;return-1},t.getGrahicsDataWithCache=function(t,e){return this._graphicsCache[t][e]},t.setGrahicsDataWithCache=function(t,e,i){this._graphicsCache[t][e]=i},t.destroy=function(){var t;for(var e in this._isDestroyed=!0,this.subTextureDic)(t=this.subTextureDic[e])&&t.destroy();for(e in this._textureDic)(t=this._textureDic[e])&&t.destroy();for(var i=0,a=this.skinSlotDisplayDataArr.length;i<a;i++)this.skinSlotDisplayDataArr[i].destory();this.skinSlotDisplayDataArr.length=0,this.url&&delete s.TEMPLET_DICTIONARY[this.url],laya.resource.Resource.prototype.destroy.call(this)},t.getAniNameByIndex=function(t){var e=this.getAnimation(t);return e?e.name:null},__getset(0,t,"rate",function(){return this._rate},function(t){this._rate=t}),s.LAYA_ANIMATION_VISION="LAYAANIMATION:1.6.0",s.TEMPLET_DICTIONARY=null,s}(AnimationTemplet);"function"==typeof define&&define.amd&&define("laya.core",["require","exports"],function(t,e){"use strict";for(var i in Object.defineProperty(e,"__esModule",{value:!0}),Laya){var a=Laya[i];a&&a.__isclass&&(e[i]=a)}});